{"remainingRequest":"D:\\大学生活\\大三\\全栈ai\\项目\\node_modules\\babel-loader\\lib\\index.js!D:\\大学生活\\大三\\全栈ai\\项目\\-Time-Traveler-Auction\\src\\services\\auth-service.js","dependencies":[{"path":"D:\\大学生活\\大三\\全栈ai\\项目\\-Time-Traveler-Auction\\src\\services\\auth-service.js","mtime":1762829596753},{"path":"D:\\大学生活\\大三\\全栈ai\\项目\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1762215254891},{"path":"D:\\大学生活\\大三\\全栈ai\\项目\\node_modules\\babel-loader\\lib\\index.js","mtime":1762215256120}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IHsgZ2V0U3VwYWJhc2UgfSBmcm9tICcuL3N1cGFiYXNlLWNsaWVudCc7CmNsYXNzIEF1dGhTZXJ2aWNlIHsKICBhc3luYyBzaWduVXBBY2NvdW50KGFjY291bnQsIHBhc3N3b3JkLCB1c2VybmFtZSkgewogICAgY29uc3Qgc3VwYWJhc2UgPSBnZXRTdXBhYmFzZSgpOwogICAgLy8g5aaC5p6cIGFjY291bnQg5piv6YKu566x77yM55u05o6l55So77yb5ZCm5YiZ55Sf5oiQ57O757uf6YKu566x77yI5ruh6LazIFN1cGFiYXNlIOe6puadn++8iQogICAgY29uc3QgaXNFbWFpbCA9IC9ALy50ZXN0KGFjY291bnQpOwogICAgY29uc3QgZW1haWwgPSBpc0VtYWlsID8gYWNjb3VudCA6IGAke2FjY291bnR9QGxvY2FsLmludmFsaWRgOwogICAgY29uc3QgewogICAgICBkYXRhLAogICAgICBlcnJvcgogICAgfSA9IGF3YWl0IHN1cGFiYXNlLmF1dGguc2lnblVwKHsKICAgICAgZW1haWwsCiAgICAgIHBhc3N3b3JkCiAgICB9KTsKICAgIGlmIChlcnJvcikgdGhyb3cgZXJyb3I7CiAgICBpZiAoZGF0YSAmJiBkYXRhLnVzZXIpIHsKICAgICAgYXdhaXQgc3VwYWJhc2UuZnJvbSgncHJvZmlsZXMnKS51cHNlcnQoewogICAgICAgIGlkOiBkYXRhLnVzZXIuaWQsCiAgICAgICAgdXNlcm5hbWU6IHVzZXJuYW1lIHx8IGFjY291bnQsCiAgICAgICAgYWNjb3VudAogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBkYXRhOwogIH0KICBhc3luYyBzaWduSW5BY2NvdW50KGFjY291bnQsIHBhc3N3b3JkKSB7CiAgICBjb25zdCBzdXBhYmFzZSA9IGdldFN1cGFiYXNlKCk7CiAgICBsZXQgZW1haWwgPSBhY2NvdW50OwogICAgaWYgKCEvQC8udGVzdChhY2NvdW50KSkgewogICAgICBjb25zdCB7CiAgICAgICAgZGF0YTogcHJvZgogICAgICB9ID0gYXdhaXQgc3VwYWJhc2UuZnJvbSgncHJvZmlsZXMnKS5zZWxlY3QoJ2lkLCB1c2VybmFtZSwgYWNjb3VudCcpLmVxKCd1c2VybmFtZScsIGFjY291bnQpLm1heWJlU2luZ2xlKCk7CiAgICAgIGVtYWlsID0gcHJvZiAmJiBwcm9mLmFjY291bnQgPyBgJHtwcm9mLmFjY291bnR9QGxvY2FsLmludmFsaWRgIDogYCR7YWNjb3VudH1AbG9jYWwuaW52YWxpZGA7CiAgICB9CiAgICBjb25zdCB7CiAgICAgIGRhdGEsCiAgICAgIGVycm9yCiAgICB9ID0gYXdhaXQgc3VwYWJhc2UuYXV0aC5zaWduSW5XaXRoUGFzc3dvcmQoewogICAgICBlbWFpbCwKICAgICAgcGFzc3dvcmQKICAgIH0pOwogICAgaWYgKGVycm9yKSB0aHJvdyBlcnJvcjsKICAgIHJldHVybiBkYXRhOwogIH0KICBhc3luYyBzaWduT3V0KCkgewogICAgY29uc3Qgc3VwYWJhc2UgPSBnZXRTdXBhYmFzZSgpOwogICAgYXdhaXQgc3VwYWJhc2UuYXV0aC5zaWduT3V0KCk7CiAgfQogIGFzeW5jIGdldFVzZXIoKSB7CiAgICBjb25zdCBzdXBhYmFzZSA9IGdldFN1cGFiYXNlKCk7CiAgICBjb25zdCB7CiAgICAgIGRhdGEKICAgIH0gPSBhd2FpdCBzdXBhYmFzZS5hdXRoLmdldFVzZXIoKTsKICAgIGlmICghZGF0YSB8fCAhZGF0YS51c2VyKSByZXR1cm4gbnVsbDsKCiAgICAvLyDojrflj5bnlKjmiLfotYTmlpkKICAgIHRyeSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBkYXRhOiBwcm9maWxlLAogICAgICAgIGVycm9yCiAgICAgIH0gPSBhd2FpdCBzdXBhYmFzZS5mcm9tKCdwcm9maWxlcycpLnNlbGVjdCgndXNlcm5hbWUsIGF2YXRhcicpLmVxKCdpZCcsIGRhdGEudXNlci5pZCkuc2luZ2xlKCk7CiAgICAgIGlmIChlcnJvcikgewogICAgICAgIGNvbnNvbGUud2FybignRmFpbGVkIHRvIGxvYWQgdXNlciBwcm9maWxlOicsIGVycm9yKTsKICAgICAgICAvLyDlpoLmnpzml6Dms5Xojrflj5bnlKjmiLfotYTmlpnvvIzov5Tlm57ln7rnoYDnlKjmiLfkv6Hmga8KICAgICAgICByZXR1cm4gZGF0YS51c2VyOwogICAgICB9CgogICAgICAvLyDlsIbotYTmlpnkv6Hmga/lkIjlubbliLDnlKjmiLflr7nosaHkuK0KICAgICAgcmV0dXJuIHsKICAgICAgICAuLi5kYXRhLnVzZXIsCiAgICAgICAgdXNlcm5hbWU6IHByb2ZpbGUgJiYgcHJvZmlsZS51c2VybmFtZSwKICAgICAgICBhdmF0YXI6IHByb2ZpbGUgJiYgcHJvZmlsZS5hdmF0YXIKICAgICAgfTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgY29uc29sZS53YXJuKCdGYWlsZWQgdG8gbG9hZCB1c2VyIHByb2ZpbGU6JywgZSk7CiAgICAgIHJldHVybiBkYXRhLnVzZXI7CiAgICB9CiAgfQogIG9uQXV0aFN0YXRlQ2hhbmdlKGNhbGxiYWNrKSB7CiAgICBjb25zdCBzdXBhYmFzZSA9IGdldFN1cGFiYXNlKCk7CiAgICByZXR1cm4gc3VwYWJhc2UuYXV0aC5vbkF1dGhTdGF0ZUNoYW5nZShhc3luYyAoX2V2ZW50LCBzZXNzaW9uKSA9PiB7CiAgICAgIGNvbnN0IGJhc2VVc2VyID0gc2Vzc2lvbiAmJiBzZXNzaW9uLnVzZXIgfHwgbnVsbDsKICAgICAgaWYgKCFiYXNlVXNlcikgewogICAgICAgIGNhbGxiYWNrKG51bGwpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0cnkgewogICAgICAgIGNvbnN0IHsKICAgICAgICAgIGRhdGE6IHByb2ZpbGUKICAgICAgICB9ID0gYXdhaXQgc3VwYWJhc2UuZnJvbSgncHJvZmlsZXMnKS5zZWxlY3QoJ3VzZXJuYW1lLCBhdmF0YXInKS5lcSgnaWQnLCBiYXNlVXNlci5pZCkuc2luZ2xlKCk7CiAgICAgICAgY29uc3QgbWVyZ2VkID0gewogICAgICAgICAgLi4uYmFzZVVzZXIsCiAgICAgICAgICB1c2VybmFtZTogcHJvZmlsZSAmJiBwcm9maWxlLnVzZXJuYW1lLAogICAgICAgICAgYXZhdGFyOiBwcm9maWxlICYmIHByb2ZpbGUuYXZhdGFyCiAgICAgICAgfTsKICAgICAgICBjYWxsYmFjayhtZXJnZWQpOwogICAgICB9IGNhdGNoIChfKSB7CiAgICAgICAgY2FsbGJhY2soYmFzZVVzZXIpOwogICAgICB9CiAgICB9KTsKICB9Cn0KZXhwb3J0IGRlZmF1bHQgbmV3IEF1dGhTZXJ2aWNlKCk7"},{"version":3,"names":["getSupabase","AuthService","signUpAccount","account","password","username","supabase","isEmail","test","email","data","error","auth","signUp","user","from","upsert","id","signInAccount","prof","select","eq","maybeSingle","signInWithPassword","signOut","getUser","profile","single","console","warn","avatar","e","onAuthStateChange","callback","_event","session","baseUser","merged","_"],"sources":["D:/大学生活/大三/全栈ai/项目/-Time-Traveler-Auction/src/services/auth-service.js"],"sourcesContent":["import { getSupabase } from './supabase-client'\r\n\r\nclass AuthService {\r\n  async signUpAccount(account, password, username) {\r\n    const supabase = getSupabase()\r\n    // 如果 account 是邮箱，直接用；否则生成系统邮箱（满足 Supabase 约束）\r\n    const isEmail = /@/.test(account)\r\n    const email = isEmail ? account : `${account}@local.invalid`\r\n    const { data, error } = await supabase.auth.signUp({ email, password })\r\n    if (error) throw error\r\n    if (data && data.user) {\r\n      await supabase.from('profiles').upsert({ id: data.user.id, username: username || account, account })\r\n    }\r\n    return data\r\n  }\r\n\r\n  async signInAccount(account, password) {\r\n    const supabase = getSupabase()\r\n    let email = account\r\n    if (!/@/.test(account)) {\r\n      const { data: prof } = await supabase.from('profiles').select('id, username, account').eq('username', account).maybeSingle()\r\n      email = (prof && prof.account) ? `${prof.account}@local.invalid` : `${account}@local.invalid`\r\n    }\r\n    const { data, error } = await supabase.auth.signInWithPassword({ email, password })\r\n    if (error) throw error\r\n    return data\r\n  }\r\n\r\n  async signOut() {\r\n    const supabase = getSupabase()\r\n    await supabase.auth.signOut()\r\n  }\r\n\r\n  async getUser() {\r\n    const supabase = getSupabase()\r\n    const { data } = await supabase.auth.getUser()\r\n    if (!data || !data.user) return null\r\n    \r\n    // 获取用户资料\r\n    try {\r\n      const { data: profile, error } = await supabase\r\n        .from('profiles')\r\n        .select('username, avatar')\r\n        .eq('id', data.user.id)\r\n        .single()\r\n      \r\n      if (error) {\r\n        console.warn('Failed to load user profile:', error)\r\n        // 如果无法获取用户资料，返回基础用户信息\r\n        return data.user\r\n      }\r\n      \r\n      // 将资料信息合并到用户对象中\r\n      return {\r\n        ...data.user,\r\n        username: profile && profile.username,\r\n        avatar: profile && profile.avatar\r\n      }\r\n    } catch (e) {\r\n      console.warn('Failed to load user profile:', e)\r\n      return data.user\r\n    }\r\n  }\r\n\r\n  onAuthStateChange(callback) {\r\n    const supabase = getSupabase()\r\n    return supabase.auth.onAuthStateChange(async (_event, session) => {\r\n      const baseUser = (session && session.user) || null\r\n      if (!baseUser) {\r\n        callback(null)\r\n        return\r\n      }\r\n      try {\r\n        const { data: profile } = await supabase\r\n          .from('profiles')\r\n          .select('username, avatar')\r\n          .eq('id', baseUser.id)\r\n          .single()\r\n        const merged = {\r\n          ...baseUser,\r\n          username: profile && profile.username,\r\n          avatar: profile && profile.avatar\r\n        }\r\n        callback(merged)\r\n      } catch (_) {\r\n        callback(baseUser)\r\n      }\r\n    })\r\n  }\r\n}\r\n\r\nexport default new AuthService()\r\n"],"mappings":"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","ignoreList":[]}]}