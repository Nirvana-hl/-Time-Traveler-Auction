{"remainingRequest":"D:\\大学生活\\大三\\全栈ai\\项目\\node_modules\\babel-loader\\lib\\index.js!D:\\大学生活\\大三\\全栈ai\\项目\\-Time-Traveler-Auction\\src\\services\\auction-persist-service.js","dependencies":[{"path":"D:\\大学生活\\大三\\全栈ai\\项目\\-Time-Traveler-Auction\\src\\services\\auction-persist-service.js","mtime":1762087622756},{"path":"D:\\大学生活\\大三\\全栈ai\\项目\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1762215254891},{"path":"D:\\大学生活\\大三\\全栈ai\\项目\\node_modules\\babel-loader\\lib\\index.js","mtime":1762215256120}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IHsgZ2V0U3VwYWJhc2UgfSBmcm9tICcuL3N1cGFiYXNlLWNsaWVudCc7CmNsYXNzIEF1Y3Rpb25QZXJzaXN0U2VydmljZSB7CiAgYXN5bmMgdXBzZXJ0QXVjdGlvbihyb29tSWQsIGF1Y3Rpb24pIHsKICAgIGNvbnN0IHN1cGFiYXNlID0gZ2V0U3VwYWJhc2UoKTsKICAgIC8vIOmBv+WFjeWQjOS4gOaIv+mXtOWQjOS4gOaLjeWNluWTgemHjeWkje+8iOS7hemSiOWvuSBhY3RpdmUg54q25oCB77yJCiAgICBjb25zdCB7CiAgICAgIGRhdGE6IGV4aXN0aW5nCiAgICB9ID0gYXdhaXQgc3VwYWJhc2UuZnJvbSgnYXVjdGlvbnMnKS5zZWxlY3QoJ2lkJykuZXEoJ3Jvb21faWQnLCByb29tSWQpLmVxKCdhcnRpZmFjdF9pZCcsIGF1Y3Rpb24uYXJ0aWZhY3QuaWQpLmVxKCdzdGF0dXMnLCAnYWN0aXZlJykubGltaXQoMSk7CiAgICBpZiAoZXhpc3RpbmcgJiYgZXhpc3RpbmcubGVuZ3RoKSB7CiAgICAgIC8vIOW3suWtmOWcqOa0u+WKqOaLjeWNlu+8jOebtOaOpei/lOWbnuWOn+aLjeWNluWvueixoe+8jOS4jeWGjeWGmeWFpemHjeWkjeiusOW9lQogICAgICByZXR1cm4gYXVjdGlvbjsKICAgIH0KICAgIGNvbnN0IHsKICAgICAgZXJyb3IKICAgIH0gPSBhd2FpdCBzdXBhYmFzZS5mcm9tKCdhdWN0aW9ucycpLnVwc2VydCh7CiAgICAgIHJvb21faWQ6IHJvb21JZCwKICAgICAgaWQ6IGF1Y3Rpb24uaWQsCiAgICAgIGFydGlmYWN0X2lkOiBhdWN0aW9uLmFydGlmYWN0LmlkLAogICAgICBhcnRpZmFjdDogYXVjdGlvbi5hcnRpZmFjdCwKICAgICAgaGlnaGVzdF9iaWQ6IGF1Y3Rpb24uaGlnaGVzdEJpZCwKICAgICAgaGlnaGVzdF9iaWRkZXI6IGF1Y3Rpb24uaGlnaGVzdEJpZGRlciwKICAgICAgdGltZV9yZW1haW5pbmc6IGF1Y3Rpb24udGltZVJlbWFpbmluZywKICAgICAgc3RhdHVzOiBhdWN0aW9uLnN0YXR1cwogICAgfSk7CiAgICBpZiAoZXJyb3IpIHRocm93IGVycm9yOwogICAgcmV0dXJuIGF1Y3Rpb247CiAgfQogIGFzeW5jIHVwZGF0ZUJpZChyb29tSWQsIGF1Y3Rpb25JZCwgaGlnaGVzdEJpZCwgaGlnaGVzdEJpZGRlcikgewogICAgY29uc3Qgc3VwYWJhc2UgPSBnZXRTdXBhYmFzZSgpOwogICAgY29uc3QgewogICAgICBlcnJvcgogICAgfSA9IGF3YWl0IHN1cGFiYXNlLmZyb20oJ2F1Y3Rpb25zJykudXBkYXRlKHsKICAgICAgaGlnaGVzdF9iaWQ6IGhpZ2hlc3RCaWQsCiAgICAgIGhpZ2hlc3RfYmlkZGVyOiBoaWdoZXN0QmlkZGVyCiAgICB9KS5lcSgnaWQnLCBhdWN0aW9uSWQpOwogICAgaWYgKGVycm9yKSB0aHJvdyBlcnJvcjsKICB9CiAgYXN5bmMgZW5kQXVjdGlvbihyb29tSWQsIGF1Y3Rpb24pIHsKICAgIGNvbnN0IHN1cGFiYXNlID0gZ2V0U3VwYWJhc2UoKTsKICAgIC8vIOWOn+WtkOaAp+e7k+adn++8muS7heW9k+aLjeWNluS7jeS4uiBhY3RpdmUg5pe25omN5omn6KGM57uT5p2f5LiO5b2S5bGe77yM6YG/5YWN6YeN5aSN5o+S5YWlCiAgICBjb25zdCB7CiAgICAgIGRhdGE6IHVwZGF0ZWRSb3dzLAogICAgICBlcnJvcjogZW5kRXJyCiAgICB9ID0gYXdhaXQgc3VwYWJhc2UuZnJvbSgnYXVjdGlvbnMnKS51cGRhdGUoewogICAgICBzdGF0dXM6ICdlbmRlZCcsCiAgICAgIHRpbWVfcmVtYWluaW5nOiAwCiAgICB9KS5lcSgnaWQnLCBhdWN0aW9uLmlkKS5lcSgnc3RhdHVzJywgJ2FjdGl2ZScpLnNlbGVjdCgnaWQsIGFydGlmYWN0X2lkLCBhcnRpZmFjdCwgaGlnaGVzdF9iaWQsIGhpZ2hlc3RfYmlkZGVyJyk7CiAgICBpZiAoZW5kRXJyKSB0aHJvdyBlbmRFcnI7CgogICAgLy8g6Iul5peg6KGM6KKr5pu05paw77ya6K+05piO5bey57uT5p2f5oiW5LiN5a2Y5Zyo77yM55u05o6l6L+U5Zue77yM5LiN5YaN6YeN5aSN5YaZ5Y6G5Y+yL+W9kuWxngogICAgaWYgKCF1cGRhdGVkUm93cyB8fCB1cGRhdGVkUm93cy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgY29uc3Qgcm93ID0gdXBkYXRlZFJvd3NbMF07CiAgICBjb25zdCBmaW5hbFdpbm5lciA9IHJvdyAmJiByb3cuaGlnaGVzdF9iaWRkZXIgPyByb3cuaGlnaGVzdF9iaWRkZXIgOiBudWxsOwogICAgY29uc3QgZmluYWxCaWQgPSByb3cgJiYgdHlwZW9mIHJvdy5oaWdoZXN0X2JpZCA9PT0gJ251bWJlcicgPyByb3cuaGlnaGVzdF9iaWQgOiAwOwogICAgY29uc3QgYXJ0aWZhY3RJZCA9IHJvdyAmJiByb3cuYXJ0aWZhY3RfaWQ7CiAgICBjb25zdCBhcnRpZmFjdCA9IHJvdyAmJiByb3cuYXJ0aWZhY3QgPyByb3cuYXJ0aWZhY3QgOiBhdWN0aW9uLmFydGlmYWN0IHx8IHsKICAgICAgaWQ6IGFydGlmYWN0SWQKICAgIH07CgogICAgLy8g5YaZ5YWl5ouN5Y2W5Y6G5Y+y77yI5LulRELnu5PmnpzkuLrlh4bvvIkKICAgIGNvbnN0IHsKICAgICAgZXJyb3I6IGhlcnIKICAgIH0gPSBhd2FpdCBzdXBhYmFzZS5mcm9tKCdhdWN0aW9uX2hpc3RvcnknKS5pbnNlcnQoewogICAgICBhdWN0aW9uX2lkOiBhdWN0aW9uLmlkLAogICAgICBhcnRpZmFjdF9pZDogYXJ0aWZhY3RJZCB8fCBhcnRpZmFjdCAmJiBhcnRpZmFjdC5pZCwKICAgICAgYXJ0aWZhY3Q6IGFydGlmYWN0LAogICAgICB3aW5uZXI6IGZpbmFsV2lubmVyLAogICAgICB3aW5uaW5nX2JpZDogZmluYWxCaWQKICAgIH0pOwogICAgaWYgKGhlcnIpIHRocm93IGhlcnI7CgogICAgLy8g6Iul5pyA57uI5pyJ6I636IOc6ICF77yM5YiZ5bCG6K+l5ZWG5ZOB5b2S5YWl5YW25oi/6Ze05omL54mM77yIcm9vbV9hcnRpZmFjdHPvvInvvIzkuIDmrKHmgKfmj5LlhaUKICAgIGlmIChmaW5hbFdpbm5lciAmJiAoYXJ0aWZhY3RJZCB8fCBhcnRpZmFjdCAmJiBhcnRpZmFjdC5pZCkpIHsKICAgICAgY29uc3QgewogICAgICAgIGVycm9yOiBhZXJyCiAgICAgIH0gPSBhd2FpdCBzdXBhYmFzZS5mcm9tKCdyb29tX2FydGlmYWN0cycpLmluc2VydCh7CiAgICAgICAgcm9vbV9pZDogcm9vbUlkLAogICAgICAgIG93bmVyX3VzZXJfaWQ6IGZpbmFsV2lubmVyLAogICAgICAgIGFydGlmYWN0X2lkOiBhcnRpZmFjdElkIHx8IGFydGlmYWN0LmlkCiAgICAgIH0pOwogICAgICBpZiAoYWVycikgdGhyb3cgYWVycjsKICAgIH0KCiAgICAvLyDliKDpmaTmnKzova7mi43ljZbooYzvvIjluYLnrYnvvIzph43lpI3osIPnlKjkuI3kvJrlvbHlk43mlbDmja7mraPnoa7mgKfvvIkKICAgIGF3YWl0IHN1cGFiYXNlLmZyb20oJ2F1Y3Rpb25zJykuZGVsZXRlKCkuZXEoJ2lkJywgYXVjdGlvbi5pZCk7CiAgfQp9CmV4cG9ydCBkZWZhdWx0IG5ldyBBdWN0aW9uUGVyc2lzdFNlcnZpY2UoKTs="},{"version":3,"names":["getSupabase","AuctionPersistService","upsertAuction","roomId","auction","supabase","data","existing","from","select","eq","artifact","id","limit","length","error","upsert","room_id","artifact_id","highest_bid","highestBid","highest_bidder","highestBidder","time_remaining","timeRemaining","status","updateBid","auctionId","update","endAuction","updatedRows","endErr","row","finalWinner","finalBid","artifactId","herr","insert","auction_id","winner","winning_bid","aerr","owner_user_id","delete"],"sources":["D:/大学生活/大三/全栈ai/项目/-Time-Traveler-Auction/src/services/auction-persist-service.js"],"sourcesContent":["import { getSupabase } from './supabase-client'\r\n\r\nclass AuctionPersistService {\r\n  async upsertAuction(roomId, auction) {\r\n    const supabase = getSupabase()\r\n    // 避免同一房间同一拍卖品重复（仅针对 active 状态）\r\n    const { data: existing } = await supabase\r\n      .from('auctions')\r\n      .select('id')\r\n      .eq('room_id', roomId)\r\n      .eq('artifact_id', auction.artifact.id)\r\n      .eq('status', 'active')\r\n      .limit(1)\r\n    if (existing && existing.length) {\r\n      // 已存在活动拍卖，直接返回原拍卖对象，不再写入重复记录\r\n      return auction\r\n    }\r\n    const { error } = await supabase\r\n      .from('auctions')\r\n      .upsert({\r\n        room_id: roomId,\r\n        id: auction.id,\r\n        artifact_id: auction.artifact.id,\r\n        artifact: auction.artifact,\r\n        highest_bid: auction.highestBid,\r\n        highest_bidder: auction.highestBidder,\r\n        time_remaining: auction.timeRemaining,\r\n        status: auction.status\r\n      })\r\n    if (error) throw error\r\n    return auction\r\n  }\r\n\r\n  async updateBid(roomId, auctionId, highestBid, highestBidder) {\r\n    const supabase = getSupabase()\r\n    const { error } = await supabase\r\n      .from('auctions')\r\n      .update({ highest_bid: highestBid, highest_bidder: highestBidder })\r\n      .eq('id', auctionId)\r\n    if (error) throw error\r\n  }\r\n\r\n  async endAuction(roomId, auction) {\r\n    const supabase = getSupabase()\r\n    // 原子性结束：仅当拍卖仍为 active 时才执行结束与归属，避免重复插入\r\n    const { data: updatedRows, error: endErr } = await supabase\r\n      .from('auctions')\r\n      .update({ status: 'ended', time_remaining: 0 })\r\n      .eq('id', auction.id)\r\n      .eq('status', 'active')\r\n      .select('id, artifact_id, artifact, highest_bid, highest_bidder')\r\n    if (endErr) throw endErr\r\n\r\n    // 若无行被更新：说明已结束或不存在，直接返回，不再重复写历史/归属\r\n    if (!updatedRows || updatedRows.length === 0) {\r\n      return\r\n    }\r\n\r\n    const row = updatedRows[0]\r\n    const finalWinner = row && row.highest_bidder ? row.highest_bidder : null\r\n    const finalBid = row && typeof row.highest_bid === 'number' ? row.highest_bid : 0\r\n    const artifactId = row && row.artifact_id\r\n    const artifact = row && row.artifact ? row.artifact : (auction.artifact || { id: artifactId })\r\n\r\n    // 写入拍卖历史（以DB结果为准）\r\n    const { error: herr } = await supabase\r\n      .from('auction_history')\r\n      .insert({\r\n        auction_id: auction.id,\r\n        artifact_id: artifactId || (artifact && artifact.id),\r\n        artifact: artifact,\r\n        winner: finalWinner,\r\n        winning_bid: finalBid\r\n      })\r\n    if (herr) throw herr\r\n\r\n    // 若最终有获胜者，则将该商品归入其房间手牌（room_artifacts），一次性插入\r\n    if (finalWinner && (artifactId || (artifact && artifact.id))) {\r\n      const { error: aerr } = await supabase\r\n        .from('room_artifacts')\r\n        .insert({\r\n          room_id: roomId,\r\n          owner_user_id: finalWinner,\r\n          artifact_id: artifactId || artifact.id\r\n        })\r\n      if (aerr) throw aerr\r\n    }\r\n\r\n    // 删除本轮拍卖行（幂等，重复调用不会影响数据正确性）\r\n    await supabase.from('auctions').delete().eq('id', auction.id)\r\n  }\r\n}\r\n\r\nexport default new AuctionPersistService()\r\n"],"mappings":"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","ignoreList":[]}]}