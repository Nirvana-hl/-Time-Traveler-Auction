{"remainingRequest":"D:\\大学生活\\大三\\全栈ai\\项目\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\大学生活\\大三\\全栈ai\\项目\\-Time-Traveler-Auction\\src\\pages\\index\\index.vue?vue&type=script&lang=js","dependencies":[{"path":"D:\\大学生活\\大三\\全栈ai\\项目\\-Time-Traveler-Auction\\src\\pages\\index\\index.vue","mtime":1762820564094},{"path":"D:\\大学生活\\大三\\全栈ai\\项目\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1762215254891},{"path":"D:\\大学生活\\大三\\全栈ai\\项目\\node_modules\\babel-loader\\lib\\index.js","mtime":1762215256120},{"path":"D:\\大学生活\\大三\\全栈ai\\项目\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1762215254891},{"path":"D:\\大学生活\\大三\\全栈ai\\项目\\node_modules\\vue-loader\\lib\\index.js","mtime":1762215256637}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CmltcG9ydCB7IG1hcFN0YXRlLCBtYXBHZXR0ZXJzIH0gZnJvbSAndnVleCcKaW1wb3J0IEF1Y3Rpb25QYW5lbCBmcm9tICcuLi8uLi9jb21wb25lbnRzL2F1Y3Rpb24tcGFuZWwvYXVjdGlvbi1wYW5lbC52dWUnCmltcG9ydCByb29tU2VydmljZSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9yb29tLXNlcnZpY2UnCmltcG9ydCB7IGdldFN1cGFiYXNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvc3VwYWJhc2UtY2xpZW50JwppbXBvcnQgYXVjdGlvblNlcnZpY2UgZnJvbSAnLi4vLi4vc2VydmljZXMvYXVjdGlvbi1zZXJ2aWNlJwppbXBvcnQgeyBzdGFydENvdW50ZG93biwgY2xlYXJDb3VudGRvd24gfSBmcm9tICcuLi8uLi9mZWF0dXJlcy9nYW1lL2NvdW50ZG93bicKaW1wb3J0IHsgbG9hZFJvb21TdGF0ZSBhcyBsb2FkUm9vbVN0YXRlU2VydmljZSB9IGZyb20gJy4uLy4uL2ZlYXR1cmVzL2dhbWUvcm9vbS1zdGF0ZS5zZXJ2aWNlJwppbXBvcnQgeyBzdWJzY3JpYmVSb29tUmVhbHRpbWUgYXMgc3Vic2NyaWJlUm9vbVJlYWx0aW1lU2VydmljZSwgdW5zdWJzY3JpYmVSb29tUmVhbHRpbWUgYXMgdW5zdWJzY3JpYmVSb29tUmVhbHRpbWVTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vZmVhdHVyZXMvZ2FtZS9yb29tLXJlYWx0aW1lJwppbXBvcnQgeyBzdGFydEdhbWUgYXMgc3RhcnRHYW1lRmxvdywgYXV0b1N0YXJ0QXVjdGlvbiBhcyBhdXRvU3RhcnRBdWN0aW9uRmxvdyB9IGZyb20gJy4uLy4uL2ZlYXR1cmVzL2dhbWUvYXVjdGlvbi1mbG93LnNlcnZpY2UnCmltcG9ydCB7IHNlbmRDaGF0TWVzc2FnZSB9IGZyb20gJy4uLy4uL2ZlYXR1cmVzL2dhbWUvY2hhdC5zZXJ2aWNlJwppbXBvcnQgeyB0b2dnbGVSZWFkeSBhcyB0b2dnbGVSZWFkeUFjdGlvbiwgbW92ZVRvU2VhdCBhcyBtb3ZlVG9TZWF0QWN0aW9uLCBsZWF2ZVJvb20gYXMgbGVhdmVSb29tQWN0aW9uIH0gZnJvbSAnLi4vLi4vZmVhdHVyZXMvZ2FtZS9yb29tLWFjdGlvbnMuc2VydmljZScKaW1wb3J0IHsgbG9hZEFydGlmYWN0cyBhcyBsb2FkQXJ0aWZhY3RzU2VydmljZSB9IGZyb20gJy4uLy4uL2ZlYXR1cmVzL2dhbWUvYXJ0aWZhY3RzLnNlcnZpY2UnCmltcG9ydCB7IGxvYWRDb2xsZWN0aW9uc0Zyb21BcnRpZmFjdHMsIGdldEN1cnJlbnRDb2xsZWN0aW9uQ291bnQgYXMgZ2V0Q29sbGVjdGlvbkNvdW50VXRpbCwgZ2V0Q29sbGVjdGlvblByb2dyZXNzIGFzIGdldENvbGxlY3Rpb25Qcm9ncmVzc1V0aWwgfSBmcm9tICcuLi8uLi9mZWF0dXJlcy9nYW1lL2NvbGxlY3Rpb25zLnV0aWxzJwppbXBvcnQgeyBmb3JtYXRNZXNzYWdlVGltZSBhcyBmb3JtYXRNZXNzYWdlVGltZUhlbHBlciwgZ2V0QXZhdGFyRm9yIGFzIGdldEF2YXRhckZvckhlbHBlciwgZ2V0TmFtZUZvciBhcyBnZXROYW1lRm9ySGVscGVyIH0gZnJvbSAnLi4vLi4vZmVhdHVyZXMvZ2FtZS91aS5oZWxwZXJzJwppbXBvcnQgeyBmaXJzdExvZ2luRGlhbG9ndWUgYXMgZmlyc3RMb2dpbkRpYWxvZ3VlQ29uZmlnLCBnZXRDdXJyZW50TGFuZ3VhZ2UgYXMgZ2V0Q3VycmVudExhbmd1YWdlSW1wb3J0ZWQgfSBmcm9tICcuLi8uLi9jb25maWcvZGlhbG9ndWUtY29uZmlnJwpleHBvcnQgZGVmYXVsdCB7CiAgbmFtZTogJ0dhbWVJbmRleCcsCiAgY29tcG9uZW50czogewogICAgQXVjdGlvblBhbmVsCiAgfSwKICBkYXRhKCkgewogICAgcmV0dXJuIHsKICAgICAgc2VsZWN0ZWRDYXJkOiBudWxsLAogICAgICBzaG93SGFuZFBvcHVwOiBmYWxzZSwKICAgICAgaGFuZFBsYXllcjogbnVsbCwKICAgICAgYXJ0aWZhY3RNYXA6IHt9LAogICAgICByb29tOiBudWxsLAogICAgICBwcm9maWxlTWFwOiB7fSwKICAgICAgcmVmcmVzaFRpbWVyOiBudWxsLAogICAgICBjb2xsZWN0aW9uczogW10sCiAgICAgIHNob3dHYW1lRW5kRGlhbG9nOiBmYWxzZSwKICAgICAgZmluYWxTY29yZXM6IFtdLAogICAgICB3aW5uZXJJbmZvOiBudWxsLAogICAgICBhdWN0aW9uQ291bnRkb3duOiAwLAogICAgICBhdWN0aW9uVGltZXI6IG51bGwsCiAgICAgIGN1cnJlbnRBdWN0aW9uOiBudWxsLAogICAgICAvLyDlm57lkIjnm7jlhbPvvIjliY3nq6/lrp7ml7bmmL7npLrvvIzmiL/kuLvmr4/ova7lvIDmi43ml7blub/mkq3ku6Xkv53mjIHlkIzmraXvvIkKICAgICAgcm91bmRDb3VudDogMCwKICAgICAgdG90YWxSb3VuZHM6IDYsCiAgICAgIGNoYXRNZXNzYWdlczogW10sCiAgICAgIG5ld01lc3NhZ2U6ICcnLAogICAgICBjaGF0Q2hhbm5lbDogbnVsbCwKICAgICAgY291bnRkb3duSW5Qcm9ncmVzczogZmFsc2UsCiAgICAgIGV4cGFuZGVkQ29sbGVjdGlvbnM6IHt9LAogICAgICBzaG93TmFycmF0aW9uOiBmYWxzZSwKICAgICAgdHlwaW5nVGV4dDogJycsCiAgICAgIHR5cGluZ1RpbWVyOiBudWxsLAogICAgICAvLyDlrZjlgqjmiYDmnInnjqnlrrbnmoTmiYvniYzmlbDmja7vvIznlKjkuo7ku7flgLzorqHnrpcKICAgICAgYWxsUGxheWVyc0FydGlmYWN0czoge30KICAgIH0KICB9LAogIGNvbXB1dGVkOiB7CiAgICAuLi5tYXBTdGF0ZShbJ2dhbWVQaGFzZScsICdnYW1lTG9nJywgJ3Nob3dDYXJkRGV0YWlsJywgJ3VzZXInLCAncm9vbUlkJywgJ3JvdW5kQ3VycmVudCcsICdyb3VuZFRvdGFsJ10pLAogICAgLy8g5bCG5b2T5YmN546p5a625rOo5YWl5Yiw5riy5p+T5LiK5LiL5paH77yM6YG/5YWN5qih5p2/5byV55So5oql6ZSZCiAgICBjdXJyZW50UGxheWVyKCkgeyByZXR1cm4gdGhpcy4kc3RvcmUuc3RhdGUuY3VycmVudFBsYXllciB9LAogICAgaXNPd25lcigpIHsgcmV0dXJuIHRoaXMucm9vbSAmJiB0aGlzLnVzZXIgJiYgdGhpcy5yb29tLm93bmVyX2lkID09PSB0aGlzLnVzZXIuaWQgfSwKICAgIGFsbFJlYWR5KCkgewogICAgICBjb25zdCBwbGF5ZXJzID0gKHRoaXMucm9vbSAmJiB0aGlzLnJvb20ucm9vbV9wbGF5ZXJzKSA/IHRoaXMucm9vbS5yb29tX3BsYXllcnMgOiBbXQogICAgICByZXR1cm4gcGxheWVycy5sZW5ndGggPiAwICYmIHBsYXllcnMuZXZlcnkocCA9PiAhIXAuaXNfcmVhZHkpCiAgICB9LAogICAgY3VycmVudFVzZXJSZWFkeSgpIHsKICAgICAgY29uc3QgdXNlciA9IHRoaXMudXNlcgogICAgICBjb25zdCBwbGF5ZXJzID0gKHRoaXMucm9vbSAmJiB0aGlzLnJvb20ucm9vbV9wbGF5ZXJzKSA/IHRoaXMucm9vbS5yb29tX3BsYXllcnMgOiBbXQogICAgICBpZiAoIXVzZXIpIHJldHVybiBmYWxzZQogICAgICBjb25zdCBtZSA9IHBsYXllcnMuZmluZChwID0+IHAudXNlcl9pZCA9PT0gdXNlci5pZCkKICAgICAgcmV0dXJuICEhKG1lICYmIG1lLmlzX3JlYWR5KQogICAgfSwKICAgIHBsYXllckNvdW50KCkgewogICAgICByZXR1cm4gKHRoaXMucm9vbSAmJiB0aGlzLnJvb20ucm9vbV9wbGF5ZXJzKSA/IHRoaXMucm9vbS5yb29tX3BsYXllcnMubGVuZ3RoIDogMAogICAgfSwKICAgIG93bmVyTmFtZSgpIHsKICAgICAgaWYgKCF0aGlzLnJvb20pIHJldHVybiAnLScKICAgICAgcmV0dXJuIHRoaXMuZ2V0TmFtZUZvcih0aGlzLnJvb20ub3duZXJfaWQpCiAgICB9LAogICAgc2VhdENvdW50KCkgeyByZXR1cm4gKHRoaXMucm9vbSAmJiBOdW1iZXIodGhpcy5yb29tLm1heF9wbGF5ZXJzKSkgPyBOdW1iZXIodGhpcy5yb29tLm1heF9wbGF5ZXJzKSA6IDAgfSwKICAgIHNlYXRzKCkgewogICAgICBjb25zdCBwbGF5ZXJzID0gKHRoaXMucm9vbSAmJiB0aGlzLnJvb20ucm9vbV9wbGF5ZXJzKSA/IHRoaXMucm9vbS5yb29tX3BsYXllcnMgOiBbXQogICAgICBjb25zdCBtYXggPSB0aGlzLnNlYXRDb3VudAogICAgICBjb25zdCBzZWF0cyA9IEFycmF5LmZyb20oeyBsZW5ndGg6IG1heCB9LCAoKSA9PiAoeyBwbGF5ZXI6IG51bGwgfSkpCiAgICAgIC8vIOaUvue9ruW3suiuvue9ruW6p+S9jeeahOeOqeWutgogICAgICBwbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgY29uc3QgaWR4ID0gdHlwZW9mIHAuc2VhdF9pbmRleCA9PT0gJ251bWJlcicgPyBwLnNlYXRfaW5kZXggOiAtMQogICAgICAgIGlmIChpZHggPj0gMCAmJiBpZHggPCBtYXggJiYgIXNlYXRzW2lkeF0ucGxheWVyKSBzZWF0c1tpZHhdLnBsYXllciA9IHAKICAgICAgfSkKICAgICAgLy8g5bCG5pyq6K6+572u5bqn5L2N55qE546p5a625L6d5qyh5pS+5Yiw56m65L2NCiAgICAgIHBsYXllcnMuZmlsdGVyKHAgPT4gdHlwZW9mIHAuc2VhdF9pbmRleCAhPT0gJ251bWJlcicgfHwgcC5zZWF0X2luZGV4IDwgMCkuZm9yRWFjaChwID0+IHsKICAgICAgICBjb25zdCBlbXB0eUlkeCA9IHNlYXRzLmZpbmRJbmRleChzID0+ICFzLnBsYXllcikKICAgICAgICBpZiAoZW1wdHlJZHggPj0gMCkgc2VhdHNbZW1wdHlJZHhdLnBsYXllciA9IHAKICAgICAgfSkKICAgICAgcmV0dXJuIHNlYXRzCiAgICB9LAogICAgZ2FtZVBoYXNlVGV4dCgpIHsKICAgICAgY29uc3QgcGhhc2VNYXAgPSB7CiAgICAgICAgJ3ByZXBhcmF0aW9uJzogJ+WHhuWkh+mYtuautScsCiAgICAgICAgJ2NvdW50ZG93bic6ICfpooTlgJLorqHml7YnLAogICAgICAgICdpbnRlcm1pc3Npb24nOiAn6Ze05q2H6Zi25q61JywKICAgICAgICAnYXVjdGlvbic6ICfmi43ljZbpmLbmrrUnLAogICAgICAgICdzZXR0bGVtZW50JzogJ+e7k+eul+mYtuautScKICAgICAgfQogICAgICByZXR1cm4gcGhhc2VNYXBbdGhpcy5nYW1lUGhhc2VdIHx8ICfmnKrnn6XpmLbmrrUnCiAgICB9LAogICAKCiAgICAvLyDmoLnmja7lvZPliY3nlKjmiLfmiYvniYzorqHnrpfmlLbol4/pm4bmmL7npLrmlbDmja7vvIzluKbnvJPlrZjlrZfmrrXvvIzkvr/kuo7mqKHmnb/nm7TmjqXlvJXnlKgKICAgIGNvbGxlY3Rpb25zQ29tcHV0ZWQoKSB7CiAgICAgIGNvbnN0IGxpc3QgPSBBcnJheS5pc0FycmF5KHRoaXMuY29sbGVjdGlvbnMpID8gdGhpcy5jb2xsZWN0aW9ucyA6IFtdCiAgICAgIC8vIOS7heWxleekuueUqOaIt+aJi+eJjOS4reiHs+WwkeWMheWQqzHku7bor6XmlLbol4/pm4bnmoTmg4XlhrUKICAgICAgcmV0dXJuIGxpc3QKICAgICAgICAubWFwKGNvbCA9PiB7CiAgICAgICAgICBjb25zdCBjdXJyZW50ID0gdGhpcy5nZXRDdXJyZW50Q29sbGVjdGlvbkNvdW50KGNvbCkKICAgICAgICAgIGNvbnN0IHByb2dyZXNzID0gTWF0aC5taW4oKGN1cnJlbnQgLyAoY29sLnJlcXVpcmVkQ291bnQgfHwgMSkpICogMTAwLCAxMDApCiAgICAgICAgICByZXR1cm4geyAuLi5jb2wsIF9jdXJyZW50OiBjdXJyZW50LCBfcHJvZ3Jlc3M6IHByb2dyZXNzIH0KICAgICAgICB9KQogICAgICAgIC5maWx0ZXIoY29sID0+IGNvbC5fY3VycmVudCA+IDApCiAgICB9LAoKICAgIC8vIOWQiOW5tuiBiuWkqeS4juezu+e7n+aXpeW/l+S4uuWQjOS4gOS/oeaBr+a1ge+8jOaMieaXtumXtOaOkuW6jwogICAgY2hhdEZlZWQoKSB7CiAgICAgIGNvbnN0IGxvZ3MgPSAodGhpcy5nYW1lTG9nIHx8IFtdKS5tYXAoKGwsIGlkeCkgPT4gKHsKICAgICAgICBpZDogYGxvZy0ke2wudGltZXN0YW1wIHx8IGlkeH1gLAogICAgICAgIHR5cGU6ICdsb2cnLAogICAgICAgIHVzZXJJZDogbnVsbCwKICAgICAgICB1c2VybmFtZTogJ+ezu+e7nycsCiAgICAgICAgY29udGVudDogbC5tZXNzYWdlLAogICAgICAgIHRpbWVzdGFtcDogbC50aW1lc3RhbXAgfHwgMAogICAgICB9KSkKICAgICAgY29uc3QgY2hhdHMgPSAodGhpcy5jaGF0TWVzc2FnZXMgfHwgW10pLm1hcChtID0+ICh7IC4uLm0sIHR5cGU6ICdjaGF0JyB9KSkKICAgICAgY29uc3QgbWVyZ2VkID0gWy4uLmxvZ3MsIC4uLmNoYXRzXQogICAgICByZXR1cm4gbWVyZ2VkLnNvcnQoKGEsIGIpID0+IChhLnRpbWVzdGFtcCB8fCAwKSAtIChiLnRpbWVzdGFtcCB8fCAwKSkKICAgIH0sCiAgICAvLyDmmrTpnLLlr7nor53phY3nva7kvpvmqKHmnb/kvb/nlKgKICAgIGZpcnN0TG9naW5Db25maWcoKSB7IHJldHVybiBmaXJzdExvZ2luRGlhbG9ndWVDb25maWcgfSwKICAgIC8vIOW9k+WJjeiusui/sOinkuiJsumFjee9ruS4juWQjeensAogICAgbmFycmF0aW9uQ2hhcmFjdGVyTmFtZSgpIHsgcmV0dXJuICh0aGlzLmdldEN1cnJlbnRMYW5ndWFnZSgpID09PSAnemgtQ04nKSA/ICflpKfmnKjljZrlo6snIDogJ0RyLiBBbGluYScgfSwKICAgIG5hcnJhdGlvbkNoYXJhY3RlcigpIHsKICAgICAgY29uc3Qga2V5ID0gdGhpcy5uYXJyYXRpb25DaGFyYWN0ZXJOYW1lCiAgICAgIGNvbnN0IGNoYXJzID0gZmlyc3RMb2dpbkRpYWxvZ3VlQ29uZmlnICYmIGZpcnN0TG9naW5EaWFsb2d1ZUNvbmZpZy5jaGFyYWN0ZXJzCiAgICAgIHJldHVybiAoY2hhcnMgJiYgY2hhcnNba2V5XSkgPyBjaGFyc1trZXldIDogeyBpbWFnZTogJy9pbWFnZXMvZ3VpZGUucG5nJywgcG9zaXRpb246ICdyaWdodCcsIGNvbG9yOiAnIzNiODJmNicgfQogICAgfQogIH0sCiAgYXN5bmMgbW91bnRlZCgpIHsKICAgIGNvbnN0IHJvb21JZCA9IHRoaXMuJHJvdXRlLnF1ZXJ5LnJvb21JZAogICAgaWYgKHJvb21JZCkgdGhpcy4kc3RvcmUuY29tbWl0KCdTRVRfUk9PTV9JRCcsIHJvb21JZCkKICAgIGF3YWl0IHRoaXMuaW5pdGlhbGl6ZUdhbWUoKQogICAgYXdhaXQgdGhpcy5sb2FkUm9vbVN0YXRlKCkKICAgIC8vIGxvYWRSb29tU3RhdGUg5Lit5bey57uP6LCD55So5LqGIGxvYWRBbGxQbGF5ZXJzQXJ0aWZhY3Rz77yM6L+Z6YeM56Gu5L+d5pWw5o2u5Yqg6L29CiAgICBhd2FpdCB0aGlzLnN1YnNjcmliZVJvb21SZWFsdGltZSgpCiAgfSwKICBiZWZvcmVEZXN0cm95KCkgewogICAgdGhpcy51bnN1YnNjcmliZVJvb21SZWFsdGltZSgpCiAgICBpZiAodGhpcy5yZWZyZXNoVGltZXIpIHsgY2xlYXJJbnRlcnZhbCh0aGlzLnJlZnJlc2hUaW1lcik7IHRoaXMucmVmcmVzaFRpbWVyID0gbnVsbCB9CiAgICBpZiAodGhpcy5hdWN0aW9uVGltZXIpIHsgY2xlYXJJbnRlcnZhbCh0aGlzLmF1Y3Rpb25UaW1lcik7IHRoaXMuYXVjdGlvblRpbWVyID0gbnVsbCB9CiAgICBpZiAodGhpcy50eXBpbmdUaW1lcikgeyBjbGVhckludGVydmFsKHRoaXMudHlwaW5nVGltZXIpOyB0aGlzLnR5cGluZ1RpbWVyID0gbnVsbCB9CiAgICB0aGlzLiRzZXQodGhpcywgJ2F1Y3Rpb25Db3VudGRvd24nLCAwKQogIH0sCiAgd2F0Y2g6IHsKICAgIGdhbWVMb2coKSB7CiAgICAgIHRoaXMuJG5leHRUaWNrKCgpID0+IHsKICAgICAgICBjb25zdCBjaGF0Q29udGFpbmVyID0gdGhpcy4kcmVmcy5jaGF0Q29udGFpbmVyCiAgICAgICAgaWYgKGNoYXRDb250YWluZXIpIHsgY2hhdENvbnRhaW5lci5zY3JvbGxUb3AgPSBjaGF0Q29udGFpbmVyLnNjcm9sbEhlaWdodCB9CiAgICAgIH0pCiAgICB9CiAgfSwKICBtZXRob2RzOiB7CiAgICAvLyDljrvmjonmqKHmi5/liJ3lp4vljJbnjqnlrrbvvIzmlLnkuLrkvb/nlKjmiL/pl7TnmoTlrp7pmYXnjqnlrrbliJfooagKICAgIGFzeW5jIGluaXRpYWxpemVHYW1lKCkgewogICAgICBjb25zdCBhcnRpZmFjdHMgPSBhd2FpdCB0aGlzLmxvYWRBcnRpZmFjdHMoKQogICAgICB0aGlzLmFydGlmYWN0TWFwID0gYXJ0aWZhY3RzLnJlZHVjZSgoYWNjLCBhKSA9PiB7IGFjY1thLmlkXSA9IGE7IHJldHVybiBhY2MgfSwge30pCiAgICAgIGF3YWl0IHRoaXMubG9hZENvbGxlY3Rpb25zKCkKICAgIH0sCiAgICBhc3luYyBzdWJzY3JpYmVSb29tUmVhbHRpbWUoKSB7CiAgICAgIGNvbnN0IHJpZCA9IHRoaXMuJHN0b3JlLnN0YXRlLnJvb21JZAogICAgICBpZiAoIXJpZCkgcmV0dXJuCiAgICAgIGNvbnN0IHN1cGFiYXNlID0gZ2V0U3VwYWJhc2UoKQogICAgICBjb25zdCB7IHJvb21DaGFubmVsLCBicm9hZGNhc3RDaGFubmVsIH0gPSBzdWJzY3JpYmVSb29tUmVhbHRpbWVTZXJ2aWNlKAogICAgICAgIHsgcm9vbUlkOiByaWQsIHN1cGFiYXNlLCBvbkxvYWRSb29tU3RhdGU6IHRoaXMubG9hZFJvb21TdGF0ZSB9LAogICAgICAgIHsKICAgICAgICAgIG9uR2FtZVN0YXJ0ZWQ6IGFzeW5jIChfcGF5bG9hZCkgPT4gewogICAgICAgICAgICAvLyDpmLLmraLph43lpI3lkK/liqjlpJrkuKrlgJLorqHml7YKICAgICAgICAgICAgaWYgKHRoaXMuY291bnRkb3duSW5Qcm9ncmVzcykgcmV0dXJuCiAgICAgICAgICAgIHRoaXMuY291bnRkb3duSW5Qcm9ncmVzcyA9IHRydWUKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIOaWsOWxgOW8gOWni++8mumHjee9ruiBiuWkqea2iOaBr+WSjOS7t+WAvOaVsOaNrgogICAgICAgICAgICB0aGlzLmNoYXRNZXNzYWdlcyA9IFtdCiAgICAgICAgICAgIHRoaXMuYWxsUGxheWVyc0FydGlmYWN0cyA9IHt9CiAgICAgICAgICAgIC8vIOmHjee9ruWbnuWQiOaVsAogICAgICAgICAgICB0aGlzLiRzdG9yZS5jb21taXQoJ1JFU0VUX1JPVU5EJykKICAgICAgICAgICAgdGhpcy4kc3RvcmUuY29tbWl0KCdTRVRfUk9VTkRfVE9UQUwnLCA2KQogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy4kc3RvcmUuY29tbWl0KCdTRVRfR0FNRV9QSEFTRScsICdjb3VudGRvd24nKQogICAgICAgICAgICB0aGlzLiRzZXQodGhpcywgJ2F1Y3Rpb25Db3VudGRvd24nLCA1KQogICAgICAgICAgICBjb25zdCBtZSA9ICh0aGlzLnJvb20gJiYgdGhpcy5yb29tLnJvb21fcGxheWVycyA/IHRoaXMucm9vbS5yb29tX3BsYXllcnMgOiBbXSkuZmluZChwID0+IHAudXNlcl9pZCA9PT0gdGhpcy4kc3RvcmUuc3RhdGUudXNlci5pZCkKICAgICAgICAgICAgaWYgKG1lKSB7CiAgICAgICAgICAgICAgdGhpcy4kc3RvcmUuY29tbWl0KCdTRVRfQ1VSUkVOVF9QTEFZRVInLCB7IGlkOiBtZS51c2VyX2lkLCBuYW1lOiB0aGlzLmdldE5hbWVGb3IobWUudXNlcl9pZCksIGVuZXJneTogNTAsIGFydGlmYWN0czogW10sIGl0ZW1zOiBbXSB9KQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLmF1Y3Rpb25UaW1lcikgeyBjbGVhckludGVydmFsKHRoaXMuYXVjdGlvblRpbWVyKTsgdGhpcy5hdWN0aW9uVGltZXIgPSBudWxsIH0KICAgICAgICAgICAgdGhpcy4kbmV4dFRpY2soKCkgPT4gewogICAgICAgICAgICAgIHN0YXJ0Q291bnRkb3duKHsKICAgICAgICAgICAgICAgIHNlY29uZHM6IDUsCiAgICAgICAgICAgICAgICBvblRpY2s6IChzKSA9PiB7IHRoaXMuJHNldCh0aGlzLCAnYXVjdGlvbkNvdW50ZG93bicsIHMpIH0sCiAgICAgICAgICAgICAgICBvbkRvbmU6IGFzeW5jICgpID0+IHsgdGhpcy5jb3VudGRvd25JblByb2dyZXNzID0gZmFsc2U7IGlmICh0aGlzLmlzT3duZXIpIHsgYXdhaXQgdGhpcy5hdXRvU3RhcnRBdWN0aW9uKCkgfSB9LAogICAgICAgICAgICAgICAgZ2V0UmVmOiAoKSA9PiB0aGlzLmF1Y3Rpb25UaW1lciwKICAgICAgICAgICAgICAgIHNldFJlZjogKGlkKSA9PiB7IHRoaXMuYXVjdGlvblRpbWVyID0gaWQgfSwKICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9KQogICAgICAgICAgfSwKICAgICAgICAgIG9uQXVjdGlvblN0YXJ0ZWQ6IGFzeW5jIChkdXJhdGlvbiwgcGF5bG9hZCkgPT4geyAKICAgICAgICAgICAgLy8g56Gu5L+d5omA5pyJ546p5a626YO96IO955yL5Yiw5ouN5Y2W5pWw5o2uCiAgICAgICAgICAgIGF3YWl0IHRoaXMubG9hZFJvb21TdGF0ZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyDlkIzmraXlm57lkIjmlbDvvIjlpoLmnpzlub/mkq3kuK3ljIXlkKvkuoblm57lkIjkv6Hmga/vvIkKICAgICAgICAgICAgaWYgKHBheWxvYWQgJiYgdHlwZW9mIHBheWxvYWQucm91bmRDdXJyZW50ID09PSAnbnVtYmVyJykgewogICAgICAgICAgICAgIHRoaXMuJHN0b3JlLmNvbW1pdCgnU0VUX1JPVU5EX0NVUlJFTlQnLCBwYXlsb2FkLnJvdW5kQ3VycmVudCkKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocGF5bG9hZCAmJiB0eXBlb2YgcGF5bG9hZC5yb3VuZFRvdGFsID09PSAnbnVtYmVyJykgewogICAgICAgICAgICAgIHRoaXMuJHN0b3JlLmNvbW1pdCgnU0VUX1JPVU5EX1RPVEFMJywgcGF5bG9hZC5yb3VuZFRvdGFsKQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnN0YXJ0QXVjdGlvblRpbWVyKGR1cmF0aW9uKSAKICAgICAgICAgIH0sCiAgICAgICAgICBvbkJpZFVwZGF0ZTogKHsgYXVjdGlvbklkLCBoaWdoZXN0QmlkLCBoaWdoZXN0QmlkZGVyIH0pID0+IHsKICAgICAgICAgICAgaWYgKCFhdWN0aW9uSWQpIHJldHVybgogICAgICAgICAgICBjb25zdCBsaXN0ID0gdGhpcy4kc3RvcmUuc3RhdGUuY3VycmVudEF1Y3Rpb25zIHx8IFtdCiAgICAgICAgICAgIGNvbnN0IGlkeCA9IGxpc3QuZmluZEluZGV4KGEgPT4gYS5pZCA9PT0gYXVjdGlvbklkKQogICAgICAgICAgICBpZiAoaWR4ID49IDApIHsKICAgICAgICAgICAgICBjb25zdCBuZXh0ID0geyAuLi5saXN0W2lkeF0sIGhpZ2hlc3RCaWQsIGhpZ2hlc3RCaWRkZXIgfQogICAgICAgICAgICAgIHRoaXMuJHN0b3JlLmNvbW1pdCgnQUREX09SX1VQREFURV9BVUNUSU9OJywgbmV4dCkKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIC8vIOaXp+WbnuWQiOW5v+aSreW3suenu+mZpO+8jOe7n+S4gOacrOWcsOaOqOi/m++8jOS4jeWGjeaOpeaUtuivpeS6i+S7tgogICAgICAgICAgb25Sb3VuZFVwZGF0ZWQ6IChfZGF0YSkgPT4ge30sCiAgICAgICAgICBvbkdhbWVFbmRlZDogKCkgPT4gewogICAgICAgICAgICB0aGlzLiRzdG9yZS5jb21taXQoJ1NFVF9HQU1FX1BIQVNFJywgJ3NldHRsZW1lbnQnKQogICAgICAgIHRoaXMuY29tcHV0ZUZpbmFsU2NvcmVzKCkuZmluYWxseSgoKSA9PiB7IHRoaXMuc2hvd0dhbWVFbmREaWFsb2cgPSB0cnVlIH0pCiAgICAgICAgICAgIGlmICh0aGlzLmF1Y3Rpb25UaW1lcikgeyBjbGVhckludGVydmFsKHRoaXMuYXVjdGlvblRpbWVyKTsgdGhpcy5hdWN0aW9uVGltZXIgPSBudWxsIH0KICAgICAgICAgIH0sCiAgICAgICAgICBvbkF1Y3Rpb25FbmRlZDogYXN5bmMgKCkgPT4geyBhd2FpdCB0aGlzLmxvYWRSb29tU3RhdGUoKSB9LAogICAgICAgICAgb25DaGF0TWVzc2FnZTogKG1lc3NhZ2UpID0+IHsKICAgICAgICAgICAgLy8g6YG/5YWN6YeN5aSN5re75Yqg5raI5oGvCiAgICAgICAgICAgIGlmICghbWVzc2FnZSB8fCAhbWVzc2FnZS5pZCkgcmV0dXJuCiAgICAgICAgICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5jaGF0TWVzc2FnZXMuZmluZChtID0+IG0uaWQgPT09IG1lc3NhZ2UuaWQgfHwgKG0udXNlcklkID09PSBtZXNzYWdlLnVzZXJJZCAmJiBtLnRpbWVzdGFtcCA9PT0gbWVzc2FnZS50aW1lc3RhbXAgJiYgbS5jb250ZW50ID09PSBtZXNzYWdlLmNvbnRlbnQpKQogICAgICAgICAgICBpZiAoZXhpc3RpbmcpIHJldHVybgogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5jaGF0TWVzc2FnZXMucHVzaChtZXNzYWdlKQogICAgICAgICAgICB0aGlzLiRuZXh0VGljaygoKSA9PiB7CiAgICAgICAgICAgICAgY29uc3QgY2hhdENvbnRhaW5lciA9IHRoaXMuJHJlZnMuY2hhdENvbnRhaW5lcgogICAgICAgICAgICAgIGlmIChjaGF0Q29udGFpbmVyKSB7IGNoYXRDb250YWluZXIuc2Nyb2xsVG9wID0gY2hhdENvbnRhaW5lci5zY3JvbGxIZWlnaHQgfQogICAgICAgICAgICB9KQogICAgICAgICAgfSwKICAgICAgICB9LAogICAgICAgICgpID0+IHsgaWYgKCF0aGlzLnJlZnJlc2hUaW1lcikgeyB0aGlzLnJlZnJlc2hUaW1lciA9IHNldEludGVydmFsKHRoaXMubG9hZFJvb21TdGF0ZSwgMTAwMCkgfSB9CiAgICAgICkKICAgICAgdGhpcy5yb29tQ2hhbm5lbCA9IHJvb21DaGFubmVsCiAgICAgIHRoaXMuYnJvYWRjYXN0Q2hhbm5lbCA9IGJyb2FkY2FzdENoYW5uZWwKICAgIH0sCiAgICB1bnN1YnNjcmliZVJvb21SZWFsdGltZSgpIHsKICAgICAgdW5zdWJzY3JpYmVSb29tUmVhbHRpbWVTZXJ2aWNlKHRoaXMucm9vbUNoYW5uZWwsIHRoaXMuYnJvYWRjYXN0Q2hhbm5lbCkKICAgICAgdGhpcy5yb29tQ2hhbm5lbCA9IG51bGwKICAgICAgdGhpcy5icm9hZGNhc3RDaGFubmVsID0gbnVsbAogICAgfSwKICAgIGFzeW5jIGxvYWRSb29tU3RhdGUoKSB7CiAgICAgIGNvbnN0IHJpZCA9IHRoaXMuJHN0b3JlLnN0YXRlLnJvb21JZAogICAgICBjb25zdCBzdXBhYmFzZSA9IGdldFN1cGFiYXNlKCkKICAgICAgYXdhaXQgbG9hZFJvb21TdGF0ZVNlcnZpY2UoewogICAgICAgIHJvb21JZDogcmlkLAogICAgICAgIHJvb21TZXJ2aWNlLAogICAgICAgIHN1cGFiYXNlLAogICAgICAgIGFydGlmYWN0TWFwOiB0aGlzLmFydGlmYWN0TWFwLAogICAgICAgIHN0b3JlOiB0aGlzLiRzdG9yZSwKICAgICAgICBzZXRSb29tOiAocm9vbSkgPT4geyB0aGlzLnJvb20gPSByb29tIH0sCiAgICAgICAgc2V0UHJvZmlsZU1hcDogKG1hcCkgPT4geyB0aGlzLnByb2ZpbGVNYXAgPSBtYXAgfSwKICAgICAgICBzZXRHYW1lUGhhc2U6IChwaGFzZSkgPT4geyB0aGlzLiRzdG9yZS5jb21taXQoJ1NFVF9HQU1FX1BIQVNFJywgcGhhc2UpIH0sCiAgICAgICAgY2xlYXJBdWN0aW9uVGltZXI6ICgpID0+IHsgaWYgKHRoaXMuYXVjdGlvblRpbWVyKSB7IGNsZWFySW50ZXJ2YWwodGhpcy5hdWN0aW9uVGltZXIpOyB0aGlzLmF1Y3Rpb25UaW1lciA9IG51bGwgfSB9LAogICAgICAgIHNldEF1Y3Rpb25Db3VudGRvd246IChuKSA9PiB7IHRoaXMuJHNldCh0aGlzLCAnYXVjdGlvbkNvdW50ZG93bicsIG4pIH0sCiAgICAgICAgb25TaG93R2FtZUVuZDogKCkgPT4geyB0aGlzLnNob3dHYW1lRW5kRGlhbG9nID0gdHJ1ZTsgc2V0VGltZW91dCgoKSA9PiB7IHRoaXMuaGFuZGxlR2FtZUVuZCgpIH0sIDMwMDApIH0sCiAgICAgIH0pCiAgICAgIC8vIOWKoOi9veaJgOacieeOqeWutueahOaJi+eJjOaVsOaNru+8jOeUqOS6juS7t+WAvOiuoeeulwogICAgICBhd2FpdCB0aGlzLmxvYWRBbGxQbGF5ZXJzQXJ0aWZhY3RzKCkKICAgICAgLy8g5aaC5p6c5Yi35paw5ZCO5Y+R546w5LuN5pyJ5rS76LeD5ouN5Y2W77yM5L2G5pys5Zyw5peg5YCS6K6h5pe277yM5YiZ55So5b2T5YmN5Ymp5L2Z5pe26Ze05ZCv5Yqo57uf5LiA5YCS6K6h5pe2CiAgICAgIGNvbnN0IGF1Y3Rpb25zID0gdGhpcy4kc3RvcmUuc3RhdGUuY3VycmVudEF1Y3Rpb25zIHx8IFtdCiAgICAgIGlmICh0aGlzLiRzdG9yZS5zdGF0ZS5nYW1lUGhhc2UgPT09ICdhdWN0aW9uJyAmJiBhdWN0aW9ucy5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uc3QgcmVtYWluaW5nID0gTnVtYmVyKHRoaXMuYXVjdGlvbkNvdW50ZG93biB8fCAwKQogICAgICAgIGlmICghdGhpcy5hdWN0aW9uVGltZXIgJiYgcmVtYWluaW5nID4gMCkgewogICAgICAgICAgc3RhcnRDb3VudGRvd24oewogICAgICAgICAgICBzZWNvbmRzOiByZW1haW5pbmcsCiAgICAgICAgICAgIG9uVGljazogKHMpID0+IHsgdGhpcy4kc2V0KHRoaXMsICdhdWN0aW9uQ291bnRkb3duJywgcyk7IH0sCiAgICAgICAgICAgIG9uRG9uZTogYXN5bmMgKCkgPT4geyBhd2FpdCB0aGlzLm9uQXVjdGlvblRpbWVVcCgpIH0sCiAgICAgICAgICAgIGdldFJlZjogKCkgPT4gdGhpcy5hdWN0aW9uVGltZXIsCiAgICAgICAgICAgIHNldFJlZjogKGlkKSA9PiB7IHRoaXMuYXVjdGlvblRpbWVyID0gaWQgfSwKICAgICAgICAgIH0pCiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgCiAgICAvLyDliqDovb3miYDmnInnjqnlrrbnmoTmiYvniYzmlbDmja4KICAgIGFzeW5jIGxvYWRBbGxQbGF5ZXJzQXJ0aWZhY3RzKCkgewogICAgICB0cnkgewogICAgICAgIGNvbnN0IHJpZCA9IHRoaXMuJHN0b3JlLnN0YXRlLnJvb21JZAogICAgICAgIGlmICghcmlkKSB7CiAgICAgICAgICB0aGlzLmFsbFBsYXllcnNBcnRpZmFjdHMgPSB7fQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQogICAgICAgIAogICAgICAgIGNvbnN0IHN1cGFiYXNlID0gZ2V0U3VwYWJhc2UoKQogICAgICAgIC8vIOiOt+WPluaIv+mXtOWGheaJgOacieeOqeWutueahOaJi+eJjOaVsOaNrgogICAgICAgIGNvbnN0IHsgZGF0YTogYWxsQXJ0aWZhY3RzIH0gPSBhd2FpdCBzdXBhYmFzZQogICAgICAgICAgLmZyb20oJ3Jvb21fYXJ0aWZhY3RzJykKICAgICAgICAgIC5zZWxlY3QoJ293bmVyX3VzZXJfaWQsIGFydGlmYWN0X2lkJykKICAgICAgICAgIC5lcSgncm9vbV9pZCcsIHJpZCkKICAgICAgICAKICAgICAgICAvLyDmjInnjqnlrrZJROWIhue7hAogICAgICAgIGNvbnN0IHBsYXllckFydGlmYWN0c01hcCA9IHt9CiAgICAgICAgaWYgKGFsbEFydGlmYWN0cyAmJiBhbGxBcnRpZmFjdHMubGVuZ3RoID4gMCkgewogICAgICAgICAgYWxsQXJ0aWZhY3RzLmZvckVhY2gocm93ID0+IHsKICAgICAgICAgICAgY29uc3QgdXNlcklkID0gcm93Lm93bmVyX3VzZXJfaWQKICAgICAgICAgICAgaWYgKCFwbGF5ZXJBcnRpZmFjdHNNYXBbdXNlcklkXSkgewogICAgICAgICAgICAgIHBsYXllckFydGlmYWN0c01hcFt1c2VySWRdID0gW10KICAgICAgICAgICAgfQogICAgICAgICAgICBwbGF5ZXJBcnRpZmFjdHNNYXBbdXNlcklkXS5wdXNoKHJvdy5hcnRpZmFjdF9pZCkKICAgICAgICAgIH0pCiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIOS9v+eUqCBWdWUuc2V0IOehruS/neWTjeW6lOW8j+abtOaWsAogICAgICAgIHRoaXMuJHNldCh0aGlzLCAnYWxsUGxheWVyc0FydGlmYWN0cycsIHBsYXllckFydGlmYWN0c01hcCkKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUud2FybignW2dhbWVdIGxvYWRBbGxQbGF5ZXJzQXJ0aWZhY3RzIGZhaWxlZCcsIGUpCiAgICAgICAgdGhpcy5hbGxQbGF5ZXJzQXJ0aWZhY3RzID0ge30KICAgICAgfQogICAgfSwKICAgIGFzeW5jIHRvZ2dsZVJlYWR5KCkgewogICAgICB0cnkgewogICAgICAgIGNvbnN0IHJpZCA9IHRoaXMuJHN0b3JlLnN0YXRlLnJvb21JZAogICAgICAgIGNvbnN0IHVpZCA9IHRoaXMuJHN0b3JlLnN0YXRlLnVzZXIgJiYgdGhpcy4kc3RvcmUuc3RhdGUudXNlci5pZAogICAgICAgIGlmICghcmlkIHx8ICF1aWQpIHJldHVybgogICAgICAgIGF3YWl0IHRvZ2dsZVJlYWR5QWN0aW9uKHsgcm9vbUlkOiByaWQsIHVzZXJJZDogdWlkLCByb29tOiB0aGlzLnJvb20sIHJvb21TZXJ2aWNlLCByZWxvYWQ6IHRoaXMubG9hZFJvb21TdGF0ZSB9KQogICAgICB9IGNhdGNoIChlKSB7IGNvbnNvbGUud2FybignW2dhbWVdIHRvZ2dsZVJlYWR5IGZhaWxlZCcsIGUpIH0KICAgIH0sCiAgICBhc3luYyBtb3ZlVG9TZWF0KGlkeCkgewogICAgICB0cnkgewogICAgICAgIGNvbnN0IHJpZCA9IHRoaXMuJHN0b3JlLnN0YXRlLnJvb21JZAogICAgICAgIGNvbnN0IHVpZCA9IHRoaXMuJHN0b3JlLnN0YXRlLnVzZXIgJiYgdGhpcy4kc3RvcmUuc3RhdGUudXNlci5pZAogICAgICAgIGlmICghcmlkIHx8ICF1aWQpIHJldHVybgogICAgICAgIGNvbnN0IHRhcmdldFNlYXQgPSB7IGluZGV4OiBpZHgsIHBsYXllcjogdGhpcy5zZWF0c1tpZHhdICYmIHRoaXMuc2VhdHNbaWR4XS5wbGF5ZXIgfQogICAgICAgIGF3YWl0IG1vdmVUb1NlYXRBY3Rpb24oeyByb29tSWQ6IHJpZCwgdXNlcklkOiB1aWQsIHJvb206IHRoaXMucm9vbSwgc2VhdHM6IHRhcmdldFNlYXQsIHJvb21TZXJ2aWNlLCByZWxvYWQ6IHRoaXMubG9hZFJvb21TdGF0ZSB9KQogICAgICB9IGNhdGNoIChlKSB7IGNvbnNvbGUud2FybignW2dhbWVdIG1vdmVUb1NlYXQgZmFpbGVkJywgZSkgfQogICAgfSwKICAgIGFzeW5jIGxlYXZlUm9vbSgpIHsKICAgICAgdHJ5IHsKICAgICAgICBjb25zdCByaWQgPSB0aGlzLiRzdG9yZS5zdGF0ZS5yb29tSWQKICAgICAgICBjb25zdCB1aWQgPSB0aGlzLiRzdG9yZS5zdGF0ZS51c2VyICYmIHRoaXMuJHN0b3JlLnN0YXRlLnVzZXIuaWQKICAgICAgICBpZiAoIXJpZCB8fCAhdWlkKSByZXR1cm4KICAgICAgICBhd2FpdCBsZWF2ZVJvb21BY3Rpb24oewogICAgICAgICAgcm9vbUlkOiByaWQsCiAgICAgICAgICB1c2VySWQ6IHVpZCwKICAgICAgICAgIGNsZWFyQXVjdGlvblRpbWVyOiAoKSA9PiB7IGlmICh0aGlzLmF1Y3Rpb25UaW1lcikgeyBjbGVhckludGVydmFsKHRoaXMuYXVjdGlvblRpbWVyKTsgdGhpcy5hdWN0aW9uVGltZXIgPSBudWxsIH0gfSwKICAgICAgICAgIHNldENvdW50ZG93bjogKG4pID0+IHsgdGhpcy4kc2V0KHRoaXMsICdhdWN0aW9uQ291bnRkb3duJywgbikgfSwKICAgICAgICAgIHN0b3JlOiB0aGlzLiRzdG9yZSwKICAgICAgICAgIGF1Y3Rpb25TZXJ2aWNlLAogICAgICAgICAgcm9vbVNlcnZpY2UsCiAgICAgICAgICB1bnN1YnNjcmliZTogKCkgPT4gdGhpcy51bnN1YnNjcmliZVJvb21SZWFsdGltZSgpLAogICAgICAgICAgc2V0Um9vbUlkOiAodikgPT4gdGhpcy4kc3RvcmUuY29tbWl0KCdTRVRfUk9PTV9JRCcsIHYpLAogICAgICAgICAgc2V0TG9jYWxSb29tOiAodikgPT4geyB0aGlzLnJvb20gPSB2IH0sCiAgICAgICAgICBuYXZpZ2F0ZVRvUm9vbXM6ICgpID0+IHRoaXMuJHJvdXRlci5wdXNoKCcvcm9vbXMnKSwKICAgICAgICB9KQogICAgICB9IGNhdGNoIChlKSB7IGNvbnNvbGUud2FybignW2dhbWVdIGxlYXZlUm9vbSBmYWlsZWQnLCBlKSB9CiAgICB9LAogICAgCiAgICAvLyDmuLjmiI/nu5PmnZ/lpITnkIYKICAgIGFzeW5jIGhhbmRsZUdhbWVFbmQoKSB7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgcmlkID0gdGhpcy4kc3RvcmUuc3RhdGUucm9vbUlkCiAgICAgICAgaWYgKHJpZCkgewogICAgICAgICAgLy8g5bCG5oi/6Ze054q25oCB6YeN572u5Li6IHdhaXRpbmfvvIzkvr/kuo7nu6fnu63miL/pl7TlhoXlh4blpIcv5paw5LiA5bGACiAgICAgICAgICBjb25zdCBzdXBhYmFzZSA9IGdldFN1cGFiYXNlKCkKICAgICAgICAgIGF3YWl0IHN1cGFiYXNlLmZyb20oJ3Jvb21zJykudXBkYXRlKHsgc3RhdHVzOiAnd2FpdGluZycgfSkuZXEoJ2lkJywgcmlkKQogICAgICAgICAgLy8g6Lez6L2s5Zue5oi/6Ze06aG16Z2i77yI5ri45oiP6aG15pC65bimIHJvb21JZCDljbPmmK/miL/pl7TnlYzpnaLvvIkKICAgICAgICAgIHRoaXMuJHJvdXRlci5wdXNoKHsgcGF0aDogJy9nYW1lJywgcXVlcnk6IHsgcm9vbUlkOiByaWQsIGdhbWVFbmRlZDogJ3RydWUnIH0gfSkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy4kcm91dGVyLnB1c2goJy9yb29tcycpCiAgICAgICAgfQogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS53YXJuKCdbZ2FtZV0gaGFuZGxlR2FtZUVuZCBmYWlsZWQnLCBlKQogICAgICAgIC8vIOWFnOW6lei3s+WbnuaIv+mXtOWIl+ihqAogICAgICAgIHRoaXMuJHJvdXRlci5wdXNoKCcvcm9vbXMnKQogICAgICB9CiAgICB9LAogICAgYXN5bmMgc3RhcnRHYW1lKCkgewogICAgICB0cnkgewogICAgICAgIGNvbnN0IHJpZCA9IHRoaXMuJHN0b3JlLnN0YXRlLnJvb21JZAogICAgICAgIGNvbnN0IHVpZCA9IHRoaXMuJHN0b3JlLnN0YXRlLnVzZXIgJiYgdGhpcy4kc3RvcmUuc3RhdGUudXNlci5pZAogICAgICAgIGlmICghcmlkIHx8ICF1aWQgfHwgIXRoaXMuaXNPd25lciB8fCAhdGhpcy5hbGxSZWFkeSkgcmV0dXJuCiAgICAgICAgLy8g5paw5bGA5byA5aeL5YmN6YeN572u57O757uf5pel5b+X44CB6IGK5aSp5raI5oGv5ZKM5Lu35YC85pWw5o2uCiAgICAgICAgdHJ5IHsgdGhpcy4kc3RvcmUuY29tbWl0KCdDTEVBUl9HQU1FX0xPRycpIH0gY2F0Y2ggKF8pIHt9CiAgICAgICAgdGhpcy5jaGF0TWVzc2FnZXMgPSBbXQogICAgICAgIHRoaXMuYWxsUGxheWVyc0FydGlmYWN0cyA9IHt9CiAgICAgICAgYXdhaXQgcm9vbVNlcnZpY2Uuc3RhcnRHYW1lKHJpZCwgdWlkKQogICAgICAgIGNvbnN0IHN1cGFiYXNlID0gZ2V0U3VwYWJhc2UoKQogICAgICAgIHRoaXMucm91bmRDb3VudCA9IDAKICAgICAgICBhd2FpdCBzdGFydEdhbWVGbG93KHsKICAgICAgICAgIHJvb21JZDogcmlkLAogICAgICAgICAgdXNlcklkOiB1aWQsCiAgICAgICAgICBpc093bmVyOiB0aGlzLmlzT3duZXIsCiAgICAgICAgICBhbGxSZWFkeTogdGhpcy5hbGxSZWFkeSwKICAgICAgICAgIHN0b3JlOiB0aGlzLiRzdG9yZSwKICAgICAgICAgIHN1cGFiYXNlLAogICAgICAgICAgc2V0Q291bnRkb3duOiAobikgPT4gdGhpcy4kc2V0KHRoaXMsICdhdWN0aW9uQ291bnRkb3duJywgbiksCiAgICAgICAgICBzZXRDdXJyZW50UGxheWVyRnJvbVJvb206ICgpID0+IHsKICAgICAgICAgICAgY29uc3QgbWUgPSAodGhpcy5yb29tICYmIHRoaXMucm9vbS5yb29tX3BsYXllcnMgPyB0aGlzLnJvb20ucm9vbV9wbGF5ZXJzIDogW10pLmZpbmQocCA9PiBwLnVzZXJfaWQgPT09IHVpZCkKICAgICAgICAgICAgaWYgKG1lKSB7IHRoaXMuJHN0b3JlLmNvbW1pdCgnU0VUX0NVUlJFTlRfUExBWUVSJywgeyBpZDogbWUudXNlcl9pZCwgbmFtZTogdGhpcy5nZXROYW1lRm9yKG1lLnVzZXJfaWQpLCBlbmVyZ3k6IDUwLCBhcnRpZmFjdHM6IFtdLCBpdGVtczogW10gfSkgfQogICAgICAgICAgfSwKICAgICAgICAgIG9uQ291bnRkb3duRG9uZTogYXN5bmMgKCkgPT4gewogICAgICAgICAgICBpZiAodGhpcy5pc093bmVyKSB7IGF3YWl0IHRoaXMuYXV0b1N0YXJ0QXVjdGlvbigpIH0KICAgICAgICAgIH0sCiAgICAgICAgfSkKICAgICAgICAvLyDmiL/kuLvmnKzlnLDkuZ/lkK/liqjpooTlgJLorqHml7bvvIzpmLLmraLlub/mkq3kuI3lm57kvKDlr7zoh7TkuI3op6blj5Egb25HYW1lU3RhcnRlZAogICAgICAgIGlmICghdGhpcy5jb3VudGRvd25JblByb2dyZXNzKSB7CiAgICAgICAgICB0aGlzLmNvdW50ZG93bkluUHJvZ3Jlc3MgPSB0cnVlCiAgICAgICAgICAvLyDnoa7kv53mnKzlnLDkuZ/ph43nva7mlbDmja4KICAgICAgICAgIHRoaXMuY2hhdE1lc3NhZ2VzID0gW10KICAgICAgICAgIHRoaXMuYWxsUGxheWVyc0FydGlmYWN0cyA9IHt9CiAgICAgICAgICB0aGlzLiRzdG9yZS5jb21taXQoJ1NFVF9HQU1FX1BIQVNFJywgJ2NvdW50ZG93bicpCiAgICAgICAgICB0aGlzLiRzZXQodGhpcywgJ2F1Y3Rpb25Db3VudGRvd24nLCA1KQogICAgICAgICAgY29uc3QgbWUgPSAodGhpcy5yb29tICYmIHRoaXMucm9vbS5yb29tX3BsYXllcnMgPyB0aGlzLnJvb20ucm9vbV9wbGF5ZXJzIDogW10pLmZpbmQocCA9PiBwLnVzZXJfaWQgPT09IHVpZCkKICAgICAgICAgIGlmIChtZSkgewogICAgICAgICAgICB0aGlzLiRzdG9yZS5jb21taXQoJ1NFVF9DVVJSRU5UX1BMQVlFUicsIHsgaWQ6IG1lLnVzZXJfaWQsIG5hbWU6IHRoaXMuZ2V0TmFtZUZvcihtZS51c2VyX2lkKSwgZW5lcmd5OiA1MCwgYXJ0aWZhY3RzOiBbXSwgaXRlbXM6IFtdIH0pCiAgICAgICAgICB9CiAgICAgICAgICBpZiAodGhpcy5hdWN0aW9uVGltZXIpIHsgY2xlYXJJbnRlcnZhbCh0aGlzLmF1Y3Rpb25UaW1lcik7IHRoaXMuYXVjdGlvblRpbWVyID0gbnVsbCB9CiAgICAgICAgICB0aGlzLiRuZXh0VGljaygoKSA9PiB7CiAgICAgICAgICAgIHN0YXJ0Q291bnRkb3duKHsKICAgICAgICAgICAgICBzZWNvbmRzOiA1LAogICAgICAgICAgICAgIG9uVGljazogKHMpID0+IHsgdGhpcy4kc2V0KHRoaXMsICdhdWN0aW9uQ291bnRkb3duJywgcykgfSwKICAgICAgICAgICAgICBvbkRvbmU6IGFzeW5jICgpID0+IHsgdGhpcy5jb3VudGRvd25JblByb2dyZXNzID0gZmFsc2U7IGlmICh0aGlzLmlzT3duZXIpIHsgYXdhaXQgdGhpcy5hdXRvU3RhcnRBdWN0aW9uKCkgfSB9LAogICAgICAgICAgICAgIGdldFJlZjogKCkgPT4gdGhpcy5hdWN0aW9uVGltZXIsCiAgICAgICAgICAgICAgc2V0UmVmOiAoaWQpID0+IHsgdGhpcy5hdWN0aW9uVGltZXIgPSBpZCB9LAogICAgICAgICAgICB9KQogICAgICAgICAgfSkKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGUpIHsgY29uc29sZS53YXJuKCdbZ2FtZV0gc3RhcnRHYW1lIGZhaWxlZCcsIGUpIH0KICAgIH0sCiAgICAKICAgIGFzeW5jIHN0YXJ0QXVjdGlvbigpIHsKICAgICAgLy8g5ZCM5pe25oq95Y+W5aSa5Lu26L+b6KGM5ouN5Y2W77yI56S65L6L5Li6MuS7tu+8iQogICAgICBjb25zdCBhcnRpZmFjdHMgPSBhd2FpdCB0aGlzLmxvYWRBcnRpZmFjdHMoKQogICAgICBpZiAoYXJ0aWZhY3RzLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25zdCBwaWNrcyA9IFtdCiAgICAgICAgd2hpbGUgKHBpY2tzLmxlbmd0aCA8IE1hdGgubWluKDIsIGFydGlmYWN0cy5sZW5ndGgpKSB7CiAgICAgICAgICBjb25zdCBjYW5kaWRhdGUgPSBhcnRpZmFjdHNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogYXJ0aWZhY3RzLmxlbmd0aCldCiAgICAgICAgICBpZiAoIXBpY2tzLmZpbmQocCA9PiBwLmlkID09PSBjYW5kaWRhdGUuaWQpKSBwaWNrcy5wdXNoKGNhbmRpZGF0ZSkKICAgICAgICB9CiAgICAgICAgZm9yIChjb25zdCBhcnQgb2YgcGlja3MpIHsKICAgICAgICAgIGF3YWl0IHRoaXMuJHN0b3JlLmRpc3BhdGNoKCdzdGFydEF1Y3Rpb24nLCBhcnQpCiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgCiAgICBhc3luYyBsb2FkQXJ0aWZhY3RzKCkgewogICAgICB0cnkgewogICAgICAgIGNvbnN0IHN1cGFiYXNlID0gZ2V0U3VwYWJhc2UoKQogICAgICAgIHJldHVybiBhd2FpdCBsb2FkQXJ0aWZhY3RzU2VydmljZSh7IHN1cGFiYXNlIH0pCiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7IGNvbnNvbGUuZXJyb3IoJ+WKoOi9veWNoeeJjOaVsOaNruWksei0pTonLCBlcnJvcik7IHJldHVybiBbXSB9CiAgICB9LAogICAgCiAgICBzaG93QXJ0aWZhY3REZXRhaWwoYXJ0aWZhY3RJZCkgewogICAgICAvLyDoi6Xlt7LliqDovb1hcnRpZmFjdE1hcO+8jOWImeS8mOWFiOWxleekuuecn+WunuaVsOaNrgogICAgICBjb25zdCBhcnRpZmFjdCA9IHRoaXMuYXJ0aWZhY3RNYXBbYXJ0aWZhY3RJZF0KICAgICAgaWYgKGFydGlmYWN0KSB7CiAgICAgICAgdGhpcy5zZWxlY3RlZENhcmQgPSBhcnRpZmFjdAogICAgICB9IGVsc2UgewogICAgICAgIC8vIOWbnumAgO+8mue7tOaMgeWOn+ekuuS+iwogICAgICAgIHRoaXMuc2VsZWN0ZWRDYXJkID0gewogICAgICAgICAgaWQ6IGFydGlmYWN0SWQsCiAgICAgICAgICBuYW1lOiAn56S65L6L5aWH54mpJywKICAgICAgICAgIGVyYTogJ+WPpOS7oycsCiAgICAgICAgICBsb2NhdGlvbjogJ+acquefpScsCiAgICAgICAgICBzdG9yeTogJ+i/meaYr+S4gOS4quelnuenmOeahOWlh+eJqS4uLicsCiAgICAgICAgICBjb2xsZWN0aW9uVGFnczogWyfoibrmnK/nkbDlrp0nXSwKICAgICAgICAgIGJhc2VWYWx1ZTogOCwKICAgICAgICAgIGltYWdlOiAnaHR0cHM6Ly92aWEucGxhY2Vob2xkZXIuY29tLzMwMHgyMDA/dGV4dD3npLrkvovlpYfniaknCiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuJHN0b3JlLmNvbW1pdCgnU0VUX1NIT1dfQ0FSRF9ERVRBSUwnLCB0cnVlKQogICAgfSwKICAgIAogICAgaGlkZUNhcmREZXRhaWwoKSB7CiAgICAgIHRoaXMuJHN0b3JlLmNvbW1pdCgnU0VUX1NIT1dfQ0FSRF9ERVRBSUwnLCBmYWxzZSkKICAgICAgdGhpcy5zZWxlY3RlZENhcmQgPSBudWxsCiAgICB9LAogICAgc2hvd0FydGlmYWN0RGV0YWlsRnJvbUF1Y3Rpb24oYXJ0aWZhY3QpIHsKICAgICAgdGhpcy5zZWxlY3RlZENhcmQgPSBhcnRpZmFjdAogICAgICB0aGlzLiRzdG9yZS5jb21taXQoJ1NFVF9TSE9XX0NBUkRfREVUQUlMJywgZmFsc2UpCiAgICAgIHRoaXMub3Blbk5hcnJhdGlvbigpCiAgICB9LAogICAgLy8g6K6h566X546p5a625oC75Lu35YC877yI5pSv5oyB5omA5pyJ546p5a6277yJCiAgICBnZXRQbGF5ZXJUb3RhbFZhbHVlKHVzZXJJZCkgewogICAgICBpZiAoIXVzZXJJZCkgcmV0dXJuIDAKICAgICAgCiAgICAgIC8vIOS8mOWFiOS7jiBhbGxQbGF5ZXJzQXJ0aWZhY3RzIOiOt+WPluaJgOacieeOqeWutueahOaJi+eJjOaVsOaNrgogICAgICBsZXQgb3duZWQgPSBbXQogICAgICBpZiAodGhpcy5hbGxQbGF5ZXJzQXJ0aWZhY3RzICYmIHRoaXMuYWxsUGxheWVyc0FydGlmYWN0c1t1c2VySWRdKSB7CiAgICAgICAgb3duZWQgPSBBcnJheS5pc0FycmF5KHRoaXMuYWxsUGxheWVyc0FydGlmYWN0c1t1c2VySWRdKSA/IHRoaXMuYWxsUGxheWVyc0FydGlmYWN0c1t1c2VySWRdIDogW10KICAgICAgfSBlbHNlIHsKICAgICAgICAvLyDlm57pgIDvvJrlpoLmnpwgYWxsUGxheWVyc0FydGlmYWN0cyDkuK3msqHmnInvvIzlsJ3or5Xku47lvZPliY3njqnlrrbmlbDmja7ojrflj5YKICAgICAgICBjb25zdCBjdXJyZW50ID0gdGhpcy4kc3RvcmUuc3RhdGUuY3VycmVudFBsYXllcgogICAgICAgIGlmIChjdXJyZW50ICYmIGN1cnJlbnQuaWQgPT09IHVzZXJJZCkgewogICAgICAgICAgb3duZWQgPSBBcnJheS5pc0FycmF5KHRoaXMuJHN0b3JlLnN0YXRlLnBsYXllckFydGlmYWN0cykgPyB0aGlzLiRzdG9yZS5zdGF0ZS5wbGF5ZXJBcnRpZmFjdHMgOiBbXQogICAgICAgIH0KICAgICAgfQogICAgICAKICAgICAgaWYgKCFvd25lZCB8fCBvd25lZC5sZW5ndGggPT09IDApIHJldHVybiAwCiAgICAgIAogICAgICAvLyDnoa7kv50gYXJ0aWZhY3RNYXAg5bey5Yqg6L29CiAgICAgIGlmICghdGhpcy5hcnRpZmFjdE1hcCB8fCBPYmplY3Qua2V5cyh0aGlzLmFydGlmYWN0TWFwKS5sZW5ndGggPT09IDApIHJldHVybiAwCiAgICAgIAogICAgICBsZXQgdG90YWwgPSAwCiAgICAgIG93bmVkLmZvckVhY2goYWlkID0+IHsKICAgICAgICBjb25zdCBhID0gdGhpcy5hcnRpZmFjdE1hcFthaWRdCiAgICAgICAgaWYgKGEgJiYgdHlwZW9mIGEuYmFzZVZhbHVlID09PSAnbnVtYmVyJykgewogICAgICAgICAgdG90YWwgKz0gYS5iYXNlVmFsdWUKICAgICAgICB9CiAgICAgIH0pCiAgICAgIHJldHVybiB0b3RhbAogICAgfSwKCiAgICBzaG93UGxheWVySGFuZChwbGF5ZXIpIHsKICAgICAgLy8g5p6E6YCg546p5a625a+56LGh77yM5YyF5ZCr5omL54mM5L+h5oGvCiAgICAgIGNvbnN0IHBsYXllckRhdGEgPSB7CiAgICAgICAgaWQ6IHBsYXllci51c2VyX2lkLAogICAgICAgIG5hbWU6IHRoaXMuZ2V0TmFtZUZvcihwbGF5ZXIudXNlcl9pZCksCiAgICAgICAgYXJ0aWZhY3RzOiB0aGlzLmN1cnJlbnRQbGF5ZXIgJiYgdGhpcy5jdXJyZW50UGxheWVyLmlkID09PSBwbGF5ZXIudXNlcl9pZCA/IAogICAgICAgICAgKHRoaXMuY3VycmVudFBsYXllci5hcnRpZmFjdHMgfHwgW10pIDogW10KICAgICAgfQogICAgICB0aGlzLmhhbmRQbGF5ZXIgPSBwbGF5ZXJEYXRhCiAgICAgIHRoaXMuc2hvd0hhbmRQb3B1cCA9IHRydWUKICAgIH0sCgogICAgaGlkZUhhbmQoKSB7CiAgICAgIHRoaXMuaGFuZFBsYXllciA9IG51bGwKICAgICAgdGhpcy5zaG93SGFuZFBvcHVwID0gZmFsc2UKICAgIH0sCiAgICAKICAgIAogICAgZ2V0QXZhdGFyRm9yKHVzZXJJZCkgeyByZXR1cm4gZ2V0QXZhdGFyRm9ySGVscGVyKHsgcHJvZmlsZU1hcDogdGhpcy5wcm9maWxlTWFwLCB1c2VySWQgfSkgfSwKICAgIGdldE5hbWVGb3IodXNlcklkKSB7IHJldHVybiBnZXROYW1lRm9ySGVscGVyKHsgcHJvZmlsZU1hcDogdGhpcy5wcm9maWxlTWFwLCByb29tOiB0aGlzLnJvb20sIHVzZXJJZCB9KSB9LAogICAgZ2V0Q3VycmVudExhbmd1YWdlKCkgeyByZXR1cm4gZ2V0Q3VycmVudExhbmd1YWdlSW1wb3J0ZWQoKSB9LAogICAgCiAgICAvLyDliqDovb3mlLbol4/pm4bmlbDmja7vvJrln7rkuo7mlbDmja7lupMgYXJ0aWZhY3RzIOeahCBjb2xsZWN0aW9uX3RhZ3Mg5Yqo5oCB55Sf5oiQCiAgICBhc3luYyBsb2FkQ29sbGVjdGlvbnMoKSB7CiAgICAgIHRyeSB7IHRoaXMuY29sbGVjdGlvbnMgPSBsb2FkQ29sbGVjdGlvbnNGcm9tQXJ0aWZhY3RzKHRoaXMuYXJ0aWZhY3RNYXApIH0KICAgICAgY2F0Y2ggKGVycm9yKSB7IGNvbnNvbGUuZXJyb3IoJ+WKoOi9veaUtuiXj+mbhuaVsOaNruWksei0pTonLCBlcnJvcik7IHRoaXMuY29sbGVjdGlvbnMgPSBbXSB9CiAgICB9LAogICAgCiAgIAogICAgCiAgICAvLyDojrflj5blvZPliY3mlLbol4/pm4bmlbDph4/vvIjln7rkuo7lvZPliY3nlKjmiLfmiYvniYzvvIzkuJTlj5fmnIDlpKfopoHmsYLmlbDkuIrpmZDpmZDliLbvvIkKICAgIGdldEN1cnJlbnRDb2xsZWN0aW9uQ291bnQoY29sbGVjdGlvbikgewogICAgICBjb25zdCBvd25lZCA9ICh0aGlzLmN1cnJlbnRQbGF5ZXIgJiYgdGhpcy5jdXJyZW50UGxheWVyLmFydGlmYWN0cykgPyB0aGlzLmN1cnJlbnRQbGF5ZXIuYXJ0aWZhY3RzIDogW10KICAgICAgcmV0dXJuIGdldENvbGxlY3Rpb25Db3VudFV0aWwoeyBhcnRpZmFjdE1hcDogdGhpcy5hcnRpZmFjdE1hcCwgb3duZWRBcnRpZmFjdElkczogb3duZWQsIGNvbGxlY3Rpb24gfSkKICAgIH0sCgoKICAgIC8vIOWxleW8gC/mlLbotbfmlLbol4/pm4YKICAgIHRvZ2dsZUNvbGxlY3Rpb24oY29sbGVjdGlvbikgewogICAgICBjb25zdCBpZCA9IGNvbGxlY3Rpb24gJiYgY29sbGVjdGlvbi5pZAogICAgICBpZiAoIWlkKSByZXR1cm4KICAgICAgdGhpcy4kc2V0KHRoaXMuZXhwYW5kZWRDb2xsZWN0aW9ucywgaWQsICF0aGlzLmV4cGFuZGVkQ29sbGVjdGlvbnNbaWRdKQogICAgfSwKICAgIAogICAgLy8g5YWz6Zet5ri45oiP57uT5p2f5a+56K+d5qGGCiAgICBjbG9zZUdhbWVFbmREaWFsb2coKSB7CiAgICAgIHRoaXMuc2hvd0dhbWVFbmREaWFsb2cgPSBmYWxzZQogICAgfSwKICAgIAogICAgLy8g55WZ5Zyo5oi/6Ze0CiAgICBzdGF5SW5Sb29tKCkgewogICAgICB0aGlzLnNob3dHYW1lRW5kRGlhbG9nID0gZmFsc2UKICAgICAgdHJ5IHsgdGhpcy4kc3RvcmUuY29tbWl0KCdDTEVBUl9HQU1FX0xPRycpIH0gY2F0Y2ggKF8pIHt9CiAgICAgIC8vIOi/lOWbnuW9k+WJjeaIv+mXtOWHhuWkh+eVjOmdogogICAgICBjb25zdCByaWQgPSB0aGlzLiRzdG9yZS5zdGF0ZS5yb29tSWQKICAgICAgaWYgKHJpZCkgewogICAgICAgIHRoaXMuJHN0b3JlLmNvbW1pdCgnU0VUX0dBTUVfUEhBU0UnLCAncHJlcGFyYXRpb24nKQogICAgICAgIHRoaXMuJHJvdXRlci5wdXNoKHsgcGF0aDogJy9nYW1lJywgcXVlcnk6IHsgcm9vbUlkOiByaWQgfSB9KQogICAgICB9CiAgICB9LAogICAgCiAgICAvLyDov5Tlm57miL/pl7TliJfooagKICAgIGdvVG9Sb29tcygpIHsKICAgICAgdGhpcy5zaG93R2FtZUVuZERpYWxvZyA9IGZhbHNlCiAgICAgIHRoaXMudW5zdWJzY3JpYmVSb29tUmVhbHRpbWUoKQogICAgICB0cnkgeyB0aGlzLiRzdG9yZS5jb21taXQoJ0NMRUFSX0dBTUVfTE9HJykgfSBjYXRjaCAoXykge30KICAgICAgLy8g6L+U5Zue5b2T5YmN5oi/6Ze05YeG5aSH55WM6Z2i77yI5pu056ym5ZCI5pyf5pyb77yJCiAgICAgIGNvbnN0IHJpZCA9IHRoaXMuJHN0b3JlLnN0YXRlLnJvb21JZAogICAgICBpZiAocmlkKSB7CiAgICAgICAgdGhpcy4kc3RvcmUuY29tbWl0KCdTRVRfR0FNRV9QSEFTRScsICdwcmVwYXJhdGlvbicpCiAgICAgICAgdGhpcy4kcm91dGVyLnB1c2goeyBwYXRoOiAnL2dhbWUnLCBxdWVyeTogeyByb29tSWQ6IHJpZCB9IH0pCiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy4kcm91dGVyLnB1c2goJy9yb29tcycpCiAgICAgIH0KICAgIH0sCiAgICAKICAgIC8vIOaXtumXtOWIsO+8mue7k+adn+W9k+WJjeaJgOacieaLjeWNluW5tue7k+eul+WIsOWvueW6lOeOqeWutuaJi+eJjO+8jOeEtuWQjui/m+WFpTEwc+mXtOath+aIlue7k+adn+a4uOaIjwogICAgYXN5bmMgb25BdWN0aW9uVGltZVVwKCkgewogICAgICB0cnkgewogICAgICAgIGNvbnN0IGF1Y3Rpb25zID0gdGhpcy4kc3RvcmUuc3RhdGUuY3VycmVudEF1Y3Rpb25zIHx8IFtdCiAgICAgICAgLy8g57uf5LiA5YCS6K6h5pe257uT5p2f77ya57uT5p2f5omA5pyJ5b2T5YmN5ouN5Y2WCiAgICAgICAgZm9yIChjb25zdCBhIG9mIGF1Y3Rpb25zKSB7CiAgICAgICAgICBhd2FpdCB0aGlzLiRzdG9yZS5kaXNwYXRjaCgnZW5kQXVjdGlvbicsIGEuaWQpCiAgICAgICAgfQogICAgICAgIC8vIOWIpOaWreaYr+WQpui+vuWIsOaAu+WbnuWQiOaVsAogICAgICAgIGNvbnN0IGN1ciA9IE51bWJlcih0aGlzLiRzdG9yZS5zdGF0ZS5yb3VuZEN1cnJlbnQgfHwgMCkKICAgICAgICBjb25zdCB0b3QgPSBOdW1iZXIodGhpcy4kc3RvcmUuc3RhdGUucm91bmRUb3RhbCB8fCA2KQogICAgICAgIGlmIChjdXIgPj0gdG90KSB7CiAgICAgICAgICAvLyDop6blj5Hnu5PmnZ8KICAgICAgICAgIHRoaXMuJHN0b3JlLmNvbW1pdCgnU0VUX0dBTUVfUEhBU0UnLCAnc2V0dGxlbWVudCcpCiAgICAgICAgICBhd2FpdCB0aGlzLmNvbXB1dGVGaW5hbFNjb3JlcygpCiAgICAgICAgICB0aGlzLnNob3dHYW1lRW5kRGlhbG9nID0gdHJ1ZQogICAgICAgICAgcmV0dXJuCiAgICAgICAgfQogICAgICAgIC8vIOWQpuWImei/m+WFpTEwc+mXtOath+mYtuautQogICAgICAgIHRoaXMuc3RhcnRJbnRlcm1pc3Npb25UaW1lcigxMCkKICAgICAgfSBjYXRjaCAoZSkgeyBjb25zb2xlLndhcm4oJ1tnYW1lXSBvbkF1Y3Rpb25UaW1lVXAgZmFpbGVkJywgZSkgfQogICAgfSwKCiAgICAvLyDlvIDlp4vmi43ljZblgJLorqHml7bvvJrnu5/kuIDmr4/ova7mi43ljZblj6rmnInkuIDkuKrlgJLorqHml7YKICAgIHN0YXJ0QXVjdGlvblRpbWVyKGR1cmF0aW9uID0gMzApIHsKICAgICAgdGhpcy4kc3RvcmUuY29tbWl0KCdTRVRfR0FNRV9QSEFTRScsICdhdWN0aW9uJykKICAgICAgc3RhcnRDb3VudGRvd24oewogICAgICAgIHNlY29uZHM6IGR1cmF0aW9uLAogICAgICAgIG9uVGljazogKHMpID0+IHsgdGhpcy4kc2V0KHRoaXMsICdhdWN0aW9uQ291bnRkb3duJywgcyk7IH0sCiAgICAgICAgb25Eb25lOiBhc3luYyAoKSA9PiB7IGF3YWl0IHRoaXMub25BdWN0aW9uVGltZVVwKCkgfSwKICAgICAgICBnZXRSZWY6ICgpID0+IHRoaXMuYXVjdGlvblRpbWVyLAogICAgICAgIHNldFJlZjogKGlkKSA9PiB7IHRoaXMuYXVjdGlvblRpbWVyID0gaWQgfSwKICAgICAgfSkKICAgIH0sCgoKICAgIAogICAgLy8g5q+P6L2u5LmL6Ze055qE6Ze05q2H6K6h5pe25Zmo77yM57uT5p2f5ZCO6Ieq5Yqo5byA5aeL5LiL5LiA6L2u5ouN5Y2WCiAgICBzdGFydEludGVybWlzc2lvblRpbWVyKGR1cmF0aW9uID0gMTApIHsKICAgICAgdGhpcy4kc3RvcmUuY29tbWl0KCdTRVRfR0FNRV9QSEFTRScsICdpbnRlcm1pc3Npb24nKQogICAgICBzdGFydENvdW50ZG93bih7CiAgICAgICAgc2Vjb25kczogZHVyYXRpb24sCiAgICAgICAgb25UaWNrOiAocykgPT4geyB0aGlzLiRzZXQodGhpcywgJ2F1Y3Rpb25Db3VudGRvd24nLCBzKTsgfSwKICAgICAgICBvbkRvbmU6IGFzeW5jICgpID0+IHsKICAgICAgICAgIGlmICh0aGlzLmlzT3duZXIpIHsKICAgICAgICAgICAgYXdhaXQgdGhpcy5hdXRvU3RhcnRBdWN0aW9uKCkKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGdldFJlZjogKCkgPT4gdGhpcy5hdWN0aW9uVGltZXIsCiAgICAgICAgc2V0UmVmOiAoaWQpID0+IHsgdGhpcy5hdWN0aW9uVGltZXIgPSBpZCB9LAogICAgICB9KQogICAgfSwKICAgIAogICAgLy8g6Ieq5Yqo5byA5aeL5ouN5Y2WCiAgICBhc3luYyBhdXRvU3RhcnRBdWN0aW9uKCkgewogICAgICB0cnkgewogICAgICAgIGNvbnN0IHJpZCA9IHRoaXMuJHN0b3JlLnN0YXRlLnJvb21JZAogICAgICAgIGNvbnN0IHN1cGFiYXNlID0gZ2V0U3VwYWJhc2UoKQogICAgICAgIGF3YWl0IGF1dG9TdGFydEF1Y3Rpb25GbG93KHsKICAgICAgICAgIHJvb21JZDogcmlkLAogICAgICAgICAgc3RvcmU6IHRoaXMuJHN0b3JlLAogICAgICAgICAgc3VwYWJhc2UsCiAgICAgICAgICBsb2FkQXJ0aWZhY3RzOiAoKSA9PiB0aGlzLmxvYWRBcnRpZmFjdHMoKSwKICAgICAgICAgIGRpc3BhdGNoU3RhcnRBdWN0aW9uOiAoYXJ0KSA9PiB0aGlzLiRzdG9yZS5kaXNwYXRjaCgnc3RhcnRBdWN0aW9uJywgYXJ0KSwKICAgICAgICAgIHN0YXJ0QXVjdGlvblRpbWVyOiAoc2VjKSA9PiB0aGlzLnN0YXJ0QXVjdGlvblRpbWVyKHNlYyksCiAgICAgICAgICByb3VuZENvdW50OiB0aGlzLnJvdW5kQ291bnQsCiAgICAgICAgICB0b3RhbFJvdW5kczogdGhpcy50b3RhbFJvdW5kcywKICAgICAgICAgIHNldFJvdW5kQ291bnQ6IChuKSA9PiB7IHRoaXMucm91bmRDb3VudCA9IG4gfSwKICAgICAgICB9KQogICAgICB9IGNhdGNoIChlKSB7IGNvbnNvbGUud2FybignW2dhbWVdIGF1dG9TdGFydEF1Y3Rpb24gZmFpbGVkJywgZSkgfQogICAgfSwKICAgIAogICAgLy8g5Y+R6YCB6IGK5aSp5raI5oGvCiAgICBhc3luYyBzZW5kTWVzc2FnZSgpIHsKICAgICAgaWYgKCF0aGlzLm5ld01lc3NhZ2UudHJpbSgpIHx8ICF0aGlzLnVzZXIpIHJldHVybgogICAgICBjb25zdCBtZXNzYWdlID0geyAKICAgICAgICBpZDogRGF0ZS5ub3coKSwgCiAgICAgICAgdXNlcklkOiB0aGlzLnVzZXIuaWQsIAogICAgICAgIHVzZXJuYW1lOiB0aGlzLmdldE5hbWVGb3IodGhpcy51c2VyLmlkKSwgCiAgICAgICAgY29udGVudDogdGhpcy5uZXdNZXNzYWdlLnRyaW0oKSwgCiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpIAogICAgICB9CiAgICAgIC8vIOacrOWcsOeri+WNs+aYvuekuu+8jOaPkOS+m+WNs+aXtuWPjemmiAogICAgICB0aGlzLmNoYXRNZXNzYWdlcy5wdXNoKG1lc3NhZ2UpCiAgICAgIHRoaXMubmV3TWVzc2FnZSA9ICcnCiAgICAgIAogICAgICAvLyDmu5rliqjliLDlupXpg6gKICAgICAgdGhpcy4kbmV4dFRpY2soKCkgPT4gewogICAgICAgIGNvbnN0IGNoYXRDb250YWluZXIgPSB0aGlzLiRyZWZzLmNoYXRDb250YWluZXIKICAgICAgICBpZiAoY2hhdENvbnRhaW5lcikgeyBjaGF0Q29udGFpbmVyLnNjcm9sbFRvcCA9IGNoYXRDb250YWluZXIuc2Nyb2xsSGVpZ2h0IH0KICAgICAgfSkKICAgICAgCiAgICAgIC8vIOWPkemAgeWIsOacjeWKoeWZqO+8jOW5v+aSree7meaJgOacieeOqeWutgogICAgICBjb25zdCByaWQgPSB0aGlzLiRzdG9yZS5zdGF0ZS5yb29tSWQKICAgICAgaWYgKHJpZCkgeyAKICAgICAgICB0cnkgeyAKICAgICAgICAgIGNvbnN0IHN1cGFiYXNlID0gZ2V0U3VwYWJhc2UoKQogICAgICAgICAgYXdhaXQgc2VuZENoYXRNZXNzYWdlKHsgc3VwYWJhc2UsIHJvb21JZDogcmlkLCBtZXNzYWdlIH0pIAogICAgICAgIH0gY2F0Y2ggKGUpIHsgCiAgICAgICAgICBjb25zb2xlLndhcm4oJ1tnYW1lXSBzZW5kTWVzc2FnZSBmYWlsZWQnLCBlKQogICAgICAgICAgLy8g5Y+R6YCB5aSx6LSl5pe277yM5Y+v5Lul6YCJ5oup56e76Zmk5pys5Zyw5raI5oGv5oiW5L+d55WZ77yI5L+d55WZ5o+Q5L6b5pu05aW955qE55So5oi35L2T6aqM77yJCiAgICAgICAgfSAKICAgICAgfQogICAgfSwKICAgIAogICAgLy8g5qC85byP5YyW5raI5oGv5pe26Ze0CiAgICBmb3JtYXRNZXNzYWdlVGltZSh0aW1lc3RhbXApIHsgcmV0dXJuIGZvcm1hdE1lc3NhZ2VUaW1lSGVscGVyKHRpbWVzdGFtcCkgfQogICAgLAoKICAgIC8vIOiuoeeul+acgOe7iOW+l+WIhuW5tuehruWumui1ouWutgogICAgYXN5bmMgY29tcHV0ZUZpbmFsU2NvcmVzKCkgewogICAgICB0cnkgewogICAgICAgIGNvbnN0IHJpZCA9IHRoaXMuJHN0b3JlLnN0YXRlLnJvb21JZAogICAgICAgIGlmICghcmlkKSByZXR1cm4KICAgICAgICBjb25zdCBzdXBhYmFzZSA9IGdldFN1cGFiYXNlKCkKICAgICAgICBjb25zdCB7IGRhdGE6IHJvd3MgfSA9IGF3YWl0IHN1cGFiYXNlCiAgICAgICAgICAuZnJvbSgncm9vbV9hcnRpZmFjdHMnKQogICAgICAgICAgLnNlbGVjdCgnb3duZXJfdXNlcl9pZCwgYXJ0aWZhY3RfaWQnKQogICAgICAgICAgLmVxKCdyb29tX2lkJywgcmlkKQogICAgICAgIGNvbnN0IHVzZXJUb0FydGlmYWN0cyA9IHt9CiAgICAgICAgOyhyb3dzIHx8IFtdKS5mb3JFYWNoKHIgPT4gewogICAgICAgICAgaWYgKCF1c2VyVG9BcnRpZmFjdHNbci5vd25lcl91c2VyX2lkXSkgdXNlclRvQXJ0aWZhY3RzW3Iub3duZXJfdXNlcl9pZF0gPSBbXQogICAgICAgICAgdXNlclRvQXJ0aWZhY3RzW3Iub3duZXJfdXNlcl9pZF0ucHVzaChyLmFydGlmYWN0X2lkKQogICAgICAgIH0pCgogICAgICAgIGNvbnN0IGNvbGxlY3Rpb25zID0gQXJyYXkuaXNBcnJheSh0aGlzLmNvbGxlY3Rpb25zKSA/IHRoaXMuY29sbGVjdGlvbnMgOiBbXQogICAgICAgIGNvbnN0IHNjb3JlcyA9IE9iamVjdC5rZXlzKHVzZXJUb0FydGlmYWN0cykubWFwKHVpZCA9PiB7CiAgICAgICAgICBjb25zdCBvd25lZCA9IHVzZXJUb0FydGlmYWN0c1t1aWRdCiAgICAgICAgICAvLyDmlLbol4/pm4bliIbmlbAKICAgICAgICAgIGxldCBjb2xsZWN0aW9uU2NvcmUgPSAwCiAgICAgICAgICBjb2xsZWN0aW9ucy5mb3JFYWNoKGNvbCA9PiB7CiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnQgPSBnZXRDb2xsZWN0aW9uQ291bnRVdGlsKHsgYXJ0aWZhY3RNYXA6IHRoaXMuYXJ0aWZhY3RNYXAsIG93bmVkQXJ0aWZhY3RJZHM6IG93bmVkLCBjb2xsZWN0aW9uOiBjb2wgfSkKICAgICAgICAgICAgaWYgKGN1cnJlbnQgPj0gKGNvbC5yZXF1aXJlZENvdW50IHx8IDEpKSBjb2xsZWN0aW9uU2NvcmUgKz0gKGNvbC5yZXdhcmRQb2ludHMgfHwgMCkKICAgICAgICAgIH0pCiAgICAgICAgICAvLyDpm7bmlaPlpYfnianliIbmlbDvvIjln7rnoYDku7flgLzkuIDljYrvvIzlkJHkuIvlj5bmlbTvvIkKICAgICAgICAgIGxldCBhcnRpZmFjdFNjb3JlID0gMAogICAgICAgICAgb3duZWQuZm9yRWFjaChhaWQgPT4gewogICAgICAgICAgICBjb25zdCBhID0gdGhpcy5hcnRpZmFjdE1hcFthaWRdCiAgICAgICAgICAgIGlmIChhICYmIHR5cGVvZiBhLmJhc2VWYWx1ZSA9PT0gJ251bWJlcicpIGFydGlmYWN0U2NvcmUgKz0gTWF0aC5mbG9vcihhLmJhc2VWYWx1ZSAvIDIpCiAgICAgICAgICB9KQogICAgICAgIAogICAgICAgICAgY29uc3QgdG90YWwgPSBjb2xsZWN0aW9uU2NvcmUgKyBhcnRpZmFjdFNjb3JlCiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB1c2VySWQ6IHVpZCwKICAgICAgICAgICAgbmFtZTogdGhpcy5nZXROYW1lRm9yKHVpZCksCiAgICAgICAgICAgIGF2YXRhcjogdGhpcy5nZXRBdmF0YXJGb3IodWlkKSwKICAgICAgICAgICAgY29sbGVjdGlvblNjb3JlLAogICAgICAgICAgICBhcnRpZmFjdFNjb3JlLAogICAgICAgICAgICB0b3RhbAogICAgICAgICAgfQogICAgICAgIH0pCgogICAgICAgIGNvbnN0IHNvcnRlZCA9IHNjb3Jlcy5zb3J0KChhLCBiKSA9PiBiLnRvdGFsIC0gYS50b3RhbCkKICAgICAgICB0aGlzLmZpbmFsU2NvcmVzID0gc29ydGVkCiAgICAgICAgdGhpcy53aW5uZXJJbmZvID0gc29ydGVkWzBdIHx8IG51bGwKCiAgICAgICAgaWYgKHRoaXMud2lubmVySW5mbykgewogICAgICAgICAgdGhpcy4kc3RvcmUuY29tbWl0KCdBRERfR0FNRV9MT0cnLCB7IHRpbWVzdGFtcDogRGF0ZS5ub3coKSwgbWVzc2FnZTogYOacrOWxgOe7k+adn++8jOiDnOiAhe+8miR7dGhpcy53aW5uZXJJbmZvLm5hbWV977yI5oC75YiGICR7dGhpcy53aW5uZXJJbmZvLnRvdGFsfe+8iWAgfSkKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGUpIHsgY29uc29sZS53YXJuKCdbZ2FtZV0gY29tcHV0ZUZpbmFsU2NvcmVzIGZhaWxlZCcsIGUpIH0KICAgIH0sCgogICAgLy8g5byA5ZCvL+WFs+mXreaWh+eJqeiusui/sAogICAgb3Blbk5hcnJhdGlvbigpIHsKICAgICAgLy8g5p6E6YCg6K6y6L+w5paH5pys77yM5YyF5ZCr5Z+65pys5LuL57uNICsg5pWF5LqLCiAgICAgIGNvbnN0IGJhc2UgPSBgJHt0aGlzLnNlbGVjdGVkQ2FyZC5uYW1lfe+8jOadpeiHqiAke3RoaXMuc2VsZWN0ZWRDYXJkLmVyYX0ke3RoaXMuc2VsZWN0ZWRDYXJkLmxvY2F0aW9uID8gJyDCtyAnICsgdGhpcy5zZWxlY3RlZENhcmQubG9jYXRpb24gOiAnJ33jgIJcbmAKICAgICAgY29uc3Qgc3RvcnkgPSAodGhpcy5zZWxlY3RlZENhcmQuc3RvcnkgfHwgJycpLnRyaW0oKQogICAgICBjb25zdCBmdWxsID0gYCR7YmFzZX0ke3N0b3J5fWAudHJpbSgpCiAgICAgIC8vIOaJk+Wtl+acuuaViOaenAogICAgICB0aGlzLnR5cGluZ1RleHQgPSAnJwogICAgICB0aGlzLnNob3dOYXJyYXRpb24gPSB0cnVlCiAgICAgIGNvbnN0IHNwZWVkID0gKGZpcnN0TG9naW5EaWFsb2d1ZUNvbmZpZyAmJiBmaXJzdExvZ2luRGlhbG9ndWVDb25maWcuYW5pbWF0aW9ucyAmJiBmaXJzdExvZ2luRGlhbG9ndWVDb25maWcuYW5pbWF0aW9ucy50ZXh0VHlwaW5nU3BlZWQpIHx8IDMwCiAgICAgIGlmICh0aGlzLnR5cGluZ1RpbWVyKSB7IGNsZWFySW50ZXJ2YWwodGhpcy50eXBpbmdUaW1lcik7IHRoaXMudHlwaW5nVGltZXIgPSBudWxsIH0KICAgICAgbGV0IGkgPSAwCiAgICAgIHRoaXMudHlwaW5nVGltZXIgPSBzZXRJbnRlcnZhbCgoKSA9PiB7CiAgICAgICAgaWYgKGkgPj0gZnVsbC5sZW5ndGgpIHsKICAgICAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy50eXBpbmdUaW1lcikKICAgICAgICAgIHRoaXMudHlwaW5nVGltZXIgPSBudWxsCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMudHlwaW5nVGV4dCArPSBmdWxsW2ldCiAgICAgICAgICBpICs9IDEKICAgICAgICB9CiAgICAgIH0sIHNwZWVkKQogICAgfSwKICAgIGNsb3NlTmFycmF0aW9uKCkgewogICAgICBpZiAodGhpcy50eXBpbmdUaW1lcikgeyBjbGVhckludGVydmFsKHRoaXMudHlwaW5nVGltZXIpOyB0aGlzLnR5cGluZ1RpbWVyID0gbnVsbCB9CiAgICAgIHRoaXMuc2hvd05hcnJhdGlvbiA9IGZhbHNlCiAgICAgIHRoaXMudHlwaW5nVGV4dCA9ICcnCiAgICB9CiAgfQp9Cg=="},{"version":3,"sources":["index.vue"],"names":[],"mappings":";AAqVA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;;;AAIA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"index.vue","sourceRoot":"src/pages/index","sourcesContent":["<template>\n  <div class=\"game-container\" :class=\"{ 'post-start': gamePhase !== 'preparation' }\">\n    <!-- 顶部状态栏：品牌/用户信息/导航控制（登录、个人中心、准备/开始/商店/退出） -->\n    <div class=\"top-auth-bar\">\n      <div class=\"left\">\n        <span class=\"brand\">时空旅人拍卖会</span>\n      </div>\n      <div class=\"right\" v-if=\"user\">\n        <span class=\"user-email\">{{ user.email }}</span>\n        <button class=\"nav-button\" @click=\"$router.push('/profile')\">个人中心</button>\n      </div>\n      <div class=\"right\" v-else>\n        <button class=\"nav-button primary\" @click=\"$router.push('/login')\">登录 / 注册</button>\n      </div>\n    </div>\n\n    <div class=\"game-status\">\n      <div class=\"room-info\">\n        <div class=\"room-name\">{{ room ? (room.name || '未命名房间') : '未加入房间' }}</div>\n        <div class=\"room-meta\" v-if=\"room\">玩家 {{ playerCount }}/{{ seatCount }} · 房主：{{ ownerName }}</div>\n        <div class=\"room-id-pill\">ID: {{ room ? (room.short_id || room.id) : '-' }}</div>\n      </div>\n      <span class=\"game-phase\">{{ gamePhaseText }}</span>\n      <div class=\"game-controls\">\n        <button class=\"control-button\" @click=\"toggleReady\" v-if=\"gamePhase === 'preparation'\">{{ currentUserReady ? '取消准备' : '准备' }}</button>\n        <button class=\"control-button\" @click=\"startGame\" v-if=\"gamePhase === 'preparation' && isOwner && allReady\">开始游戏</button>\n        <button class=\"control-button\" @click=\"startAuction\" v-if=\"false\">开始拍卖</button>\n        <button class=\"control-button danger\" @click=\"leaveRoom\">退出房间</button>\n      </div>\n    </div>\n\n    <!-- 玩家头像区域：展示房间玩家，点击头像可查看该玩家手牌（当前仅展示自己的手牌明细） -->\n    <div class=\"players-avatars\" v-if=\"playerCount > 0 && gamePhase !== 'preparation'\">\n      <div class=\"avatar-item\" v-for=\"p in (room ? room.room_players : [])\" :key=\"p.user_id\" @click=\"showPlayerHand(p)\">\n        <div class=\"avatar-wrap\">\n          <img class=\"player-avatar\" :src=\"getAvatarFor(p.user_id)\" />\n          <span class=\"ready-indicator\" :class=\"{ on: !!p.is_ready }\"></span>\n        </div>\n        <div class=\"player-name\">{{ getNameFor(p.user_id) }}</div>\n        <div class=\"player-value\">价值 {{ getPlayerTotalValue(p.user_id) }}</div>\n      </div>\n    </div>\n\n    <!-- 拍卖舞台：在不同的 gamePhase 下显示倒计时/间歇/拍卖面板或占位提示 -->\n    <div class=\"auction-stage\" :class=\"{ 'align-left': gamePhase === 'auction' }\">\n      <!-- 预倒计时阶段（游戏开始后5s预热） -->\n      <template v-if=\"gamePhase === 'countdown'\">\n        <div class=\"countdown-stage\">\n          <div class=\"countdown-content\">\n            <div class=\"countdown-icon\">⏳</div>\n            <div class=\"countdown-title\">游戏即将开始</div>\n            <div class=\"countdown-timer\">{{ auctionCountdown }}s</div>\n            <div class=\"countdown-subtitle\">请稍候，拍卖即将开始...</div>\n          </div>\n        </div>\n      </template>\n            <!-- 间歇阶段（每轮结束后的休息时间） -->\n      <template v-else-if=\"gamePhase === 'intermission'\">\n        <div class=\"countdown-stage\">\n          <div class=\"countdown-content\">\n            <div class=\"countdown-icon\">🧭</div>\n            <div class=\"countdown-title\">间歇中</div>\n            <div class=\"countdown-timer\">{{ auctionCountdown }}s</div>\n            <div class=\"countdown-subtitle\">请稍候，下一轮拍卖即将开始...</div>\n          </div>\n        </div>\n      </template>\n      \n      <!-- 拍卖阶段：展示拍卖面板（当前拍品列表、轮次信息、点击卡片触发讲述） -->\n      <auction-panel \n        v-else-if=\"gamePhase === 'auction' && $store.state.currentAuctions && $store.state.currentAuctions.length\" \n        :auctions=\"$store.state.currentAuctions\" \n        :countdown=\"auctionCountdown\"\n        :round-current=\"$store.state.roundCurrent\"\n        :round-total=\"$store.state.roundTotal\"\n        @artifact-click=\"showArtifactDetailFromAuction\" \n      />\n      <!-- 其他情况显示占位提示 -->\n      <div v-else class=\"stage-placeholder\">拍卖会台空闲，等待新一轮拍卖</div>\n    </div>\n\n    <!-- 房间座位区（准备阶段）：点击空位入座，已入座玩家显示头像与准备标记 -->\n    <div class=\"seats\" v-if=\"seatCount > 0 && gamePhase === 'preparation'\" :style=\"{ gridTemplateColumns: 'repeat(' + seatCount + ', 1fr)' }\">\n      <div class=\"seat\" v-for=\"(seat, idx) in seats\" :key=\"idx\" :class=\"{ occupied: !!seat.player }\" @click=\"moveToSeat(idx)\">\n        <div class=\"seat-index\">{{ idx + 1 }}/{{ seatCount }}</div>\n        <div class=\"seat-body\">\n          <div v-if=\"seat.player\" class=\"seat-player\">\n            <div class=\"avatar-wrap\">\n              <img class=\"seat-avatar\" :src=\"getAvatarFor(seat.player.user_id)\" />\n              <span v-if=\"seat.player.is_ready\" class=\"ready-badge\">✓</span>\n            </div>\n            <div class=\"seat-name\">{{ getNameFor(seat.player.user_id) }}</div>\n          </div>\n          <div v-else class=\"seat-empty\">空位</div>\n        </div>\n      </div>\n    </div>\n\n    <!-- 当前玩家手牌：展示自己已拥有的奇物，点击查看详情（或触发讲述） -->\n    <div class=\"my-hand\" v-if=\"gamePhase !== 'preparation'\">\n      <h3 class=\"hand-title\">我的手牌</h3>\n      <div class=\"hand-grid\">\n        <div\n          v-for=\"(aid, idx) in (currentPlayer ? currentPlayer.artifacts : [])\"\n          :key=\"aid + '-' + idx\"\n          class=\"hand-card fancy\"\n          @click=\"showArtifactDetail(aid)\"\n        >\n          <div class=\"hand-media\">\n            <img\n              class=\"hand-image\"\n              :src=\"artifactMap[aid] ? artifactMap[aid].image : 'https://via.placeholder.com/160x100?text=未知卡牌'\"\n            />\n            <div class=\"hand-overlay\"></div>\n          </div>\n          <div class=\"hand-info\">\n            <div class=\"hand-name\" :title=\"artifactMap[aid] ? artifactMap[aid].name : aid\">\n              {{ artifactMap[aid] ? artifactMap[aid].name : aid }}\n            </div>\n            <div class=\"hand-era\" v-if=\"artifactMap[aid] && (artifactMap[aid].era || artifactMap[aid].location)\">\n              {{ artifactMap[aid].era }}<span v-if=\"artifactMap[aid].location\"> · {{ artifactMap[aid].location }}</span>\n            </div>\n            <div class=\"hand-tags\" v-if=\"artifactMap[aid] && artifactMap[aid].collectionTags && artifactMap[aid].collectionTags.length\">\n              <span\n                class=\"hand-tag\"\n                v-for=\"tag in artifactMap[aid].collectionTags.slice(0,2)\"\n                :key=\"tag\"\n              >{{ tag }}</span>\n              <span class=\"hand-tag more\" v-if=\"artifactMap[aid].collectionTags.length > 2\">+{{ artifactMap[aid].collectionTags.length - 2 }}</span>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n\n    <!-- 收藏集进度：仅展示与自己已拥有奇物相关的收藏集，支持展开查看成员清单 -->\n    <div class=\"collections-panel\" v-if=\"gamePhase !== 'preparation'\">\n      <div class=\"collections-section\">\n        <h4 class=\"collections-title\">收藏集进度</h4>\n        <div class=\"collections-list\">\n          <div \n            v-for=\"collection in collectionsComputed\" \n            :key=\"collection.id\"\n            class=\"collection-progress-item\"\n            :class=\"{ completed: collection._current >= collection.requiredCount }\"\n          >\n            <div class=\"collection-header\" @click=\"toggleCollection(collection)\">\n              <div class=\"collection-icon\">🏆</div>\n              <div class=\"collection-info\">\n                <div class=\"collection-name\">{{ collection.name }}</div>\n                <div class=\"collection-description\">{{ collection.description }}</div>\n              </div>\n              <div class=\"collection-reward\" v-if=\"collection._current >= collection.requiredCount\">\n                <span class=\"reward-badge\">✓</span>\n              </div>\n            </div>\n            <!-- 展开展示该收藏集所需所有商品 -->\n            <div class=\"collection-members\" v-if=\"expandedCollections[collection.id]\">\n              <div class=\"member-item\" v-for=\"aid in (collection.artifactIds || [])\" :key=\"aid\">\n                <img class=\"member-image\" :src=\"artifactMap[aid] ? artifactMap[aid].image : 'https://via.placeholder.com/60x40?text=No+Img'\" />\n                <div class=\"member-info\">\n                  <div class=\"member-name\">{{ artifactMap[aid] ? artifactMap[aid].name : aid }}</div>\n                  <div class=\"member-meta\">{{ artifactMap[aid] && artifactMap[aid].era }}<span v-if=\"artifactMap[aid] && artifactMap[aid].location\"> · {{ artifactMap[aid].location }}</span></div>\n                </div>\n                <div class=\"member-status\" :class=\"{ owned: currentPlayer && currentPlayer.artifacts && currentPlayer.artifacts.includes(aid) }\">\n                  {{ currentPlayer && currentPlayer.artifacts && currentPlayer.artifacts.includes(aid) ? '已拥有' : '未拥有' }}\n                </div>\n              </div>\n            </div>\n            <div class=\"progress-container\">\n              <div class=\"progress-bar\">\n                <div \n                  class=\"progress-fill\"\n                  :style=\"{ width: collection._progress + '%' }\"\n                ></div>\n              </div>\n              <div class=\"progress-text\">\n                {{ collection._current }}/{{ collection.requiredCount }}\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n\n    <!-- 聊天/日志面板：合并系统日志与聊天消息为统一时间序信息流 -->\n    <div class=\"chat-panel\" v-if=\"gamePhase !== 'preparation'\">\n      <div class=\"chat-header\">\n        <h4 class=\"chat-title\">聊天 / 日志</h4>\n        <div class=\"chat-status\">\n          <span class=\"status-dot\"></span>\n          <span class=\"status-text\">在线</span>\n        </div>\n      </div>\n      \n      <div class=\"chat-messages\" ref=\"chatContainer\">\n        <div \n          v-for=\"message in chatFeed\" \n          :key=\"message.id\"\n          class=\"chat-message\"\n          :class=\"{ 'own-message': message.type === 'chat' && message.userId === (user && user.id), 'system-log': message.type === 'log' }\"\n        >\n          <div class=\"message-header\">\n            <span class=\"message-username\">{{ message.type === 'log' ? '系统' : message.username }}</span>\n            <span class=\"message-time\">{{ formatMessageTime(message.timestamp) }}</span>\n          </div>\n          <div class=\"message-content\">{{ message.content }}</div>\n        </div>\n      </div>\n      \n      <div class=\"chat-input\">\n        <input \n          v-model=\"newMessage\"\n          @keyup.enter=\"sendMessage\"\n          placeholder=\"输入消息...\"\n          class=\"message-input\"\n        />\n        <button @click=\"sendMessage\" class=\"send-button\" :disabled=\"!newMessage.trim()\">\n          <span class=\"send-icon\">📤</span>\n        </button>\n      </div>\n    </div>\n\n    <!-- 卡牌详情弹窗：展示所选奇物的核心信息与标签 -->\n    <div v-if=\"showCardDetail\" class=\"card-detail-popup\">\n      <div class=\"popup-overlay\" @click=\"hideCardDetail\"></div>\n      <div class=\"popup-content\" v-if=\"selectedCard\">\n        <img \n          class=\"detail-image\" \n          :src=\"selectedCard.image\" \n          alt=\"奇物图片\"\n        />\n        <div class=\"detail-content\">\n          <h3 class=\"detail-name\">{{ selectedCard.name }}</h3>\n          <p class=\"detail-era\">{{ selectedCard.era }} - {{ selectedCard.location }}</p>\n          <p class=\"detail-story\">{{ selectedCard.story }}</p>\n          <div class=\"detail-tags\">\n            <span \n              v-for=\"tag in selectedCard.collectionTags\" \n              :key=\"tag\"\n              class=\"detail-tag\"\n            >\n              {{ tag }}\n            </span>\n          </div>\n          <p class=\"detail-value\">基础价值: {{ selectedCard.baseValue }}</p>\n            \n        </div>\n        <button class=\"close-button\" @click=\"hideCardDetail\">关闭</button>\n      </div>\n    </div>\n\n      <!-- 文物讲述弹层：以角色对白形式讲述 selectedCard 的关键信息 -->\n      <div v-if=\"showNarration && selectedCard\" class=\"narration-popup\">\n        <div class=\"popup-overlay\" @click=\"closeNarration\"></div>\n        <div class=\"popup-content narration-content\">\n          <!-- 顶部：文物大图与快速元信息，图片下方显示名称 -->\n          <div class=\"artifact-media\" v-if=\"selectedCard\">\n            <img class=\"artifact-image-large\" :src=\"selectedCard.image || 'https://via.placeholder.com/800x240?text=Artifact'\" alt=\"artifact\" />\n            <div class=\"artifact-quick-meta\">\n              <span class=\"badge era\" v-if=\"selectedCard.era\">{{ selectedCard.era }}</span>\n              <span class=\"badge location\" v-if=\"selectedCard.location\">{{ selectedCard.location }}</span>\n              <span class=\"badge value\" v-if=\"selectedCard.baseValue !== undefined\">价值 {{ selectedCard.baseValue }}</span>\n              <span class=\"badge tags\" v-if=\"(selectedCard.collectionTags || []).length\">{{ (selectedCard.collectionTags || []).slice(0,3).join('、') }}</span>\n            </div>\n          </div>\n          <div class=\"artifact-caption\" v-if=\"selectedCard && selectedCard.name\">{{ selectedCard.name }}</div>\n\n          <!-- 下方：人物与对白一行排列 -->\n          <div class=\"narration-dialog\">\n            <!-- 左侧：角色大图与姓名 -->\n            <div class=\"character-side\" :style=\"{ borderColor: narrationCharacter && narrationCharacter.color ? narrationCharacter.color : '#3b82f6' }\">\n              <img class=\"character-image\" :src=\"(narrationCharacter && narrationCharacter.image) || '/images/guide.png'\" />\n              <div class=\"character-name\" :style=\"{ color: narrationCharacter && narrationCharacter.color ? narrationCharacter.color : '#3b82f6' }\">\n                {{ narrationCharacterName }}\n              </div>\n            </div>\n            <!-- 右侧：对白气泡 -->\n            <div class=\"speech-side\">\n              <div class=\"speech-bubble\">\n                <div class=\"speech-text\">{{ typingText }}</div>\n              </div>\n              <div class=\"narration-actions\">\n                <button class=\"control-button primary\" @click=\"closeNarration\">好的</button>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n\n    <!-- 手牌弹窗：查看某位玩家的手牌缩略（当前仅展示当前玩家持有的真实列表） -->\n    <div v-if=\"showHandPopup\" class=\"hand-popup\">\n      <div class=\"popup-overlay\" @click=\"hideHand\"></div>\n      <div class=\"popup-content\">\n        <h3 class=\"hand-title\">{{ handPlayer ? handPlayer.name + ' 的手牌' : '手牌' }}</h3>\n        <div class=\"hand-grid\">\n          <div v-for=\"aid in (handPlayer ? handPlayer.artifacts : [])\" :key=\"aid\" class=\"hand-card\">\n            <img class=\"hand-image\" :src=\"artifactMap[aid] ? artifactMap[aid].image : 'https://via.placeholder.com/160x100?text=未知卡牌'\" />\n            <div class=\"hand-name\">{{ artifactMap[aid] ? artifactMap[aid].name : aid }}</div>\n          </div>\n        </div>\n        <button class=\"close-button\" @click=\"hideHand\">关闭</button>\n      </div>\n    </div>\n\n    <!-- 游戏结束对话框：展示最终排名与赢家信息，提供回房或去列表的导航 -->\n    <div v-if=\"showGameEndDialog\" class=\"game-end-popup\">\n      <div class=\"popup-overlay\" @click=\"closeGameEndDialog\"></div>\n      <div class=\"popup-content game-end-content\">\n        <div class=\"game-end-header\">\n          <div class=\"game-end-icon\">🏆</div>\n          <h2 class=\"game-end-title\">游戏结束</h2>\n          <p class=\"game-end-subtitle\" v-if=\"winnerInfo\">胜者：{{ winnerInfo.name }} · 总分 {{ winnerInfo.total }}</p>\n          <p class=\"game-end-subtitle\" v-else>感谢参与时空旅人拍卖会！</p>\n        </div>\n        <div class=\"final-scoreboard\" v-if=\"finalScores && finalScores.length\">\n          <div class=\"score-row\" v-for=\"(p, idx) in finalScores\" :key=\"p.userId\">\n            <div class=\"rank\">{{ idx + 1 }}</div>\n            <img class=\"score-avatar\" :src=\"p.avatar\" />\n            <div class=\"name\">{{ p.name }}</div>\n            <div class=\"detail\">收藏集 {{ p.collectionScore }} + 奇物 {{ p.artifactScore }} = <b>{{ p.total }}</b></div>\n          </div>\n        </div>\n        \n        <div class=\"game-end-actions\">\n          <button class=\"action-button primary\" @click=\"stayInRoom\">\n            <span class=\"btn-icon\">🏠</span>\n            留在房间\n          </button>\n          <button class=\"action-button secondary\" @click=\"goToRooms\">\n            <span class=\"btn-icon\">📋</span>\n            返回房间列表\n          </button>\n        </div>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script>\nimport { mapState, mapGetters } from 'vuex'\nimport AuctionPanel from '../../components/auction-panel/auction-panel.vue'\nimport roomService from '../../services/room-service'\nimport { getSupabase } from '../../services/supabase-client'\nimport auctionService from '../../services/auction-service'\nimport { startCountdown, clearCountdown } from '../../features/game/countdown'\nimport { loadRoomState as loadRoomStateService } from '../../features/game/room-state.service'\nimport { subscribeRoomRealtime as subscribeRoomRealtimeService, unsubscribeRoomRealtime as unsubscribeRoomRealtimeService } from '../../features/game/room-realtime'\nimport { startGame as startGameFlow, autoStartAuction as autoStartAuctionFlow } from '../../features/game/auction-flow.service'\nimport { sendChatMessage } from '../../features/game/chat.service'\nimport { toggleReady as toggleReadyAction, moveToSeat as moveToSeatAction, leaveRoom as leaveRoomAction } from '../../features/game/room-actions.service'\nimport { loadArtifacts as loadArtifactsService } from '../../features/game/artifacts.service'\nimport { loadCollectionsFromArtifacts, getCurrentCollectionCount as getCollectionCountUtil, getCollectionProgress as getCollectionProgressUtil } from '../../features/game/collections.utils'\nimport { formatMessageTime as formatMessageTimeHelper, getAvatarFor as getAvatarForHelper, getNameFor as getNameForHelper } from '../../features/game/ui.helpers'\nimport { firstLoginDialogue as firstLoginDialogueConfig, getCurrentLanguage as getCurrentLanguageImported } from '../../config/dialogue-config'\nexport default {\n  name: 'GameIndex',\n  components: {\n    AuctionPanel\n  },\n  data() {\n    return {\n      selectedCard: null,\n      showHandPopup: false,\n      handPlayer: null,\n      artifactMap: {},\n      room: null,\n      profileMap: {},\n      refreshTimer: null,\n      collections: [],\n      showGameEndDialog: false,\n      finalScores: [],\n      winnerInfo: null,\n      auctionCountdown: 0,\n      auctionTimer: null,\n      currentAuction: null,\n      // 回合相关（前端实时显示，房主每轮开拍时广播以保持同步）\n      roundCount: 0,\n      totalRounds: 6,\n      chatMessages: [],\n      newMessage: '',\n      chatChannel: null,\n      countdownInProgress: false,\n      expandedCollections: {},\n      showNarration: false,\n      typingText: '',\n      typingTimer: null,\n      // 存储所有玩家的手牌数据，用于价值计算\n      allPlayersArtifacts: {}\n    }\n  },\n  computed: {\n    ...mapState(['gamePhase', 'gameLog', 'showCardDetail', 'user', 'roomId', 'roundCurrent', 'roundTotal']),\n    // 将当前玩家注入到渲染上下文，避免模板引用报错\n    currentPlayer() { return this.$store.state.currentPlayer },\n    isOwner() { return this.room && this.user && this.room.owner_id === this.user.id },\n    allReady() {\n      const players = (this.room && this.room.room_players) ? this.room.room_players : []\n      return players.length > 0 && players.every(p => !!p.is_ready)\n    },\n    currentUserReady() {\n      const user = this.user\n      const players = (this.room && this.room.room_players) ? this.room.room_players : []\n      if (!user) return false\n      const me = players.find(p => p.user_id === user.id)\n      return !!(me && me.is_ready)\n    },\n    playerCount() {\n      return (this.room && this.room.room_players) ? this.room.room_players.length : 0\n    },\n    ownerName() {\n      if (!this.room) return '-'\n      return this.getNameFor(this.room.owner_id)\n    },\n    seatCount() { return (this.room && Number(this.room.max_players)) ? Number(this.room.max_players) : 0 },\n    seats() {\n      const players = (this.room && this.room.room_players) ? this.room.room_players : []\n      const max = this.seatCount\n      const seats = Array.from({ length: max }, () => ({ player: null }))\n      // 放置已设置座位的玩家\n      players.forEach(p => {\n        const idx = typeof p.seat_index === 'number' ? p.seat_index : -1\n        if (idx >= 0 && idx < max && !seats[idx].player) seats[idx].player = p\n      })\n      // 将未设置座位的玩家依次放到空位\n      players.filter(p => typeof p.seat_index !== 'number' || p.seat_index < 0).forEach(p => {\n        const emptyIdx = seats.findIndex(s => !s.player)\n        if (emptyIdx >= 0) seats[emptyIdx].player = p\n      })\n      return seats\n    },\n    gamePhaseText() {\n      const phaseMap = {\n        'preparation': '准备阶段',\n        'countdown': '预倒计时',\n        'intermission': '间歇阶段',\n        'auction': '拍卖阶段',\n        'settlement': '结算阶段'\n      }\n      return phaseMap[this.gamePhase] || '未知阶段'\n    },\n   \n\n    // 根据当前用户手牌计算收藏集显示数据，带缓存字段，便于模板直接引用\n    collectionsComputed() {\n      const list = Array.isArray(this.collections) ? this.collections : []\n      // 仅展示用户手牌中至少包含1件该收藏集的情况\n      return list\n        .map(col => {\n          const current = this.getCurrentCollectionCount(col)\n          const progress = Math.min((current / (col.requiredCount || 1)) * 100, 100)\n          return { ...col, _current: current, _progress: progress }\n        })\n        .filter(col => col._current > 0)\n    },\n\n    // 合并聊天与系统日志为同一信息流，按时间排序\n    chatFeed() {\n      const logs = (this.gameLog || []).map((l, idx) => ({\n        id: `log-${l.timestamp || idx}`,\n        type: 'log',\n        userId: null,\n        username: '系统',\n        content: l.message,\n        timestamp: l.timestamp || 0\n      }))\n      const chats = (this.chatMessages || []).map(m => ({ ...m, type: 'chat' }))\n      const merged = [...logs, ...chats]\n      return merged.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0))\n    },\n    // 暴露对话配置供模板使用\n    firstLoginConfig() { return firstLoginDialogueConfig },\n    // 当前讲述角色配置与名称\n    narrationCharacterName() { return (this.getCurrentLanguage() === 'zh-CN') ? '大木博士' : 'Dr. Alina' },\n    narrationCharacter() {\n      const key = this.narrationCharacterName\n      const chars = firstLoginDialogueConfig && firstLoginDialogueConfig.characters\n      return (chars && chars[key]) ? chars[key] : { image: '/images/guide.png', position: 'right', color: '#3b82f6' }\n    }\n  },\n  async mounted() {\n    const roomId = this.$route.query.roomId\n    if (roomId) this.$store.commit('SET_ROOM_ID', roomId)\n    await this.initializeGame()\n    await this.loadRoomState()\n    // loadRoomState 中已经调用了 loadAllPlayersArtifacts，这里确保数据加载\n    await this.subscribeRoomRealtime()\n  },\n  beforeDestroy() {\n    this.unsubscribeRoomRealtime()\n    if (this.refreshTimer) { clearInterval(this.refreshTimer); this.refreshTimer = null }\n    if (this.auctionTimer) { clearInterval(this.auctionTimer); this.auctionTimer = null }\n    if (this.typingTimer) { clearInterval(this.typingTimer); this.typingTimer = null }\n    this.$set(this, 'auctionCountdown', 0)\n  },\n  watch: {\n    gameLog() {\n      this.$nextTick(() => {\n        const chatContainer = this.$refs.chatContainer\n        if (chatContainer) { chatContainer.scrollTop = chatContainer.scrollHeight }\n      })\n    }\n  },\n  methods: {\n    // 去掉模拟初始化玩家，改为使用房间的实际玩家列表\n    async initializeGame() {\n      const artifacts = await this.loadArtifacts()\n      this.artifactMap = artifacts.reduce((acc, a) => { acc[a.id] = a; return acc }, {})\n      await this.loadCollections()\n    },\n    async subscribeRoomRealtime() {\n      const rid = this.$store.state.roomId\n      if (!rid) return\n      const supabase = getSupabase()\n      const { roomChannel, broadcastChannel } = subscribeRoomRealtimeService(\n        { roomId: rid, supabase, onLoadRoomState: this.loadRoomState },\n        {\n          onGameStarted: async (_payload) => {\n            // 防止重复启动多个倒计时\n            if (this.countdownInProgress) return\n            this.countdownInProgress = true\n            \n            // 新局开始：重置聊天消息和价值数据\n            this.chatMessages = []\n            this.allPlayersArtifacts = {}\n            // 重置回合数\n            this.$store.commit('RESET_ROUND')\n            this.$store.commit('SET_ROUND_TOTAL', 6)\n            \n            this.$store.commit('SET_GAME_PHASE', 'countdown')\n            this.$set(this, 'auctionCountdown', 5)\n            const me = (this.room && this.room.room_players ? this.room.room_players : []).find(p => p.user_id === this.$store.state.user.id)\n            if (me) {\n              this.$store.commit('SET_CURRENT_PLAYER', { id: me.user_id, name: this.getNameFor(me.user_id), energy: 50, artifacts: [], items: [] })\n            }\n            if (this.auctionTimer) { clearInterval(this.auctionTimer); this.auctionTimer = null }\n            this.$nextTick(() => {\n              startCountdown({\n                seconds: 5,\n                onTick: (s) => { this.$set(this, 'auctionCountdown', s) },\n                onDone: async () => { this.countdownInProgress = false; if (this.isOwner) { await this.autoStartAuction() } },\n                getRef: () => this.auctionTimer,\n                setRef: (id) => { this.auctionTimer = id },\n              })\n            })\n          },\n          onAuctionStarted: async (duration, payload) => { \n            // 确保所有玩家都能看到拍卖数据\n            await this.loadRoomState()\n            \n            // 同步回合数（如果广播中包含了回合信息）\n            if (payload && typeof payload.roundCurrent === 'number') {\n              this.$store.commit('SET_ROUND_CURRENT', payload.roundCurrent)\n            }\n            if (payload && typeof payload.roundTotal === 'number') {\n              this.$store.commit('SET_ROUND_TOTAL', payload.roundTotal)\n            }\n            \n            this.startAuctionTimer(duration) \n          },\n          onBidUpdate: ({ auctionId, highestBid, highestBidder }) => {\n            if (!auctionId) return\n            const list = this.$store.state.currentAuctions || []\n            const idx = list.findIndex(a => a.id === auctionId)\n            if (idx >= 0) {\n              const next = { ...list[idx], highestBid, highestBidder }\n              this.$store.commit('ADD_OR_UPDATE_AUCTION', next)\n            }\n          },\n          // 旧回合广播已移除，统一本地推进，不再接收该事件\n          onRoundUpdated: (_data) => {},\n          onGameEnded: () => {\n            this.$store.commit('SET_GAME_PHASE', 'settlement')\n        this.computeFinalScores().finally(() => { this.showGameEndDialog = true })\n            if (this.auctionTimer) { clearInterval(this.auctionTimer); this.auctionTimer = null }\n          },\n          onAuctionEnded: async () => { await this.loadRoomState() },\n          onChatMessage: (message) => {\n            // 避免重复添加消息\n            if (!message || !message.id) return\n            const existing = this.chatMessages.find(m => m.id === message.id || (m.userId === message.userId && m.timestamp === message.timestamp && m.content === message.content))\n            if (existing) return\n            \n            this.chatMessages.push(message)\n            this.$nextTick(() => {\n              const chatContainer = this.$refs.chatContainer\n              if (chatContainer) { chatContainer.scrollTop = chatContainer.scrollHeight }\n            })\n          },\n        },\n        () => { if (!this.refreshTimer) { this.refreshTimer = setInterval(this.loadRoomState, 1000) } }\n      )\n      this.roomChannel = roomChannel\n      this.broadcastChannel = broadcastChannel\n    },\n    unsubscribeRoomRealtime() {\n      unsubscribeRoomRealtimeService(this.roomChannel, this.broadcastChannel)\n      this.roomChannel = null\n      this.broadcastChannel = null\n    },\n    async loadRoomState() {\n      const rid = this.$store.state.roomId\n      const supabase = getSupabase()\n      await loadRoomStateService({\n        roomId: rid,\n        roomService,\n        supabase,\n        artifactMap: this.artifactMap,\n        store: this.$store,\n        setRoom: (room) => { this.room = room },\n        setProfileMap: (map) => { this.profileMap = map },\n        setGamePhase: (phase) => { this.$store.commit('SET_GAME_PHASE', phase) },\n        clearAuctionTimer: () => { if (this.auctionTimer) { clearInterval(this.auctionTimer); this.auctionTimer = null } },\n        setAuctionCountdown: (n) => { this.$set(this, 'auctionCountdown', n) },\n        onShowGameEnd: () => { this.showGameEndDialog = true; setTimeout(() => { this.handleGameEnd() }, 3000) },\n      })\n      // 加载所有玩家的手牌数据，用于价值计算\n      await this.loadAllPlayersArtifacts()\n      // 如果刷新后发现仍有活跃拍卖，但本地无倒计时，则用当前剩余时间启动统一倒计时\n      const auctions = this.$store.state.currentAuctions || []\n      if (this.$store.state.gamePhase === 'auction' && auctions.length > 0) {\n        const remaining = Number(this.auctionCountdown || 0)\n        if (!this.auctionTimer && remaining > 0) {\n          startCountdown({\n            seconds: remaining,\n            onTick: (s) => { this.$set(this, 'auctionCountdown', s); },\n            onDone: async () => { await this.onAuctionTimeUp() },\n            getRef: () => this.auctionTimer,\n            setRef: (id) => { this.auctionTimer = id },\n          })\n        }\n      }\n    },\n    \n    // 加载所有玩家的手牌数据\n    async loadAllPlayersArtifacts() {\n      try {\n        const rid = this.$store.state.roomId\n        if (!rid) {\n          this.allPlayersArtifacts = {}\n          return\n        }\n        \n        const supabase = getSupabase()\n        // 获取房间内所有玩家的手牌数据\n        const { data: allArtifacts } = await supabase\n          .from('room_artifacts')\n          .select('owner_user_id, artifact_id')\n          .eq('room_id', rid)\n        \n        // 按玩家ID分组\n        const playerArtifactsMap = {}\n        if (allArtifacts && allArtifacts.length > 0) {\n          allArtifacts.forEach(row => {\n            const userId = row.owner_user_id\n            if (!playerArtifactsMap[userId]) {\n              playerArtifactsMap[userId] = []\n            }\n            playerArtifactsMap[userId].push(row.artifact_id)\n          })\n        }\n        \n        // 使用 Vue.set 确保响应式更新\n        this.$set(this, 'allPlayersArtifacts', playerArtifactsMap)\n      } catch (e) {\n        console.warn('[game] loadAllPlayersArtifacts failed', e)\n        this.allPlayersArtifacts = {}\n      }\n    },\n    async toggleReady() {\n      try {\n        const rid = this.$store.state.roomId\n        const uid = this.$store.state.user && this.$store.state.user.id\n        if (!rid || !uid) return\n        await toggleReadyAction({ roomId: rid, userId: uid, room: this.room, roomService, reload: this.loadRoomState })\n      } catch (e) { console.warn('[game] toggleReady failed', e) }\n    },\n    async moveToSeat(idx) {\n      try {\n        const rid = this.$store.state.roomId\n        const uid = this.$store.state.user && this.$store.state.user.id\n        if (!rid || !uid) return\n        const targetSeat = { index: idx, player: this.seats[idx] && this.seats[idx].player }\n        await moveToSeatAction({ roomId: rid, userId: uid, room: this.room, seats: targetSeat, roomService, reload: this.loadRoomState })\n      } catch (e) { console.warn('[game] moveToSeat failed', e) }\n    },\n    async leaveRoom() {\n      try {\n        const rid = this.$store.state.roomId\n        const uid = this.$store.state.user && this.$store.state.user.id\n        if (!rid || !uid) return\n        await leaveRoomAction({\n          roomId: rid,\n          userId: uid,\n          clearAuctionTimer: () => { if (this.auctionTimer) { clearInterval(this.auctionTimer); this.auctionTimer = null } },\n          setCountdown: (n) => { this.$set(this, 'auctionCountdown', n) },\n          store: this.$store,\n          auctionService,\n          roomService,\n          unsubscribe: () => this.unsubscribeRoomRealtime(),\n          setRoomId: (v) => this.$store.commit('SET_ROOM_ID', v),\n          setLocalRoom: (v) => { this.room = v },\n          navigateToRooms: () => this.$router.push('/rooms'),\n        })\n      } catch (e) { console.warn('[game] leaveRoom failed', e) }\n    },\n    \n    // 游戏结束处理\n    async handleGameEnd() {\n      try {\n        const rid = this.$store.state.roomId\n        if (rid) {\n          // 将房间状态重置为 waiting，便于继续房间内准备/新一局\n          const supabase = getSupabase()\n          await supabase.from('rooms').update({ status: 'waiting' }).eq('id', rid)\n          // 跳转回房间页面（游戏页携带 roomId 即是房间界面）\n          this.$router.push({ path: '/game', query: { roomId: rid, gameEnded: 'true' } })\n        } else {\n          this.$router.push('/rooms')\n        }\n      } catch (e) {\n        console.warn('[game] handleGameEnd failed', e)\n        // 兜底跳回房间列表\n        this.$router.push('/rooms')\n      }\n    },\n    async startGame() {\n      try {\n        const rid = this.$store.state.roomId\n        const uid = this.$store.state.user && this.$store.state.user.id\n        if (!rid || !uid || !this.isOwner || !this.allReady) return\n        // 新局开始前重置系统日志、聊天消息和价值数据\n        try { this.$store.commit('CLEAR_GAME_LOG') } catch (_) {}\n        this.chatMessages = []\n        this.allPlayersArtifacts = {}\n        await roomService.startGame(rid, uid)\n        const supabase = getSupabase()\n        this.roundCount = 0\n        await startGameFlow({\n          roomId: rid,\n          userId: uid,\n          isOwner: this.isOwner,\n          allReady: this.allReady,\n          store: this.$store,\n          supabase,\n          setCountdown: (n) => this.$set(this, 'auctionCountdown', n),\n          setCurrentPlayerFromRoom: () => {\n            const me = (this.room && this.room.room_players ? this.room.room_players : []).find(p => p.user_id === uid)\n            if (me) { this.$store.commit('SET_CURRENT_PLAYER', { id: me.user_id, name: this.getNameFor(me.user_id), energy: 50, artifacts: [], items: [] }) }\n          },\n          onCountdownDone: async () => {\n            if (this.isOwner) { await this.autoStartAuction() }\n          },\n        })\n        // 房主本地也启动预倒计时，防止广播不回传导致不触发 onGameStarted\n        if (!this.countdownInProgress) {\n          this.countdownInProgress = true\n          // 确保本地也重置数据\n          this.chatMessages = []\n          this.allPlayersArtifacts = {}\n          this.$store.commit('SET_GAME_PHASE', 'countdown')\n          this.$set(this, 'auctionCountdown', 5)\n          const me = (this.room && this.room.room_players ? this.room.room_players : []).find(p => p.user_id === uid)\n          if (me) {\n            this.$store.commit('SET_CURRENT_PLAYER', { id: me.user_id, name: this.getNameFor(me.user_id), energy: 50, artifacts: [], items: [] })\n          }\n          if (this.auctionTimer) { clearInterval(this.auctionTimer); this.auctionTimer = null }\n          this.$nextTick(() => {\n            startCountdown({\n              seconds: 5,\n              onTick: (s) => { this.$set(this, 'auctionCountdown', s) },\n              onDone: async () => { this.countdownInProgress = false; if (this.isOwner) { await this.autoStartAuction() } },\n              getRef: () => this.auctionTimer,\n              setRef: (id) => { this.auctionTimer = id },\n            })\n          })\n        }\n      } catch (e) { console.warn('[game] startGame failed', e) }\n    },\n    \n    async startAuction() {\n      // 同时抽取多件进行拍卖（示例为2件）\n      const artifacts = await this.loadArtifacts()\n      if (artifacts.length > 0) {\n        const picks = []\n        while (picks.length < Math.min(2, artifacts.length)) {\n          const candidate = artifacts[Math.floor(Math.random() * artifacts.length)]\n          if (!picks.find(p => p.id === candidate.id)) picks.push(candidate)\n        }\n        for (const art of picks) {\n          await this.$store.dispatch('startAuction', art)\n        }\n      }\n    },\n    \n    async loadArtifacts() {\n      try {\n        const supabase = getSupabase()\n        return await loadArtifactsService({ supabase })\n      } catch (error) { console.error('加载卡牌数据失败:', error); return [] }\n    },\n    \n    showArtifactDetail(artifactId) {\n      // 若已加载artifactMap，则优先展示真实数据\n      const artifact = this.artifactMap[artifactId]\n      if (artifact) {\n        this.selectedCard = artifact\n      } else {\n        // 回退：维持原示例\n        this.selectedCard = {\n          id: artifactId,\n          name: '示例奇物',\n          era: '古代',\n          location: '未知',\n          story: '这是一个神秘的奇物...',\n          collectionTags: ['艺术瑰宝'],\n          baseValue: 8,\n          image: 'https://via.placeholder.com/300x200?text=示例奇物'\n        }\n      }\n      this.$store.commit('SET_SHOW_CARD_DETAIL', true)\n    },\n    \n    hideCardDetail() {\n      this.$store.commit('SET_SHOW_CARD_DETAIL', false)\n      this.selectedCard = null\n    },\n    showArtifactDetailFromAuction(artifact) {\n      this.selectedCard = artifact\n      this.$store.commit('SET_SHOW_CARD_DETAIL', false)\n      this.openNarration()\n    },\n    // 计算玩家总价值（支持所有玩家）\n    getPlayerTotalValue(userId) {\n      if (!userId) return 0\n      \n      // 优先从 allPlayersArtifacts 获取所有玩家的手牌数据\n      let owned = []\n      if (this.allPlayersArtifacts && this.allPlayersArtifacts[userId]) {\n        owned = Array.isArray(this.allPlayersArtifacts[userId]) ? this.allPlayersArtifacts[userId] : []\n      } else {\n        // 回退：如果 allPlayersArtifacts 中没有，尝试从当前玩家数据获取\n        const current = this.$store.state.currentPlayer\n        if (current && current.id === userId) {\n          owned = Array.isArray(this.$store.state.playerArtifacts) ? this.$store.state.playerArtifacts : []\n        }\n      }\n      \n      if (!owned || owned.length === 0) return 0\n      \n      // 确保 artifactMap 已加载\n      if (!this.artifactMap || Object.keys(this.artifactMap).length === 0) return 0\n      \n      let total = 0\n      owned.forEach(aid => {\n        const a = this.artifactMap[aid]\n        if (a && typeof a.baseValue === 'number') {\n          total += a.baseValue\n        }\n      })\n      return total\n    },\n\n    showPlayerHand(player) {\n      // 构造玩家对象，包含手牌信息\n      const playerData = {\n        id: player.user_id,\n        name: this.getNameFor(player.user_id),\n        artifacts: this.currentPlayer && this.currentPlayer.id === player.user_id ? \n          (this.currentPlayer.artifacts || []) : []\n      }\n      this.handPlayer = playerData\n      this.showHandPopup = true\n    },\n\n    hideHand() {\n      this.handPlayer = null\n      this.showHandPopup = false\n    },\n    \n    \n    getAvatarFor(userId) { return getAvatarForHelper({ profileMap: this.profileMap, userId }) },\n    getNameFor(userId) { return getNameForHelper({ profileMap: this.profileMap, room: this.room, userId }) },\n    getCurrentLanguage() { return getCurrentLanguageImported() },\n    \n    // 加载收藏集数据：基于数据库 artifacts 的 collection_tags 动态生成\n    async loadCollections() {\n      try { this.collections = loadCollectionsFromArtifacts(this.artifactMap) }\n      catch (error) { console.error('加载收藏集数据失败:', error); this.collections = [] }\n    },\n    \n   \n    \n    // 获取当前收藏集数量（基于当前用户手牌，且受最大要求数上限限制）\n    getCurrentCollectionCount(collection) {\n      const owned = (this.currentPlayer && this.currentPlayer.artifacts) ? this.currentPlayer.artifacts : []\n      return getCollectionCountUtil({ artifactMap: this.artifactMap, ownedArtifactIds: owned, collection })\n    },\n\n\n    // 展开/收起收藏集\n    toggleCollection(collection) {\n      const id = collection && collection.id\n      if (!id) return\n      this.$set(this.expandedCollections, id, !this.expandedCollections[id])\n    },\n    \n    // 关闭游戏结束对话框\n    closeGameEndDialog() {\n      this.showGameEndDialog = false\n    },\n    \n    // 留在房间\n    stayInRoom() {\n      this.showGameEndDialog = false\n      try { this.$store.commit('CLEAR_GAME_LOG') } catch (_) {}\n      // 返回当前房间准备界面\n      const rid = this.$store.state.roomId\n      if (rid) {\n        this.$store.commit('SET_GAME_PHASE', 'preparation')\n        this.$router.push({ path: '/game', query: { roomId: rid } })\n      }\n    },\n    \n    // 返回房间列表\n    goToRooms() {\n      this.showGameEndDialog = false\n      this.unsubscribeRoomRealtime()\n      try { this.$store.commit('CLEAR_GAME_LOG') } catch (_) {}\n      // 返回当前房间准备界面（更符合期望）\n      const rid = this.$store.state.roomId\n      if (rid) {\n        this.$store.commit('SET_GAME_PHASE', 'preparation')\n        this.$router.push({ path: '/game', query: { roomId: rid } })\n      } else {\n        this.$router.push('/rooms')\n      }\n    },\n    \n    // 时间到：结束当前所有拍卖并结算到对应玩家手牌，然后进入10s间歇或结束游戏\n    async onAuctionTimeUp() {\n      try {\n        const auctions = this.$store.state.currentAuctions || []\n        // 统一倒计时结束：结束所有当前拍卖\n        for (const a of auctions) {\n          await this.$store.dispatch('endAuction', a.id)\n        }\n        // 判断是否达到总回合数\n        const cur = Number(this.$store.state.roundCurrent || 0)\n        const tot = Number(this.$store.state.roundTotal || 6)\n        if (cur >= tot) {\n          // 触发结束\n          this.$store.commit('SET_GAME_PHASE', 'settlement')\n          await this.computeFinalScores()\n          this.showGameEndDialog = true\n          return\n        }\n        // 否则进入10s间歇阶段\n        this.startIntermissionTimer(10)\n      } catch (e) { console.warn('[game] onAuctionTimeUp failed', e) }\n    },\n\n    // 开始拍卖倒计时：统一每轮拍卖只有一个倒计时\n    startAuctionTimer(duration = 30) {\n      this.$store.commit('SET_GAME_PHASE', 'auction')\n      startCountdown({\n        seconds: duration,\n        onTick: (s) => { this.$set(this, 'auctionCountdown', s); },\n        onDone: async () => { await this.onAuctionTimeUp() },\n        getRef: () => this.auctionTimer,\n        setRef: (id) => { this.auctionTimer = id },\n      })\n    },\n\n\n    \n    // 每轮之间的间歇计时器，结束后自动开始下一轮拍卖\n    startIntermissionTimer(duration = 10) {\n      this.$store.commit('SET_GAME_PHASE', 'intermission')\n      startCountdown({\n        seconds: duration,\n        onTick: (s) => { this.$set(this, 'auctionCountdown', s); },\n        onDone: async () => {\n          if (this.isOwner) {\n            await this.autoStartAuction()\n          }\n        },\n        getRef: () => this.auctionTimer,\n        setRef: (id) => { this.auctionTimer = id },\n      })\n    },\n    \n    // 自动开始拍卖\n    async autoStartAuction() {\n      try {\n        const rid = this.$store.state.roomId\n        const supabase = getSupabase()\n        await autoStartAuctionFlow({\n          roomId: rid,\n          store: this.$store,\n          supabase,\n          loadArtifacts: () => this.loadArtifacts(),\n          dispatchStartAuction: (art) => this.$store.dispatch('startAuction', art),\n          startAuctionTimer: (sec) => this.startAuctionTimer(sec),\n          roundCount: this.roundCount,\n          totalRounds: this.totalRounds,\n          setRoundCount: (n) => { this.roundCount = n },\n        })\n      } catch (e) { console.warn('[game] autoStartAuction failed', e) }\n    },\n    \n    // 发送聊天消息\n    async sendMessage() {\n      if (!this.newMessage.trim() || !this.user) return\n      const message = { \n        id: Date.now(), \n        userId: this.user.id, \n        username: this.getNameFor(this.user.id), \n        content: this.newMessage.trim(), \n        timestamp: Date.now() \n      }\n      // 本地立即显示，提供即时反馈\n      this.chatMessages.push(message)\n      this.newMessage = ''\n      \n      // 滚动到底部\n      this.$nextTick(() => {\n        const chatContainer = this.$refs.chatContainer\n        if (chatContainer) { chatContainer.scrollTop = chatContainer.scrollHeight }\n      })\n      \n      // 发送到服务器，广播给所有玩家\n      const rid = this.$store.state.roomId\n      if (rid) { \n        try { \n          const supabase = getSupabase()\n          await sendChatMessage({ supabase, roomId: rid, message }) \n        } catch (e) { \n          console.warn('[game] sendMessage failed', e)\n          // 发送失败时，可以选择移除本地消息或保留（保留提供更好的用户体验）\n        } \n      }\n    },\n    \n    // 格式化消息时间\n    formatMessageTime(timestamp) { return formatMessageTimeHelper(timestamp) }\n    ,\n\n    // 计算最终得分并确定赢家\n    async computeFinalScores() {\n      try {\n        const rid = this.$store.state.roomId\n        if (!rid) return\n        const supabase = getSupabase()\n        const { data: rows } = await supabase\n          .from('room_artifacts')\n          .select('owner_user_id, artifact_id')\n          .eq('room_id', rid)\n        const userToArtifacts = {}\n        ;(rows || []).forEach(r => {\n          if (!userToArtifacts[r.owner_user_id]) userToArtifacts[r.owner_user_id] = []\n          userToArtifacts[r.owner_user_id].push(r.artifact_id)\n        })\n\n        const collections = Array.isArray(this.collections) ? this.collections : []\n        const scores = Object.keys(userToArtifacts).map(uid => {\n          const owned = userToArtifacts[uid]\n          // 收藏集分数\n          let collectionScore = 0\n          collections.forEach(col => {\n            const current = getCollectionCountUtil({ artifactMap: this.artifactMap, ownedArtifactIds: owned, collection: col })\n            if (current >= (col.requiredCount || 1)) collectionScore += (col.rewardPoints || 0)\n          })\n          // 零散奇物分数（基础价值一半，向下取整）\n          let artifactScore = 0\n          owned.forEach(aid => {\n            const a = this.artifactMap[aid]\n            if (a && typeof a.baseValue === 'number') artifactScore += Math.floor(a.baseValue / 2)\n          })\n        \n          const total = collectionScore + artifactScore\n          return {\n            userId: uid,\n            name: this.getNameFor(uid),\n            avatar: this.getAvatarFor(uid),\n            collectionScore,\n            artifactScore,\n            total\n          }\n        })\n\n        const sorted = scores.sort((a, b) => b.total - a.total)\n        this.finalScores = sorted\n        this.winnerInfo = sorted[0] || null\n\n        if (this.winnerInfo) {\n          this.$store.commit('ADD_GAME_LOG', { timestamp: Date.now(), message: `本局结束，胜者：${this.winnerInfo.name}（总分 ${this.winnerInfo.total}）` })\n        }\n      } catch (e) { console.warn('[game] computeFinalScores failed', e) }\n    },\n\n    // 开启/关闭文物讲述\n    openNarration() {\n      // 构造讲述文本，包含基本介绍 + 故事\n      const base = `${this.selectedCard.name}，来自 ${this.selectedCard.era}${this.selectedCard.location ? ' · ' + this.selectedCard.location : ''}。\\n`\n      const story = (this.selectedCard.story || '').trim()\n      const full = `${base}${story}`.trim()\n      // 打字机效果\n      this.typingText = ''\n      this.showNarration = true\n      const speed = (firstLoginDialogueConfig && firstLoginDialogueConfig.animations && firstLoginDialogueConfig.animations.textTypingSpeed) || 30\n      if (this.typingTimer) { clearInterval(this.typingTimer); this.typingTimer = null }\n      let i = 0\n      this.typingTimer = setInterval(() => {\n        if (i >= full.length) {\n          clearInterval(this.typingTimer)\n          this.typingTimer = null\n        } else {\n          this.typingText += full[i]\n          i += 1\n        }\n      }, speed)\n    },\n    closeNarration() {\n      if (this.typingTimer) { clearInterval(this.typingTimer); this.typingTimer = null }\n      this.showNarration = false\n      this.typingText = ''\n    }\n  }\n}\n</script>\n\n<style lang=\"scss\" scoped src=\"./index.scss\"></style>"]}]}