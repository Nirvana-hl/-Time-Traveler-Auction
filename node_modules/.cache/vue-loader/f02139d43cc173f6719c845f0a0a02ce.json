{"remainingRequest":"D:\\大学生活\\大三\\全栈ai\\项目\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\大学生活\\大三\\全栈ai\\项目\\-Time-Traveler-Auction\\src\\pages\\index\\index.vue?vue&type=script&lang=js","dependencies":[{"path":"D:\\大学生活\\大三\\全栈ai\\项目\\-Time-Traveler-Auction\\src\\pages\\index\\index.vue","mtime":1762781804553},{"path":"D:\\大学生活\\大三\\全栈ai\\项目\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1762215254891},{"path":"D:\\大学生活\\大三\\全栈ai\\项目\\node_modules\\babel-loader\\lib\\index.js","mtime":1762215256120},{"path":"D:\\大学生活\\大三\\全栈ai\\项目\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1762215254891},{"path":"D:\\大学生活\\大三\\全栈ai\\项目\\node_modules\\vue-loader\\lib\\index.js","mtime":1762215256637}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CmltcG9ydCB7IG1hcFN0YXRlLCBtYXBHZXR0ZXJzIH0gZnJvbSAndnVleCcKaW1wb3J0IEF1Y3Rpb25QYW5lbCBmcm9tICcuLi8uLi9jb21wb25lbnRzL2F1Y3Rpb24tcGFuZWwvYXVjdGlvbi1wYW5lbC52dWUnCmltcG9ydCBJdGVtU2hvcCBmcm9tICcuLi8uLi9jb21wb25lbnRzL2l0ZW0tc2hvcC9pdGVtLXNob3AudnVlJwppbXBvcnQgcm9vbVNlcnZpY2UgZnJvbSAnLi4vLi4vc2VydmljZXMvcm9vbS1zZXJ2aWNlJwppbXBvcnQgeyBnZXRTdXBhYmFzZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3N1cGFiYXNlLWNsaWVudCcKaW1wb3J0IGF1Y3Rpb25TZXJ2aWNlIGZyb20gJy4uLy4uL3NlcnZpY2VzL2F1Y3Rpb24tc2VydmljZScKaW1wb3J0IHsgc3RhcnRDb3VudGRvd24sIGNsZWFyQ291bnRkb3duIH0gZnJvbSAnLi4vLi4vZmVhdHVyZXMvZ2FtZS9jb3VudGRvd24nCmltcG9ydCB7IGxvYWRSb29tU3RhdGUgYXMgbG9hZFJvb21TdGF0ZVNlcnZpY2UgfSBmcm9tICcuLi8uLi9mZWF0dXJlcy9nYW1lL3Jvb20tc3RhdGUuc2VydmljZScKaW1wb3J0IHsgc3Vic2NyaWJlUm9vbVJlYWx0aW1lIGFzIHN1YnNjcmliZVJvb21SZWFsdGltZVNlcnZpY2UsIHVuc3Vic2NyaWJlUm9vbVJlYWx0aW1lIGFzIHVuc3Vic2NyaWJlUm9vbVJlYWx0aW1lU2VydmljZSB9IGZyb20gJy4uLy4uL2ZlYXR1cmVzL2dhbWUvcm9vbS1yZWFsdGltZScKaW1wb3J0IHsgc3RhcnRHYW1lIGFzIHN0YXJ0R2FtZUZsb3csIGF1dG9TdGFydEF1Y3Rpb24gYXMgYXV0b1N0YXJ0QXVjdGlvbkZsb3cgfSBmcm9tICcuLi8uLi9mZWF0dXJlcy9nYW1lL2F1Y3Rpb24tZmxvdy5zZXJ2aWNlJwppbXBvcnQgeyBzZW5kQ2hhdE1lc3NhZ2UgfSBmcm9tICcuLi8uLi9mZWF0dXJlcy9nYW1lL2NoYXQuc2VydmljZScKaW1wb3J0IHsgdG9nZ2xlUmVhZHkgYXMgdG9nZ2xlUmVhZHlBY3Rpb24sIG1vdmVUb1NlYXQgYXMgbW92ZVRvU2VhdEFjdGlvbiwgbGVhdmVSb29tIGFzIGxlYXZlUm9vbUFjdGlvbiB9IGZyb20gJy4uLy4uL2ZlYXR1cmVzL2dhbWUvcm9vbS1hY3Rpb25zLnNlcnZpY2UnCmltcG9ydCB7IGxvYWRBcnRpZmFjdHMgYXMgbG9hZEFydGlmYWN0c1NlcnZpY2UgfSBmcm9tICcuLi8uLi9mZWF0dXJlcy9nYW1lL2FydGlmYWN0cy5zZXJ2aWNlJwppbXBvcnQgeyBsb2FkQ29sbGVjdGlvbnNGcm9tQXJ0aWZhY3RzLCBnZXRDdXJyZW50Q29sbGVjdGlvbkNvdW50IGFzIGdldENvbGxlY3Rpb25Db3VudFV0aWwsIGdldENvbGxlY3Rpb25Qcm9ncmVzcyBhcyBnZXRDb2xsZWN0aW9uUHJvZ3Jlc3NVdGlsIH0gZnJvbSAnLi4vLi4vZmVhdHVyZXMvZ2FtZS9jb2xsZWN0aW9ucy51dGlscycKaW1wb3J0IHsgZm9ybWF0TWVzc2FnZVRpbWUgYXMgZm9ybWF0TWVzc2FnZVRpbWVIZWxwZXIsIGdldEF2YXRhckZvciBhcyBnZXRBdmF0YXJGb3JIZWxwZXIsIGdldE5hbWVGb3IgYXMgZ2V0TmFtZUZvckhlbHBlciB9IGZyb20gJy4uLy4uL2ZlYXR1cmVzL2dhbWUvdWkuaGVscGVycycKaW1wb3J0IHsgZmlyc3RMb2dpbkRpYWxvZ3VlIGFzIGZpcnN0TG9naW5EaWFsb2d1ZUNvbmZpZywgZ2V0Q3VycmVudExhbmd1YWdlIGFzIGdldEN1cnJlbnRMYW5ndWFnZUltcG9ydGVkIH0gZnJvbSAnLi4vLi4vY29uZmlnL2RpYWxvZ3VlLWNvbmZpZycKZXhwb3J0IGRlZmF1bHQgewogIG5hbWU6ICdHYW1lSW5kZXgnLAogIGNvbXBvbmVudHM6IHsKICAgIEF1Y3Rpb25QYW5lbCwKICAgIEl0ZW1TaG9wCiAgfSwKICBkYXRhKCkgewogICAgcmV0dXJuIHsKICAgICAgc2VsZWN0ZWRDYXJkOiBudWxsLAogICAgICBzaG93SGFuZFBvcHVwOiBmYWxzZSwKICAgICAgaGFuZFBsYXllcjogbnVsbCwKICAgICAgYXJ0aWZhY3RNYXA6IHt9LAogICAgICByb29tOiBudWxsLAogICAgICBwcm9maWxlTWFwOiB7fSwKICAgICAgcmVmcmVzaFRpbWVyOiBudWxsLAogICAgICBjb2xsZWN0aW9uczogW10sCiAgICAgIHNob3dHYW1lRW5kRGlhbG9nOiBmYWxzZSwKICAgICAgZmluYWxTY29yZXM6IFtdLAogICAgICB3aW5uZXJJbmZvOiBudWxsLAogICAgICBhdWN0aW9uQ291bnRkb3duOiAwLAogICAgICBhdWN0aW9uVGltZXI6IG51bGwsCiAgICAgIGN1cnJlbnRBdWN0aW9uOiBudWxsLAogICAgICAvLyDlm57lkIjnm7jlhbPvvIjliY3nq6/lrp7ml7bmmL7npLrvvIzmiL/kuLvmr4/ova7lvIDmi43ml7blub/mkq3ku6Xkv53mjIHlkIzmraXvvIkKICAgICAgcm91bmRDb3VudDogMCwKICAgICAgdG90YWxSb3VuZHM6IDYsCiAgICAgIGNoYXRNZXNzYWdlczogW10sCiAgICAgIG5ld01lc3NhZ2U6ICcnLAogICAgICBjaGF0Q2hhbm5lbDogbnVsbCwKICAgICAgY291bnRkb3duSW5Qcm9ncmVzczogZmFsc2UsCiAgICAgIGV4cGFuZGVkQ29sbGVjdGlvbnM6IHt9LAogICAgICBzaG93TmFycmF0aW9uOiBmYWxzZSwKICAgICAgdHlwaW5nVGV4dDogJycsCiAgICAgIHR5cGluZ1RpbWVyOiBudWxsLAogICAgICAvLyDlrZjlgqjmiYDmnInnjqnlrrbnmoTmiYvniYzmlbDmja7vvIznlKjkuo7ku7flgLzorqHnrpcKICAgICAgYWxsUGxheWVyc0FydGlmYWN0czoge30KICAgIH0KICB9LAogIGNvbXB1dGVkOiB7CiAgICAuLi5tYXBTdGF0ZShbJ2dhbWVQaGFzZScsICdnYW1lTG9nJywgJ3Nob3dDYXJkRGV0YWlsJywgJ3Nob3dTaG9wJywgJ3VzZXInLCAncm9vbUlkJywgJ3JvdW5kQ3VycmVudCcsICdyb3VuZFRvdGFsJ10pLAogICAgLy8g5bCG5b2T5YmN546p5a625rOo5YWl5Yiw5riy5p+T5LiK5LiL5paH77yM6YG/5YWN5qih5p2/5byV55So5oql6ZSZCiAgICBjdXJyZW50UGxheWVyKCkgeyByZXR1cm4gdGhpcy4kc3RvcmUuc3RhdGUuY3VycmVudFBsYXllciB9LAogICAgaXNPd25lcigpIHsgcmV0dXJuIHRoaXMucm9vbSAmJiB0aGlzLnVzZXIgJiYgdGhpcy5yb29tLm93bmVyX2lkID09PSB0aGlzLnVzZXIuaWQgfSwKICAgIGFsbFJlYWR5KCkgewogICAgICBjb25zdCBwbGF5ZXJzID0gKHRoaXMucm9vbSAmJiB0aGlzLnJvb20ucm9vbV9wbGF5ZXJzKSA/IHRoaXMucm9vbS5yb29tX3BsYXllcnMgOiBbXQogICAgICByZXR1cm4gcGxheWVycy5sZW5ndGggPiAwICYmIHBsYXllcnMuZXZlcnkocCA9PiAhIXAuaXNfcmVhZHkpCiAgICB9LAogICAgY3VycmVudFVzZXJSZWFkeSgpIHsKICAgICAgY29uc3QgdXNlciA9IHRoaXMudXNlcgogICAgICBjb25zdCBwbGF5ZXJzID0gKHRoaXMucm9vbSAmJiB0aGlzLnJvb20ucm9vbV9wbGF5ZXJzKSA/IHRoaXMucm9vbS5yb29tX3BsYXllcnMgOiBbXQogICAgICBpZiAoIXVzZXIpIHJldHVybiBmYWxzZQogICAgICBjb25zdCBtZSA9IHBsYXllcnMuZmluZChwID0+IHAudXNlcl9pZCA9PT0gdXNlci5pZCkKICAgICAgcmV0dXJuICEhKG1lICYmIG1lLmlzX3JlYWR5KQogICAgfSwKICAgIHBsYXllckNvdW50KCkgewogICAgICByZXR1cm4gKHRoaXMucm9vbSAmJiB0aGlzLnJvb20ucm9vbV9wbGF5ZXJzKSA/IHRoaXMucm9vbS5yb29tX3BsYXllcnMubGVuZ3RoIDogMAogICAgfSwKICAgIG93bmVyTmFtZSgpIHsKICAgICAgaWYgKCF0aGlzLnJvb20pIHJldHVybiAnLScKICAgICAgcmV0dXJuIHRoaXMuZ2V0TmFtZUZvcih0aGlzLnJvb20ub3duZXJfaWQpCiAgICB9LAogICAgc2VhdENvdW50KCkgeyByZXR1cm4gKHRoaXMucm9vbSAmJiBOdW1iZXIodGhpcy5yb29tLm1heF9wbGF5ZXJzKSkgPyBOdW1iZXIodGhpcy5yb29tLm1heF9wbGF5ZXJzKSA6IDAgfSwKICAgIHNlYXRzKCkgewogICAgICBjb25zdCBwbGF5ZXJzID0gKHRoaXMucm9vbSAmJiB0aGlzLnJvb20ucm9vbV9wbGF5ZXJzKSA/IHRoaXMucm9vbS5yb29tX3BsYXllcnMgOiBbXQogICAgICBjb25zdCBtYXggPSB0aGlzLnNlYXRDb3VudAogICAgICBjb25zdCBzZWF0cyA9IEFycmF5LmZyb20oeyBsZW5ndGg6IG1heCB9LCAoKSA9PiAoeyBwbGF5ZXI6IG51bGwgfSkpCiAgICAgIC8vIOaUvue9ruW3suiuvue9ruW6p+S9jeeahOeOqeWutgogICAgICBwbGF5ZXJzLmZvckVhY2gocCA9PiB7CiAgICAgICAgY29uc3QgaWR4ID0gdHlwZW9mIHAuc2VhdF9pbmRleCA9PT0gJ251bWJlcicgPyBwLnNlYXRfaW5kZXggOiAtMQogICAgICAgIGlmIChpZHggPj0gMCAmJiBpZHggPCBtYXggJiYgIXNlYXRzW2lkeF0ucGxheWVyKSBzZWF0c1tpZHhdLnBsYXllciA9IHAKICAgICAgfSkKICAgICAgLy8g5bCG5pyq6K6+572u5bqn5L2N55qE546p5a625L6d5qyh5pS+5Yiw56m65L2NCiAgICAgIHBsYXllcnMuZmlsdGVyKHAgPT4gdHlwZW9mIHAuc2VhdF9pbmRleCAhPT0gJ251bWJlcicgfHwgcC5zZWF0X2luZGV4IDwgMCkuZm9yRWFjaChwID0+IHsKICAgICAgICBjb25zdCBlbXB0eUlkeCA9IHNlYXRzLmZpbmRJbmRleChzID0+ICFzLnBsYXllcikKICAgICAgICBpZiAoZW1wdHlJZHggPj0gMCkgc2VhdHNbZW1wdHlJZHhdLnBsYXllciA9IHAKICAgICAgfSkKICAgICAgcmV0dXJuIHNlYXRzCiAgICB9LAogICAgZ2FtZVBoYXNlVGV4dCgpIHsKICAgICAgY29uc3QgcGhhc2VNYXAgPSB7CiAgICAgICAgJ3ByZXBhcmF0aW9uJzogJ+WHhuWkh+mYtuautScsCiAgICAgICAgJ2NvdW50ZG93bic6ICfpooTlgJLorqHml7YnLAogICAgICAgICdpbnRlcm1pc3Npb24nOiAn6Ze05q2H6Zi25q61JywKICAgICAgICAnYXVjdGlvbic6ICfmi43ljZbpmLbmrrUnLAogICAgICAgICdpdGVtJzogJ+mBk+WFt+mYtuautScsCiAgICAgICAgJ3NldHRsZW1lbnQnOiAn57uT566X6Zi25q61JwogICAgICB9CiAgICAgIHJldHVybiBwaGFzZU1hcFt0aGlzLmdhbWVQaGFzZV0gfHwgJ+acquefpemYtuautScKICAgIH0sCiAgIAoKICAgIC8vIOagueaNruW9k+WJjeeUqOaIt+aJi+eJjOiuoeeul+aUtuiXj+mbhuaYvuekuuaVsOaNru+8jOW4pue8k+WtmOWtl+aute+8jOS+v+S6juaooeadv+ebtOaOpeW8leeUqAogICAgY29sbGVjdGlvbnNDb21wdXRlZCgpIHsKICAgICAgY29uc3QgbGlzdCA9IEFycmF5LmlzQXJyYXkodGhpcy5jb2xsZWN0aW9ucykgPyB0aGlzLmNvbGxlY3Rpb25zIDogW10KICAgICAgLy8g5LuF5bGV56S655So5oi35omL54mM5Lit6Iez5bCR5YyF5ZCrMeS7tuivpeaUtuiXj+mbhueahOaDheWGtQogICAgICByZXR1cm4gbGlzdAogICAgICAgIC5tYXAoY29sID0+IHsKICAgICAgICAgIGNvbnN0IGN1cnJlbnQgPSB0aGlzLmdldEN1cnJlbnRDb2xsZWN0aW9uQ291bnQoY29sKQogICAgICAgICAgY29uc3QgcHJvZ3Jlc3MgPSBNYXRoLm1pbigoY3VycmVudCAvIChjb2wucmVxdWlyZWRDb3VudCB8fCAxKSkgKiAxMDAsIDEwMCkKICAgICAgICAgIHJldHVybiB7IC4uLmNvbCwgX2N1cnJlbnQ6IGN1cnJlbnQsIF9wcm9ncmVzczogcHJvZ3Jlc3MgfQogICAgICAgIH0pCiAgICAgICAgLmZpbHRlcihjb2wgPT4gY29sLl9jdXJyZW50ID4gMCkKICAgIH0sCgogICAgLy8g5ZCI5bm26IGK5aSp5LiO57O757uf5pel5b+X5Li65ZCM5LiA5L+h5oGv5rWB77yM5oyJ5pe26Ze05o6S5bqPCiAgICBjaGF0RmVlZCgpIHsKICAgICAgY29uc3QgbG9ncyA9ICh0aGlzLmdhbWVMb2cgfHwgW10pLm1hcCgobCwgaWR4KSA9PiAoewogICAgICAgIGlkOiBgbG9nLSR7bC50aW1lc3RhbXAgfHwgaWR4fWAsCiAgICAgICAgdHlwZTogJ2xvZycsCiAgICAgICAgdXNlcklkOiBudWxsLAogICAgICAgIHVzZXJuYW1lOiAn57O757ufJywKICAgICAgICBjb250ZW50OiBsLm1lc3NhZ2UsCiAgICAgICAgdGltZXN0YW1wOiBsLnRpbWVzdGFtcCB8fCAwCiAgICAgIH0pKQogICAgICBjb25zdCBjaGF0cyA9ICh0aGlzLmNoYXRNZXNzYWdlcyB8fCBbXSkubWFwKG0gPT4gKHsgLi4ubSwgdHlwZTogJ2NoYXQnIH0pKQogICAgICBjb25zdCBtZXJnZWQgPSBbLi4ubG9ncywgLi4uY2hhdHNdCiAgICAgIHJldHVybiBtZXJnZWQuc29ydCgoYSwgYikgPT4gKGEudGltZXN0YW1wIHx8IDApIC0gKGIudGltZXN0YW1wIHx8IDApKQogICAgfSwKICAgIC8vIOaatOmcsuWvueivnemFjee9ruS+m+aooeadv+S9v+eUqAogICAgZmlyc3RMb2dpbkNvbmZpZygpIHsgcmV0dXJuIGZpcnN0TG9naW5EaWFsb2d1ZUNvbmZpZyB9LAogICAgLy8g5b2T5YmN6K6y6L+w6KeS6Imy6YWN572u5LiO5ZCN56ewCiAgICBuYXJyYXRpb25DaGFyYWN0ZXJOYW1lKCkgeyByZXR1cm4gKHRoaXMuZ2V0Q3VycmVudExhbmd1YWdlKCkgPT09ICd6aC1DTicpID8gJ+Wkp+acqOWNmuWjqycgOiAnRHIuIEFsaW5hJyB9LAogICAgbmFycmF0aW9uQ2hhcmFjdGVyKCkgewogICAgICBjb25zdCBrZXkgPSB0aGlzLm5hcnJhdGlvbkNoYXJhY3Rlck5hbWUKICAgICAgY29uc3QgY2hhcnMgPSBmaXJzdExvZ2luRGlhbG9ndWVDb25maWcgJiYgZmlyc3RMb2dpbkRpYWxvZ3VlQ29uZmlnLmNoYXJhY3RlcnMKICAgICAgcmV0dXJuIChjaGFycyAmJiBjaGFyc1trZXldKSA/IGNoYXJzW2tleV0gOiB7IGltYWdlOiAnL2ltYWdlcy9ndWlkZS5wbmcnLCBwb3NpdGlvbjogJ3JpZ2h0JywgY29sb3I6ICcjM2I4MmY2JyB9CiAgICB9CiAgfSwKICBhc3luYyBtb3VudGVkKCkgewogICAgY29uc3Qgcm9vbUlkID0gdGhpcy4kcm91dGUucXVlcnkucm9vbUlkCiAgICBpZiAocm9vbUlkKSB0aGlzLiRzdG9yZS5jb21taXQoJ1NFVF9ST09NX0lEJywgcm9vbUlkKQogICAgYXdhaXQgdGhpcy5pbml0aWFsaXplR2FtZSgpCiAgICBhd2FpdCB0aGlzLmxvYWRSb29tU3RhdGUoKQogICAgLy8gbG9hZFJvb21TdGF0ZSDkuK3lt7Lnu4/osIPnlKjkuoYgbG9hZEFsbFBsYXllcnNBcnRpZmFjdHPvvIzov5nph4znoa7kv53mlbDmja7liqDovb0KICAgIGF3YWl0IHRoaXMuc3Vic2NyaWJlUm9vbVJlYWx0aW1lKCkKICB9LAogIGJlZm9yZURlc3Ryb3koKSB7CiAgICB0aGlzLnVuc3Vic2NyaWJlUm9vbVJlYWx0aW1lKCkKICAgIGlmICh0aGlzLnJlZnJlc2hUaW1lcikgeyBjbGVhckludGVydmFsKHRoaXMucmVmcmVzaFRpbWVyKTsgdGhpcy5yZWZyZXNoVGltZXIgPSBudWxsIH0KICAgIGlmICh0aGlzLmF1Y3Rpb25UaW1lcikgeyBjbGVhckludGVydmFsKHRoaXMuYXVjdGlvblRpbWVyKTsgdGhpcy5hdWN0aW9uVGltZXIgPSBudWxsIH0KICAgIGlmICh0aGlzLnR5cGluZ1RpbWVyKSB7IGNsZWFySW50ZXJ2YWwodGhpcy50eXBpbmdUaW1lcik7IHRoaXMudHlwaW5nVGltZXIgPSBudWxsIH0KICAgIHRoaXMuJHNldCh0aGlzLCAnYXVjdGlvbkNvdW50ZG93bicsIDApCiAgfSwKICB3YXRjaDogewogICAgZ2FtZUxvZygpIHsKICAgICAgdGhpcy4kbmV4dFRpY2soKCkgPT4gewogICAgICAgIGNvbnN0IGNoYXRDb250YWluZXIgPSB0aGlzLiRyZWZzLmNoYXRDb250YWluZXIKICAgICAgICBpZiAoY2hhdENvbnRhaW5lcikgeyBjaGF0Q29udGFpbmVyLnNjcm9sbFRvcCA9IGNoYXRDb250YWluZXIuc2Nyb2xsSGVpZ2h0IH0KICAgICAgfSkKICAgIH0KICB9LAogIG1ldGhvZHM6IHsKICAgIC8vIOWOu+aOieaooeaLn+WIneWni+WMlueOqeWutu+8jOaUueS4uuS9v+eUqOaIv+mXtOeahOWunumZheeOqeWutuWIl+ihqAogICAgYXN5bmMgaW5pdGlhbGl6ZUdhbWUoKSB7CiAgICAgIGNvbnN0IGFydGlmYWN0cyA9IGF3YWl0IHRoaXMubG9hZEFydGlmYWN0cygpCiAgICAgIHRoaXMuYXJ0aWZhY3RNYXAgPSBhcnRpZmFjdHMucmVkdWNlKChhY2MsIGEpID0+IHsgYWNjW2EuaWRdID0gYTsgcmV0dXJuIGFjYyB9LCB7fSkKICAgICAgYXdhaXQgdGhpcy5sb2FkQ29sbGVjdGlvbnMoKQogICAgfSwKICAgIGFzeW5jIHN1YnNjcmliZVJvb21SZWFsdGltZSgpIHsKICAgICAgY29uc3QgcmlkID0gdGhpcy4kc3RvcmUuc3RhdGUucm9vbUlkCiAgICAgIGlmICghcmlkKSByZXR1cm4KICAgICAgY29uc3Qgc3VwYWJhc2UgPSBnZXRTdXBhYmFzZSgpCiAgICAgIGNvbnN0IHsgcm9vbUNoYW5uZWwsIGJyb2FkY2FzdENoYW5uZWwgfSA9IHN1YnNjcmliZVJvb21SZWFsdGltZVNlcnZpY2UoCiAgICAgICAgeyByb29tSWQ6IHJpZCwgc3VwYWJhc2UsIG9uTG9hZFJvb21TdGF0ZTogdGhpcy5sb2FkUm9vbVN0YXRlIH0sCiAgICAgICAgewogICAgICAgICAgb25HYW1lU3RhcnRlZDogYXN5bmMgKF9wYXlsb2FkKSA9PiB7CiAgICAgICAgICAgIC8vIOmYsuatoumHjeWkjeWQr+WKqOWkmuS4quWAkuiuoeaXtgogICAgICAgICAgICBpZiAodGhpcy5jb3VudGRvd25JblByb2dyZXNzKSByZXR1cm4KICAgICAgICAgICAgdGhpcy5jb3VudGRvd25JblByb2dyZXNzID0gdHJ1ZQogICAgICAgICAgICAKICAgICAgICAgICAgLy8g5paw5bGA5byA5aeL77ya6YeN572u6IGK5aSp5raI5oGv5ZKM5Lu35YC85pWw5o2uCiAgICAgICAgICAgIHRoaXMuY2hhdE1lc3NhZ2VzID0gW10KICAgICAgICAgICAgdGhpcy5hbGxQbGF5ZXJzQXJ0aWZhY3RzID0ge30KICAgICAgICAgICAgLy8g6YeN572u5Zue5ZCI5pWwCiAgICAgICAgICAgIHRoaXMuJHN0b3JlLmNvbW1pdCgnUkVTRVRfUk9VTkQnKQogICAgICAgICAgICB0aGlzLiRzdG9yZS5jb21taXQoJ1NFVF9ST1VORF9UT1RBTCcsIDYpCiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLiRzdG9yZS5jb21taXQoJ1NFVF9HQU1FX1BIQVNFJywgJ2NvdW50ZG93bicpCiAgICAgICAgICAgIHRoaXMuJHNldCh0aGlzLCAnYXVjdGlvbkNvdW50ZG93bicsIDUpCiAgICAgICAgICAgIGNvbnN0IG1lID0gKHRoaXMucm9vbSAmJiB0aGlzLnJvb20ucm9vbV9wbGF5ZXJzID8gdGhpcy5yb29tLnJvb21fcGxheWVycyA6IFtdKS5maW5kKHAgPT4gcC51c2VyX2lkID09PSB0aGlzLiRzdG9yZS5zdGF0ZS51c2VyLmlkKQogICAgICAgICAgICBpZiAobWUpIHsKICAgICAgICAgICAgICB0aGlzLiRzdG9yZS5jb21taXQoJ1NFVF9DVVJSRU5UX1BMQVlFUicsIHsgaWQ6IG1lLnVzZXJfaWQsIG5hbWU6IHRoaXMuZ2V0TmFtZUZvcihtZS51c2VyX2lkKSwgZW5lcmd5OiA1MCwgYXJ0aWZhY3RzOiBbXSwgaXRlbXM6IFtdIH0pCiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuYXVjdGlvblRpbWVyKSB7IGNsZWFySW50ZXJ2YWwodGhpcy5hdWN0aW9uVGltZXIpOyB0aGlzLmF1Y3Rpb25UaW1lciA9IG51bGwgfQogICAgICAgICAgICB0aGlzLiRuZXh0VGljaygoKSA9PiB7CiAgICAgICAgICAgICAgc3RhcnRDb3VudGRvd24oewogICAgICAgICAgICAgICAgc2Vjb25kczogNSwKICAgICAgICAgICAgICAgIG9uVGljazogKHMpID0+IHsgdGhpcy4kc2V0KHRoaXMsICdhdWN0aW9uQ291bnRkb3duJywgcykgfSwKICAgICAgICAgICAgICAgIG9uRG9uZTogYXN5bmMgKCkgPT4geyB0aGlzLmNvdW50ZG93bkluUHJvZ3Jlc3MgPSBmYWxzZTsgaWYgKHRoaXMuaXNPd25lcikgeyBhd2FpdCB0aGlzLmF1dG9TdGFydEF1Y3Rpb24oKSB9IH0sCiAgICAgICAgICAgICAgICBnZXRSZWY6ICgpID0+IHRoaXMuYXVjdGlvblRpbWVyLAogICAgICAgICAgICAgICAgc2V0UmVmOiAoaWQpID0+IHsgdGhpcy5hdWN0aW9uVGltZXIgPSBpZCB9LAogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0pCiAgICAgICAgICB9LAogICAgICAgICAgb25BdWN0aW9uU3RhcnRlZDogYXN5bmMgKGR1cmF0aW9uLCBwYXlsb2FkKSA9PiB7IAogICAgICAgICAgICAvLyDnoa7kv53miYDmnInnjqnlrrbpg73og73nnIvliLDmi43ljZbmlbDmja4KICAgICAgICAgICAgYXdhaXQgdGhpcy5sb2FkUm9vbVN0YXRlKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIOWQjOatpeWbnuWQiOaVsO+8iOWmguaenOW5v+aSreS4reWMheWQq+S6huWbnuWQiOS/oeaBr++8iQogICAgICAgICAgICBpZiAocGF5bG9hZCAmJiB0eXBlb2YgcGF5bG9hZC5yb3VuZEN1cnJlbnQgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgICAgdGhpcy4kc3RvcmUuY29tbWl0KCdTRVRfUk9VTkRfQ1VSUkVOVCcsIHBheWxvYWQucm91bmRDdXJyZW50KQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwYXlsb2FkICYmIHR5cGVvZiBwYXlsb2FkLnJvdW5kVG90YWwgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgICAgdGhpcy4kc3RvcmUuY29tbWl0KCdTRVRfUk9VTkRfVE9UQUwnLCBwYXlsb2FkLnJvdW5kVG90YWwpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc3RhcnRBdWN0aW9uVGltZXIoZHVyYXRpb24pIAogICAgICAgICAgfSwKICAgICAgICAgIG9uQmlkVXBkYXRlOiAoeyBhdWN0aW9uSWQsIGhpZ2hlc3RCaWQsIGhpZ2hlc3RCaWRkZXIgfSkgPT4gewogICAgICAgICAgICBpZiAoIWF1Y3Rpb25JZCkgcmV0dXJuCiAgICAgICAgICAgIGNvbnN0IGxpc3QgPSB0aGlzLiRzdG9yZS5zdGF0ZS5jdXJyZW50QXVjdGlvbnMgfHwgW10KICAgICAgICAgICAgY29uc3QgaWR4ID0gbGlzdC5maW5kSW5kZXgoYSA9PiBhLmlkID09PSBhdWN0aW9uSWQpCiAgICAgICAgICAgIGlmIChpZHggPj0gMCkgewogICAgICAgICAgICAgIGNvbnN0IG5leHQgPSB7IC4uLmxpc3RbaWR4XSwgaGlnaGVzdEJpZCwgaGlnaGVzdEJpZGRlciB9CiAgICAgICAgICAgICAgdGhpcy4kc3RvcmUuY29tbWl0KCdBRERfT1JfVVBEQVRFX0FVQ1RJT04nLCBuZXh0KQogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgLy8g5pen5Zue5ZCI5bm/5pKt5bey56e76Zmk77yM57uf5LiA5pys5Zyw5o6o6L+b77yM5LiN5YaN5o6l5pS26K+l5LqL5Lu2CiAgICAgICAgICBvblJvdW5kVXBkYXRlZDogKF9kYXRhKSA9PiB7fSwKICAgICAgICAgIG9uR2FtZUVuZGVkOiAoKSA9PiB7CiAgICAgICAgICAgIHRoaXMuJHN0b3JlLmNvbW1pdCgnU0VUX0dBTUVfUEhBU0UnLCAnc2V0dGxlbWVudCcpCiAgICAgICAgdGhpcy5jb21wdXRlRmluYWxTY29yZXMoKS5maW5hbGx5KCgpID0+IHsgdGhpcy5zaG93R2FtZUVuZERpYWxvZyA9IHRydWUgfSkKICAgICAgICAgICAgaWYgKHRoaXMuYXVjdGlvblRpbWVyKSB7IGNsZWFySW50ZXJ2YWwodGhpcy5hdWN0aW9uVGltZXIpOyB0aGlzLmF1Y3Rpb25UaW1lciA9IG51bGwgfQogICAgICAgICAgfSwKICAgICAgICAgIG9uQXVjdGlvbkVuZGVkOiBhc3luYyAoKSA9PiB7IGF3YWl0IHRoaXMubG9hZFJvb21TdGF0ZSgpIH0sCiAgICAgICAgICBvbkNoYXRNZXNzYWdlOiAobWVzc2FnZSkgPT4gewogICAgICAgICAgICAvLyDpgb/lhY3ph43lpI3mt7vliqDmtojmga8KICAgICAgICAgICAgaWYgKCFtZXNzYWdlIHx8ICFtZXNzYWdlLmlkKSByZXR1cm4KICAgICAgICAgICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLmNoYXRNZXNzYWdlcy5maW5kKG0gPT4gbS5pZCA9PT0gbWVzc2FnZS5pZCB8fCAobS51c2VySWQgPT09IG1lc3NhZ2UudXNlcklkICYmIG0udGltZXN0YW1wID09PSBtZXNzYWdlLnRpbWVzdGFtcCAmJiBtLmNvbnRlbnQgPT09IG1lc3NhZ2UuY29udGVudCkpCiAgICAgICAgICAgIGlmIChleGlzdGluZykgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLmNoYXRNZXNzYWdlcy5wdXNoKG1lc3NhZ2UpCiAgICAgICAgICAgIHRoaXMuJG5leHRUaWNrKCgpID0+IHsKICAgICAgICAgICAgICBjb25zdCBjaGF0Q29udGFpbmVyID0gdGhpcy4kcmVmcy5jaGF0Q29udGFpbmVyCiAgICAgICAgICAgICAgaWYgKGNoYXRDb250YWluZXIpIHsgY2hhdENvbnRhaW5lci5zY3JvbGxUb3AgPSBjaGF0Q29udGFpbmVyLnNjcm9sbEhlaWdodCB9CiAgICAgICAgICAgIH0pCiAgICAgICAgICB9LAogICAgICAgIH0sCiAgICAgICAgKCkgPT4geyBpZiAoIXRoaXMucmVmcmVzaFRpbWVyKSB7IHRoaXMucmVmcmVzaFRpbWVyID0gc2V0SW50ZXJ2YWwodGhpcy5sb2FkUm9vbVN0YXRlLCAxMDAwKSB9IH0KICAgICAgKQogICAgICB0aGlzLnJvb21DaGFubmVsID0gcm9vbUNoYW5uZWwKICAgICAgdGhpcy5icm9hZGNhc3RDaGFubmVsID0gYnJvYWRjYXN0Q2hhbm5lbAogICAgfSwKICAgIHVuc3Vic2NyaWJlUm9vbVJlYWx0aW1lKCkgewogICAgICB1bnN1YnNjcmliZVJvb21SZWFsdGltZVNlcnZpY2UodGhpcy5yb29tQ2hhbm5lbCwgdGhpcy5icm9hZGNhc3RDaGFubmVsKQogICAgICB0aGlzLnJvb21DaGFubmVsID0gbnVsbAogICAgICB0aGlzLmJyb2FkY2FzdENoYW5uZWwgPSBudWxsCiAgICB9LAogICAgYXN5bmMgbG9hZFJvb21TdGF0ZSgpIHsKICAgICAgY29uc3QgcmlkID0gdGhpcy4kc3RvcmUuc3RhdGUucm9vbUlkCiAgICAgIGNvbnN0IHN1cGFiYXNlID0gZ2V0U3VwYWJhc2UoKQogICAgICBhd2FpdCBsb2FkUm9vbVN0YXRlU2VydmljZSh7CiAgICAgICAgcm9vbUlkOiByaWQsCiAgICAgICAgcm9vbVNlcnZpY2UsCiAgICAgICAgc3VwYWJhc2UsCiAgICAgICAgYXJ0aWZhY3RNYXA6IHRoaXMuYXJ0aWZhY3RNYXAsCiAgICAgICAgc3RvcmU6IHRoaXMuJHN0b3JlLAogICAgICAgIHNldFJvb206IChyb29tKSA9PiB7IHRoaXMucm9vbSA9IHJvb20gfSwKICAgICAgICBzZXRQcm9maWxlTWFwOiAobWFwKSA9PiB7IHRoaXMucHJvZmlsZU1hcCA9IG1hcCB9LAogICAgICAgIHNldEdhbWVQaGFzZTogKHBoYXNlKSA9PiB7IHRoaXMuJHN0b3JlLmNvbW1pdCgnU0VUX0dBTUVfUEhBU0UnLCBwaGFzZSkgfSwKICAgICAgICBjbGVhckF1Y3Rpb25UaW1lcjogKCkgPT4geyBpZiAodGhpcy5hdWN0aW9uVGltZXIpIHsgY2xlYXJJbnRlcnZhbCh0aGlzLmF1Y3Rpb25UaW1lcik7IHRoaXMuYXVjdGlvblRpbWVyID0gbnVsbCB9IH0sCiAgICAgICAgc2V0QXVjdGlvbkNvdW50ZG93bjogKG4pID0+IHsgdGhpcy4kc2V0KHRoaXMsICdhdWN0aW9uQ291bnRkb3duJywgbikgfSwKICAgICAgICBvblNob3dHYW1lRW5kOiAoKSA9PiB7IHRoaXMuc2hvd0dhbWVFbmREaWFsb2cgPSB0cnVlOyBzZXRUaW1lb3V0KCgpID0+IHsgdGhpcy5oYW5kbGVHYW1lRW5kKCkgfSwgMzAwMCkgfSwKICAgICAgfSkKICAgICAgLy8g5Yqg6L295omA5pyJ546p5a6255qE5omL54mM5pWw5o2u77yM55So5LqO5Lu35YC86K6h566XCiAgICAgIGF3YWl0IHRoaXMubG9hZEFsbFBsYXllcnNBcnRpZmFjdHMoKQogICAgICAvLyDlpoLmnpzliLfmlrDlkI7lj5HnjrDku43mnInmtLvot4Pmi43ljZbvvIzkvYbmnKzlnLDml6DlgJLorqHml7bvvIzliJnnlKjlvZPliY3liankvZnml7bpl7TlkK/liqjnu5/kuIDlgJLorqHml7YKICAgICAgY29uc3QgYXVjdGlvbnMgPSB0aGlzLiRzdG9yZS5zdGF0ZS5jdXJyZW50QXVjdGlvbnMgfHwgW10KICAgICAgaWYgKHRoaXMuJHN0b3JlLnN0YXRlLmdhbWVQaGFzZSA9PT0gJ2F1Y3Rpb24nICYmIGF1Y3Rpb25zLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25zdCByZW1haW5pbmcgPSBOdW1iZXIodGhpcy5hdWN0aW9uQ291bnRkb3duIHx8IDApCiAgICAgICAgaWYgKCF0aGlzLmF1Y3Rpb25UaW1lciAmJiByZW1haW5pbmcgPiAwKSB7CiAgICAgICAgICBzdGFydENvdW50ZG93bih7CiAgICAgICAgICAgIHNlY29uZHM6IHJlbWFpbmluZywKICAgICAgICAgICAgb25UaWNrOiAocykgPT4geyB0aGlzLiRzZXQodGhpcywgJ2F1Y3Rpb25Db3VudGRvd24nLCBzKTsgfSwKICAgICAgICAgICAgb25Eb25lOiBhc3luYyAoKSA9PiB7IGF3YWl0IHRoaXMub25BdWN0aW9uVGltZVVwKCkgfSwKICAgICAgICAgICAgZ2V0UmVmOiAoKSA9PiB0aGlzLmF1Y3Rpb25UaW1lciwKICAgICAgICAgICAgc2V0UmVmOiAoaWQpID0+IHsgdGhpcy5hdWN0aW9uVGltZXIgPSBpZCB9LAogICAgICAgICAgfSkKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAKICAgIC8vIOWKoOi9veaJgOacieeOqeWutueahOaJi+eJjOaVsOaNrgogICAgYXN5bmMgbG9hZEFsbFBsYXllcnNBcnRpZmFjdHMoKSB7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgcmlkID0gdGhpcy4kc3RvcmUuc3RhdGUucm9vbUlkCiAgICAgICAgaWYgKCFyaWQpIHsKICAgICAgICAgIHRoaXMuYWxsUGxheWVyc0FydGlmYWN0cyA9IHt9CiAgICAgICAgICByZXR1cm4KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgY29uc3Qgc3VwYWJhc2UgPSBnZXRTdXBhYmFzZSgpCiAgICAgICAgLy8g6I635Y+W5oi/6Ze05YaF5omA5pyJ546p5a6255qE5omL54mM5pWw5o2uCiAgICAgICAgY29uc3QgeyBkYXRhOiBhbGxBcnRpZmFjdHMgfSA9IGF3YWl0IHN1cGFiYXNlCiAgICAgICAgICAuZnJvbSgncm9vbV9hcnRpZmFjdHMnKQogICAgICAgICAgLnNlbGVjdCgnb3duZXJfdXNlcl9pZCwgYXJ0aWZhY3RfaWQnKQogICAgICAgICAgLmVxKCdyb29tX2lkJywgcmlkKQogICAgICAgIAogICAgICAgIC8vIOaMieeOqeWutklE5YiG57uECiAgICAgICAgY29uc3QgcGxheWVyQXJ0aWZhY3RzTWFwID0ge30KICAgICAgICBpZiAoYWxsQXJ0aWZhY3RzICYmIGFsbEFydGlmYWN0cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICBhbGxBcnRpZmFjdHMuZm9yRWFjaChyb3cgPT4gewogICAgICAgICAgICBjb25zdCB1c2VySWQgPSByb3cub3duZXJfdXNlcl9pZAogICAgICAgICAgICBpZiAoIXBsYXllckFydGlmYWN0c01hcFt1c2VySWRdKSB7CiAgICAgICAgICAgICAgcGxheWVyQXJ0aWZhY3RzTWFwW3VzZXJJZF0gPSBbXQogICAgICAgICAgICB9CiAgICAgICAgICAgIHBsYXllckFydGlmYWN0c01hcFt1c2VySWRdLnB1c2gocm93LmFydGlmYWN0X2lkKQogICAgICAgICAgfSkKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8g5L2/55SoIFZ1ZS5zZXQg56Gu5L+d5ZON5bqU5byP5pu05pawCiAgICAgICAgdGhpcy4kc2V0KHRoaXMsICdhbGxQbGF5ZXJzQXJ0aWZhY3RzJywgcGxheWVyQXJ0aWZhY3RzTWFwKQogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS53YXJuKCdbZ2FtZV0gbG9hZEFsbFBsYXllcnNBcnRpZmFjdHMgZmFpbGVkJywgZSkKICAgICAgICB0aGlzLmFsbFBsYXllcnNBcnRpZmFjdHMgPSB7fQogICAgICB9CiAgICB9LAogICAgYXN5bmMgdG9nZ2xlUmVhZHkoKSB7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgcmlkID0gdGhpcy4kc3RvcmUuc3RhdGUucm9vbUlkCiAgICAgICAgY29uc3QgdWlkID0gdGhpcy4kc3RvcmUuc3RhdGUudXNlciAmJiB0aGlzLiRzdG9yZS5zdGF0ZS51c2VyLmlkCiAgICAgICAgaWYgKCFyaWQgfHwgIXVpZCkgcmV0dXJuCiAgICAgICAgYXdhaXQgdG9nZ2xlUmVhZHlBY3Rpb24oeyByb29tSWQ6IHJpZCwgdXNlcklkOiB1aWQsIHJvb206IHRoaXMucm9vbSwgcm9vbVNlcnZpY2UsIHJlbG9hZDogdGhpcy5sb2FkUm9vbVN0YXRlIH0pCiAgICAgIH0gY2F0Y2ggKGUpIHsgY29uc29sZS53YXJuKCdbZ2FtZV0gdG9nZ2xlUmVhZHkgZmFpbGVkJywgZSkgfQogICAgfSwKICAgIGFzeW5jIG1vdmVUb1NlYXQoaWR4KSB7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgcmlkID0gdGhpcy4kc3RvcmUuc3RhdGUucm9vbUlkCiAgICAgICAgY29uc3QgdWlkID0gdGhpcy4kc3RvcmUuc3RhdGUudXNlciAmJiB0aGlzLiRzdG9yZS5zdGF0ZS51c2VyLmlkCiAgICAgICAgaWYgKCFyaWQgfHwgIXVpZCkgcmV0dXJuCiAgICAgICAgY29uc3QgdGFyZ2V0U2VhdCA9IHsgaW5kZXg6IGlkeCwgcGxheWVyOiB0aGlzLnNlYXRzW2lkeF0gJiYgdGhpcy5zZWF0c1tpZHhdLnBsYXllciB9CiAgICAgICAgYXdhaXQgbW92ZVRvU2VhdEFjdGlvbih7IHJvb21JZDogcmlkLCB1c2VySWQ6IHVpZCwgcm9vbTogdGhpcy5yb29tLCBzZWF0czogdGFyZ2V0U2VhdCwgcm9vbVNlcnZpY2UsIHJlbG9hZDogdGhpcy5sb2FkUm9vbVN0YXRlIH0pCiAgICAgIH0gY2F0Y2ggKGUpIHsgY29uc29sZS53YXJuKCdbZ2FtZV0gbW92ZVRvU2VhdCBmYWlsZWQnLCBlKSB9CiAgICB9LAogICAgYXN5bmMgbGVhdmVSb29tKCkgewogICAgICB0cnkgewogICAgICAgIGNvbnN0IHJpZCA9IHRoaXMuJHN0b3JlLnN0YXRlLnJvb21JZAogICAgICAgIGNvbnN0IHVpZCA9IHRoaXMuJHN0b3JlLnN0YXRlLnVzZXIgJiYgdGhpcy4kc3RvcmUuc3RhdGUudXNlci5pZAogICAgICAgIGlmICghcmlkIHx8ICF1aWQpIHJldHVybgogICAgICAgIGF3YWl0IGxlYXZlUm9vbUFjdGlvbih7CiAgICAgICAgICByb29tSWQ6IHJpZCwKICAgICAgICAgIHVzZXJJZDogdWlkLAogICAgICAgICAgY2xlYXJBdWN0aW9uVGltZXI6ICgpID0+IHsgaWYgKHRoaXMuYXVjdGlvblRpbWVyKSB7IGNsZWFySW50ZXJ2YWwodGhpcy5hdWN0aW9uVGltZXIpOyB0aGlzLmF1Y3Rpb25UaW1lciA9IG51bGwgfSB9LAogICAgICAgICAgc2V0Q291bnRkb3duOiAobikgPT4geyB0aGlzLiRzZXQodGhpcywgJ2F1Y3Rpb25Db3VudGRvd24nLCBuKSB9LAogICAgICAgICAgc3RvcmU6IHRoaXMuJHN0b3JlLAogICAgICAgICAgYXVjdGlvblNlcnZpY2UsCiAgICAgICAgICByb29tU2VydmljZSwKICAgICAgICAgIHVuc3Vic2NyaWJlOiAoKSA9PiB0aGlzLnVuc3Vic2NyaWJlUm9vbVJlYWx0aW1lKCksCiAgICAgICAgICBzZXRSb29tSWQ6ICh2KSA9PiB0aGlzLiRzdG9yZS5jb21taXQoJ1NFVF9ST09NX0lEJywgdiksCiAgICAgICAgICBzZXRMb2NhbFJvb206ICh2KSA9PiB7IHRoaXMucm9vbSA9IHYgfSwKICAgICAgICAgIG5hdmlnYXRlVG9Sb29tczogKCkgPT4gdGhpcy4kcm91dGVyLnB1c2goJy9yb29tcycpLAogICAgICAgIH0pCiAgICAgIH0gY2F0Y2ggKGUpIHsgY29uc29sZS53YXJuKCdbZ2FtZV0gbGVhdmVSb29tIGZhaWxlZCcsIGUpIH0KICAgIH0sCiAgICAKICAgIC8vIOa4uOaIj+e7k+adn+WkhOeQhgogICAgYXN5bmMgaGFuZGxlR2FtZUVuZCgpIHsKICAgICAgdHJ5IHsKICAgICAgICBjb25zdCByaWQgPSB0aGlzLiRzdG9yZS5zdGF0ZS5yb29tSWQKICAgICAgICBpZiAocmlkKSB7CiAgICAgICAgICAvLyDlsIbmiL/pl7TnirbmgIHph43nva7kuLogd2FpdGluZ++8jOS+v+S6jue7p+e7reaIv+mXtOWGheWHhuWkhy/mlrDkuIDlsYAKICAgICAgICAgIGNvbnN0IHN1cGFiYXNlID0gZ2V0U3VwYWJhc2UoKQogICAgICAgICAgYXdhaXQgc3VwYWJhc2UuZnJvbSgncm9vbXMnKS51cGRhdGUoeyBzdGF0dXM6ICd3YWl0aW5nJyB9KS5lcSgnaWQnLCByaWQpCiAgICAgICAgICAvLyDot7Povazlm57miL/pl7TpobXpnaLvvIjmuLjmiI/pobXmkLrluKYgcm9vbUlkIOWNs+aYr+aIv+mXtOeVjOmdou+8iQogICAgICAgICAgdGhpcy4kcm91dGVyLnB1c2goeyBwYXRoOiAnL2dhbWUnLCBxdWVyeTogeyByb29tSWQ6IHJpZCwgZ2FtZUVuZGVkOiAndHJ1ZScgfSB9KQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLiRyb3V0ZXIucHVzaCgnL3Jvb21zJykKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLndhcm4oJ1tnYW1lXSBoYW5kbGVHYW1lRW5kIGZhaWxlZCcsIGUpCiAgICAgICAgLy8g5YWc5bqV6Lez5Zue5oi/6Ze05YiX6KGoCiAgICAgICAgdGhpcy4kcm91dGVyLnB1c2goJy9yb29tcycpCiAgICAgIH0KICAgIH0sCiAgICBhc3luYyBzdGFydEdhbWUoKSB7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgcmlkID0gdGhpcy4kc3RvcmUuc3RhdGUucm9vbUlkCiAgICAgICAgY29uc3QgdWlkID0gdGhpcy4kc3RvcmUuc3RhdGUudXNlciAmJiB0aGlzLiRzdG9yZS5zdGF0ZS51c2VyLmlkCiAgICAgICAgaWYgKCFyaWQgfHwgIXVpZCB8fCAhdGhpcy5pc093bmVyIHx8ICF0aGlzLmFsbFJlYWR5KSByZXR1cm4KICAgICAgICAvLyDmlrDlsYDlvIDlp4vliY3ph43nva7ns7vnu5/ml6Xlv5fjgIHogYrlpKnmtojmga/lkozku7flgLzmlbDmja4KICAgICAgICB0cnkgeyB0aGlzLiRzdG9yZS5jb21taXQoJ0NMRUFSX0dBTUVfTE9HJykgfSBjYXRjaCAoXykge30KICAgICAgICB0aGlzLmNoYXRNZXNzYWdlcyA9IFtdCiAgICAgICAgdGhpcy5hbGxQbGF5ZXJzQXJ0aWZhY3RzID0ge30KICAgICAgICBhd2FpdCByb29tU2VydmljZS5zdGFydEdhbWUocmlkLCB1aWQpCiAgICAgICAgY29uc3Qgc3VwYWJhc2UgPSBnZXRTdXBhYmFzZSgpCiAgICAgICAgdGhpcy5yb3VuZENvdW50ID0gMAogICAgICAgIGF3YWl0IHN0YXJ0R2FtZUZsb3coewogICAgICAgICAgcm9vbUlkOiByaWQsCiAgICAgICAgICB1c2VySWQ6IHVpZCwKICAgICAgICAgIGlzT3duZXI6IHRoaXMuaXNPd25lciwKICAgICAgICAgIGFsbFJlYWR5OiB0aGlzLmFsbFJlYWR5LAogICAgICAgICAgc3RvcmU6IHRoaXMuJHN0b3JlLAogICAgICAgICAgc3VwYWJhc2UsCiAgICAgICAgICBzZXRDb3VudGRvd246IChuKSA9PiB0aGlzLiRzZXQodGhpcywgJ2F1Y3Rpb25Db3VudGRvd24nLCBuKSwKICAgICAgICAgIHNldEN1cnJlbnRQbGF5ZXJGcm9tUm9vbTogKCkgPT4gewogICAgICAgICAgICBjb25zdCBtZSA9ICh0aGlzLnJvb20gJiYgdGhpcy5yb29tLnJvb21fcGxheWVycyA/IHRoaXMucm9vbS5yb29tX3BsYXllcnMgOiBbXSkuZmluZChwID0+IHAudXNlcl9pZCA9PT0gdWlkKQogICAgICAgICAgICBpZiAobWUpIHsgdGhpcy4kc3RvcmUuY29tbWl0KCdTRVRfQ1VSUkVOVF9QTEFZRVInLCB7IGlkOiBtZS51c2VyX2lkLCBuYW1lOiB0aGlzLmdldE5hbWVGb3IobWUudXNlcl9pZCksIGVuZXJneTogNTAsIGFydGlmYWN0czogW10sIGl0ZW1zOiBbXSB9KSB9CiAgICAgICAgICB9LAogICAgICAgICAgb25Db3VudGRvd25Eb25lOiBhc3luYyAoKSA9PiB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzT3duZXIpIHsgYXdhaXQgdGhpcy5hdXRvU3RhcnRBdWN0aW9uKCkgfQogICAgICAgICAgfSwKICAgICAgICB9KQogICAgICAgIC8vIOaIv+S4u+acrOWcsOS5n+WQr+WKqOmihOWAkuiuoeaXtu+8jOmYsuatouW5v+aSreS4jeWbnuS8oOWvvOiHtOS4jeinpuWPkSBvbkdhbWVTdGFydGVkCiAgICAgICAgaWYgKCF0aGlzLmNvdW50ZG93bkluUHJvZ3Jlc3MpIHsKICAgICAgICAgIHRoaXMuY291bnRkb3duSW5Qcm9ncmVzcyA9IHRydWUKICAgICAgICAgIC8vIOehruS/neacrOWcsOS5n+mHjee9ruaVsOaNrgogICAgICAgICAgdGhpcy5jaGF0TWVzc2FnZXMgPSBbXQogICAgICAgICAgdGhpcy5hbGxQbGF5ZXJzQXJ0aWZhY3RzID0ge30KICAgICAgICAgIHRoaXMuJHN0b3JlLmNvbW1pdCgnU0VUX0dBTUVfUEhBU0UnLCAnY291bnRkb3duJykKICAgICAgICAgIHRoaXMuJHNldCh0aGlzLCAnYXVjdGlvbkNvdW50ZG93bicsIDUpCiAgICAgICAgICBjb25zdCBtZSA9ICh0aGlzLnJvb20gJiYgdGhpcy5yb29tLnJvb21fcGxheWVycyA/IHRoaXMucm9vbS5yb29tX3BsYXllcnMgOiBbXSkuZmluZChwID0+IHAudXNlcl9pZCA9PT0gdWlkKQogICAgICAgICAgaWYgKG1lKSB7CiAgICAgICAgICAgIHRoaXMuJHN0b3JlLmNvbW1pdCgnU0VUX0NVUlJFTlRfUExBWUVSJywgeyBpZDogbWUudXNlcl9pZCwgbmFtZTogdGhpcy5nZXROYW1lRm9yKG1lLnVzZXJfaWQpLCBlbmVyZ3k6IDUwLCBhcnRpZmFjdHM6IFtdLCBpdGVtczogW10gfSkKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0aGlzLmF1Y3Rpb25UaW1lcikgeyBjbGVhckludGVydmFsKHRoaXMuYXVjdGlvblRpbWVyKTsgdGhpcy5hdWN0aW9uVGltZXIgPSBudWxsIH0KICAgICAgICAgIHRoaXMuJG5leHRUaWNrKCgpID0+IHsKICAgICAgICAgICAgc3RhcnRDb3VudGRvd24oewogICAgICAgICAgICAgIHNlY29uZHM6IDUsCiAgICAgICAgICAgICAgb25UaWNrOiAocykgPT4geyB0aGlzLiRzZXQodGhpcywgJ2F1Y3Rpb25Db3VudGRvd24nLCBzKSB9LAogICAgICAgICAgICAgIG9uRG9uZTogYXN5bmMgKCkgPT4geyB0aGlzLmNvdW50ZG93bkluUHJvZ3Jlc3MgPSBmYWxzZTsgaWYgKHRoaXMuaXNPd25lcikgeyBhd2FpdCB0aGlzLmF1dG9TdGFydEF1Y3Rpb24oKSB9IH0sCiAgICAgICAgICAgICAgZ2V0UmVmOiAoKSA9PiB0aGlzLmF1Y3Rpb25UaW1lciwKICAgICAgICAgICAgICBzZXRSZWY6IChpZCkgPT4geyB0aGlzLmF1Y3Rpb25UaW1lciA9IGlkIH0sCiAgICAgICAgICAgIH0pCiAgICAgICAgICB9KQogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkgeyBjb25zb2xlLndhcm4oJ1tnYW1lXSBzdGFydEdhbWUgZmFpbGVkJywgZSkgfQogICAgfSwKICAgIAogICAgYXN5bmMgc3RhcnRBdWN0aW9uKCkgewogICAgICAvLyDlkIzml7bmir3lj5blpJrku7bov5vooYzmi43ljZbvvIjnpLrkvovkuLoy5Lu277yJCiAgICAgIGNvbnN0IGFydGlmYWN0cyA9IGF3YWl0IHRoaXMubG9hZEFydGlmYWN0cygpCiAgICAgIGlmIChhcnRpZmFjdHMubGVuZ3RoID4gMCkgewogICAgICAgIGNvbnN0IHBpY2tzID0gW10KICAgICAgICB3aGlsZSAocGlja3MubGVuZ3RoIDwgTWF0aC5taW4oMiwgYXJ0aWZhY3RzLmxlbmd0aCkpIHsKICAgICAgICAgIGNvbnN0IGNhbmRpZGF0ZSA9IGFydGlmYWN0c1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBhcnRpZmFjdHMubGVuZ3RoKV0KICAgICAgICAgIGlmICghcGlja3MuZmluZChwID0+IHAuaWQgPT09IGNhbmRpZGF0ZS5pZCkpIHBpY2tzLnB1c2goY2FuZGlkYXRlKQogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IGFydCBvZiBwaWNrcykgewogICAgICAgICAgYXdhaXQgdGhpcy4kc3RvcmUuZGlzcGF0Y2goJ3N0YXJ0QXVjdGlvbicsIGFydCkKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICAKICAgIGFzeW5jIGxvYWRBcnRpZmFjdHMoKSB7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3Qgc3VwYWJhc2UgPSBnZXRTdXBhYmFzZSgpCiAgICAgICAgcmV0dXJuIGF3YWl0IGxvYWRBcnRpZmFjdHNTZXJ2aWNlKHsgc3VwYWJhc2UgfSkKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsgY29uc29sZS5lcnJvcign5Yqg6L295Y2h54mM5pWw5o2u5aSx6LSlOicsIGVycm9yKTsgcmV0dXJuIFtdIH0KICAgIH0sCiAgICAKICAgIG9wZW5TaG9wKCkgewogICAgICB0aGlzLiRzdG9yZS5jb21taXQoJ1NFVF9TSE9XX1NIT1AnLCB0cnVlKQogICAgfSwKICAgIAogICAgY2xvc2VTaG9wKCkgewogICAgICB0aGlzLiRzdG9yZS5jb21taXQoJ1NFVF9TSE9XX1NIT1AnLCBmYWxzZSkKICAgIH0sCiAgICAKICAgIHNob3dBcnRpZmFjdERldGFpbChhcnRpZmFjdElkKSB7CiAgICAgIC8vIOiLpeW3suWKoOi9vWFydGlmYWN0TWFw77yM5YiZ5LyY5YWI5bGV56S655yf5a6e5pWw5o2uCiAgICAgIGNvbnN0IGFydGlmYWN0ID0gdGhpcy5hcnRpZmFjdE1hcFthcnRpZmFjdElkXQogICAgICBpZiAoYXJ0aWZhY3QpIHsKICAgICAgICB0aGlzLnNlbGVjdGVkQ2FyZCA9IGFydGlmYWN0CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8g5Zue6YCA77ya57u05oyB5Y6f56S65L6LCiAgICAgICAgdGhpcy5zZWxlY3RlZENhcmQgPSB7CiAgICAgICAgICBpZDogYXJ0aWZhY3RJZCwKICAgICAgICAgIG5hbWU6ICfnpLrkvovlpYfniaknLAogICAgICAgICAgZXJhOiAn5Y+k5LujJywKICAgICAgICAgIGxvY2F0aW9uOiAn5pyq55+lJywKICAgICAgICAgIHN0b3J5OiAn6L+Z5piv5LiA5Liq56We56eY55qE5aWH54mpLi4uJywKICAgICAgICAgIGNvbGxlY3Rpb25UYWdzOiBbJ+iJuuacr+eRsOWunSddLAogICAgICAgICAgYmFzZVZhbHVlOiA4LAogICAgICAgICAgaW1hZ2U6ICdodHRwczovL3ZpYS5wbGFjZWhvbGRlci5jb20vMzAweDIwMD90ZXh0PeekuuS+i+Wlh+eJqScKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy4kc3RvcmUuY29tbWl0KCdTRVRfU0hPV19DQVJEX0RFVEFJTCcsIHRydWUpCiAgICB9LAogICAgCiAgICBoaWRlQ2FyZERldGFpbCgpIHsKICAgICAgdGhpcy4kc3RvcmUuY29tbWl0KCdTRVRfU0hPV19DQVJEX0RFVEFJTCcsIGZhbHNlKQogICAgICB0aGlzLnNlbGVjdGVkQ2FyZCA9IG51bGwKICAgIH0sCiAgICBzaG93QXJ0aWZhY3REZXRhaWxGcm9tQXVjdGlvbihhcnRpZmFjdCkgewogICAgICB0aGlzLnNlbGVjdGVkQ2FyZCA9IGFydGlmYWN0CiAgICAgIHRoaXMuJHN0b3JlLmNvbW1pdCgnU0VUX1NIT1dfQ0FSRF9ERVRBSUwnLCBmYWxzZSkKICAgICAgdGhpcy5vcGVuTmFycmF0aW9uKCkKICAgIH0sCiAgICAvLyDorqHnrpfnjqnlrrbmgLvku7flgLzvvIjmlK/mjIHmiYDmnInnjqnlrrbvvIkKICAgIGdldFBsYXllclRvdGFsVmFsdWUodXNlcklkKSB7CiAgICAgIGlmICghdXNlcklkKSByZXR1cm4gMAogICAgICAKICAgICAgLy8g5LyY5YWI5LuOIGFsbFBsYXllcnNBcnRpZmFjdHMg6I635Y+W5omA5pyJ546p5a6255qE5omL54mM5pWw5o2uCiAgICAgIGxldCBvd25lZCA9IFtdCiAgICAgIGlmICh0aGlzLmFsbFBsYXllcnNBcnRpZmFjdHMgJiYgdGhpcy5hbGxQbGF5ZXJzQXJ0aWZhY3RzW3VzZXJJZF0pIHsKICAgICAgICBvd25lZCA9IEFycmF5LmlzQXJyYXkodGhpcy5hbGxQbGF5ZXJzQXJ0aWZhY3RzW3VzZXJJZF0pID8gdGhpcy5hbGxQbGF5ZXJzQXJ0aWZhY3RzW3VzZXJJZF0gOiBbXQogICAgICB9IGVsc2UgewogICAgICAgIC8vIOWbnumAgO+8muWmguaenCBhbGxQbGF5ZXJzQXJ0aWZhY3RzIOS4reayoeacie+8jOWwneivleS7juW9k+WJjeeOqeWutuaVsOaNruiOt+WPlgogICAgICAgIGNvbnN0IGN1cnJlbnQgPSB0aGlzLiRzdG9yZS5zdGF0ZS5jdXJyZW50UGxheWVyCiAgICAgICAgaWYgKGN1cnJlbnQgJiYgY3VycmVudC5pZCA9PT0gdXNlcklkKSB7CiAgICAgICAgICBvd25lZCA9IEFycmF5LmlzQXJyYXkodGhpcy4kc3RvcmUuc3RhdGUucGxheWVyQXJ0aWZhY3RzKSA/IHRoaXMuJHN0b3JlLnN0YXRlLnBsYXllckFydGlmYWN0cyA6IFtdCiAgICAgICAgfQogICAgICB9CiAgICAgIAogICAgICBpZiAoIW93bmVkIHx8IG93bmVkLmxlbmd0aCA9PT0gMCkgcmV0dXJuIDAKICAgICAgCiAgICAgIC8vIOehruS/nSBhcnRpZmFjdE1hcCDlt7LliqDovb0KICAgICAgaWYgKCF0aGlzLmFydGlmYWN0TWFwIHx8IE9iamVjdC5rZXlzKHRoaXMuYXJ0aWZhY3RNYXApLmxlbmd0aCA9PT0gMCkgcmV0dXJuIDAKICAgICAgCiAgICAgIGxldCB0b3RhbCA9IDAKICAgICAgb3duZWQuZm9yRWFjaChhaWQgPT4gewogICAgICAgIGNvbnN0IGEgPSB0aGlzLmFydGlmYWN0TWFwW2FpZF0KICAgICAgICBpZiAoYSAmJiB0eXBlb2YgYS5iYXNlVmFsdWUgPT09ICdudW1iZXInKSB7CiAgICAgICAgICB0b3RhbCArPSBhLmJhc2VWYWx1ZQogICAgICAgIH0KICAgICAgfSkKICAgICAgcmV0dXJuIHRvdGFsCiAgICB9LAoKICAgIHNob3dQbGF5ZXJIYW5kKHBsYXllcikgewogICAgICAvLyDmnoTpgKDnjqnlrrblr7nosaHvvIzljIXlkKvmiYvniYzkv6Hmga8KICAgICAgY29uc3QgcGxheWVyRGF0YSA9IHsKICAgICAgICBpZDogcGxheWVyLnVzZXJfaWQsCiAgICAgICAgbmFtZTogdGhpcy5nZXROYW1lRm9yKHBsYXllci51c2VyX2lkKSwKICAgICAgICBhcnRpZmFjdHM6IHRoaXMuY3VycmVudFBsYXllciAmJiB0aGlzLmN1cnJlbnRQbGF5ZXIuaWQgPT09IHBsYXllci51c2VyX2lkID8gCiAgICAgICAgICAodGhpcy5jdXJyZW50UGxheWVyLmFydGlmYWN0cyB8fCBbXSkgOiBbXQogICAgICB9CiAgICAgIHRoaXMuaGFuZFBsYXllciA9IHBsYXllckRhdGEKICAgICAgdGhpcy5zaG93SGFuZFBvcHVwID0gdHJ1ZQogICAgfSwKCiAgICBoaWRlSGFuZCgpIHsKICAgICAgdGhpcy5oYW5kUGxheWVyID0gbnVsbAogICAgICB0aGlzLnNob3dIYW5kUG9wdXAgPSBmYWxzZQogICAgfSwKICAgIAogICAgCiAgICBnZXRBdmF0YXJGb3IodXNlcklkKSB7IHJldHVybiBnZXRBdmF0YXJGb3JIZWxwZXIoeyBwcm9maWxlTWFwOiB0aGlzLnByb2ZpbGVNYXAsIHVzZXJJZCB9KSB9LAogICAgZ2V0TmFtZUZvcih1c2VySWQpIHsgcmV0dXJuIGdldE5hbWVGb3JIZWxwZXIoeyBwcm9maWxlTWFwOiB0aGlzLnByb2ZpbGVNYXAsIHJvb206IHRoaXMucm9vbSwgdXNlcklkIH0pIH0sCiAgICBnZXRDdXJyZW50TGFuZ3VhZ2UoKSB7IHJldHVybiBnZXRDdXJyZW50TGFuZ3VhZ2VJbXBvcnRlZCgpIH0sCiAgICAKICAgIC8vIOWKoOi9veaUtuiXj+mbhuaVsOaNru+8muWfuuS6juaVsOaNruW6kyBhcnRpZmFjdHMg55qEIGNvbGxlY3Rpb25fdGFncyDliqjmgIHnlJ/miJAKICAgIGFzeW5jIGxvYWRDb2xsZWN0aW9ucygpIHsKICAgICAgdHJ5IHsgdGhpcy5jb2xsZWN0aW9ucyA9IGxvYWRDb2xsZWN0aW9uc0Zyb21BcnRpZmFjdHModGhpcy5hcnRpZmFjdE1hcCkgfQogICAgICBjYXRjaCAoZXJyb3IpIHsgY29uc29sZS5lcnJvcign5Yqg6L295pS26JeP6ZuG5pWw5o2u5aSx6LSlOicsIGVycm9yKTsgdGhpcy5jb2xsZWN0aW9ucyA9IFtdIH0KICAgIH0sCiAgICAKICAgCiAgICAKICAgIC8vIOiOt+WPluW9k+WJjeaUtuiXj+mbhuaVsOmHj++8iOWfuuS6juW9k+WJjeeUqOaIt+aJi+eJjO+8jOS4lOWPl+acgOWkp+imgeaxguaVsOS4iumZkOmZkOWItu+8iQogICAgZ2V0Q3VycmVudENvbGxlY3Rpb25Db3VudChjb2xsZWN0aW9uKSB7CiAgICAgIGNvbnN0IG93bmVkID0gKHRoaXMuY3VycmVudFBsYXllciAmJiB0aGlzLmN1cnJlbnRQbGF5ZXIuYXJ0aWZhY3RzKSA/IHRoaXMuY3VycmVudFBsYXllci5hcnRpZmFjdHMgOiBbXQogICAgICByZXR1cm4gZ2V0Q29sbGVjdGlvbkNvdW50VXRpbCh7IGFydGlmYWN0TWFwOiB0aGlzLmFydGlmYWN0TWFwLCBvd25lZEFydGlmYWN0SWRzOiBvd25lZCwgY29sbGVjdGlvbiB9KQogICAgfSwKCgogICAgLy8g5bGV5byAL+aUtui1t+aUtuiXj+mbhgogICAgdG9nZ2xlQ29sbGVjdGlvbihjb2xsZWN0aW9uKSB7CiAgICAgIGNvbnN0IGlkID0gY29sbGVjdGlvbiAmJiBjb2xsZWN0aW9uLmlkCiAgICAgIGlmICghaWQpIHJldHVybgogICAgICB0aGlzLiRzZXQodGhpcy5leHBhbmRlZENvbGxlY3Rpb25zLCBpZCwgIXRoaXMuZXhwYW5kZWRDb2xsZWN0aW9uc1tpZF0pCiAgICB9LAogICAgCiAgICAvLyDlhbPpl63muLjmiI/nu5PmnZ/lr7nor53moYYKICAgIGNsb3NlR2FtZUVuZERpYWxvZygpIHsKICAgICAgdGhpcy5zaG93R2FtZUVuZERpYWxvZyA9IGZhbHNlCiAgICB9LAogICAgCiAgICAvLyDnlZnlnKjmiL/pl7QKICAgIHN0YXlJblJvb20oKSB7CiAgICAgIHRoaXMuc2hvd0dhbWVFbmREaWFsb2cgPSBmYWxzZQogICAgICB0cnkgeyB0aGlzLiRzdG9yZS5jb21taXQoJ0NMRUFSX0dBTUVfTE9HJykgfSBjYXRjaCAoXykge30KICAgICAgLy8g6L+U5Zue5b2T5YmN5oi/6Ze05YeG5aSH55WM6Z2iCiAgICAgIGNvbnN0IHJpZCA9IHRoaXMuJHN0b3JlLnN0YXRlLnJvb21JZAogICAgICBpZiAocmlkKSB7CiAgICAgICAgdGhpcy4kc3RvcmUuY29tbWl0KCdTRVRfR0FNRV9QSEFTRScsICdwcmVwYXJhdGlvbicpCiAgICAgICAgdGhpcy4kcm91dGVyLnB1c2goeyBwYXRoOiAnL2dhbWUnLCBxdWVyeTogeyByb29tSWQ6IHJpZCB9IH0pCiAgICAgIH0KICAgIH0sCiAgICAKICAgIC8vIOi/lOWbnuaIv+mXtOWIl+ihqAogICAgZ29Ub1Jvb21zKCkgewogICAgICB0aGlzLnNob3dHYW1lRW5kRGlhbG9nID0gZmFsc2UKICAgICAgdGhpcy51bnN1YnNjcmliZVJvb21SZWFsdGltZSgpCiAgICAgIHRyeSB7IHRoaXMuJHN0b3JlLmNvbW1pdCgnQ0xFQVJfR0FNRV9MT0cnKSB9IGNhdGNoIChfKSB7fQogICAgICAvLyDov5Tlm57lvZPliY3miL/pl7Tlh4blpIfnlYzpnaLvvIjmm7TnrKblkIjmnJ/mnJvvvIkKICAgICAgY29uc3QgcmlkID0gdGhpcy4kc3RvcmUuc3RhdGUucm9vbUlkCiAgICAgIGlmIChyaWQpIHsKICAgICAgICB0aGlzLiRzdG9yZS5jb21taXQoJ1NFVF9HQU1FX1BIQVNFJywgJ3ByZXBhcmF0aW9uJykKICAgICAgICB0aGlzLiRyb3V0ZXIucHVzaCh7IHBhdGg6ICcvZ2FtZScsIHF1ZXJ5OiB7IHJvb21JZDogcmlkIH0gfSkKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLiRyb3V0ZXIucHVzaCgnL3Jvb21zJykKICAgICAgfQogICAgfSwKICAgIAogICAgLy8g5pe26Ze05Yiw77ya57uT5p2f5b2T5YmN5omA5pyJ5ouN5Y2W5bm257uT566X5Yiw5a+55bqU546p5a625omL54mM77yM54S25ZCO6L+b5YWlMTBz6Ze05q2H5oiW57uT5p2f5ri45oiPCiAgICBhc3luYyBvbkF1Y3Rpb25UaW1lVXAoKSB7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgYXVjdGlvbnMgPSB0aGlzLiRzdG9yZS5zdGF0ZS5jdXJyZW50QXVjdGlvbnMgfHwgW10KICAgICAgICAvLyDnu5/kuIDlgJLorqHml7bnu5PmnZ/vvJrnu5PmnZ/miYDmnInlvZPliY3mi43ljZYKICAgICAgICBmb3IgKGNvbnN0IGEgb2YgYXVjdGlvbnMpIHsKICAgICAgICAgIGF3YWl0IHRoaXMuJHN0b3JlLmRpc3BhdGNoKCdlbmRBdWN0aW9uJywgYS5pZCkKICAgICAgICB9CiAgICAgICAgLy8g5Yik5pat5piv5ZCm6L6+5Yiw5oC75Zue5ZCI5pWwCiAgICAgICAgY29uc3QgY3VyID0gTnVtYmVyKHRoaXMuJHN0b3JlLnN0YXRlLnJvdW5kQ3VycmVudCB8fCAwKQogICAgICAgIGNvbnN0IHRvdCA9IE51bWJlcih0aGlzLiRzdG9yZS5zdGF0ZS5yb3VuZFRvdGFsIHx8IDYpCiAgICAgICAgaWYgKGN1ciA+PSB0b3QpIHsKICAgICAgICAgIC8vIOinpuWPkee7k+adnwogICAgICAgICAgdGhpcy4kc3RvcmUuY29tbWl0KCdTRVRfR0FNRV9QSEFTRScsICdzZXR0bGVtZW50JykKICAgICAgICAgIGF3YWl0IHRoaXMuY29tcHV0ZUZpbmFsU2NvcmVzKCkKICAgICAgICAgIHRoaXMuc2hvd0dhbWVFbmREaWFsb2cgPSB0cnVlCiAgICAgICAgICByZXR1cm4KICAgICAgICB9CiAgICAgICAgLy8g5ZCm5YiZ6L+b5YWlMTBz6Ze05q2H6Zi25q61CiAgICAgICAgdGhpcy5zdGFydEludGVybWlzc2lvblRpbWVyKDEwKQogICAgICB9IGNhdGNoIChlKSB7IGNvbnNvbGUud2FybignW2dhbWVdIG9uQXVjdGlvblRpbWVVcCBmYWlsZWQnLCBlKSB9CiAgICB9LAoKICAgIC8vIOW8gOWni+aLjeWNluWAkuiuoeaXtu+8mue7n+S4gOavj+i9ruaLjeWNluWPquacieS4gOS4quWAkuiuoeaXtgogICAgc3RhcnRBdWN0aW9uVGltZXIoZHVyYXRpb24gPSAzMCkgewogICAgICB0aGlzLiRzdG9yZS5jb21taXQoJ1NFVF9HQU1FX1BIQVNFJywgJ2F1Y3Rpb24nKQogICAgICBzdGFydENvdW50ZG93bih7CiAgICAgICAgc2Vjb25kczogZHVyYXRpb24sCiAgICAgICAgb25UaWNrOiAocykgPT4geyB0aGlzLiRzZXQodGhpcywgJ2F1Y3Rpb25Db3VudGRvd24nLCBzKTsgfSwKICAgICAgICBvbkRvbmU6IGFzeW5jICgpID0+IHsgYXdhaXQgdGhpcy5vbkF1Y3Rpb25UaW1lVXAoKSB9LAogICAgICAgIGdldFJlZjogKCkgPT4gdGhpcy5hdWN0aW9uVGltZXIsCiAgICAgICAgc2V0UmVmOiAoaWQpID0+IHsgdGhpcy5hdWN0aW9uVGltZXIgPSBpZCB9LAogICAgICB9KQogICAgfSwKCgogICAgCiAgICAvLyDmr4/ova7kuYvpl7TnmoTpl7TmrYforqHml7blmajvvIznu5PmnZ/lkI7oh6rliqjlvIDlp4vkuIvkuIDova7mi43ljZYKICAgIHN0YXJ0SW50ZXJtaXNzaW9uVGltZXIoZHVyYXRpb24gPSAxMCkgewogICAgICB0aGlzLiRzdG9yZS5jb21taXQoJ1NFVF9HQU1FX1BIQVNFJywgJ2ludGVybWlzc2lvbicpCiAgICAgIHN0YXJ0Q291bnRkb3duKHsKICAgICAgICBzZWNvbmRzOiBkdXJhdGlvbiwKICAgICAgICBvblRpY2s6IChzKSA9PiB7IHRoaXMuJHNldCh0aGlzLCAnYXVjdGlvbkNvdW50ZG93bicsIHMpOyB9LAogICAgICAgIG9uRG9uZTogYXN5bmMgKCkgPT4gewogICAgICAgICAgaWYgKHRoaXMuaXNPd25lcikgewogICAgICAgICAgICBhd2FpdCB0aGlzLmF1dG9TdGFydEF1Y3Rpb24oKQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgZ2V0UmVmOiAoKSA9PiB0aGlzLmF1Y3Rpb25UaW1lciwKICAgICAgICBzZXRSZWY6IChpZCkgPT4geyB0aGlzLmF1Y3Rpb25UaW1lciA9IGlkIH0sCiAgICAgIH0pCiAgICB9LAogICAgCiAgICAvLyDoh6rliqjlvIDlp4vmi43ljZYKICAgIGFzeW5jIGF1dG9TdGFydEF1Y3Rpb24oKSB7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgcmlkID0gdGhpcy4kc3RvcmUuc3RhdGUucm9vbUlkCiAgICAgICAgY29uc3Qgc3VwYWJhc2UgPSBnZXRTdXBhYmFzZSgpCiAgICAgICAgYXdhaXQgYXV0b1N0YXJ0QXVjdGlvbkZsb3coewogICAgICAgICAgcm9vbUlkOiByaWQsCiAgICAgICAgICBzdG9yZTogdGhpcy4kc3RvcmUsCiAgICAgICAgICBzdXBhYmFzZSwKICAgICAgICAgIGxvYWRBcnRpZmFjdHM6ICgpID0+IHRoaXMubG9hZEFydGlmYWN0cygpLAogICAgICAgICAgZGlzcGF0Y2hTdGFydEF1Y3Rpb246IChhcnQpID0+IHRoaXMuJHN0b3JlLmRpc3BhdGNoKCdzdGFydEF1Y3Rpb24nLCBhcnQpLAogICAgICAgICAgc3RhcnRBdWN0aW9uVGltZXI6IChzZWMpID0+IHRoaXMuc3RhcnRBdWN0aW9uVGltZXIoc2VjKSwKICAgICAgICAgIHJvdW5kQ291bnQ6IHRoaXMucm91bmRDb3VudCwKICAgICAgICAgIHRvdGFsUm91bmRzOiB0aGlzLnRvdGFsUm91bmRzLAogICAgICAgICAgc2V0Um91bmRDb3VudDogKG4pID0+IHsgdGhpcy5yb3VuZENvdW50ID0gbiB9LAogICAgICAgIH0pCiAgICAgIH0gY2F0Y2ggKGUpIHsgY29uc29sZS53YXJuKCdbZ2FtZV0gYXV0b1N0YXJ0QXVjdGlvbiBmYWlsZWQnLCBlKSB9CiAgICB9LAogICAgCiAgICAvLyDlj5HpgIHogYrlpKnmtojmga8KICAgIGFzeW5jIHNlbmRNZXNzYWdlKCkgewogICAgICBpZiAoIXRoaXMubmV3TWVzc2FnZS50cmltKCkgfHwgIXRoaXMudXNlcikgcmV0dXJuCiAgICAgIGNvbnN0IG1lc3NhZ2UgPSB7IAogICAgICAgIGlkOiBEYXRlLm5vdygpLCAKICAgICAgICB1c2VySWQ6IHRoaXMudXNlci5pZCwgCiAgICAgICAgdXNlcm5hbWU6IHRoaXMuZ2V0TmFtZUZvcih0aGlzLnVzZXIuaWQpLCAKICAgICAgICBjb250ZW50OiB0aGlzLm5ld01lc3NhZ2UudHJpbSgpLCAKICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCkgCiAgICAgIH0KICAgICAgLy8g5pys5Zyw56uL5Y2z5pi+56S677yM5o+Q5L6b5Y2z5pe25Y+N6aaICiAgICAgIHRoaXMuY2hhdE1lc3NhZ2VzLnB1c2gobWVzc2FnZSkKICAgICAgdGhpcy5uZXdNZXNzYWdlID0gJycKICAgICAgCiAgICAgIC8vIOa7muWKqOWIsOW6lemDqAogICAgICB0aGlzLiRuZXh0VGljaygoKSA9PiB7CiAgICAgICAgY29uc3QgY2hhdENvbnRhaW5lciA9IHRoaXMuJHJlZnMuY2hhdENvbnRhaW5lcgogICAgICAgIGlmIChjaGF0Q29udGFpbmVyKSB7IGNoYXRDb250YWluZXIuc2Nyb2xsVG9wID0gY2hhdENvbnRhaW5lci5zY3JvbGxIZWlnaHQgfQogICAgICB9KQogICAgICAKICAgICAgLy8g5Y+R6YCB5Yiw5pyN5Yqh5Zmo77yM5bm/5pKt57uZ5omA5pyJ546p5a62CiAgICAgIGNvbnN0IHJpZCA9IHRoaXMuJHN0b3JlLnN0YXRlLnJvb21JZAogICAgICBpZiAocmlkKSB7IAogICAgICAgIHRyeSB7IAogICAgICAgICAgY29uc3Qgc3VwYWJhc2UgPSBnZXRTdXBhYmFzZSgpCiAgICAgICAgICBhd2FpdCBzZW5kQ2hhdE1lc3NhZ2UoeyBzdXBhYmFzZSwgcm9vbUlkOiByaWQsIG1lc3NhZ2UgfSkgCiAgICAgICAgfSBjYXRjaCAoZSkgeyAKICAgICAgICAgIGNvbnNvbGUud2FybignW2dhbWVdIHNlbmRNZXNzYWdlIGZhaWxlZCcsIGUpCiAgICAgICAgICAvLyDlj5HpgIHlpLHotKXml7bvvIzlj6/ku6XpgInmi6nnp7vpmaTmnKzlnLDmtojmga/miJbkv53nlZnvvIjkv53nlZnmj5Dkvpvmm7Tlpb3nmoTnlKjmiLfkvZPpqozvvIkKICAgICAgICB9IAogICAgICB9CiAgICB9LAogICAgCiAgICAvLyDmoLzlvI/ljJbmtojmga/ml7bpl7QKICAgIGZvcm1hdE1lc3NhZ2VUaW1lKHRpbWVzdGFtcCkgeyByZXR1cm4gZm9ybWF0TWVzc2FnZVRpbWVIZWxwZXIodGltZXN0YW1wKSB9CiAgICAsCgogICAgLy8g6K6h566X5pyA57uI5b6X5YiG5bm256Gu5a6a6LWi5a62CiAgICBhc3luYyBjb21wdXRlRmluYWxTY29yZXMoKSB7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgcmlkID0gdGhpcy4kc3RvcmUuc3RhdGUucm9vbUlkCiAgICAgICAgaWYgKCFyaWQpIHJldHVybgogICAgICAgIGNvbnN0IHN1cGFiYXNlID0gZ2V0U3VwYWJhc2UoKQogICAgICAgIGNvbnN0IHsgZGF0YTogcm93cyB9ID0gYXdhaXQgc3VwYWJhc2UKICAgICAgICAgIC5mcm9tKCdyb29tX2FydGlmYWN0cycpCiAgICAgICAgICAuc2VsZWN0KCdvd25lcl91c2VyX2lkLCBhcnRpZmFjdF9pZCcpCiAgICAgICAgICAuZXEoJ3Jvb21faWQnLCByaWQpCiAgICAgICAgY29uc3QgdXNlclRvQXJ0aWZhY3RzID0ge30KICAgICAgICA7KHJvd3MgfHwgW10pLmZvckVhY2gociA9PiB7CiAgICAgICAgICBpZiAoIXVzZXJUb0FydGlmYWN0c1tyLm93bmVyX3VzZXJfaWRdKSB1c2VyVG9BcnRpZmFjdHNbci5vd25lcl91c2VyX2lkXSA9IFtdCiAgICAgICAgICB1c2VyVG9BcnRpZmFjdHNbci5vd25lcl91c2VyX2lkXS5wdXNoKHIuYXJ0aWZhY3RfaWQpCiAgICAgICAgfSkKCiAgICAgICAgY29uc3QgY29sbGVjdGlvbnMgPSBBcnJheS5pc0FycmF5KHRoaXMuY29sbGVjdGlvbnMpID8gdGhpcy5jb2xsZWN0aW9ucyA6IFtdCiAgICAgICAgY29uc3Qgc2NvcmVzID0gT2JqZWN0LmtleXModXNlclRvQXJ0aWZhY3RzKS5tYXAodWlkID0+IHsKICAgICAgICAgIGNvbnN0IG93bmVkID0gdXNlclRvQXJ0aWZhY3RzW3VpZF0KICAgICAgICAgIC8vIOaUtuiXj+mbhuWIhuaVsAogICAgICAgICAgbGV0IGNvbGxlY3Rpb25TY29yZSA9IDAKICAgICAgICAgIGNvbGxlY3Rpb25zLmZvckVhY2goY29sID0+IHsKICAgICAgICAgICAgY29uc3QgY3VycmVudCA9IGdldENvbGxlY3Rpb25Db3VudFV0aWwoeyBhcnRpZmFjdE1hcDogdGhpcy5hcnRpZmFjdE1hcCwgb3duZWRBcnRpZmFjdElkczogb3duZWQsIGNvbGxlY3Rpb246IGNvbCB9KQogICAgICAgICAgICBpZiAoY3VycmVudCA+PSAoY29sLnJlcXVpcmVkQ291bnQgfHwgMSkpIGNvbGxlY3Rpb25TY29yZSArPSAoY29sLnJld2FyZFBvaW50cyB8fCAwKQogICAgICAgICAgfSkKICAgICAgICAgIC8vIOmbtuaVo+Wlh+eJqeWIhuaVsO+8iOWfuuehgOS7t+WAvOS4gOWNiu+8jOWQkeS4i+WPluaVtO+8iQogICAgICAgICAgbGV0IGFydGlmYWN0U2NvcmUgPSAwCiAgICAgICAgICBvd25lZC5mb3JFYWNoKGFpZCA9PiB7CiAgICAgICAgICAgIGNvbnN0IGEgPSB0aGlzLmFydGlmYWN0TWFwW2FpZF0KICAgICAgICAgICAgaWYgKGEgJiYgdHlwZW9mIGEuYmFzZVZhbHVlID09PSAnbnVtYmVyJykgYXJ0aWZhY3RTY29yZSArPSBNYXRoLmZsb29yKGEuYmFzZVZhbHVlIC8gMikKICAgICAgICAgIH0pCiAgICAgICAgCiAgICAgICAgICBjb25zdCB0b3RhbCA9IGNvbGxlY3Rpb25TY29yZSArIGFydGlmYWN0U2NvcmUKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHVzZXJJZDogdWlkLAogICAgICAgICAgICBuYW1lOiB0aGlzLmdldE5hbWVGb3IodWlkKSwKICAgICAgICAgICAgYXZhdGFyOiB0aGlzLmdldEF2YXRhckZvcih1aWQpLAogICAgICAgICAgICBjb2xsZWN0aW9uU2NvcmUsCiAgICAgICAgICAgIGFydGlmYWN0U2NvcmUsCiAgICAgICAgICAgIHRvdGFsCiAgICAgICAgICB9CiAgICAgICAgfSkKCiAgICAgICAgY29uc3Qgc29ydGVkID0gc2NvcmVzLnNvcnQoKGEsIGIpID0+IGIudG90YWwgLSBhLnRvdGFsKQogICAgICAgIHRoaXMuZmluYWxTY29yZXMgPSBzb3J0ZWQKICAgICAgICB0aGlzLndpbm5lckluZm8gPSBzb3J0ZWRbMF0gfHwgbnVsbAoKICAgICAgICBpZiAodGhpcy53aW5uZXJJbmZvKSB7CiAgICAgICAgICB0aGlzLiRzdG9yZS5jb21taXQoJ0FERF9HQU1FX0xPRycsIHsgdGltZXN0YW1wOiBEYXRlLm5vdygpLCBtZXNzYWdlOiBg5pys5bGA57uT5p2f77yM6IOc6ICF77yaJHt0aGlzLndpbm5lckluZm8ubmFtZX3vvIjmgLvliIYgJHt0aGlzLndpbm5lckluZm8udG90YWx977yJYCB9KQogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkgeyBjb25zb2xlLndhcm4oJ1tnYW1lXSBjb21wdXRlRmluYWxTY29yZXMgZmFpbGVkJywgZSkgfQogICAgfSwKCiAgICAvLyDlvIDlkK8v5YWz6Zet5paH54mp6K6y6L+wCiAgICBvcGVuTmFycmF0aW9uKCkgewogICAgICAvLyDmnoTpgKDorrLov7DmlofmnKzvvIzljIXlkKvln7rmnKzku4vnu40gKyDmlYXkuosKICAgICAgY29uc3QgYmFzZSA9IGAke3RoaXMuc2VsZWN0ZWRDYXJkLm5hbWV977yM5p2l6IeqICR7dGhpcy5zZWxlY3RlZENhcmQuZXJhfSR7dGhpcy5zZWxlY3RlZENhcmQubG9jYXRpb24gPyAnIMK3ICcgKyB0aGlzLnNlbGVjdGVkQ2FyZC5sb2NhdGlvbiA6ICcnfeOAglxuYAogICAgICBjb25zdCBzdG9yeSA9ICh0aGlzLnNlbGVjdGVkQ2FyZC5zdG9yeSB8fCAnJykudHJpbSgpCiAgICAgIGNvbnN0IGZ1bGwgPSBgJHtiYXNlfSR7c3Rvcnl9YC50cmltKCkKICAgICAgLy8g5omT5a2X5py65pWI5p6cCiAgICAgIHRoaXMudHlwaW5nVGV4dCA9ICcnCiAgICAgIHRoaXMuc2hvd05hcnJhdGlvbiA9IHRydWUKICAgICAgY29uc3Qgc3BlZWQgPSAoZmlyc3RMb2dpbkRpYWxvZ3VlQ29uZmlnICYmIGZpcnN0TG9naW5EaWFsb2d1ZUNvbmZpZy5hbmltYXRpb25zICYmIGZpcnN0TG9naW5EaWFsb2d1ZUNvbmZpZy5hbmltYXRpb25zLnRleHRUeXBpbmdTcGVlZCkgfHwgMzAKICAgICAgaWYgKHRoaXMudHlwaW5nVGltZXIpIHsgY2xlYXJJbnRlcnZhbCh0aGlzLnR5cGluZ1RpbWVyKTsgdGhpcy50eXBpbmdUaW1lciA9IG51bGwgfQogICAgICBsZXQgaSA9IDAKICAgICAgdGhpcy50eXBpbmdUaW1lciA9IHNldEludGVydmFsKCgpID0+IHsKICAgICAgICBpZiAoaSA+PSBmdWxsLmxlbmd0aCkgewogICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLnR5cGluZ1RpbWVyKQogICAgICAgICAgdGhpcy50eXBpbmdUaW1lciA9IG51bGwKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy50eXBpbmdUZXh0ICs9IGZ1bGxbaV0KICAgICAgICAgIGkgKz0gMQogICAgICAgIH0KICAgICAgfSwgc3BlZWQpCiAgICB9LAogICAgY2xvc2VOYXJyYXRpb24oKSB7CiAgICAgIGlmICh0aGlzLnR5cGluZ1RpbWVyKSB7IGNsZWFySW50ZXJ2YWwodGhpcy50eXBpbmdUaW1lcik7IHRoaXMudHlwaW5nVGltZXIgPSBudWxsIH0KICAgICAgdGhpcy5zaG93TmFycmF0aW9uID0gZmFsc2UKICAgICAgdGhpcy50eXBpbmdUZXh0ID0gJycKICAgIH0KICB9Cn0K"},{"version":3,"sources":["index.vue"],"names":[],"mappings":";AAmWA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;;;AAIA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"index.vue","sourceRoot":"src/pages/index","sourcesContent":["<template>\n  <div class=\"game-container\" :class=\"{ 'post-start': gamePhase !== 'preparation' }\">\n    <!-- 顶部状态栏：品牌/用户信息/导航控制（登录、个人中心、准备/开始/商店/退出） -->\n    <div class=\"top-auth-bar\">\n      <div class=\"left\">\n        <span class=\"brand\">时空旅人拍卖会</span>\n      </div>\n      <div class=\"right\" v-if=\"user\">\n        <span class=\"user-email\">{{ user.email }}</span>\n        <button class=\"nav-button\" @click=\"$router.push('/profile')\">个人中心</button>\n      </div>\n      <div class=\"right\" v-else>\n        <button class=\"nav-button primary\" @click=\"$router.push('/login')\">登录 / 注册</button>\n      </div>\n    </div>\n\n    <div class=\"game-status\">\n      <div class=\"room-info\">\n        <div class=\"room-name\">{{ room ? (room.name || '未命名房间') : '未加入房间' }}</div>\n        <div class=\"room-meta\" v-if=\"room\">玩家 {{ playerCount }}/{{ seatCount }} · 房主：{{ ownerName }}</div>\n        <div class=\"room-id-pill\">ID: {{ room ? (room.short_id || room.id) : '-' }}</div>\n      </div>\n      <span class=\"game-phase\">{{ gamePhaseText }}</span>\n       <div class=\"player-energy-hud\" v-if=\"currentPlayer && gamePhase === 'item'\">\n        <span class=\"icon\">⚡</span>\n        <span class=\"label\">能量</span>\n        <span class=\"value\">{{ $store.state.playerEnergy }}</span>\n      </div>\n      <div class=\"game-controls\">\n        <button class=\"control-button\" @click=\"toggleReady\" v-if=\"gamePhase === 'preparation'\">{{ currentUserReady ? '取消准备' : '准备' }}</button>\n        <button class=\"control-button\" @click=\"startGame\" v-if=\"gamePhase === 'preparation' && isOwner && allReady\">开始游戏</button>\n        <button class=\"control-button\" @click=\"startAuction\" v-if=\"false\">开始拍卖</button>\n        <button class=\"control-button\" @click=\"openShop\" v-if=\"gamePhase === 'item'\">道具商店</button>\n        <button class=\"control-button danger\" @click=\"leaveRoom\">退出房间</button>\n      </div>\n    </div>\n\n    <!-- 玩家头像区域：展示房间玩家，点击头像可查看该玩家手牌（当前仅展示自己的手牌明细） -->\n    <div class=\"players-avatars\" v-if=\"playerCount > 0 && gamePhase !== 'preparation'\">\n      <div class=\"avatar-item\" v-for=\"p in (room ? room.room_players : [])\" :key=\"p.user_id\" @click=\"showPlayerHand(p)\">\n        <div class=\"avatar-wrap\">\n          <img class=\"player-avatar\" :src=\"getAvatarFor(p.user_id)\" />\n          <span class=\"ready-indicator\" :class=\"{ on: !!p.is_ready }\"></span>\n        </div>\n        <div class=\"player-name\">{{ getNameFor(p.user_id) }}</div>\n        <div class=\"player-value\">价值 {{ getPlayerTotalValue(p.user_id) }}</div>\n      </div>\n    </div>\n\n    <!-- 拍卖舞台：在不同的 gamePhase 下显示倒计时/间歇/拍卖面板或占位提示 -->\n    <div class=\"auction-stage\" :class=\"{ 'align-left': gamePhase === 'auction' }\">\n      <!-- 预倒计时阶段（游戏开始后5s预热） -->\n      <template v-if=\"gamePhase === 'countdown'\">\n        <div class=\"countdown-stage\">\n          <div class=\"countdown-content\">\n            <div class=\"countdown-icon\">⏳</div>\n            <div class=\"countdown-title\">游戏即将开始</div>\n            <div class=\"countdown-timer\">{{ auctionCountdown }}s</div>\n            <div class=\"countdown-subtitle\">请稍候，拍卖即将开始...</div>\n          </div>\n        </div>\n      </template>\n            <!-- 间歇阶段（每轮结束后的休息时间） -->\n      <template v-else-if=\"gamePhase === 'intermission'\">\n        <div class=\"countdown-stage\">\n          <div class=\"countdown-content\">\n            <div class=\"countdown-icon\">🧭</div>\n            <div class=\"countdown-title\">间歇中</div>\n            <div class=\"countdown-timer\">{{ auctionCountdown }}s</div>\n            <div class=\"countdown-subtitle\">请稍候，下一轮拍卖即将开始...</div>\n          </div>\n        </div>\n      </template>\n      \n      <!-- 拍卖阶段：展示拍卖面板（当前拍品列表、轮次信息、点击卡片触发讲述） -->\n      <auction-panel \n        v-else-if=\"gamePhase === 'auction' && $store.state.currentAuctions && $store.state.currentAuctions.length\" \n        :auctions=\"$store.state.currentAuctions\" \n        :countdown=\"auctionCountdown\"\n        :round-current=\"$store.state.roundCurrent\"\n        :round-total=\"$store.state.roundTotal\"\n        @artifact-click=\"showArtifactDetailFromAuction\" \n      />\n      <!-- 其他情况显示占位提示 -->\n      <div v-else class=\"stage-placeholder\">拍卖会台空闲，等待新一轮拍卖</div>\n    </div>\n\n    <!-- 房间座位区（准备阶段）：点击空位入座，已入座玩家显示头像与准备标记 -->\n    <div class=\"seats\" v-if=\"seatCount > 0 && gamePhase === 'preparation'\" :style=\"{ gridTemplateColumns: 'repeat(' + seatCount + ', 1fr)' }\">\n      <div class=\"seat\" v-for=\"(seat, idx) in seats\" :key=\"idx\" :class=\"{ occupied: !!seat.player }\" @click=\"moveToSeat(idx)\">\n        <div class=\"seat-index\">{{ idx + 1 }}/{{ seatCount }}</div>\n        <div class=\"seat-body\">\n          <div v-if=\"seat.player\" class=\"seat-player\">\n            <div class=\"avatar-wrap\">\n              <img class=\"seat-avatar\" :src=\"getAvatarFor(seat.player.user_id)\" />\n              <span v-if=\"seat.player.is_ready\" class=\"ready-badge\">✓</span>\n            </div>\n            <div class=\"seat-name\">{{ getNameFor(seat.player.user_id) }}</div>\n          </div>\n          <div v-else class=\"seat-empty\">空位</div>\n        </div>\n      </div>\n    </div>\n\n    <!-- 当前玩家手牌：展示自己已拥有的奇物，点击查看详情（或触发讲述） -->\n    <div class=\"my-hand\" v-if=\"gamePhase !== 'preparation'\">\n      <h3 class=\"hand-title\">我的手牌</h3>\n      <div class=\"hand-grid\">\n        <div\n          v-for=\"(aid, idx) in (currentPlayer ? currentPlayer.artifacts : [])\"\n          :key=\"aid + '-' + idx\"\n          class=\"hand-card fancy\"\n          @click=\"showArtifactDetail(aid)\"\n        >\n          <div class=\"hand-media\">\n            <img\n              class=\"hand-image\"\n              :src=\"artifactMap[aid] ? artifactMap[aid].image : 'https://via.placeholder.com/160x100?text=未知卡牌'\"\n            />\n            <div class=\"hand-overlay\"></div>\n          </div>\n          <div class=\"hand-info\">\n            <div class=\"hand-name\" :title=\"artifactMap[aid] ? artifactMap[aid].name : aid\">\n              {{ artifactMap[aid] ? artifactMap[aid].name : aid }}\n            </div>\n            <div class=\"hand-era\" v-if=\"artifactMap[aid] && (artifactMap[aid].era || artifactMap[aid].location)\">\n              {{ artifactMap[aid].era }}<span v-if=\"artifactMap[aid].location\"> · {{ artifactMap[aid].location }}</span>\n            </div>\n            <div class=\"hand-tags\" v-if=\"artifactMap[aid] && artifactMap[aid].collectionTags && artifactMap[aid].collectionTags.length\">\n              <span\n                class=\"hand-tag\"\n                v-for=\"tag in artifactMap[aid].collectionTags.slice(0,2)\"\n                :key=\"tag\"\n              >{{ tag }}</span>\n              <span class=\"hand-tag more\" v-if=\"artifactMap[aid].collectionTags.length > 2\">+{{ artifactMap[aid].collectionTags.length - 2 }}</span>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n\n    <!-- 收藏集进度：仅展示与自己已拥有奇物相关的收藏集，支持展开查看成员清单 -->\n    <div class=\"collections-panel\" v-if=\"gamePhase !== 'preparation'\">\n      <div class=\"collections-section\">\n        <h4 class=\"collections-title\">收藏集进度</h4>\n        <div class=\"collections-list\">\n          <div \n            v-for=\"collection in collectionsComputed\" \n            :key=\"collection.id\"\n            class=\"collection-progress-item\"\n            :class=\"{ completed: collection._current >= collection.requiredCount }\"\n          >\n            <div class=\"collection-header\" @click=\"toggleCollection(collection)\">\n              <div class=\"collection-icon\">🏆</div>\n              <div class=\"collection-info\">\n                <div class=\"collection-name\">{{ collection.name }}</div>\n                <div class=\"collection-description\">{{ collection.description }}</div>\n              </div>\n              <div class=\"collection-reward\" v-if=\"collection._current >= collection.requiredCount\">\n                <span class=\"reward-badge\">✓</span>\n              </div>\n            </div>\n            <!-- 展开展示该收藏集所需所有商品 -->\n            <div class=\"collection-members\" v-if=\"expandedCollections[collection.id]\">\n              <div class=\"member-item\" v-for=\"aid in (collection.artifactIds || [])\" :key=\"aid\">\n                <img class=\"member-image\" :src=\"artifactMap[aid] ? artifactMap[aid].image : 'https://via.placeholder.com/60x40?text=No+Img'\" />\n                <div class=\"member-info\">\n                  <div class=\"member-name\">{{ artifactMap[aid] ? artifactMap[aid].name : aid }}</div>\n                  <div class=\"member-meta\">{{ artifactMap[aid] && artifactMap[aid].era }}<span v-if=\"artifactMap[aid] && artifactMap[aid].location\"> · {{ artifactMap[aid].location }}</span></div>\n                </div>\n                <div class=\"member-status\" :class=\"{ owned: currentPlayer && currentPlayer.artifacts && currentPlayer.artifacts.includes(aid) }\">\n                  {{ currentPlayer && currentPlayer.artifacts && currentPlayer.artifacts.includes(aid) ? '已拥有' : '未拥有' }}\n                </div>\n              </div>\n            </div>\n            <div class=\"progress-container\">\n              <div class=\"progress-bar\">\n                <div \n                  class=\"progress-fill\"\n                  :style=\"{ width: collection._progress + '%' }\"\n                ></div>\n              </div>\n              <div class=\"progress-text\">\n                {{ collection._current }}/{{ collection.requiredCount }}\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n\n    <!-- 聊天/日志面板：合并系统日志与聊天消息为统一时间序信息流 -->\n    <div class=\"chat-panel\" v-if=\"gamePhase !== 'preparation'\">\n      <div class=\"chat-header\">\n        <h4 class=\"chat-title\">聊天 / 日志</h4>\n        <div class=\"chat-status\">\n          <span class=\"status-dot\"></span>\n          <span class=\"status-text\">在线</span>\n        </div>\n      </div>\n      \n      <div class=\"chat-messages\" ref=\"chatContainer\">\n        <div \n          v-for=\"message in chatFeed\" \n          :key=\"message.id\"\n          class=\"chat-message\"\n          :class=\"{ 'own-message': message.type === 'chat' && message.userId === (user && user.id), 'system-log': message.type === 'log' }\"\n        >\n          <div class=\"message-header\">\n            <span class=\"message-username\">{{ message.type === 'log' ? '系统' : message.username }}</span>\n            <span class=\"message-time\">{{ formatMessageTime(message.timestamp) }}</span>\n          </div>\n          <div class=\"message-content\">{{ message.content }}</div>\n        </div>\n      </div>\n      \n      <div class=\"chat-input\">\n        <input \n          v-model=\"newMessage\"\n          @keyup.enter=\"sendMessage\"\n          placeholder=\"输入消息...\"\n          class=\"message-input\"\n        />\n        <button @click=\"sendMessage\" class=\"send-button\" :disabled=\"!newMessage.trim()\">\n          <span class=\"send-icon\">📤</span>\n        </button>\n      </div>\n    </div>\n\n    <!-- 卡牌详情弹窗：展示所选奇物的核心信息与标签 -->\n    <div v-if=\"showCardDetail\" class=\"card-detail-popup\">\n      <div class=\"popup-overlay\" @click=\"hideCardDetail\"></div>\n      <div class=\"popup-content\" v-if=\"selectedCard\">\n        <img \n          class=\"detail-image\" \n          :src=\"selectedCard.image\" \n          alt=\"奇物图片\"\n        />\n        <div class=\"detail-content\">\n          <h3 class=\"detail-name\">{{ selectedCard.name }}</h3>\n          <p class=\"detail-era\">{{ selectedCard.era }} - {{ selectedCard.location }}</p>\n          <p class=\"detail-story\">{{ selectedCard.story }}</p>\n          <div class=\"detail-tags\">\n            <span \n              v-for=\"tag in selectedCard.collectionTags\" \n              :key=\"tag\"\n              class=\"detail-tag\"\n            >\n              {{ tag }}\n            </span>\n          </div>\n          <p class=\"detail-value\">基础价值: {{ selectedCard.baseValue }}</p>\n            \n        </div>\n        <button class=\"close-button\" @click=\"hideCardDetail\">关闭</button>\n      </div>\n    </div>\n\n      <!-- 文物讲述弹层：以角色对白形式讲述 selectedCard 的关键信息 -->\n      <div v-if=\"showNarration && selectedCard\" class=\"narration-popup\">\n        <div class=\"popup-overlay\" @click=\"closeNarration\"></div>\n        <div class=\"popup-content narration-content\">\n          <!-- 顶部：文物大图与快速元信息，图片下方显示名称 -->\n          <div class=\"artifact-media\" v-if=\"selectedCard\">\n            <img class=\"artifact-image-large\" :src=\"selectedCard.image || 'https://via.placeholder.com/800x240?text=Artifact'\" alt=\"artifact\" />\n            <div class=\"artifact-quick-meta\">\n              <span class=\"badge era\" v-if=\"selectedCard.era\">{{ selectedCard.era }}</span>\n              <span class=\"badge location\" v-if=\"selectedCard.location\">{{ selectedCard.location }}</span>\n              <span class=\"badge value\" v-if=\"selectedCard.baseValue !== undefined\">价值 {{ selectedCard.baseValue }}</span>\n              <span class=\"badge tags\" v-if=\"(selectedCard.collectionTags || []).length\">{{ (selectedCard.collectionTags || []).slice(0,3).join('、') }}</span>\n            </div>\n          </div>\n          <div class=\"artifact-caption\" v-if=\"selectedCard && selectedCard.name\">{{ selectedCard.name }}</div>\n\n          <!-- 下方：人物与对白一行排列 -->\n          <div class=\"narration-dialog\">\n            <!-- 左侧：角色大图与姓名 -->\n            <div class=\"character-side\" :style=\"{ borderColor: narrationCharacter && narrationCharacter.color ? narrationCharacter.color : '#3b82f6' }\">\n              <img class=\"character-image\" :src=\"(narrationCharacter && narrationCharacter.image) || '/images/guide.png'\" />\n              <div class=\"character-name\" :style=\"{ color: narrationCharacter && narrationCharacter.color ? narrationCharacter.color : '#3b82f6' }\">\n                {{ narrationCharacterName }}\n              </div>\n            </div>\n            <!-- 右侧：对白气泡 -->\n            <div class=\"speech-side\">\n              <div class=\"speech-bubble\">\n                <div class=\"speech-text\">{{ typingText }}</div>\n              </div>\n              <div class=\"narration-actions\">\n                <button class=\"control-button primary\" @click=\"closeNarration\">好的</button>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n    <!-- 道具商店弹窗：复用全局商店组件 <item-shop />，与 /shop 页面共用一套逻辑 -->\n    <div v-if=\"showShop\" class=\"shop-popup\">\n      <div class=\"popup-overlay\" @click=\"closeShop\"></div>\n      <div class=\"popup-content\">\n        <item-shop />\n        <button class=\"close-button\" @click=\"closeShop\">关闭商店</button>\n      </div>\n    </div>\n\n    <!-- 手牌弹窗：查看某位玩家的手牌缩略（当前仅展示当前玩家持有的真实列表） -->\n    <div v-if=\"showHandPopup\" class=\"hand-popup\">\n      <div class=\"popup-overlay\" @click=\"hideHand\"></div>\n      <div class=\"popup-content\">\n        <h3 class=\"hand-title\">{{ handPlayer ? handPlayer.name + ' 的手牌' : '手牌' }}</h3>\n        <div class=\"hand-grid\">\n          <div v-for=\"aid in (handPlayer ? handPlayer.artifacts : [])\" :key=\"aid\" class=\"hand-card\">\n            <img class=\"hand-image\" :src=\"artifactMap[aid] ? artifactMap[aid].image : 'https://via.placeholder.com/160x100?text=未知卡牌'\" />\n            <div class=\"hand-name\">{{ artifactMap[aid] ? artifactMap[aid].name : aid }}</div>\n          </div>\n        </div>\n        <button class=\"close-button\" @click=\"hideHand\">关闭</button>\n      </div>\n    </div>\n\n    <!-- 游戏结束对话框：展示最终排名与赢家信息，提供回房或去列表的导航 -->\n    <div v-if=\"showGameEndDialog\" class=\"game-end-popup\">\n      <div class=\"popup-overlay\" @click=\"closeGameEndDialog\"></div>\n      <div class=\"popup-content game-end-content\">\n        <div class=\"game-end-header\">\n          <div class=\"game-end-icon\">🏆</div>\n          <h2 class=\"game-end-title\">游戏结束</h2>\n          <p class=\"game-end-subtitle\" v-if=\"winnerInfo\">胜者：{{ winnerInfo.name }} · 总分 {{ winnerInfo.total }}</p>\n          <p class=\"game-end-subtitle\" v-else>感谢参与时空旅人拍卖会！</p>\n        </div>\n        <div class=\"final-scoreboard\" v-if=\"finalScores && finalScores.length\">\n          <div class=\"score-row\" v-for=\"(p, idx) in finalScores\" :key=\"p.userId\">\n            <div class=\"rank\">{{ idx + 1 }}</div>\n            <img class=\"score-avatar\" :src=\"p.avatar\" />\n            <div class=\"name\">{{ p.name }}</div>\n            <div class=\"detail\">收藏集 {{ p.collectionScore }} + 奇物 {{ p.artifactScore }} = <b>{{ p.total }}</b></div>\n          </div>\n        </div>\n        \n        <div class=\"game-end-actions\">\n          <button class=\"action-button primary\" @click=\"stayInRoom\">\n            <span class=\"btn-icon\">🏠</span>\n            留在房间\n          </button>\n          <button class=\"action-button secondary\" @click=\"goToRooms\">\n            <span class=\"btn-icon\">📋</span>\n            返回房间列表\n          </button>\n        </div>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script>\nimport { mapState, mapGetters } from 'vuex'\nimport AuctionPanel from '../../components/auction-panel/auction-panel.vue'\nimport ItemShop from '../../components/item-shop/item-shop.vue'\nimport roomService from '../../services/room-service'\nimport { getSupabase } from '../../services/supabase-client'\nimport auctionService from '../../services/auction-service'\nimport { startCountdown, clearCountdown } from '../../features/game/countdown'\nimport { loadRoomState as loadRoomStateService } from '../../features/game/room-state.service'\nimport { subscribeRoomRealtime as subscribeRoomRealtimeService, unsubscribeRoomRealtime as unsubscribeRoomRealtimeService } from '../../features/game/room-realtime'\nimport { startGame as startGameFlow, autoStartAuction as autoStartAuctionFlow } from '../../features/game/auction-flow.service'\nimport { sendChatMessage } from '../../features/game/chat.service'\nimport { toggleReady as toggleReadyAction, moveToSeat as moveToSeatAction, leaveRoom as leaveRoomAction } from '../../features/game/room-actions.service'\nimport { loadArtifacts as loadArtifactsService } from '../../features/game/artifacts.service'\nimport { loadCollectionsFromArtifacts, getCurrentCollectionCount as getCollectionCountUtil, getCollectionProgress as getCollectionProgressUtil } from '../../features/game/collections.utils'\nimport { formatMessageTime as formatMessageTimeHelper, getAvatarFor as getAvatarForHelper, getNameFor as getNameForHelper } from '../../features/game/ui.helpers'\nimport { firstLoginDialogue as firstLoginDialogueConfig, getCurrentLanguage as getCurrentLanguageImported } from '../../config/dialogue-config'\nexport default {\n  name: 'GameIndex',\n  components: {\n    AuctionPanel,\n    ItemShop\n  },\n  data() {\n    return {\n      selectedCard: null,\n      showHandPopup: false,\n      handPlayer: null,\n      artifactMap: {},\n      room: null,\n      profileMap: {},\n      refreshTimer: null,\n      collections: [],\n      showGameEndDialog: false,\n      finalScores: [],\n      winnerInfo: null,\n      auctionCountdown: 0,\n      auctionTimer: null,\n      currentAuction: null,\n      // 回合相关（前端实时显示，房主每轮开拍时广播以保持同步）\n      roundCount: 0,\n      totalRounds: 6,\n      chatMessages: [],\n      newMessage: '',\n      chatChannel: null,\n      countdownInProgress: false,\n      expandedCollections: {},\n      showNarration: false,\n      typingText: '',\n      typingTimer: null,\n      // 存储所有玩家的手牌数据，用于价值计算\n      allPlayersArtifacts: {}\n    }\n  },\n  computed: {\n    ...mapState(['gamePhase', 'gameLog', 'showCardDetail', 'showShop', 'user', 'roomId', 'roundCurrent', 'roundTotal']),\n    // 将当前玩家注入到渲染上下文，避免模板引用报错\n    currentPlayer() { return this.$store.state.currentPlayer },\n    isOwner() { return this.room && this.user && this.room.owner_id === this.user.id },\n    allReady() {\n      const players = (this.room && this.room.room_players) ? this.room.room_players : []\n      return players.length > 0 && players.every(p => !!p.is_ready)\n    },\n    currentUserReady() {\n      const user = this.user\n      const players = (this.room && this.room.room_players) ? this.room.room_players : []\n      if (!user) return false\n      const me = players.find(p => p.user_id === user.id)\n      return !!(me && me.is_ready)\n    },\n    playerCount() {\n      return (this.room && this.room.room_players) ? this.room.room_players.length : 0\n    },\n    ownerName() {\n      if (!this.room) return '-'\n      return this.getNameFor(this.room.owner_id)\n    },\n    seatCount() { return (this.room && Number(this.room.max_players)) ? Number(this.room.max_players) : 0 },\n    seats() {\n      const players = (this.room && this.room.room_players) ? this.room.room_players : []\n      const max = this.seatCount\n      const seats = Array.from({ length: max }, () => ({ player: null }))\n      // 放置已设置座位的玩家\n      players.forEach(p => {\n        const idx = typeof p.seat_index === 'number' ? p.seat_index : -1\n        if (idx >= 0 && idx < max && !seats[idx].player) seats[idx].player = p\n      })\n      // 将未设置座位的玩家依次放到空位\n      players.filter(p => typeof p.seat_index !== 'number' || p.seat_index < 0).forEach(p => {\n        const emptyIdx = seats.findIndex(s => !s.player)\n        if (emptyIdx >= 0) seats[emptyIdx].player = p\n      })\n      return seats\n    },\n    gamePhaseText() {\n      const phaseMap = {\n        'preparation': '准备阶段',\n        'countdown': '预倒计时',\n        'intermission': '间歇阶段',\n        'auction': '拍卖阶段',\n        'item': '道具阶段',\n        'settlement': '结算阶段'\n      }\n      return phaseMap[this.gamePhase] || '未知阶段'\n    },\n   \n\n    // 根据当前用户手牌计算收藏集显示数据，带缓存字段，便于模板直接引用\n    collectionsComputed() {\n      const list = Array.isArray(this.collections) ? this.collections : []\n      // 仅展示用户手牌中至少包含1件该收藏集的情况\n      return list\n        .map(col => {\n          const current = this.getCurrentCollectionCount(col)\n          const progress = Math.min((current / (col.requiredCount || 1)) * 100, 100)\n          return { ...col, _current: current, _progress: progress }\n        })\n        .filter(col => col._current > 0)\n    },\n\n    // 合并聊天与系统日志为同一信息流，按时间排序\n    chatFeed() {\n      const logs = (this.gameLog || []).map((l, idx) => ({\n        id: `log-${l.timestamp || idx}`,\n        type: 'log',\n        userId: null,\n        username: '系统',\n        content: l.message,\n        timestamp: l.timestamp || 0\n      }))\n      const chats = (this.chatMessages || []).map(m => ({ ...m, type: 'chat' }))\n      const merged = [...logs, ...chats]\n      return merged.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0))\n    },\n    // 暴露对话配置供模板使用\n    firstLoginConfig() { return firstLoginDialogueConfig },\n    // 当前讲述角色配置与名称\n    narrationCharacterName() { return (this.getCurrentLanguage() === 'zh-CN') ? '大木博士' : 'Dr. Alina' },\n    narrationCharacter() {\n      const key = this.narrationCharacterName\n      const chars = firstLoginDialogueConfig && firstLoginDialogueConfig.characters\n      return (chars && chars[key]) ? chars[key] : { image: '/images/guide.png', position: 'right', color: '#3b82f6' }\n    }\n  },\n  async mounted() {\n    const roomId = this.$route.query.roomId\n    if (roomId) this.$store.commit('SET_ROOM_ID', roomId)\n    await this.initializeGame()\n    await this.loadRoomState()\n    // loadRoomState 中已经调用了 loadAllPlayersArtifacts，这里确保数据加载\n    await this.subscribeRoomRealtime()\n  },\n  beforeDestroy() {\n    this.unsubscribeRoomRealtime()\n    if (this.refreshTimer) { clearInterval(this.refreshTimer); this.refreshTimer = null }\n    if (this.auctionTimer) { clearInterval(this.auctionTimer); this.auctionTimer = null }\n    if (this.typingTimer) { clearInterval(this.typingTimer); this.typingTimer = null }\n    this.$set(this, 'auctionCountdown', 0)\n  },\n  watch: {\n    gameLog() {\n      this.$nextTick(() => {\n        const chatContainer = this.$refs.chatContainer\n        if (chatContainer) { chatContainer.scrollTop = chatContainer.scrollHeight }\n      })\n    }\n  },\n  methods: {\n    // 去掉模拟初始化玩家，改为使用房间的实际玩家列表\n    async initializeGame() {\n      const artifacts = await this.loadArtifacts()\n      this.artifactMap = artifacts.reduce((acc, a) => { acc[a.id] = a; return acc }, {})\n      await this.loadCollections()\n    },\n    async subscribeRoomRealtime() {\n      const rid = this.$store.state.roomId\n      if (!rid) return\n      const supabase = getSupabase()\n      const { roomChannel, broadcastChannel } = subscribeRoomRealtimeService(\n        { roomId: rid, supabase, onLoadRoomState: this.loadRoomState },\n        {\n          onGameStarted: async (_payload) => {\n            // 防止重复启动多个倒计时\n            if (this.countdownInProgress) return\n            this.countdownInProgress = true\n            \n            // 新局开始：重置聊天消息和价值数据\n            this.chatMessages = []\n            this.allPlayersArtifacts = {}\n            // 重置回合数\n            this.$store.commit('RESET_ROUND')\n            this.$store.commit('SET_ROUND_TOTAL', 6)\n            \n            this.$store.commit('SET_GAME_PHASE', 'countdown')\n            this.$set(this, 'auctionCountdown', 5)\n            const me = (this.room && this.room.room_players ? this.room.room_players : []).find(p => p.user_id === this.$store.state.user.id)\n            if (me) {\n              this.$store.commit('SET_CURRENT_PLAYER', { id: me.user_id, name: this.getNameFor(me.user_id), energy: 50, artifacts: [], items: [] })\n            }\n            if (this.auctionTimer) { clearInterval(this.auctionTimer); this.auctionTimer = null }\n            this.$nextTick(() => {\n              startCountdown({\n                seconds: 5,\n                onTick: (s) => { this.$set(this, 'auctionCountdown', s) },\n                onDone: async () => { this.countdownInProgress = false; if (this.isOwner) { await this.autoStartAuction() } },\n                getRef: () => this.auctionTimer,\n                setRef: (id) => { this.auctionTimer = id },\n              })\n            })\n          },\n          onAuctionStarted: async (duration, payload) => { \n            // 确保所有玩家都能看到拍卖数据\n            await this.loadRoomState()\n            \n            // 同步回合数（如果广播中包含了回合信息）\n            if (payload && typeof payload.roundCurrent === 'number') {\n              this.$store.commit('SET_ROUND_CURRENT', payload.roundCurrent)\n            }\n            if (payload && typeof payload.roundTotal === 'number') {\n              this.$store.commit('SET_ROUND_TOTAL', payload.roundTotal)\n            }\n            \n            this.startAuctionTimer(duration) \n          },\n          onBidUpdate: ({ auctionId, highestBid, highestBidder }) => {\n            if (!auctionId) return\n            const list = this.$store.state.currentAuctions || []\n            const idx = list.findIndex(a => a.id === auctionId)\n            if (idx >= 0) {\n              const next = { ...list[idx], highestBid, highestBidder }\n              this.$store.commit('ADD_OR_UPDATE_AUCTION', next)\n            }\n          },\n          // 旧回合广播已移除，统一本地推进，不再接收该事件\n          onRoundUpdated: (_data) => {},\n          onGameEnded: () => {\n            this.$store.commit('SET_GAME_PHASE', 'settlement')\n        this.computeFinalScores().finally(() => { this.showGameEndDialog = true })\n            if (this.auctionTimer) { clearInterval(this.auctionTimer); this.auctionTimer = null }\n          },\n          onAuctionEnded: async () => { await this.loadRoomState() },\n          onChatMessage: (message) => {\n            // 避免重复添加消息\n            if (!message || !message.id) return\n            const existing = this.chatMessages.find(m => m.id === message.id || (m.userId === message.userId && m.timestamp === message.timestamp && m.content === message.content))\n            if (existing) return\n            \n            this.chatMessages.push(message)\n            this.$nextTick(() => {\n              const chatContainer = this.$refs.chatContainer\n              if (chatContainer) { chatContainer.scrollTop = chatContainer.scrollHeight }\n            })\n          },\n        },\n        () => { if (!this.refreshTimer) { this.refreshTimer = setInterval(this.loadRoomState, 1000) } }\n      )\n      this.roomChannel = roomChannel\n      this.broadcastChannel = broadcastChannel\n    },\n    unsubscribeRoomRealtime() {\n      unsubscribeRoomRealtimeService(this.roomChannel, this.broadcastChannel)\n      this.roomChannel = null\n      this.broadcastChannel = null\n    },\n    async loadRoomState() {\n      const rid = this.$store.state.roomId\n      const supabase = getSupabase()\n      await loadRoomStateService({\n        roomId: rid,\n        roomService,\n        supabase,\n        artifactMap: this.artifactMap,\n        store: this.$store,\n        setRoom: (room) => { this.room = room },\n        setProfileMap: (map) => { this.profileMap = map },\n        setGamePhase: (phase) => { this.$store.commit('SET_GAME_PHASE', phase) },\n        clearAuctionTimer: () => { if (this.auctionTimer) { clearInterval(this.auctionTimer); this.auctionTimer = null } },\n        setAuctionCountdown: (n) => { this.$set(this, 'auctionCountdown', n) },\n        onShowGameEnd: () => { this.showGameEndDialog = true; setTimeout(() => { this.handleGameEnd() }, 3000) },\n      })\n      // 加载所有玩家的手牌数据，用于价值计算\n      await this.loadAllPlayersArtifacts()\n      // 如果刷新后发现仍有活跃拍卖，但本地无倒计时，则用当前剩余时间启动统一倒计时\n      const auctions = this.$store.state.currentAuctions || []\n      if (this.$store.state.gamePhase === 'auction' && auctions.length > 0) {\n        const remaining = Number(this.auctionCountdown || 0)\n        if (!this.auctionTimer && remaining > 0) {\n          startCountdown({\n            seconds: remaining,\n            onTick: (s) => { this.$set(this, 'auctionCountdown', s); },\n            onDone: async () => { await this.onAuctionTimeUp() },\n            getRef: () => this.auctionTimer,\n            setRef: (id) => { this.auctionTimer = id },\n          })\n        }\n      }\n    },\n    \n    // 加载所有玩家的手牌数据\n    async loadAllPlayersArtifacts() {\n      try {\n        const rid = this.$store.state.roomId\n        if (!rid) {\n          this.allPlayersArtifacts = {}\n          return\n        }\n        \n        const supabase = getSupabase()\n        // 获取房间内所有玩家的手牌数据\n        const { data: allArtifacts } = await supabase\n          .from('room_artifacts')\n          .select('owner_user_id, artifact_id')\n          .eq('room_id', rid)\n        \n        // 按玩家ID分组\n        const playerArtifactsMap = {}\n        if (allArtifacts && allArtifacts.length > 0) {\n          allArtifacts.forEach(row => {\n            const userId = row.owner_user_id\n            if (!playerArtifactsMap[userId]) {\n              playerArtifactsMap[userId] = []\n            }\n            playerArtifactsMap[userId].push(row.artifact_id)\n          })\n        }\n        \n        // 使用 Vue.set 确保响应式更新\n        this.$set(this, 'allPlayersArtifacts', playerArtifactsMap)\n      } catch (e) {\n        console.warn('[game] loadAllPlayersArtifacts failed', e)\n        this.allPlayersArtifacts = {}\n      }\n    },\n    async toggleReady() {\n      try {\n        const rid = this.$store.state.roomId\n        const uid = this.$store.state.user && this.$store.state.user.id\n        if (!rid || !uid) return\n        await toggleReadyAction({ roomId: rid, userId: uid, room: this.room, roomService, reload: this.loadRoomState })\n      } catch (e) { console.warn('[game] toggleReady failed', e) }\n    },\n    async moveToSeat(idx) {\n      try {\n        const rid = this.$store.state.roomId\n        const uid = this.$store.state.user && this.$store.state.user.id\n        if (!rid || !uid) return\n        const targetSeat = { index: idx, player: this.seats[idx] && this.seats[idx].player }\n        await moveToSeatAction({ roomId: rid, userId: uid, room: this.room, seats: targetSeat, roomService, reload: this.loadRoomState })\n      } catch (e) { console.warn('[game] moveToSeat failed', e) }\n    },\n    async leaveRoom() {\n      try {\n        const rid = this.$store.state.roomId\n        const uid = this.$store.state.user && this.$store.state.user.id\n        if (!rid || !uid) return\n        await leaveRoomAction({\n          roomId: rid,\n          userId: uid,\n          clearAuctionTimer: () => { if (this.auctionTimer) { clearInterval(this.auctionTimer); this.auctionTimer = null } },\n          setCountdown: (n) => { this.$set(this, 'auctionCountdown', n) },\n          store: this.$store,\n          auctionService,\n          roomService,\n          unsubscribe: () => this.unsubscribeRoomRealtime(),\n          setRoomId: (v) => this.$store.commit('SET_ROOM_ID', v),\n          setLocalRoom: (v) => { this.room = v },\n          navigateToRooms: () => this.$router.push('/rooms'),\n        })\n      } catch (e) { console.warn('[game] leaveRoom failed', e) }\n    },\n    \n    // 游戏结束处理\n    async handleGameEnd() {\n      try {\n        const rid = this.$store.state.roomId\n        if (rid) {\n          // 将房间状态重置为 waiting，便于继续房间内准备/新一局\n          const supabase = getSupabase()\n          await supabase.from('rooms').update({ status: 'waiting' }).eq('id', rid)\n          // 跳转回房间页面（游戏页携带 roomId 即是房间界面）\n          this.$router.push({ path: '/game', query: { roomId: rid, gameEnded: 'true' } })\n        } else {\n          this.$router.push('/rooms')\n        }\n      } catch (e) {\n        console.warn('[game] handleGameEnd failed', e)\n        // 兜底跳回房间列表\n        this.$router.push('/rooms')\n      }\n    },\n    async startGame() {\n      try {\n        const rid = this.$store.state.roomId\n        const uid = this.$store.state.user && this.$store.state.user.id\n        if (!rid || !uid || !this.isOwner || !this.allReady) return\n        // 新局开始前重置系统日志、聊天消息和价值数据\n        try { this.$store.commit('CLEAR_GAME_LOG') } catch (_) {}\n        this.chatMessages = []\n        this.allPlayersArtifacts = {}\n        await roomService.startGame(rid, uid)\n        const supabase = getSupabase()\n        this.roundCount = 0\n        await startGameFlow({\n          roomId: rid,\n          userId: uid,\n          isOwner: this.isOwner,\n          allReady: this.allReady,\n          store: this.$store,\n          supabase,\n          setCountdown: (n) => this.$set(this, 'auctionCountdown', n),\n          setCurrentPlayerFromRoom: () => {\n            const me = (this.room && this.room.room_players ? this.room.room_players : []).find(p => p.user_id === uid)\n            if (me) { this.$store.commit('SET_CURRENT_PLAYER', { id: me.user_id, name: this.getNameFor(me.user_id), energy: 50, artifacts: [], items: [] }) }\n          },\n          onCountdownDone: async () => {\n            if (this.isOwner) { await this.autoStartAuction() }\n          },\n        })\n        // 房主本地也启动预倒计时，防止广播不回传导致不触发 onGameStarted\n        if (!this.countdownInProgress) {\n          this.countdownInProgress = true\n          // 确保本地也重置数据\n          this.chatMessages = []\n          this.allPlayersArtifacts = {}\n          this.$store.commit('SET_GAME_PHASE', 'countdown')\n          this.$set(this, 'auctionCountdown', 5)\n          const me = (this.room && this.room.room_players ? this.room.room_players : []).find(p => p.user_id === uid)\n          if (me) {\n            this.$store.commit('SET_CURRENT_PLAYER', { id: me.user_id, name: this.getNameFor(me.user_id), energy: 50, artifacts: [], items: [] })\n          }\n          if (this.auctionTimer) { clearInterval(this.auctionTimer); this.auctionTimer = null }\n          this.$nextTick(() => {\n            startCountdown({\n              seconds: 5,\n              onTick: (s) => { this.$set(this, 'auctionCountdown', s) },\n              onDone: async () => { this.countdownInProgress = false; if (this.isOwner) { await this.autoStartAuction() } },\n              getRef: () => this.auctionTimer,\n              setRef: (id) => { this.auctionTimer = id },\n            })\n          })\n        }\n      } catch (e) { console.warn('[game] startGame failed', e) }\n    },\n    \n    async startAuction() {\n      // 同时抽取多件进行拍卖（示例为2件）\n      const artifacts = await this.loadArtifacts()\n      if (artifacts.length > 0) {\n        const picks = []\n        while (picks.length < Math.min(2, artifacts.length)) {\n          const candidate = artifacts[Math.floor(Math.random() * artifacts.length)]\n          if (!picks.find(p => p.id === candidate.id)) picks.push(candidate)\n        }\n        for (const art of picks) {\n          await this.$store.dispatch('startAuction', art)\n        }\n      }\n    },\n    \n    async loadArtifacts() {\n      try {\n        const supabase = getSupabase()\n        return await loadArtifactsService({ supabase })\n      } catch (error) { console.error('加载卡牌数据失败:', error); return [] }\n    },\n    \n    openShop() {\n      this.$store.commit('SET_SHOW_SHOP', true)\n    },\n    \n    closeShop() {\n      this.$store.commit('SET_SHOW_SHOP', false)\n    },\n    \n    showArtifactDetail(artifactId) {\n      // 若已加载artifactMap，则优先展示真实数据\n      const artifact = this.artifactMap[artifactId]\n      if (artifact) {\n        this.selectedCard = artifact\n      } else {\n        // 回退：维持原示例\n        this.selectedCard = {\n          id: artifactId,\n          name: '示例奇物',\n          era: '古代',\n          location: '未知',\n          story: '这是一个神秘的奇物...',\n          collectionTags: ['艺术瑰宝'],\n          baseValue: 8,\n          image: 'https://via.placeholder.com/300x200?text=示例奇物'\n        }\n      }\n      this.$store.commit('SET_SHOW_CARD_DETAIL', true)\n    },\n    \n    hideCardDetail() {\n      this.$store.commit('SET_SHOW_CARD_DETAIL', false)\n      this.selectedCard = null\n    },\n    showArtifactDetailFromAuction(artifact) {\n      this.selectedCard = artifact\n      this.$store.commit('SET_SHOW_CARD_DETAIL', false)\n      this.openNarration()\n    },\n    // 计算玩家总价值（支持所有玩家）\n    getPlayerTotalValue(userId) {\n      if (!userId) return 0\n      \n      // 优先从 allPlayersArtifacts 获取所有玩家的手牌数据\n      let owned = []\n      if (this.allPlayersArtifacts && this.allPlayersArtifacts[userId]) {\n        owned = Array.isArray(this.allPlayersArtifacts[userId]) ? this.allPlayersArtifacts[userId] : []\n      } else {\n        // 回退：如果 allPlayersArtifacts 中没有，尝试从当前玩家数据获取\n        const current = this.$store.state.currentPlayer\n        if (current && current.id === userId) {\n          owned = Array.isArray(this.$store.state.playerArtifacts) ? this.$store.state.playerArtifacts : []\n        }\n      }\n      \n      if (!owned || owned.length === 0) return 0\n      \n      // 确保 artifactMap 已加载\n      if (!this.artifactMap || Object.keys(this.artifactMap).length === 0) return 0\n      \n      let total = 0\n      owned.forEach(aid => {\n        const a = this.artifactMap[aid]\n        if (a && typeof a.baseValue === 'number') {\n          total += a.baseValue\n        }\n      })\n      return total\n    },\n\n    showPlayerHand(player) {\n      // 构造玩家对象，包含手牌信息\n      const playerData = {\n        id: player.user_id,\n        name: this.getNameFor(player.user_id),\n        artifacts: this.currentPlayer && this.currentPlayer.id === player.user_id ? \n          (this.currentPlayer.artifacts || []) : []\n      }\n      this.handPlayer = playerData\n      this.showHandPopup = true\n    },\n\n    hideHand() {\n      this.handPlayer = null\n      this.showHandPopup = false\n    },\n    \n    \n    getAvatarFor(userId) { return getAvatarForHelper({ profileMap: this.profileMap, userId }) },\n    getNameFor(userId) { return getNameForHelper({ profileMap: this.profileMap, room: this.room, userId }) },\n    getCurrentLanguage() { return getCurrentLanguageImported() },\n    \n    // 加载收藏集数据：基于数据库 artifacts 的 collection_tags 动态生成\n    async loadCollections() {\n      try { this.collections = loadCollectionsFromArtifacts(this.artifactMap) }\n      catch (error) { console.error('加载收藏集数据失败:', error); this.collections = [] }\n    },\n    \n   \n    \n    // 获取当前收藏集数量（基于当前用户手牌，且受最大要求数上限限制）\n    getCurrentCollectionCount(collection) {\n      const owned = (this.currentPlayer && this.currentPlayer.artifacts) ? this.currentPlayer.artifacts : []\n      return getCollectionCountUtil({ artifactMap: this.artifactMap, ownedArtifactIds: owned, collection })\n    },\n\n\n    // 展开/收起收藏集\n    toggleCollection(collection) {\n      const id = collection && collection.id\n      if (!id) return\n      this.$set(this.expandedCollections, id, !this.expandedCollections[id])\n    },\n    \n    // 关闭游戏结束对话框\n    closeGameEndDialog() {\n      this.showGameEndDialog = false\n    },\n    \n    // 留在房间\n    stayInRoom() {\n      this.showGameEndDialog = false\n      try { this.$store.commit('CLEAR_GAME_LOG') } catch (_) {}\n      // 返回当前房间准备界面\n      const rid = this.$store.state.roomId\n      if (rid) {\n        this.$store.commit('SET_GAME_PHASE', 'preparation')\n        this.$router.push({ path: '/game', query: { roomId: rid } })\n      }\n    },\n    \n    // 返回房间列表\n    goToRooms() {\n      this.showGameEndDialog = false\n      this.unsubscribeRoomRealtime()\n      try { this.$store.commit('CLEAR_GAME_LOG') } catch (_) {}\n      // 返回当前房间准备界面（更符合期望）\n      const rid = this.$store.state.roomId\n      if (rid) {\n        this.$store.commit('SET_GAME_PHASE', 'preparation')\n        this.$router.push({ path: '/game', query: { roomId: rid } })\n      } else {\n        this.$router.push('/rooms')\n      }\n    },\n    \n    // 时间到：结束当前所有拍卖并结算到对应玩家手牌，然后进入10s间歇或结束游戏\n    async onAuctionTimeUp() {\n      try {\n        const auctions = this.$store.state.currentAuctions || []\n        // 统一倒计时结束：结束所有当前拍卖\n        for (const a of auctions) {\n          await this.$store.dispatch('endAuction', a.id)\n        }\n        // 判断是否达到总回合数\n        const cur = Number(this.$store.state.roundCurrent || 0)\n        const tot = Number(this.$store.state.roundTotal || 6)\n        if (cur >= tot) {\n          // 触发结束\n          this.$store.commit('SET_GAME_PHASE', 'settlement')\n          await this.computeFinalScores()\n          this.showGameEndDialog = true\n          return\n        }\n        // 否则进入10s间歇阶段\n        this.startIntermissionTimer(10)\n      } catch (e) { console.warn('[game] onAuctionTimeUp failed', e) }\n    },\n\n    // 开始拍卖倒计时：统一每轮拍卖只有一个倒计时\n    startAuctionTimer(duration = 30) {\n      this.$store.commit('SET_GAME_PHASE', 'auction')\n      startCountdown({\n        seconds: duration,\n        onTick: (s) => { this.$set(this, 'auctionCountdown', s); },\n        onDone: async () => { await this.onAuctionTimeUp() },\n        getRef: () => this.auctionTimer,\n        setRef: (id) => { this.auctionTimer = id },\n      })\n    },\n\n\n    \n    // 每轮之间的间歇计时器，结束后自动开始下一轮拍卖\n    startIntermissionTimer(duration = 10) {\n      this.$store.commit('SET_GAME_PHASE', 'intermission')\n      startCountdown({\n        seconds: duration,\n        onTick: (s) => { this.$set(this, 'auctionCountdown', s); },\n        onDone: async () => {\n          if (this.isOwner) {\n            await this.autoStartAuction()\n          }\n        },\n        getRef: () => this.auctionTimer,\n        setRef: (id) => { this.auctionTimer = id },\n      })\n    },\n    \n    // 自动开始拍卖\n    async autoStartAuction() {\n      try {\n        const rid = this.$store.state.roomId\n        const supabase = getSupabase()\n        await autoStartAuctionFlow({\n          roomId: rid,\n          store: this.$store,\n          supabase,\n          loadArtifacts: () => this.loadArtifacts(),\n          dispatchStartAuction: (art) => this.$store.dispatch('startAuction', art),\n          startAuctionTimer: (sec) => this.startAuctionTimer(sec),\n          roundCount: this.roundCount,\n          totalRounds: this.totalRounds,\n          setRoundCount: (n) => { this.roundCount = n },\n        })\n      } catch (e) { console.warn('[game] autoStartAuction failed', e) }\n    },\n    \n    // 发送聊天消息\n    async sendMessage() {\n      if (!this.newMessage.trim() || !this.user) return\n      const message = { \n        id: Date.now(), \n        userId: this.user.id, \n        username: this.getNameFor(this.user.id), \n        content: this.newMessage.trim(), \n        timestamp: Date.now() \n      }\n      // 本地立即显示，提供即时反馈\n      this.chatMessages.push(message)\n      this.newMessage = ''\n      \n      // 滚动到底部\n      this.$nextTick(() => {\n        const chatContainer = this.$refs.chatContainer\n        if (chatContainer) { chatContainer.scrollTop = chatContainer.scrollHeight }\n      })\n      \n      // 发送到服务器，广播给所有玩家\n      const rid = this.$store.state.roomId\n      if (rid) { \n        try { \n          const supabase = getSupabase()\n          await sendChatMessage({ supabase, roomId: rid, message }) \n        } catch (e) { \n          console.warn('[game] sendMessage failed', e)\n          // 发送失败时，可以选择移除本地消息或保留（保留提供更好的用户体验）\n        } \n      }\n    },\n    \n    // 格式化消息时间\n    formatMessageTime(timestamp) { return formatMessageTimeHelper(timestamp) }\n    ,\n\n    // 计算最终得分并确定赢家\n    async computeFinalScores() {\n      try {\n        const rid = this.$store.state.roomId\n        if (!rid) return\n        const supabase = getSupabase()\n        const { data: rows } = await supabase\n          .from('room_artifacts')\n          .select('owner_user_id, artifact_id')\n          .eq('room_id', rid)\n        const userToArtifacts = {}\n        ;(rows || []).forEach(r => {\n          if (!userToArtifacts[r.owner_user_id]) userToArtifacts[r.owner_user_id] = []\n          userToArtifacts[r.owner_user_id].push(r.artifact_id)\n        })\n\n        const collections = Array.isArray(this.collections) ? this.collections : []\n        const scores = Object.keys(userToArtifacts).map(uid => {\n          const owned = userToArtifacts[uid]\n          // 收藏集分数\n          let collectionScore = 0\n          collections.forEach(col => {\n            const current = getCollectionCountUtil({ artifactMap: this.artifactMap, ownedArtifactIds: owned, collection: col })\n            if (current >= (col.requiredCount || 1)) collectionScore += (col.rewardPoints || 0)\n          })\n          // 零散奇物分数（基础价值一半，向下取整）\n          let artifactScore = 0\n          owned.forEach(aid => {\n            const a = this.artifactMap[aid]\n            if (a && typeof a.baseValue === 'number') artifactScore += Math.floor(a.baseValue / 2)\n          })\n        \n          const total = collectionScore + artifactScore\n          return {\n            userId: uid,\n            name: this.getNameFor(uid),\n            avatar: this.getAvatarFor(uid),\n            collectionScore,\n            artifactScore,\n            total\n          }\n        })\n\n        const sorted = scores.sort((a, b) => b.total - a.total)\n        this.finalScores = sorted\n        this.winnerInfo = sorted[0] || null\n\n        if (this.winnerInfo) {\n          this.$store.commit('ADD_GAME_LOG', { timestamp: Date.now(), message: `本局结束，胜者：${this.winnerInfo.name}（总分 ${this.winnerInfo.total}）` })\n        }\n      } catch (e) { console.warn('[game] computeFinalScores failed', e) }\n    },\n\n    // 开启/关闭文物讲述\n    openNarration() {\n      // 构造讲述文本，包含基本介绍 + 故事\n      const base = `${this.selectedCard.name}，来自 ${this.selectedCard.era}${this.selectedCard.location ? ' · ' + this.selectedCard.location : ''}。\\n`\n      const story = (this.selectedCard.story || '').trim()\n      const full = `${base}${story}`.trim()\n      // 打字机效果\n      this.typingText = ''\n      this.showNarration = true\n      const speed = (firstLoginDialogueConfig && firstLoginDialogueConfig.animations && firstLoginDialogueConfig.animations.textTypingSpeed) || 30\n      if (this.typingTimer) { clearInterval(this.typingTimer); this.typingTimer = null }\n      let i = 0\n      this.typingTimer = setInterval(() => {\n        if (i >= full.length) {\n          clearInterval(this.typingTimer)\n          this.typingTimer = null\n        } else {\n          this.typingText += full[i]\n          i += 1\n        }\n      }, speed)\n    },\n    closeNarration() {\n      if (this.typingTimer) { clearInterval(this.typingTimer); this.typingTimer = null }\n      this.showNarration = false\n      this.typingText = ''\n    }\n  }\n}\n</script>\n\n<style lang=\"scss\" scoped src=\"./index.scss\"></style>"]}]}