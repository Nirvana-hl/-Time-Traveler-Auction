{"remainingRequest":"D:\\大学生活\\大三\\全栈ai\\项目\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\大学生活\\大三\\全栈ai\\项目\\-Time-Traveler-Auction\\src\\pages\\index\\index.vue?vue&type=script&lang=js","dependencies":[{"path":"D:\\大学生活\\大三\\全栈ai\\项目\\-Time-Traveler-Auction\\src\\pages\\index\\index.vue","mtime":1762829596718},{"path":"D:\\大学生活\\大三\\全栈ai\\项目\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1762215254891},{"path":"D:\\大学生活\\大三\\全栈ai\\项目\\node_modules\\babel-loader\\lib\\index.js","mtime":1762215256120},{"path":"D:\\大学生活\\大三\\全栈ai\\项目\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1762215254891},{"path":"D:\\大学生活\\大三\\全栈ai\\项目\\node_modules\\vue-loader\\lib\\index.js","mtime":1762215256637}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:DQppbXBvcnQgeyBtYXBTdGF0ZSwgbWFwR2V0dGVycyB9IGZyb20gJ3Z1ZXgnDQppbXBvcnQgQXVjdGlvblBhbmVsIGZyb20gJy4uLy4uL2NvbXBvbmVudHMvYXVjdGlvbi1wYW5lbC9hdWN0aW9uLXBhbmVsLnZ1ZScNCmltcG9ydCByb29tU2VydmljZSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9yb29tLXNlcnZpY2UnDQppbXBvcnQgeyBnZXRTdXBhYmFzZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3N1cGFiYXNlLWNsaWVudCcNCmltcG9ydCBhdWN0aW9uU2VydmljZSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9hdWN0aW9uLXNlcnZpY2UnDQppbXBvcnQgeyBzdGFydENvdW50ZG93biwgY2xlYXJDb3VudGRvd24gfSBmcm9tICcuLi8uLi9mZWF0dXJlcy9nYW1lL2NvdW50ZG93bicNCmltcG9ydCB7IGxvYWRSb29tU3RhdGUgYXMgbG9hZFJvb21TdGF0ZVNlcnZpY2UgfSBmcm9tICcuLi8uLi9mZWF0dXJlcy9nYW1lL3Jvb20tc3RhdGUuc2VydmljZScNCmltcG9ydCB7IHN1YnNjcmliZVJvb21SZWFsdGltZSBhcyBzdWJzY3JpYmVSb29tUmVhbHRpbWVTZXJ2aWNlLCB1bnN1YnNjcmliZVJvb21SZWFsdGltZSBhcyB1bnN1YnNjcmliZVJvb21SZWFsdGltZVNlcnZpY2UgfSBmcm9tICcuLi8uLi9mZWF0dXJlcy9nYW1lL3Jvb20tcmVhbHRpbWUnDQppbXBvcnQgeyBzdGFydEdhbWUgYXMgc3RhcnRHYW1lRmxvdywgYXV0b1N0YXJ0QXVjdGlvbiBhcyBhdXRvU3RhcnRBdWN0aW9uRmxvdyB9IGZyb20gJy4uLy4uL2ZlYXR1cmVzL2dhbWUvYXVjdGlvbi1mbG93LnNlcnZpY2UnDQppbXBvcnQgeyBzZW5kQ2hhdE1lc3NhZ2UgfSBmcm9tICcuLi8uLi9mZWF0dXJlcy9nYW1lL2NoYXQuc2VydmljZScNCmltcG9ydCB7IHRvZ2dsZVJlYWR5IGFzIHRvZ2dsZVJlYWR5QWN0aW9uLCBtb3ZlVG9TZWF0IGFzIG1vdmVUb1NlYXRBY3Rpb24sIGxlYXZlUm9vbSBhcyBsZWF2ZVJvb21BY3Rpb24gfSBmcm9tICcuLi8uLi9mZWF0dXJlcy9nYW1lL3Jvb20tYWN0aW9ucy5zZXJ2aWNlJw0KaW1wb3J0IHsgbG9hZEFydGlmYWN0cyBhcyBsb2FkQXJ0aWZhY3RzU2VydmljZSB9IGZyb20gJy4uLy4uL2ZlYXR1cmVzL2dhbWUvYXJ0aWZhY3RzLnNlcnZpY2UnDQppbXBvcnQgeyBsb2FkQ29sbGVjdGlvbnNGcm9tQXJ0aWZhY3RzLCBnZXRDdXJyZW50Q29sbGVjdGlvbkNvdW50IGFzIGdldENvbGxlY3Rpb25Db3VudFV0aWwsIGdldENvbGxlY3Rpb25Qcm9ncmVzcyBhcyBnZXRDb2xsZWN0aW9uUHJvZ3Jlc3NVdGlsIH0gZnJvbSAnLi4vLi4vZmVhdHVyZXMvZ2FtZS9jb2xsZWN0aW9ucy51dGlscycNCmltcG9ydCB7IGZvcm1hdE1lc3NhZ2VUaW1lIGFzIGZvcm1hdE1lc3NhZ2VUaW1lSGVscGVyLCBnZXRBdmF0YXJGb3IgYXMgZ2V0QXZhdGFyRm9ySGVscGVyLCBnZXROYW1lRm9yIGFzIGdldE5hbWVGb3JIZWxwZXIgfSBmcm9tICcuLi8uLi9mZWF0dXJlcy9nYW1lL3VpLmhlbHBlcnMnDQppbXBvcnQgeyBmaXJzdExvZ2luRGlhbG9ndWUgYXMgZmlyc3RMb2dpbkRpYWxvZ3VlQ29uZmlnLCBnZXRDdXJyZW50TGFuZ3VhZ2UgYXMgZ2V0Q3VycmVudExhbmd1YWdlSW1wb3J0ZWQgfSBmcm9tICcuLi8uLi9jb25maWcvZGlhbG9ndWUtY29uZmlnJw0KZXhwb3J0IGRlZmF1bHQgew0KICBuYW1lOiAnR2FtZUluZGV4JywNCiAgY29tcG9uZW50czogew0KICAgIEF1Y3Rpb25QYW5lbA0KICB9LA0KICBkYXRhKCkgew0KICAgIHJldHVybiB7DQogICAgICBzZWxlY3RlZENhcmQ6IG51bGwsDQogICAgICBzaG93SGFuZFBvcHVwOiBmYWxzZSwNCiAgICAgIGhhbmRQbGF5ZXI6IG51bGwsDQogICAgICBhcnRpZmFjdE1hcDoge30sDQogICAgICByb29tOiBudWxsLA0KICAgICAgcHJvZmlsZU1hcDoge30sDQogICAgICByZWZyZXNoVGltZXI6IG51bGwsDQogICAgICBjb2xsZWN0aW9uczogW10sDQogICAgICBzaG93R2FtZUVuZERpYWxvZzogZmFsc2UsDQogICAgICBmaW5hbFNjb3JlczogW10sDQogICAgICB3aW5uZXJJbmZvOiBudWxsLA0KICAgICAgYXVjdGlvbkNvdW50ZG93bjogMCwNCiAgICAgIGF1Y3Rpb25UaW1lcjogbnVsbCwNCiAgICAgIGN1cnJlbnRBdWN0aW9uOiBudWxsLA0KICAgICAgLy8g5Zue5ZCI55u45YWz77yI5YmN56uv5a6e5pe25pi+56S677yM5oi/5Li75q+P6L2u5byA5ouN5pe25bm/5pKt5Lul5L+d5oyB5ZCM5q2l77yJDQogICAgICByb3VuZENvdW50OiAwLA0KICAgICAgdG90YWxSb3VuZHM6IDYsDQogICAgICBjaGF0TWVzc2FnZXM6IFtdLA0KICAgICAgbmV3TWVzc2FnZTogJycsDQogICAgICBjaGF0Q2hhbm5lbDogbnVsbCwNCiAgICAgIGNvdW50ZG93bkluUHJvZ3Jlc3M6IGZhbHNlLA0KICAgICAgZXhwYW5kZWRDb2xsZWN0aW9uczoge30sDQogICAgICBzaG93TmFycmF0aW9uOiBmYWxzZSwNCiAgICAgIHR5cGluZ1RleHQ6ICcnLA0KICAgICAgdHlwaW5nVGltZXI6IG51bGwsDQogICAgICAvLyDlrZjlgqjmiYDmnInnjqnlrrbnmoTmiYvniYzmlbDmja7vvIznlKjkuo7ku7flgLzorqHnrpcNCiAgICAgIGFsbFBsYXllcnNBcnRpZmFjdHM6IHt9LA0KICAgICAgLy8g5paH54mp6L2u5pKt55u45YWz5pWw5o2uDQogICAgICBhcnRpZmFjdENhcm91c2VsRGF0YTogW10sDQogICAgICBjdXJyZW50U2xpZGU6IDAsDQogICAgICBjYXJvdXNlbEludGVydmFsOiBudWxsLA0KICAgICAgLy8g6Z+z5LmQ5o6n5Yi255u45YWz5pWw5o2uDQogICAgICBpc011c2ljUGxheWluZzogZmFsc2UsDQogICAgICBhdWRpb0VsZW1lbnQ6IG51bGwsDQogICAgICBtdXNpY1ZvbHVtZTogMC41DQogICAgfQ0KICB9LA0KICBjb21wdXRlZDogew0KICAgIC4uLm1hcFN0YXRlKFsnZ2FtZVBoYXNlJywgJ2dhbWVMb2cnLCAnc2hvd0NhcmREZXRhaWwnLCAndXNlcicsICdyb29tSWQnLCAncm91bmRDdXJyZW50JywgJ3JvdW5kVG90YWwnXSksDQogICAgLy8g5bCG5b2T5YmN546p5a625rOo5YWl5Yiw5riy5p+T5LiK5LiL5paH77yM6YG/5YWN5qih5p2/5byV55So5oql6ZSZDQogICAgY3VycmVudFBsYXllcigpIHsgcmV0dXJuIHRoaXMuJHN0b3JlLnN0YXRlLmN1cnJlbnRQbGF5ZXIgfSwNCiAgICBpc093bmVyKCkgeyByZXR1cm4gdGhpcy5yb29tICYmIHRoaXMudXNlciAmJiB0aGlzLnJvb20ub3duZXJfaWQgPT09IHRoaXMudXNlci5pZCB9LA0KICAgIGFsbFJlYWR5KCkgew0KICAgICAgY29uc3QgcGxheWVycyA9ICh0aGlzLnJvb20gJiYgdGhpcy5yb29tLnJvb21fcGxheWVycykgPyB0aGlzLnJvb20ucm9vbV9wbGF5ZXJzIDogW10NCiAgICAgIHJldHVybiBwbGF5ZXJzLmxlbmd0aCA+IDAgJiYgcGxheWVycy5ldmVyeShwID0+ICEhcC5pc19yZWFkeSkNCiAgICB9LA0KICAgIGN1cnJlbnRVc2VyUmVhZHkoKSB7DQogICAgICBjb25zdCB1c2VyID0gdGhpcy51c2VyDQogICAgICBjb25zdCBwbGF5ZXJzID0gKHRoaXMucm9vbSAmJiB0aGlzLnJvb20ucm9vbV9wbGF5ZXJzKSA/IHRoaXMucm9vbS5yb29tX3BsYXllcnMgOiBbXQ0KICAgICAgaWYgKCF1c2VyKSByZXR1cm4gZmFsc2UNCiAgICAgIGNvbnN0IG1lID0gcGxheWVycy5maW5kKHAgPT4gcC51c2VyX2lkID09PSB1c2VyLmlkKQ0KICAgICAgcmV0dXJuICEhKG1lICYmIG1lLmlzX3JlYWR5KQ0KICAgIH0sDQogICAgcGxheWVyQ291bnQoKSB7DQogICAgICByZXR1cm4gKHRoaXMucm9vbSAmJiB0aGlzLnJvb20ucm9vbV9wbGF5ZXJzKSA/IHRoaXMucm9vbS5yb29tX3BsYXllcnMubGVuZ3RoIDogMA0KICAgIH0sDQogICAgb3duZXJOYW1lKCkgew0KICAgICAgaWYgKCF0aGlzLnJvb20pIHJldHVybiAnLScNCiAgICAgIHJldHVybiB0aGlzLmdldE5hbWVGb3IodGhpcy5yb29tLm93bmVyX2lkKQ0KICAgIH0sDQogICAgc2VhdENvdW50KCkgeyByZXR1cm4gKHRoaXMucm9vbSAmJiBOdW1iZXIodGhpcy5yb29tLm1heF9wbGF5ZXJzKSkgPyBOdW1iZXIodGhpcy5yb29tLm1heF9wbGF5ZXJzKSA6IDAgfSwNCiAgICBzZWF0cygpIHsNCiAgICAgIGNvbnN0IHBsYXllcnMgPSAodGhpcy5yb29tICYmIHRoaXMucm9vbS5yb29tX3BsYXllcnMpID8gdGhpcy5yb29tLnJvb21fcGxheWVycyA6IFtdDQogICAgICBjb25zdCBtYXggPSB0aGlzLnNlYXRDb3VudA0KICAgICAgY29uc3Qgc2VhdHMgPSBBcnJheS5mcm9tKHsgbGVuZ3RoOiBtYXggfSwgKCkgPT4gKHsgcGxheWVyOiBudWxsIH0pKQ0KICAgICAgLy8g5pS+572u5bey6K6+572u5bqn5L2N55qE546p5a62DQogICAgICBwbGF5ZXJzLmZvckVhY2gocCA9PiB7DQogICAgICAgIGNvbnN0IGlkeCA9IHR5cGVvZiBwLnNlYXRfaW5kZXggPT09ICdudW1iZXInID8gcC5zZWF0X2luZGV4IDogLTENCiAgICAgICAgaWYgKGlkeCA+PSAwICYmIGlkeCA8IG1heCAmJiAhc2VhdHNbaWR4XS5wbGF5ZXIpIHNlYXRzW2lkeF0ucGxheWVyID0gcA0KICAgICAgfSkNCiAgICAgIC8vIOWwhuacquiuvue9ruW6p+S9jeeahOeOqeWutuS+neasoeaUvuWIsOepuuS9jQ0KICAgICAgcGxheWVycy5maWx0ZXIocCA9PiB0eXBlb2YgcC5zZWF0X2luZGV4ICE9PSAnbnVtYmVyJyB8fCBwLnNlYXRfaW5kZXggPCAwKS5mb3JFYWNoKHAgPT4gew0KICAgICAgICBjb25zdCBlbXB0eUlkeCA9IHNlYXRzLmZpbmRJbmRleChzID0+ICFzLnBsYXllcikNCiAgICAgICAgaWYgKGVtcHR5SWR4ID49IDApIHNlYXRzW2VtcHR5SWR4XS5wbGF5ZXIgPSBwDQogICAgICB9KQ0KICAgICAgcmV0dXJuIHNlYXRzDQogICAgfSwNCiAgICBnYW1lUGhhc2VUZXh0KCkgew0KICAgICAgY29uc3QgcGhhc2VNYXAgPSB7DQogICAgICAgICdwcmVwYXJhdGlvbic6ICflh4blpIfpmLbmrrUnLA0KICAgICAgICAnY291bnRkb3duJzogJ+mihOWAkuiuoeaXticsDQogICAgICAgICdpbnRlcm1pc3Npb24nOiAn6Ze05q2H6Zi25q61JywNCiAgICAgICAgJ2F1Y3Rpb24nOiAn5ouN5Y2W6Zi25q61JywNCiAgICAgICAgJ3NldHRsZW1lbnQnOiAn57uT566X6Zi25q61Jw0KICAgICAgfQ0KICAgICAgcmV0dXJuIHBoYXNlTWFwW3RoaXMuZ2FtZVBoYXNlXSB8fCAn5pyq55+l6Zi25q61Jw0KICAgIH0sDQogICANCg0KICAgIC8vIOagueaNruW9k+WJjeeUqOaIt+aJi+eJjOiuoeeul+aUtuiXj+mbhuaYvuekuuaVsOaNru+8jOW4pue8k+WtmOWtl+aute+8jOS+v+S6juaooeadv+ebtOaOpeW8leeUqA0KICAgIGNvbGxlY3Rpb25zQ29tcHV0ZWQoKSB7DQogICAgICBjb25zdCBsaXN0ID0gQXJyYXkuaXNBcnJheSh0aGlzLmNvbGxlY3Rpb25zKSA/IHRoaXMuY29sbGVjdGlvbnMgOiBbXQ0KICAgICAgLy8g5LuF5bGV56S655So5oi35omL54mM5Lit6Iez5bCR5YyF5ZCrMeS7tuivpeaUtuiXj+mbhueahOaDheWGtQ0KICAgICAgcmV0dXJuIGxpc3QNCiAgICAgICAgLm1hcChjb2wgPT4gew0KICAgICAgICAgIGNvbnN0IGN1cnJlbnQgPSB0aGlzLmdldEN1cnJlbnRDb2xsZWN0aW9uQ291bnQoY29sKQ0KICAgICAgICAgIGNvbnN0IHByb2dyZXNzID0gTWF0aC5taW4oKGN1cnJlbnQgLyAoY29sLnJlcXVpcmVkQ291bnQgfHwgMSkpICogMTAwLCAxMDApDQogICAgICAgICAgcmV0dXJuIHsgLi4uY29sLCBfY3VycmVudDogY3VycmVudCwgX3Byb2dyZXNzOiBwcm9ncmVzcyB9DQogICAgICAgIH0pDQogICAgICAgIC5maWx0ZXIoY29sID0+IGNvbC5fY3VycmVudCA+IDApDQogICAgfSwNCg0KICAgIC8vIOWQiOW5tuiBiuWkqeS4juezu+e7n+aXpeW/l+S4uuWQjOS4gOS/oeaBr+a1ge+8jOaMieaXtumXtOaOkuW6jw0KICAgIGNoYXRGZWVkKCkgew0KICAgICAgY29uc3QgbG9ncyA9ICh0aGlzLmdhbWVMb2cgfHwgW10pLm1hcCgobCwgaWR4KSA9PiAoew0KICAgICAgICBpZDogYGxvZy0ke2wudGltZXN0YW1wIHx8IGlkeH1gLA0KICAgICAgICB0eXBlOiAnbG9nJywNCiAgICAgICAgdXNlcklkOiBudWxsLA0KICAgICAgICB1c2VybmFtZTogJ+ezu+e7nycsDQogICAgICAgIGNvbnRlbnQ6IGwubWVzc2FnZSwNCiAgICAgICAgdGltZXN0YW1wOiBsLnRpbWVzdGFtcCB8fCAwDQogICAgICB9KSkNCiAgICAgIGNvbnN0IGNoYXRzID0gKHRoaXMuY2hhdE1lc3NhZ2VzIHx8IFtdKS5tYXAobSA9PiAoeyAuLi5tLCB0eXBlOiAnY2hhdCcgfSkpDQogICAgICBjb25zdCBtZXJnZWQgPSBbLi4ubG9ncywgLi4uY2hhdHNdDQogICAgICByZXR1cm4gbWVyZ2VkLnNvcnQoKGEsIGIpID0+IChhLnRpbWVzdGFtcCB8fCAwKSAtIChiLnRpbWVzdGFtcCB8fCAwKSkNCiAgICB9LA0KICAgIC8vIOaatOmcsuWvueivnemFjee9ruS+m+aooeadv+S9v+eUqA0KICAgIGZpcnN0TG9naW5Db25maWcoKSB7IHJldHVybiBmaXJzdExvZ2luRGlhbG9ndWVDb25maWcgfSwNCiAgICAvLyDlvZPliY3orrLov7Dop5LoibLphY3nva7kuI7lkI3np7ANCiAgICBuYXJyYXRpb25DaGFyYWN0ZXJOYW1lKCkgeyByZXR1cm4gKHRoaXMuZ2V0Q3VycmVudExhbmd1YWdlKCkgPT09ICd6aC1DTicpID8gJ+e+jumHjCcgOiAnTWlzYXRvJyB9LA0KICAgIG5hcnJhdGlvbkNoYXJhY3RlcigpIHsNCiAgICAgIGNvbnN0IGtleSA9IHRoaXMubmFycmF0aW9uQ2hhcmFjdGVyTmFtZQ0KICAgICAgY29uc3QgY2hhcnMgPSBmaXJzdExvZ2luRGlhbG9ndWVDb25maWcgJiYgZmlyc3RMb2dpbkRpYWxvZ3VlQ29uZmlnLmNoYXJhY3RlcnMNCiAgICAgIHJldHVybiAoY2hhcnMgJiYgY2hhcnNba2V5XSkgPyBjaGFyc1trZXldIDogeyBpbWFnZTogJy9pbWFnZXMvZ3VpZGUucG5nJywgcG9zaXRpb246ICdyaWdodCcsIGNvbG9yOiAnIzNiODJmNicgfQ0KICAgIH0NCiAgfSwNCiAgYXN5bmMgbW91bnRlZCgpIHsNCiAgICBjb25zdCByb29tSWQgPSB0aGlzLiRyb3V0ZS5xdWVyeS5yb29tSWQNCiAgICBpZiAocm9vbUlkKSB0aGlzLiRzdG9yZS5jb21taXQoJ1NFVF9ST09NX0lEJywgcm9vbUlkKQ0KICAgIGF3YWl0IHRoaXMuaW5pdGlhbGl6ZUdhbWUoKQ0KICAgIGF3YWl0IHRoaXMubG9hZFJvb21TdGF0ZSgpDQogICAgLy8g56uL5Y2z5Yid5aeL5YyW5paH54mp6L2u5pKt5pWw5o2u77yM56Gu5L+d5YeG5aSH6Zi25q615bCx5pyJ5YaF5a65DQogICAgYXdhaXQgdGhpcy5pbml0aWFsaXplQXJ0aWZhY3RDYXJvdXNlbCgpDQogICAgLy8gbG9hZFJvb21TdGF0ZSDkuK3lt7Lnu4/osIPnlKjkuoYgbG9hZEFsbFBsYXllcnNBcnRpZmFjdHPvvIzov5nph4znoa7kv53mlbDmja7liqDovb0NCiAgICBhd2FpdCB0aGlzLnN1YnNjcmliZVJvb21SZWFsdGltZSgpDQogICAgLy8g5Yid5aeL5YyW6Z+z5LmQ5pKt5pS+5ZmoDQogICAgdGhpcy5pbml0aWFsaXplTXVzaWMoKQ0KICB9LA0KICBiZWZvcmVEZXN0cm95KCkgew0KICAgIHRoaXMudW5zdWJzY3JpYmVSb29tUmVhbHRpbWUoKQ0KICAgIGlmICh0aGlzLnJlZnJlc2hUaW1lcikgeyBjbGVhckludGVydmFsKHRoaXMucmVmcmVzaFRpbWVyKTsgdGhpcy5yZWZyZXNoVGltZXIgPSBudWxsIH0NCiAgICBpZiAodGhpcy5hdWN0aW9uVGltZXIpIHsgY2xlYXJJbnRlcnZhbCh0aGlzLmF1Y3Rpb25UaW1lcik7IHRoaXMuYXVjdGlvblRpbWVyID0gbnVsbCB9DQogICAgaWYgKHRoaXMudHlwaW5nVGltZXIpIHsgY2xlYXJJbnRlcnZhbCh0aGlzLnR5cGluZ1RpbWVyKTsgdGhpcy50eXBpbmdUaW1lciA9IG51bGwgfQ0KICAgIGlmICh0aGlzLmNhcm91c2VsSW50ZXJ2YWwpIHsgY2xlYXJJbnRlcnZhbCh0aGlzLmNhcm91c2VsSW50ZXJ2YWwpOyB0aGlzLmNhcm91c2VsSW50ZXJ2YWwgPSBudWxsIH0NCiAgICAvLyDmuIXnkIbpn7PkuZDmkq3mlL7lmagNCiAgICB0aGlzLmNsZWFudXBNdXNpYygpDQogICAgdGhpcy4kc2V0KHRoaXMsICdhdWN0aW9uQ291bnRkb3duJywgMCkNCiAgfSwNCiAgd2F0Y2g6IHsNCiAgICBnYW1lTG9nKCkgew0KICAgICAgdGhpcy4kbmV4dFRpY2soKCkgPT4gew0KICAgICAgICBjb25zdCBjaGF0Q29udGFpbmVyID0gdGhpcy4kcmVmcy5jaGF0Q29udGFpbmVyDQogICAgICAgIGlmIChjaGF0Q29udGFpbmVyKSB7IGNoYXRDb250YWluZXIuc2Nyb2xsVG9wID0gY2hhdENvbnRhaW5lci5zY3JvbGxIZWlnaHQgfQ0KICAgICAgfSkNCiAgICB9LA0KICAgIC8vIOebkeWQrOa4uOaIj+mYtuauteWPmOWMlu+8jOWcqOWHhuWkh+mYtuauteehruS/nei9ruaSreaVsOaNruWtmOWcqA0KICAgIGdhbWVQaGFzZShuZXdQaGFzZSkgew0KICAgICAgaWYgKG5ld1BoYXNlID09PSAncHJlcGFyYXRpb24nKSB7DQogICAgICAgIHRoaXMuJG5leHRUaWNrKCgpID0+IHsNCiAgICAgICAgICAvLyDlpoLmnpzova7mkq3mlbDmja7kuLrnqbrvvIzph43mlrDliJ3lp4vljJYNCiAgICAgICAgICBpZiAoIXRoaXMuYXJ0aWZhY3RDYXJvdXNlbERhdGEgfHwgdGhpcy5hcnRpZmFjdENhcm91c2VsRGF0YS5sZW5ndGggPT09IDApIHsNCiAgICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZUFydGlmYWN0Q2Fyb3VzZWwoKQ0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAvLyDmlbDmja7lt7LlrZjlnKjvvIzlj6rpnIDnoa7kv53ova7mkq3mraPluLjov5DooYwNCiAgICAgICAgICAgIHRoaXMuc3RhcnRBdXRvQ2Fyb3VzZWwoKQ0KICAgICAgICAgIH0NCiAgICAgICAgfSkNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIC8vIOemu+W8gOWHhuWkh+mYtuauteaXtuWBnOatoui9ruaSrQ0KICAgICAgICB0aGlzLnN0b3BBdXRvQ2Fyb3VzZWwoKQ0KICAgICAgfQ0KICAgICAgDQogICAgICAvLyDmoLnmja7muLjmiI/pmLbmrrXosIPmlbTpn7PkuZDmkq3mlL4NCiAgICAgIHRoaXMuaGFuZGxlR2FtZVBoYXNlTXVzaWMobmV3UGhhc2UpDQogICAgfQ0KICB9LA0KICBtZXRob2RzOiB7DQogICAgLy8g5Yid5aeL5YyW5paH54mp6L2u5pKt5pWw5o2u77yI5pS56L+b54mI77ya56Gu5L+d5oC75pyJ5YaF5a655pi+56S677yJDQogICAgYXN5bmMgaW5pdGlhbGl6ZUFydGlmYWN0Q2Fyb3VzZWwoKSB7DQogICAgICB0cnkgew0KICAgICAgICBjb25zb2xlLmxvZygn8J+nrSDlvIDlp4vliJ3lp4vljJbmlofnianova7mkq3mlbDmja4uLi4nKQ0KICAgICAgICANCiAgICAgICAgLy8g5YWI5qOA5p+l5piv5ZCm5pyJ57yT5a2Y55qE6L2u5pKt5pWw5o2uDQogICAgICAgIGlmICh0aGlzLmFydGlmYWN0Q2Fyb3VzZWxEYXRhICYmIHRoaXMuYXJ0aWZhY3RDYXJvdXNlbERhdGEubGVuZ3RoID4gMCkgew0KICAgICAgICAgIGNvbnNvbGUubG9nKCfwn5OaIOS9v+eUqOe8k+WtmOi9ruaSreaVsOaNricpDQogICAgICAgICAgdGhpcy5zdGFydEF1dG9DYXJvdXNlbCgpDQogICAgICAgICAgcmV0dXJuDQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIC8vIOebtOaOpeS9v+eUqGFydGlmYWN0c+ihqOiOt+WPluaVsOaNrg0KICAgICAgICBjb25zdCBzdXBhYmFzZSA9IGdldFN1cGFiYXNlKCkNCiAgICAgICAgY29uc29sZS5sb2coJ/CflJcg6I635Y+WU3VwYWJhc2Xlrp7kvos6Jywgc3VwYWJhc2UgPyAn4pyFIOaIkOWKnycgOiAn4p2MIOWksei0pScpDQogICAgICAgIA0KICAgICAgICBjb25zb2xlLmxvZygn8J+TpSDmraPlnKjku45hcnRpZmFjdHPooajojrflj5bmlbDmja4uLi4nKQ0KICAgICAgICBjb25zdCB7IGRhdGE6IGFydGlmYWN0RGF0YSwgZXJyb3I6IGFydGlmYWN0RXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlDQogICAgICAgICAgLmZyb20oJ2FydGlmYWN0cycpDQogICAgICAgICAgLnNlbGVjdCgnaWQsIG5hbWUsIGVyYSwgbG9jYXRpb24sIGltYWdlLCBiYXNlX3ZhbHVlJykNCiAgICAgICAgICAubGltaXQoMTApIC8vIOiOt+WPljEw5Liq5paH54mp55So5LqO6L2u5pKtDQogICAgICAgICAgDQogICAgICAgIGNvbnNvbGUubG9nKCfwn5OKIOS7jmFydGlmYWN0c+ihqOiOt+WPluaVsOaNrue7k+aenDonLCB7DQogICAgICAgICAgZGF0YUxlbmd0aDogYXJ0aWZhY3REYXRhID8gYXJ0aWZhY3REYXRhLmxlbmd0aCA6IDAsDQogICAgICAgICAgZXJyb3I6IGFydGlmYWN0RXJyb3IsDQogICAgICAgICAgZGF0YTogYXJ0aWZhY3REYXRhDQogICAgICAgIH0pDQogICAgICAgIA0KICAgICAgICBsZXQgZmluYWxEYXRhID0gW10NCiAgICAgICAgDQogICAgICAgIGlmIChhcnRpZmFjdEVycm9yKSB7DQogICAgICAgICAgY29uc29sZS5lcnJvcign4p2MIOS7jmFydGlmYWN0c+ihqOiOt+WPluaWh+eJqeaVsOaNruWksei0pTonLCBhcnRpZmFjdEVycm9yKQ0KICAgICAgICAgIGNvbnNvbGUubG9nKCfwn5SEIOS9v+eUqOaooeaLn+aVsOaNruS9nOS4uuWkh+eUqC4uLicpDQogICAgICAgICAgZmluYWxEYXRhID0gdGhpcy5nZXRNb2NrQXJ0aWZhY3REYXRhKCkNCiAgICAgICAgfSBlbHNlIGlmIChhcnRpZmFjdERhdGEgJiYgYXJ0aWZhY3REYXRhLmxlbmd0aCA+IDApIHsNCiAgICAgICAgICBjb25zb2xlLmxvZygn4pyFIOaIkOWKn+iOt+WPluWIsOaWh+eJqeaVsOaNrjonLCBhcnRpZmFjdERhdGEubGVuZ3RoLCAn5p2hJykNCiAgICAgICAgICAvLyDlpITnkIbnnJ/lrp7mlbDmja4NCiAgICAgICAgICBmaW5hbERhdGEgPSBhcnRpZmFjdERhdGEubWFwKChpdGVtLCBpbmRleCkgPT4gew0KICAgICAgICAgICAgY29uc29sZS5sb2coYPCfk7gg5aSE55CG5paH54mpICR7aW5kZXggKyAxfTpgLCBpdGVtLm5hbWUsICfljp/lp4vlm77niYdVUkw6JywgaXRlbS5pbWFnZSkNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgLy8g56Gu5L+d5Zu+54mHVVJM5piv5a6M5pW055qEVVJMDQogICAgICAgICAgICBsZXQgaW1hZ2VVcmwgPSBpdGVtLmltYWdlDQogICAgICAgICAgICBpZiAoaW1hZ2VVcmwpIHsNCiAgICAgICAgICAgICAgaWYgKGltYWdlVXJsLnN0YXJ0c1dpdGgoJy8nKSkgew0KICAgICAgICAgICAgICAgIC8vIOebuOWvuei3r+W+hO+8jOi9rOaNouS4uue7neWvuei3r+W+hA0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCfwn5SEIOi9rOaNouebuOWvuei3r+W+hOS4uue7neWvuei3r+W+hC4uLicpDQogICAgICAgICAgICAgICAgaWYgKGltYWdlVXJsLnN0YXJ0c1dpdGgoJy9zdGF0aWMvJykpIHsNCiAgICAgICAgICAgICAgICAgIC8vIOmdmeaAgei1hOa6kOi3r+W+hO+8jOS9v+eUqOmhueebruaguei3r+W+hA0KICAgICAgICAgICAgICAgICAgaW1hZ2VVcmwgPSB3aW5kb3cubG9jYXRpb24ub3JpZ2luICsgaW1hZ2VVcmwNCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgLy8g5YW25LuW55u45a+56Lev5b6E77yM5L2/55SoU3VwYWJhc2XlrZjlgqjot6/lvoQNCiAgICAgICAgICAgICAgICAgIGltYWdlVXJsID0gJ2h0dHBzOi8vdGdrenB5d3Vrb3Jjd2RzYmZ1Yncuc3VwYWJhc2UuY28nICsgaW1hZ2VVcmwNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWltYWdlVXJsLnN0YXJ0c1dpdGgoJ2h0dHAnKSkgew0KICAgICAgICAgICAgICAgIC8vIOWPr+iDveaYr+ebuOWvuei3r+W+hOS9hue8uuWwkeaWnOadoA0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCfwn5SEIOWkhOeQhuWPr+iDvee8uuWwkeaWnOadoOeahOi3r+W+hC4uLicpDQogICAgICAgICAgICAgICAgaW1hZ2VVcmwgPSAnaHR0cHM6Ly90Z2t6cHl3dWtvcmN3ZHNiZnVidy5zdXBhYmFzZS5jby9zdG9yYWdlL3YxL29iamVjdC9wdWJsaWMvJyArIGltYWdlVXJsDQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgY29uc3QgcHJvY2Vzc2VkSXRlbSA9IHsNCiAgICAgICAgICAgICAgaWQ6IGl0ZW0uaWQsDQogICAgICAgICAgICAgIG5hbWU6IGl0ZW0ubmFtZSwNCiAgICAgICAgICAgICAgZXJhOiBpdGVtLmVyYSwNCiAgICAgICAgICAgICAgbG9jYXRpb246IGl0ZW0ubG9jYXRpb24sDQogICAgICAgICAgICAgIGltYWdlOiBpbWFnZVVybCB8fCAnaHR0cHM6Ly92aWEucGxhY2Vob2xkZXIuY29tLzQwMHgzMDA/dGV4dD3mlofnianpooTop4gnLA0KICAgICAgICAgICAgICBiYXNlVmFsdWU6IGl0ZW0uYmFzZV92YWx1ZQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBjb25zb2xlLmxvZyhg4pyFIOaWh+eJqSAke2luZGV4ICsgMX0g5aSE55CG5a6M5oiQIC0g5pyA57uI5Zu+54mHVVJMOmAsIHByb2Nlc3NlZEl0ZW0uaW1hZ2UpDQogICAgICAgICAgICByZXR1cm4gcHJvY2Vzc2VkSXRlbQ0KICAgICAgICAgIH0pDQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgY29uc29sZS5sb2coJ/Cfk60gYXJ0aWZhY3Rz6KGo5Li656m677yM5L2/55So5qih5ouf5pWw5o2uJykNCiAgICAgICAgICBmaW5hbERhdGEgPSB0aGlzLmdldE1vY2tBcnRpZmFjdERhdGEoKQ0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICAvLyDnoa7kv53mnIDnu4jmlbDmja7kuI3kuLrnqboNCiAgICAgICAgaWYgKGZpbmFsRGF0YS5sZW5ndGggPT09IDApIHsNCiAgICAgICAgICBjb25zb2xlLmxvZygn4pqg77iPIOacgOe7iOaVsOaNruS4uuepuu+8jOS9v+eUqOWkh+eUqOaooeaLn+aVsOaNricpDQogICAgICAgICAgZmluYWxEYXRhID0gdGhpcy5nZXRNb2NrQXJ0aWZhY3REYXRhKCkNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgdGhpcy5hcnRpZmFjdENhcm91c2VsRGF0YSA9IGZpbmFsRGF0YQ0KICAgICAgICBjb25zb2xlLmxvZygn8J+OryDmnIDnu4jova7mkq3mlbDmja46JywgdGhpcy5hcnRpZmFjdENhcm91c2VsRGF0YS5sZW5ndGgsICfmnaEnKQ0KICAgICAgICBjb25zb2xlLmxvZygn8J+UhCDlvIDlp4voh6rliqjova7mkq0uLi4nKQ0KICAgICAgICANCiAgICAgICAgLy8g5byA5aeL6Ieq5Yqo6L2u5pKtDQogICAgICAgIHRoaXMuc3RhcnRBdXRvQ2Fyb3VzZWwoKQ0KICAgICAgfSBjYXRjaCAoZXJyb3IpIHsNCiAgICAgICAgY29uc29sZS5lcnJvcign8J+SpSDliJ3lp4vljJbmlofnianova7mkq3lpLHotKU6JywgZXJyb3IpDQogICAgICAgIGNvbnNvbGUubG9nKCfwn5SEIOS9v+eUqOaooeaLn+aVsOaNruS9nOS4uuacgOe7iOWkh+eUqC4uLicpDQogICAgICAgIC8vIOehruS/neWNs+S9v+WHuumUmeS5n+acieaVsOaNruWxleekug0KICAgICAgICB0aGlzLmFydGlmYWN0Q2Fyb3VzZWxEYXRhID0gdGhpcy5nZXRNb2NrQXJ0aWZhY3REYXRhKCkNCiAgICAgICAgdGhpcy5zdGFydEF1dG9DYXJvdXNlbCgpDQogICAgICB9DQogICAgfSwNCiAgICANCiAgICAvLyDojrflj5bmqKHmi5/mlofnianmlbDmja7vvIjlpIfnlKjmlrnmoYjvvIkNCiAgICBnZXRNb2NrQXJ0aWZhY3REYXRhKCkgew0KICAgICAgcmV0dXJuIFsNCiAgICAgICAgew0KICAgICAgICAgIGlkOiAnYXJ0aWZhY3RfMDAxJywNCiAgICAgICAgICBuYW1lOiAn5ZSQ5Luj56eY6Imy55O3JywNCiAgICAgICAgICBlcmE6ICfllJDku6MnLA0KICAgICAgICAgIGxvY2F0aW9uOiAn5Lit5Zu9JywNCiAgICAgICAgICBpbWFnZTogJ2h0dHBzOi8vdmlhLnBsYWNlaG9sZGVyLmNvbS80MDB4MzAwL2YwZjBmMC82NjY2NjY/dGV4dD3llJDku6Pnp5joibLnk7cnLA0KICAgICAgICAgIGJhc2VWYWx1ZTogOA0KICAgICAgICB9LA0KICAgICAgICB7DQogICAgICAgICAgaWQ6ICdhcnRpZmFjdF8wMDInLA0KICAgICAgICAgIG5hbWU6ICfovr7oiqzlpYflpYforr7lm74nLA0KICAgICAgICAgIGVyYTogJ+aWh+iJuuWkjeWFtCcsDQogICAgICAgICAgbG9jYXRpb246ICfmhI/lpKfliKknLA0KICAgICAgICAgIGltYWdlOiAnaHR0cHM6Ly92aWEucGxhY2Vob2xkZXIuY29tLzQwMHgzMDAvZjBmMGYwLzY2NjY2Nj90ZXh0Pei+vuiKrOWlh+Wlh+iuvuWbvicsDQogICAgICAgICAgYmFzZVZhbHVlOiA5DQogICAgICAgIH0sDQogICAgICAgIHsNCiAgICAgICAgICBpZDogJ2FydGlmYWN0XzAwMycsDQogICAgICAgICAgbmFtZTogJ+eQpeePgOWMluefsycsDQogICAgICAgICAgZXJhOiAn5Y+y5YmNJywNCiAgICAgICAgICBsb2NhdGlvbjogJ+azoue9l+eahOa1tycsDQogICAgICAgICAgaW1hZ2U6ICdodHRwczovL3ZpYS5wbGFjZWhvbGRlci5jb20vNDAweDMwMC9mMGYwZjAvNjY2NjY2P3RleHQ955Cl54+A5YyW55+zJywNCiAgICAgICAgICBiYXNlVmFsdWU6IDYNCiAgICAgICAgfSwNCiAgICAgICAgew0KICAgICAgICAgIGlkOiAnYXJ0aWZhY3RfMDA0JywNCiAgICAgICAgICBuYW1lOiAn57u05Lqs6b6Z5aS06Ii5JywNCiAgICAgICAgICBlcmE6ICfnu7Tkuqzml7bku6MnLA0KICAgICAgICAgIGxvY2F0aW9uOiAn5YyX5qynJywNCiAgICAgICAgICBpbWFnZTogJ2h0dHBzOi8vdmlhLnBsYWNlaG9sZGVyLmNvbS80MDB4MzAwL2YwZjBmMC82NjY2NjY/dGV4dD3nu7TkuqzpvpnlpLToiLknLA0KICAgICAgICAgIGJhc2VWYWx1ZTogNw0KICAgICAgICB9LA0KICAgICAgICB7DQogICAgICAgICAgaWQ6ICdhcnRpZmFjdF8wMDUnLA0KICAgICAgICAgIG5hbWU6ICfmmJ/nm5jku6onLA0KICAgICAgICAgIGVyYTogJ+S4reS4lue6qicsDQogICAgICAgICAgbG9jYXRpb246ICfpmL/mi4nkvK8nLA0KICAgICAgICAgIGltYWdlOiAnaHR0cHM6Ly92aWEucGxhY2Vob2xkZXIuY29tLzQwMHgzMDAvZjBmMGYwLzY2NjY2Nj90ZXh0PeaYn+ebmOS7qicsDQogICAgICAgICAgYmFzZVZhbHVlOiA3DQogICAgICAgIH0NCiAgICAgIF0NCiAgICB9LA0KICAgIA0KICAgIC8vIOW8gOWni+iHquWKqOi9ruaSrQ0KICAgIHN0YXJ0QXV0b0Nhcm91c2VsKCkgew0KICAgICAgaWYgKHRoaXMuY2Fyb3VzZWxJbnRlcnZhbCkgew0KICAgICAgICBjbGVhckludGVydmFsKHRoaXMuY2Fyb3VzZWxJbnRlcnZhbCkNCiAgICAgIH0NCiAgICAgIA0KICAgICAgLy8g56Gu5L+d5pyJ5pWw5o2u5omN5byA5ZCv6L2u5pKtDQogICAgICBpZiAoIXRoaXMuYXJ0aWZhY3RDYXJvdXNlbERhdGEgfHwgdGhpcy5hcnRpZmFjdENhcm91c2VsRGF0YS5sZW5ndGggPT09IDApIHsNCiAgICAgICAgY29uc29sZS5sb2coJ+KaoO+4jyDova7mkq3mlbDmja7kuLrnqbrvvIzkuI3lkK/liqjoh6rliqjova7mkq0nKQ0KICAgICAgICByZXR1cm4NCiAgICAgIH0NCiAgICAgIA0KICAgICAgdGhpcy5jYXJvdXNlbEludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4gew0KICAgICAgICB0aGlzLm5leHRTbGlkZSgpDQogICAgICB9LCAzMDAwKSAvLyDmr48z56eS6Ieq5Yqo5YiH5o2iDQogICAgfSwNCiAgICANCiAgICAvLyDlgZzmraLoh6rliqjova7mkq0NCiAgICBzdG9wQXV0b0Nhcm91c2VsKCkgew0KICAgICAgaWYgKHRoaXMuY2Fyb3VzZWxJbnRlcnZhbCkgew0KICAgICAgICBjbGVhckludGVydmFsKHRoaXMuY2Fyb3VzZWxJbnRlcnZhbCkNCiAgICAgICAgdGhpcy5jYXJvdXNlbEludGVydmFsID0gbnVsbA0KICAgICAgfQ0KICAgIH0sDQogICAgDQogICAgLy8g5LiL5LiA5byg5bm754Gv54mHDQogICAgbmV4dFNsaWRlKCkgew0KICAgICAgaWYgKHRoaXMuYXJ0aWZhY3RDYXJvdXNlbERhdGEgJiYgdGhpcy5hcnRpZmFjdENhcm91c2VsRGF0YS5sZW5ndGggPiAwKSB7DQogICAgICAgIHRoaXMuY3VycmVudFNsaWRlID0gKHRoaXMuY3VycmVudFNsaWRlICsgMSkgJSB0aGlzLmFydGlmYWN0Q2Fyb3VzZWxEYXRhLmxlbmd0aA0KICAgICAgfQ0KICAgIH0sDQogICAgDQogICAgLy8g5LiK5LiA5byg5bm754Gv54mHDQogICAgcHJldlNsaWRlKCkgew0KICAgICAgaWYgKHRoaXMuYXJ0aWZhY3RDYXJvdXNlbERhdGEgJiYgdGhpcy5hcnRpZmFjdENhcm91c2VsRGF0YS5sZW5ndGggPiAwKSB7DQogICAgICAgIHRoaXMuY3VycmVudFNsaWRlID0gKHRoaXMuY3VycmVudFNsaWRlIC0gMSArIHRoaXMuYXJ0aWZhY3RDYXJvdXNlbERhdGEubGVuZ3RoKSAlIHRoaXMuYXJ0aWZhY3RDYXJvdXNlbERhdGEubGVuZ3RoDQogICAgICB9DQogICAgfSwNCiAgICANCiAgICAvLyDot7PovazliLDmjIflrprlubvnga/niYcNCiAgICBnb1RvU2xpZGUoaW5kZXgpIHsNCiAgICAgIGlmICh0aGlzLmFydGlmYWN0Q2Fyb3VzZWxEYXRhICYmIGluZGV4ID49IDAgJiYgaW5kZXggPCB0aGlzLmFydGlmYWN0Q2Fyb3VzZWxEYXRhLmxlbmd0aCkgew0KICAgICAgICB0aGlzLmN1cnJlbnRTbGlkZSA9IGluZGV4DQogICAgICB9DQogICAgfSwNCiAgICANCiAgICAvLyDlpITnkIblm77niYfliqDovb3plJnor68NCiAgICBoYW5kbGVJbWFnZUVycm9yKGFydGlmYWN0KSB7DQogICAgICBjb25zb2xlLndhcm4oYOaWh+eJqeWbvueJh+WKoOi9veWksei0pTogJHthcnRpZmFjdC5uYW1lfWApDQogICAgICAvLyDlj6/ku6Xorr7nva7pu5jorqTlm77niYfmiJbkvb/nlKjljaDkvY3nrKYNCiAgICAgIGFydGlmYWN0LmltYWdlID0gJ2h0dHBzOi8vdmlhLnBsYWNlaG9sZGVyLmNvbS80MDB4MzAwP3RleHQ95paH54mp6aKE6KeIJw0KICAgIH0sDQoNCiAgICAvLyDljrvmjonmqKHmi5/liJ3lp4vljJbnjqnlrrbvvIzmlLnkuLrkvb/nlKjmiL/pl7TnmoTlrp7pmYXnjqnlrrbliJfooagNCiAgICBhc3luYyBpbml0aWFsaXplR2FtZSgpIHsNCiAgICAgIGNvbnN0IGFydGlmYWN0cyA9IGF3YWl0IHRoaXMubG9hZEFydGlmYWN0cygpDQogICAgICB0aGlzLmFydGlmYWN0TWFwID0gYXJ0aWZhY3RzLnJlZHVjZSgoYWNjLCBhKSA9PiB7IGFjY1thLmlkXSA9IGE7IHJldHVybiBhY2MgfSwge30pDQogICAgICBhd2FpdCB0aGlzLmxvYWRDb2xsZWN0aW9ucygpDQogICAgfSwNCiAgICBhc3luYyBzdWJzY3JpYmVSb29tUmVhbHRpbWUoKSB7DQogICAgICBjb25zdCByaWQgPSB0aGlzLiRzdG9yZS5zdGF0ZS5yb29tSWQNCiAgICAgIGlmICghcmlkKSByZXR1cm4NCiAgICAgIGNvbnN0IHN1cGFiYXNlID0gZ2V0U3VwYWJhc2UoKQ0KICAgICAgY29uc3QgeyByb29tQ2hhbm5lbCwgYnJvYWRjYXN0Q2hhbm5lbCB9ID0gc3Vic2NyaWJlUm9vbVJlYWx0aW1lU2VydmljZSgNCiAgICAgICAgeyByb29tSWQ6IHJpZCwgc3VwYWJhc2UsIG9uTG9hZFJvb21TdGF0ZTogdGhpcy5sb2FkUm9vbVN0YXRlIH0sDQogICAgICAgIHsNCiAgICAgICAgICBvbkdhbWVTdGFydGVkOiBhc3luYyAoX3BheWxvYWQpID0+IHsNCiAgICAgICAgICAgIC8vIOmYsuatoumHjeWkjeWQr+WKqOWkmuS4quWAkuiuoeaXtg0KICAgICAgICAgICAgaWYgKHRoaXMuY291bnRkb3duSW5Qcm9ncmVzcykgcmV0dXJuDQogICAgICAgICAgICB0aGlzLmNvdW50ZG93bkluUHJvZ3Jlc3MgPSB0cnVlDQogICAgICAgICAgICANCiAgICAgICAgICAgIC8vIOaWsOWxgOW8gOWni++8mumHjee9ruiBiuWkqea2iOaBr+WSjOS7t+WAvOaVsOaNrg0KICAgICAgICAgICAgdGhpcy5jaGF0TWVzc2FnZXMgPSBbXQ0KICAgICAgICAgICAgdGhpcy5hbGxQbGF5ZXJzQXJ0aWZhY3RzID0ge30NCiAgICAgICAgICAgIC8vIOmHjee9ruWbnuWQiOaVsA0KICAgICAgICAgICAgdGhpcy4kc3RvcmUuY29tbWl0KCdSRVNFVF9ST1VORCcpDQogICAgICAgICAgICB0aGlzLiRzdG9yZS5jb21taXQoJ1NFVF9ST1VORF9UT1RBTCcsIDYpDQogICAgICAgICAgICANCiAgICAgICAgICAgIHRoaXMuJHN0b3JlLmNvbW1pdCgnU0VUX0dBTUVfUEhBU0UnLCAnY291bnRkb3duJykNCiAgICAgICAgICAgIHRoaXMuJHNldCh0aGlzLCAnYXVjdGlvbkNvdW50ZG93bicsIDUpDQogICAgICAgICAgICBjb25zdCBtZSA9ICh0aGlzLnJvb20gJiYgdGhpcy5yb29tLnJvb21fcGxheWVycyA/IHRoaXMucm9vbS5yb29tX3BsYXllcnMgOiBbXSkuZmluZChwID0+IHAudXNlcl9pZCA9PT0gdGhpcy4kc3RvcmUuc3RhdGUudXNlci5pZCkNCiAgICAgICAgICAgIGlmIChtZSkgew0KICAgICAgICAgICAgICB0aGlzLiRzdG9yZS5jb21taXQoJ1NFVF9DVVJSRU5UX1BMQVlFUicsIHsgaWQ6IG1lLnVzZXJfaWQsIG5hbWU6IHRoaXMuZ2V0TmFtZUZvcihtZS51c2VyX2lkKSwgZW5lcmd5OiA1MCwgYXJ0aWZhY3RzOiBbXSwgaXRlbXM6IFtdIH0pDQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAodGhpcy5hdWN0aW9uVGltZXIpIHsgY2xlYXJJbnRlcnZhbCh0aGlzLmF1Y3Rpb25UaW1lcik7IHRoaXMuYXVjdGlvblRpbWVyID0gbnVsbCB9DQogICAgICAgICAgICB0aGlzLiRuZXh0VGljaygoKSA9PiB7DQogICAgICAgICAgICAgIHN0YXJ0Q291bnRkb3duKHsNCiAgICAgICAgICAgICAgICBzZWNvbmRzOiA1LA0KICAgICAgICAgICAgICAgIG9uVGljazogKHMpID0+IHsgdGhpcy4kc2V0KHRoaXMsICdhdWN0aW9uQ291bnRkb3duJywgcykgfSwNCiAgICAgICAgICAgICAgICBvbkRvbmU6IGFzeW5jICgpID0+IHsgdGhpcy5jb3VudGRvd25JblByb2dyZXNzID0gZmFsc2U7IGlmICh0aGlzLmlzT3duZXIpIHsgYXdhaXQgdGhpcy5hdXRvU3RhcnRBdWN0aW9uKCkgfSB9LA0KICAgICAgICAgICAgICAgIGdldFJlZjogKCkgPT4gdGhpcy5hdWN0aW9uVGltZXIsDQogICAgICAgICAgICAgICAgc2V0UmVmOiAoaWQpID0+IHsgdGhpcy5hdWN0aW9uVGltZXIgPSBpZCB9LA0KICAgICAgICAgICAgICB9KQ0KICAgICAgICAgICAgfSkNCiAgICAgICAgICB9LA0KICAgICAgICAgIG9uQXVjdGlvblN0YXJ0ZWQ6IGFzeW5jIChkdXJhdGlvbiwgcGF5bG9hZCkgPT4geyANCiAgICAgICAgICAgIC8vIOehruS/neaJgOacieeOqeWutumDveiDveeci+WIsOaLjeWNluaVsOaNrg0KICAgICAgICAgICAgYXdhaXQgdGhpcy5sb2FkUm9vbVN0YXRlKCkNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgLy8g5ZCM5q2l5Zue5ZCI5pWw77yI5aaC5p6c5bm/5pKt5Lit5YyF5ZCr5LqG5Zue5ZCI5L+h5oGv77yJDQogICAgICAgICAgICBpZiAocGF5bG9hZCAmJiB0eXBlb2YgcGF5bG9hZC5yb3VuZEN1cnJlbnQgPT09ICdudW1iZXInKSB7DQogICAgICAgICAgICAgIHRoaXMuJHN0b3JlLmNvbW1pdCgnU0VUX1JPVU5EX0NVUlJFTlQnLCBwYXlsb2FkLnJvdW5kQ3VycmVudCkNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmIChwYXlsb2FkICYmIHR5cGVvZiBwYXlsb2FkLnJvdW5kVG90YWwgPT09ICdudW1iZXInKSB7DQogICAgICAgICAgICAgIHRoaXMuJHN0b3JlLmNvbW1pdCgnU0VUX1JPVU5EX1RPVEFMJywgcGF5bG9hZC5yb3VuZFRvdGFsKQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICB0aGlzLnN0YXJ0QXVjdGlvblRpbWVyKGR1cmF0aW9uKSANCiAgICAgICAgICB9LA0KICAgICAgICAgIG9uQmlkVXBkYXRlOiAoeyBhdWN0aW9uSWQsIGhpZ2hlc3RCaWQsIGhpZ2hlc3RCaWRkZXIgfSkgPT4gew0KICAgICAgICAgICAgaWYgKCFhdWN0aW9uSWQpIHJldHVybg0KICAgICAgICAgICAgY29uc3QgbGlzdCA9IHRoaXMuJHN0b3JlLnN0YXRlLmN1cnJlbnRBdWN0aW9ucyB8fCBbXQ0KICAgICAgICAgICAgY29uc3QgaWR4ID0gbGlzdC5maW5kSW5kZXgoYSA9PiBhLmlkID09PSBhdWN0aW9uSWQpDQogICAgICAgICAgICBpZiAoaWR4ID49IDApIHsNCiAgICAgICAgICAgICAgY29uc3QgbmV4dCA9IHsgLi4ubGlzdFtpZHhdLCBoaWdoZXN0QmlkLCBoaWdoZXN0QmlkZGVyIH0NCiAgICAgICAgICAgICAgdGhpcy4kc3RvcmUuY29tbWl0KCdBRERfT1JfVVBEQVRFX0FVQ1RJT04nLCBuZXh0KQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0sDQogICAgICAgICAgLy8g5pen5Zue5ZCI5bm/5pKt5bey56e76Zmk77yM57uf5LiA5pys5Zyw5o6o6L+b77yM5LiN5YaN5o6l5pS26K+l5LqL5Lu2DQogICAgICAgICAgb25Sb3VuZFVwZGF0ZWQ6IChfZGF0YSkgPT4ge30sDQogICAgICAgICAgb25HYW1lRW5kZWQ6ICgpID0+IHsNCiAgICAgICAgICAgIHRoaXMuJHN0b3JlLmNvbW1pdCgnU0VUX0dBTUVfUEhBU0UnLCAnc2V0dGxlbWVudCcpDQogICAgICAgIHRoaXMuY29tcHV0ZUZpbmFsU2NvcmVzKCkuZmluYWxseSgoKSA9PiB7IHRoaXMuc2hvd0dhbWVFbmREaWFsb2cgPSB0cnVlIH0pDQogICAgICAgICAgICBpZiAodGhpcy5hdWN0aW9uVGltZXIpIHsgY2xlYXJJbnRlcnZhbCh0aGlzLmF1Y3Rpb25UaW1lcik7IHRoaXMuYXVjdGlvblRpbWVyID0gbnVsbCB9DQogICAgICAgICAgfSwNCiAgICAgICAgICBvbkF1Y3Rpb25FbmRlZDogYXN5bmMgKCkgPT4geyBhd2FpdCB0aGlzLmxvYWRSb29tU3RhdGUoKSB9LA0KICAgICAgICAgIG9uQ2hhdE1lc3NhZ2U6IChtZXNzYWdlKSA9PiB7DQogICAgICAgICAgICAvLyDpgb/lhY3ph43lpI3mt7vliqDmtojmga8NCiAgICAgICAgICAgIGlmICghbWVzc2FnZSB8fCAhbWVzc2FnZS5pZCkgcmV0dXJuDQogICAgICAgICAgICBjb25zdCBleGlzdGluZyA9IHRoaXMuY2hhdE1lc3NhZ2VzLmZpbmQobSA9PiBtLmlkID09PSBtZXNzYWdlLmlkIHx8IChtLnVzZXJJZCA9PT0gbWVzc2FnZS51c2VySWQgJiYgbS50aW1lc3RhbXAgPT09IG1lc3NhZ2UudGltZXN0YW1wICYmIG0uY29udGVudCA9PT0gbWVzc2FnZS5jb250ZW50KSkNCiAgICAgICAgICAgIGlmIChleGlzdGluZykgcmV0dXJuDQogICAgICAgICAgICANCiAgICAgICAgICAgIHRoaXMuY2hhdE1lc3NhZ2VzLnB1c2gobWVzc2FnZSkNCiAgICAgICAgICAgIHRoaXMuJG5leHRUaWNrKCgpID0+IHsNCiAgICAgICAgICAgICAgY29uc3QgY2hhdENvbnRhaW5lciA9IHRoaXMuJHJlZnMuY2hhdENvbnRhaW5lcg0KICAgICAgICAgICAgICBpZiAoY2hhdENvbnRhaW5lcikgeyBjaGF0Q29udGFpbmVyLnNjcm9sbFRvcCA9IGNoYXRDb250YWluZXIuc2Nyb2xsSGVpZ2h0IH0NCiAgICAgICAgICAgIH0pDQogICAgICAgICAgfSwNCiAgICAgICAgfSwNCiAgICAgICAgKCkgPT4geyBpZiAoIXRoaXMucmVmcmVzaFRpbWVyKSB7IHRoaXMucmVmcmVzaFRpbWVyID0gc2V0SW50ZXJ2YWwodGhpcy5sb2FkUm9vbVN0YXRlLCAxMDAwKSB9IH0NCiAgICAgICkNCiAgICAgIHRoaXMucm9vbUNoYW5uZWwgPSByb29tQ2hhbm5lbA0KICAgICAgdGhpcy5icm9hZGNhc3RDaGFubmVsID0gYnJvYWRjYXN0Q2hhbm5lbA0KICAgIH0sDQogICAgdW5zdWJzY3JpYmVSb29tUmVhbHRpbWUoKSB7DQogICAgICB1bnN1YnNjcmliZVJvb21SZWFsdGltZVNlcnZpY2UodGhpcy5yb29tQ2hhbm5lbCwgdGhpcy5icm9hZGNhc3RDaGFubmVsKQ0KICAgICAgdGhpcy5yb29tQ2hhbm5lbCA9IG51bGwNCiAgICAgIHRoaXMuYnJvYWRjYXN0Q2hhbm5lbCA9IG51bGwNCiAgICB9LA0KICAgIGFzeW5jIGxvYWRSb29tU3RhdGUoKSB7DQogICAgICBjb25zdCByaWQgPSB0aGlzLiRzdG9yZS5zdGF0ZS5yb29tSWQNCiAgICAgIGNvbnN0IHN1cGFiYXNlID0gZ2V0U3VwYWJhc2UoKQ0KICAgICAgYXdhaXQgbG9hZFJvb21TdGF0ZVNlcnZpY2Uoew0KICAgICAgICByb29tSWQ6IHJpZCwNCiAgICAgICAgcm9vbVNlcnZpY2UsDQogICAgICAgIHN1cGFiYXNlLA0KICAgICAgICBhcnRpZmFjdE1hcDogdGhpcy5hcnRpZmFjdE1hcCwNCiAgICAgICAgc3RvcmU6IHRoaXMuJHN0b3JlLA0KICAgICAgICBzZXRSb29tOiAocm9vbSkgPT4geyB0aGlzLnJvb20gPSByb29tIH0sDQogICAgICAgIHNldFByb2ZpbGVNYXA6IChtYXApID0+IHsgdGhpcy5wcm9maWxlTWFwID0gbWFwIH0sDQogICAgICAgIHNldEdhbWVQaGFzZTogKHBoYXNlKSA9PiB7IHRoaXMuJHN0b3JlLmNvbW1pdCgnU0VUX0dBTUVfUEhBU0UnLCBwaGFzZSkgfSwNCiAgICAgICAgY2xlYXJBdWN0aW9uVGltZXI6ICgpID0+IHsgaWYgKHRoaXMuYXVjdGlvblRpbWVyKSB7IGNsZWFySW50ZXJ2YWwodGhpcy5hdWN0aW9uVGltZXIpOyB0aGlzLmF1Y3Rpb25UaW1lciA9IG51bGwgfSB9LA0KICAgICAgICBzZXRBdWN0aW9uQ291bnRkb3duOiAobikgPT4geyB0aGlzLiRzZXQodGhpcywgJ2F1Y3Rpb25Db3VudGRvd24nLCBuKSB9LA0KICAgICAgICBvblNob3dHYW1lRW5kOiAoKSA9PiB7IHRoaXMuc2hvd0dhbWVFbmREaWFsb2cgPSB0cnVlOyBzZXRUaW1lb3V0KCgpID0+IHsgdGhpcy5oYW5kbGVHYW1lRW5kKCkgfSwgMzAwMCkgfSwNCiAgICAgIH0pDQogICAgICAvLyDliqDovb3miYDmnInnjqnlrrbnmoTmiYvniYzmlbDmja7vvIznlKjkuo7ku7flgLzorqHnrpcNCiAgICAgIGF3YWl0IHRoaXMubG9hZEFsbFBsYXllcnNBcnRpZmFjdHMoKQ0KICAgICAgLy8g5aaC5p6c5Yi35paw5ZCO5Y+R546w5LuN5pyJ5rS76LeD5ouN5Y2W77yM5L2G5pys5Zyw5peg5YCS6K6h5pe277yM5YiZ55So5b2T5YmN5Ymp5L2Z5pe26Ze05ZCv5Yqo57uf5LiA5YCS6K6h5pe2DQogICAgICBjb25zdCBhdWN0aW9ucyA9IHRoaXMuJHN0b3JlLnN0YXRlLmN1cnJlbnRBdWN0aW9ucyB8fCBbXQ0KICAgICAgaWYgKHRoaXMuJHN0b3JlLnN0YXRlLmdhbWVQaGFzZSA9PT0gJ2F1Y3Rpb24nICYmIGF1Y3Rpb25zLmxlbmd0aCA+IDApIHsNCiAgICAgICAgY29uc3QgcmVtYWluaW5nID0gTnVtYmVyKHRoaXMuYXVjdGlvbkNvdW50ZG93biB8fCAwKQ0KICAgICAgICBpZiAoIXRoaXMuYXVjdGlvblRpbWVyICYmIHJlbWFpbmluZyA+IDApIHsNCiAgICAgICAgICBzdGFydENvdW50ZG93bih7DQogICAgICAgICAgICBzZWNvbmRzOiByZW1haW5pbmcsDQogICAgICAgICAgICBvblRpY2s6IChzKSA9PiB7IHRoaXMuJHNldCh0aGlzLCAnYXVjdGlvbkNvdW50ZG93bicsIHMpOyB9LA0KICAgICAgICAgICAgb25Eb25lOiBhc3luYyAoKSA9PiB7IGF3YWl0IHRoaXMub25BdWN0aW9uVGltZVVwKCkgfSwNCiAgICAgICAgICAgIGdldFJlZjogKCkgPT4gdGhpcy5hdWN0aW9uVGltZXIsDQogICAgICAgICAgICBzZXRSZWY6IChpZCkgPT4geyB0aGlzLmF1Y3Rpb25UaW1lciA9IGlkIH0sDQogICAgICAgICAgfSkNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0sDQogICAgDQogICAgLy8g5Yqg6L295omA5pyJ546p5a6255qE5omL54mM5pWw5o2uDQogICAgYXN5bmMgbG9hZEFsbFBsYXllcnNBcnRpZmFjdHMoKSB7DQogICAgICB0cnkgew0KICAgICAgICBjb25zdCByaWQgPSB0aGlzLiRzdG9yZS5zdGF0ZS5yb29tSWQNCiAgICAgICAgaWYgKCFyaWQpIHsNCiAgICAgICAgICB0aGlzLmFsbFBsYXllcnNBcnRpZmFjdHMgPSB7fQ0KICAgICAgICAgIHJldHVybg0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICBjb25zdCBzdXBhYmFzZSA9IGdldFN1cGFiYXNlKCkNCiAgICAgICAgLy8g6I635Y+W5oi/6Ze05YaF5omA5pyJ546p5a6255qE5omL54mM5pWw5o2uDQogICAgICAgIGNvbnN0IHsgZGF0YTogYWxsQXJ0aWZhY3RzIH0gPSBhd2FpdCBzdXBhYmFzZQ0KICAgICAgICAgIC5mcm9tKCdyb29tX2FydGlmYWN0cycpDQogICAgICAgICAgLnNlbGVjdCgnb3duZXJfdXNlcl9pZCwgYXJ0aWZhY3RfaWQnKQ0KICAgICAgICAgIC5lcSgncm9vbV9pZCcsIHJpZCkNCiAgICAgICAgDQogICAgICAgIC8vIOaMieeOqeWutklE5YiG57uEDQogICAgICAgIGNvbnN0IHBsYXllckFydGlmYWN0c01hcCA9IHt9DQogICAgICAgIGlmIChhbGxBcnRpZmFjdHMgJiYgYWxsQXJ0aWZhY3RzLmxlbmd0aCA+IDApIHsNCiAgICAgICAgICBhbGxBcnRpZmFjdHMuZm9yRWFjaChyb3cgPT4gew0KICAgICAgICAgICAgY29uc3QgdXNlcklkID0gcm93Lm93bmVyX3VzZXJfaWQNCiAgICAgICAgICAgIGlmICghcGxheWVyQXJ0aWZhY3RzTWFwW3VzZXJJZF0pIHsNCiAgICAgICAgICAgICAgcGxheWVyQXJ0aWZhY3RzTWFwW3VzZXJJZF0gPSBbXQ0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcGxheWVyQXJ0aWZhY3RzTWFwW3VzZXJJZF0ucHVzaChyb3cuYXJ0aWZhY3RfaWQpDQogICAgICAgICAgfSkNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgLy8g5L2/55SoIFZ1ZS5zZXQg56Gu5L+d5ZON5bqU5byP5pu05pawDQogICAgICAgIHRoaXMuJHNldCh0aGlzLCAnYWxsUGxheWVyc0FydGlmYWN0cycsIHBsYXllckFydGlmYWN0c01hcCkNCiAgICAgIH0gY2F0Y2ggKGUpIHsNCiAgICAgICAgY29uc29sZS53YXJuKCdbZ2FtZV0gbG9hZEFsbFBsYXllcnNBcnRpZmFjdHMgZmFpbGVkJywgZSkNCiAgICAgICAgdGhpcy5hbGxQbGF5ZXJzQXJ0aWZhY3RzID0ge30NCiAgICAgIH0NCiAgICB9LA0KICAgIGFzeW5jIHRvZ2dsZVJlYWR5KCkgew0KICAgICAgdHJ5IHsNCiAgICAgICAgY29uc3QgcmlkID0gdGhpcy4kc3RvcmUuc3RhdGUucm9vbUlkDQogICAgICAgIGNvbnN0IHVpZCA9IHRoaXMuJHN0b3JlLnN0YXRlLnVzZXIgJiYgdGhpcy4kc3RvcmUuc3RhdGUudXNlci5pZA0KICAgICAgICBpZiAoIXJpZCB8fCAhdWlkKSByZXR1cm4NCiAgICAgICAgYXdhaXQgdG9nZ2xlUmVhZHlBY3Rpb24oeyByb29tSWQ6IHJpZCwgdXNlcklkOiB1aWQsIHJvb206IHRoaXMucm9vbSwgcm9vbVNlcnZpY2UsIHJlbG9hZDogdGhpcy5sb2FkUm9vbVN0YXRlIH0pDQogICAgICB9IGNhdGNoIChlKSB7IGNvbnNvbGUud2FybignW2dhbWVdIHRvZ2dsZVJlYWR5IGZhaWxlZCcsIGUpIH0NCiAgICB9LA0KICAgIGFzeW5jIG1vdmVUb1NlYXQoaWR4KSB7DQogICAgICB0cnkgew0KICAgICAgICBjb25zdCByaWQgPSB0aGlzLiRzdG9yZS5zdGF0ZS5yb29tSWQNCiAgICAgICAgY29uc3QgdWlkID0gdGhpcy4kc3RvcmUuc3RhdGUudXNlciAmJiB0aGlzLiRzdG9yZS5zdGF0ZS51c2VyLmlkDQogICAgICAgIGlmICghcmlkIHx8ICF1aWQpIHJldHVybg0KICAgICAgICBjb25zdCB0YXJnZXRTZWF0ID0geyBpbmRleDogaWR4LCBwbGF5ZXI6IHRoaXMuc2VhdHNbaWR4XSAmJiB0aGlzLnNlYXRzW2lkeF0ucGxheWVyIH0NCiAgICAgICAgYXdhaXQgbW92ZVRvU2VhdEFjdGlvbih7IHJvb21JZDogcmlkLCB1c2VySWQ6IHVpZCwgcm9vbTogdGhpcy5yb29tLCBzZWF0czogdGFyZ2V0U2VhdCwgcm9vbVNlcnZpY2UsIHJlbG9hZDogdGhpcy5sb2FkUm9vbVN0YXRlIH0pDQogICAgICB9IGNhdGNoIChlKSB7IGNvbnNvbGUud2FybignW2dhbWVdIG1vdmVUb1NlYXQgZmFpbGVkJywgZSkgfQ0KICAgIH0sDQogICAgYXN5bmMgbGVhdmVSb29tKCkgew0KICAgICAgdHJ5IHsNCiAgICAgICAgY29uc3QgcmlkID0gdGhpcy4kc3RvcmUuc3RhdGUucm9vbUlkDQogICAgICAgIGNvbnN0IHVpZCA9IHRoaXMuJHN0b3JlLnN0YXRlLnVzZXIgJiYgdGhpcy4kc3RvcmUuc3RhdGUudXNlci5pZA0KICAgICAgICBpZiAoIXJpZCB8fCAhdWlkKSByZXR1cm4NCiAgICAgICAgYXdhaXQgbGVhdmVSb29tQWN0aW9uKHsNCiAgICAgICAgICByb29tSWQ6IHJpZCwNCiAgICAgICAgICB1c2VySWQ6IHVpZCwNCiAgICAgICAgICBjbGVhckF1Y3Rpb25UaW1lcjogKCkgPT4geyBpZiAodGhpcy5hdWN0aW9uVGltZXIpIHsgY2xlYXJJbnRlcnZhbCh0aGlzLmF1Y3Rpb25UaW1lcik7IHRoaXMuYXVjdGlvblRpbWVyID0gbnVsbCB9IH0sDQogICAgICAgICAgc2V0Q291bnRkb3duOiAobikgPT4geyB0aGlzLiRzZXQodGhpcywgJ2F1Y3Rpb25Db3VudGRvd24nLCBuKSB9LA0KICAgICAgICAgIHN0b3JlOiB0aGlzLiRzdG9yZSwNCiAgICAgICAgICBhdWN0aW9uU2VydmljZSwNCiAgICAgICAgICByb29tU2VydmljZSwNCiAgICAgICAgICB1bnN1YnNjcmliZTogKCkgPT4gdGhpcy51bnN1YnNjcmliZVJvb21SZWFsdGltZSgpLA0KICAgICAgICAgIHNldFJvb21JZDogKHYpID0+IHRoaXMuJHN0b3JlLmNvbW1pdCgnU0VUX1JPT01fSUQnLCB2KSwNCiAgICAgICAgICBzZXRMb2NhbFJvb206ICh2KSA9PiB7IHRoaXMucm9vbSA9IHYgfSwNCiAgICAgICAgICBuYXZpZ2F0ZVRvUm9vbXM6ICgpID0+IHRoaXMuJHJvdXRlci5wdXNoKCcvcm9vbXMnKSwNCiAgICAgICAgfSkNCiAgICAgIH0gY2F0Y2ggKGUpIHsgY29uc29sZS53YXJuKCdbZ2FtZV0gbGVhdmVSb29tIGZhaWxlZCcsIGUpIH0NCiAgICB9LA0KICAgIA0KICAgIC8vIOa4uOaIj+e7k+adn+WkhOeQhg0KICAgIGFzeW5jIGhhbmRsZUdhbWVFbmQoKSB7DQogICAgICB0cnkgew0KICAgICAgICBjb25zdCByaWQgPSB0aGlzLiRzdG9yZS5zdGF0ZS5yb29tSWQNCiAgICAgICAgaWYgKHJpZCkgew0KICAgICAgICAgIC8vIOWwhuaIv+mXtOeKtuaAgemHjee9ruS4uiB3YWl0aW5n77yM5L6/5LqO57un57ut5oi/6Ze05YaF5YeG5aSHL+aWsOS4gOWxgA0KICAgICAgICAgIGNvbnN0IHN1cGFiYXNlID0gZ2V0U3VwYWJhc2UoKQ0KICAgICAgICAgIGF3YWl0IHN1cGFiYXNlLmZyb20oJ3Jvb21zJykudXBkYXRlKHsgc3RhdHVzOiAnd2FpdGluZycgfSkuZXEoJ2lkJywgcmlkKQ0KICAgICAgICAgIC8vIOi3s+i9rOWbnuaIv+mXtOmhtemdou+8iOa4uOaIj+mhteaQuuW4piByb29tSWQg5Y2z5piv5oi/6Ze055WM6Z2i77yJDQogICAgICAgICAgdGhpcy4kcm91dGVyLnB1c2goeyBwYXRoOiAnL2dhbWUnLCBxdWVyeTogeyByb29tSWQ6IHJpZCwgZ2FtZUVuZGVkOiAndHJ1ZScgfSB9KQ0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHRoaXMuJHJvdXRlci5wdXNoKCcvcm9vbXMnKQ0KICAgICAgICB9DQogICAgICB9IGNhdGNoIChlKSB7DQogICAgICAgIGNvbnNvbGUud2FybignW2dhbWVdIGhhbmRsZUdhbWVFbmQgZmFpbGVkJywgZSkNCiAgICAgICAgLy8g5YWc5bqV6Lez5Zue5oi/6Ze05YiX6KGoDQogICAgICAgIHRoaXMuJHJvdXRlci5wdXNoKCcvcm9vbXMnKQ0KICAgICAgfQ0KICAgIH0sDQoNCiAgICAvLyDpn7PkuZDmjqfliLbnm7jlhbPmlrnms5UNCiAgICBpbml0aWFsaXplTXVzaWMoKSB7DQogICAgICB0cnkgew0KICAgICAgICAvLyDliJvlu7rpn7PpopHlhYPntKANCiAgICAgICAgdGhpcy5hdWRpb0VsZW1lbnQgPSBuZXcgQXVkaW8oJy9pbWFnZXMvYmdtLm1wMycpDQogICAgICAgIHRoaXMuYXVkaW9FbGVtZW50Lmxvb3AgPSB0cnVlDQogICAgICAgIHRoaXMuYXVkaW9FbGVtZW50LnZvbHVtZSA9IHRoaXMubXVzaWNWb2x1bWUNCiAgICAgICAgDQogICAgICAgIC8vIOebkeWQrOmfs+mikeaSreaUvueKtuaAgQ0KICAgICAgICB0aGlzLmF1ZGlvRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdsb2FkZWRkYXRhJywgKCkgPT4gew0KICAgICAgICAgIGNvbnNvbGUubG9nKCfwn461IOiDjOaZr+mfs+S5kOWKoOi9veWujOaIkCcpDQogICAgICAgIH0pDQogICAgICAgIA0KICAgICAgICB0aGlzLmF1ZGlvRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsIChlKSA9PiB7DQogICAgICAgICAgY29uc29sZS5lcnJvcign8J+OtSDog4zmma/pn7PkuZDliqDovb3lpLHotKU6JywgZSkNCiAgICAgICAgfSkNCiAgICAgICAgDQogICAgICAgIC8vIOWwneivleiHquWKqOaSreaUvu+8iOmcgOimgeeUqOaIt+S6pOS6kuWQjuaJjeiDveeUn+aViO+8iQ0KICAgICAgICB0aGlzLmF1ZGlvRWxlbWVudC5sb2FkKCkNCiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7DQogICAgICAgIGNvbnNvbGUuZXJyb3IoJ/CfjrUg5Yid5aeL5YyW6Z+z5LmQ5pKt5pS+5Zmo5aSx6LSlOicsIGVycm9yKQ0KICAgICAgfQ0KICAgIH0sDQogICAgDQogICAgdG9nZ2xlTXVzaWMoKSB7DQogICAgICBpZiAoIXRoaXMuYXVkaW9FbGVtZW50KSByZXR1cm4NCiAgICAgIA0KICAgICAgaWYgKHRoaXMuaXNNdXNpY1BsYXlpbmcpIHsNCiAgICAgICAgdGhpcy5wYXVzZU11c2ljKCkNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHRoaXMucGxheU11c2ljKCkNCiAgICAgIH0NCiAgICB9LA0KICAgIA0KICAgIGFzeW5jIHBsYXlNdXNpYygpIHsNCiAgICAgIGlmICghdGhpcy5hdWRpb0VsZW1lbnQpIHJldHVybg0KICAgICAgDQogICAgICB0cnkgew0KICAgICAgICBhd2FpdCB0aGlzLmF1ZGlvRWxlbWVudC5wbGF5KCkNCiAgICAgICAgdGhpcy5pc011c2ljUGxheWluZyA9IHRydWUNCiAgICAgICAgY29uc29sZS5sb2coJ/CfjrUg6IOM5pmv6Z+z5LmQ5byA5aeL5pKt5pS+JykNCiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7DQogICAgICAgIGNvbnNvbGUud2Fybign8J+OtSDpn7PkuZDmkq3mlL7lpLHotKXvvIzlj6/og73pnIDopoHnlKjmiLfkuqTkupI6JywgZXJyb3IpDQogICAgICAgIC8vIOWmguaenOaYr+iHquWKqOaSreaUvuetlueVpeWvvOiHtOeahOWksei0pe+8jOaIkeS7rOS7jeWwhueKtuaAgeagh+iusOS4uuaSreaUvg0KICAgICAgICB0aGlzLmlzTXVzaWNQbGF5aW5nID0gdHJ1ZQ0KICAgICAgfQ0KICAgIH0sDQogICAgDQogICAgcGF1c2VNdXNpYygpIHsNCiAgICAgIGlmICghdGhpcy5hdWRpb0VsZW1lbnQpIHJldHVybg0KICAgICAgDQogICAgICB0aGlzLmF1ZGlvRWxlbWVudC5wYXVzZSgpDQogICAgICB0aGlzLmlzTXVzaWNQbGF5aW5nID0gZmFsc2UNCiAgICAgIGNvbnNvbGUubG9nKCfwn461IOiDjOaZr+mfs+S5kOaaguWBnCcpDQogICAgfSwNCiAgICANCiAgICBzZXRWb2x1bWUodm9sdW1lKSB7DQogICAgICB0aGlzLm11c2ljVm9sdW1lID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgdm9sdW1lKSkNCiAgICAgIGlmICh0aGlzLmF1ZGlvRWxlbWVudCkgew0KICAgICAgICB0aGlzLmF1ZGlvRWxlbWVudC52b2x1bWUgPSB0aGlzLm11c2ljVm9sdW1lDQogICAgICB9DQogICAgfSwNCiAgICANCiAgICBjbGVhbnVwTXVzaWMoKSB7DQogICAgICBpZiAodGhpcy5hdWRpb0VsZW1lbnQpIHsNCiAgICAgICAgdGhpcy5wYXVzZU11c2ljKCkNCiAgICAgICAgdGhpcy5hdWRpb0VsZW1lbnQgPSBudWxsDQogICAgICB9DQogICAgfSwNCiAgICANCiAgICAvLyDmoLnmja7muLjmiI/pmLbmrrXlpITnkIbpn7PkuZDmkq3mlL4NCiAgICBoYW5kbGVHYW1lUGhhc2VNdXNpYyhwaGFzZSkgew0KICAgICAgaWYgKCF0aGlzLmF1ZGlvRWxlbWVudCkgcmV0dXJuDQogICAgICANCiAgICAgIC8vIOWPquacieWcqOmfs+S5kOato+WcqOaSreaUvuaXtuaJjemcgOimgeagueaNrumYtuauteiwg+aVtA0KICAgICAgaWYgKCF0aGlzLmlzTXVzaWNQbGF5aW5nKSByZXR1cm4NCiAgICAgIA0KICAgICAgc3dpdGNoIChwaGFzZSkgew0KICAgICAgICBjYXNlICdwcmVwYXJhdGlvbic6DQogICAgICAgICAgLy8g5YeG5aSH6Zi25q6177ya5q2j5bi45pKt5pS+DQogICAgICAgICAgdGhpcy5zZXRWb2x1bWUoMC41KQ0KICAgICAgICAgIGJyZWFrDQogICAgICAgIGNhc2UgJ2NvdW50ZG93bic6DQogICAgICAgIGNhc2UgJ2ludGVybWlzc2lvbic6DQogICAgICAgICAgLy8g5YCS6K6h5pe25ZKM6Ze05q2H6Zi25q6177ya6ZmN5L2O6Z+z6YePDQogICAgICAgICAgdGhpcy5zZXRWb2x1bWUoMC4zKQ0KICAgICAgICAgIGJyZWFrDQogICAgICAgIGNhc2UgJ2F1Y3Rpb24nOg0KICAgICAgICAgIC8vIOaLjeWNlumYtuaute+8muato+W4uOmfs+mHjw0KICAgICAgICAgIHRoaXMuc2V0Vm9sdW1lKDAuNSkNCiAgICAgICAgICBicmVhaw0KICAgICAgICBjYXNlICdpdGVtJzoNCiAgICAgICAgICAvLyDpgZPlhbfpmLbmrrXvvJrnqI3lvq7pmY3kvY7pn7Pph48NCiAgICAgICAgICB0aGlzLnNldFZvbHVtZSgwLjQpDQogICAgICAgICAgYnJlYWsNCiAgICAgICAgY2FzZSAnc2V0dGxlbWVudCc6DQogICAgICAgICAgLy8g57uT566X6Zi25q6177ya6ZmN5L2O6Z+z6YePDQogICAgICAgICAgdGhpcy5zZXRWb2x1bWUoMC4zKQ0KICAgICAgICAgIGJyZWFrDQogICAgICAgIGRlZmF1bHQ6DQogICAgICAgICAgdGhpcy5zZXRWb2x1bWUoMC41KQ0KICAgICAgfQ0KICAgIH0sDQoNCiAgICAvLyDpn7PkuZDmjqfliLbnm7jlhbPmlrnms5UNCiAgICBpbml0aWFsaXplTXVzaWMoKSB7DQogICAgICB0cnkgew0KICAgICAgICAvLyDliJvlu7rpn7PpopHlhYPntKANCiAgICAgICAgdGhpcy5hdWRpb0VsZW1lbnQgPSBuZXcgQXVkaW8oJy9pbWFnZXMvYmdtLm1wMycpDQogICAgICAgIHRoaXMuYXVkaW9FbGVtZW50Lmxvb3AgPSB0cnVlDQogICAgICAgIHRoaXMuYXVkaW9FbGVtZW50LnZvbHVtZSA9IHRoaXMubXVzaWNWb2x1bWUNCiAgICAgICAgDQogICAgICAgIC8vIOebkeWQrOmfs+mikeaSreaUvueKtuaAgQ0KICAgICAgICB0aGlzLmF1ZGlvRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdsb2FkZWRkYXRhJywgKCkgPT4gew0KICAgICAgICAgIGNvbnNvbGUubG9nKCfwn461IOiDjOaZr+mfs+S5kOWKoOi9veWujOaIkCcpDQogICAgICAgIH0pDQogICAgICAgIA0KICAgICAgICB0aGlzLmF1ZGlvRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsIChlKSA9PiB7DQogICAgICAgICAgY29uc29sZS5lcnJvcign8J+OtSDog4zmma/pn7PkuZDliqDovb3lpLHotKU6JywgZSkNCiAgICAgICAgfSkNCiAgICAgICAgDQogICAgICAgIC8vIOWwneivleiHquWKqOaSreaUvu+8iOmcgOimgeeUqOaIt+S6pOS6kuWQjuaJjeiDveeUn+aViO+8iQ0KICAgICAgICB0aGlzLmF1ZGlvRWxlbWVudC5sb2FkKCkNCiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7DQogICAgICAgIGNvbnNvbGUuZXJyb3IoJ/CfjrUg5Yid5aeL5YyW6Z+z5LmQ5pKt5pS+5Zmo5aSx6LSlOicsIGVycm9yKQ0KICAgICAgfQ0KICAgIH0sDQogICAgDQogICAgdG9nZ2xlTXVzaWMoKSB7DQogICAgICBpZiAoIXRoaXMuYXVkaW9FbGVtZW50KSByZXR1cm4NCiAgICAgIA0KICAgICAgaWYgKHRoaXMuaXNNdXNpY1BsYXlpbmcpIHsNCiAgICAgICAgdGhpcy5wYXVzZU11c2ljKCkNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHRoaXMucGxheU11c2ljKCkNCiAgICAgIH0NCiAgICB9LA0KICAgIA0KICAgIGFzeW5jIHBsYXlNdXNpYygpIHsNCiAgICAgIGlmICghdGhpcy5hdWRpb0VsZW1lbnQpIHJldHVybg0KICAgICAgDQogICAgICB0cnkgew0KICAgICAgICBhd2FpdCB0aGlzLmF1ZGlvRWxlbWVudC5wbGF5KCkNCiAgICAgICAgdGhpcy5pc011c2ljUGxheWluZyA9IHRydWUNCiAgICAgICAgY29uc29sZS5sb2coJ/CfjrUg6IOM5pmv6Z+z5LmQ5byA5aeL5pKt5pS+JykNCiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7DQogICAgICAgIGNvbnNvbGUud2Fybign8J+OtSDpn7PkuZDmkq3mlL7lpLHotKXvvIzlj6/og73pnIDopoHnlKjmiLfkuqTkupI6JywgZXJyb3IpDQogICAgICAgIC8vIOWmguaenOaYr+iHquWKqOaSreaUvuetlueVpeWvvOiHtOeahOWksei0pe+8jOaIkeS7rOS7jeWwhueKtuaAgeagh+iusOS4uuaSreaUvg0KICAgICAgICB0aGlzLmlzTXVzaWNQbGF5aW5nID0gdHJ1ZQ0KICAgICAgfQ0KICAgIH0sDQogICAgDQogICAgcGF1c2VNdXNpYygpIHsNCiAgICAgIGlmICghdGhpcy5hdWRpb0VsZW1lbnQpIHJldHVybg0KICAgICAgDQogICAgICB0aGlzLmF1ZGlvRWxlbWVudC5wYXVzZSgpDQogICAgICB0aGlzLmlzTXVzaWNQbGF5aW5nID0gZmFsc2UNCiAgICAgIGNvbnNvbGUubG9nKCfwn461IOiDjOaZr+mfs+S5kOaaguWBnCcpDQogICAgfSwNCiAgICANCiAgICBzZXRWb2x1bWUodm9sdW1lKSB7DQogICAgICB0aGlzLm11c2ljVm9sdW1lID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgdm9sdW1lKSkNCiAgICAgIGlmICh0aGlzLmF1ZGlvRWxlbWVudCkgew0KICAgICAgICB0aGlzLmF1ZGlvRWxlbWVudC52b2x1bWUgPSB0aGlzLm11c2ljVm9sdW1lDQogICAgICB9DQogICAgfSwNCiAgICANCiAgICBjbGVhbnVwTXVzaWMoKSB7DQogICAgICBpZiAodGhpcy5hdWRpb0VsZW1lbnQpIHsNCiAgICAgICAgdGhpcy5wYXVzZU11c2ljKCkNCiAgICAgICAgdGhpcy5hdWRpb0VsZW1lbnQgPSBudWxsDQogICAgICB9DQogICAgfSwNCiAgICANCiAgICAvLyDmoLnmja7muLjmiI/pmLbmrrXlpITnkIbpn7PkuZDmkq3mlL4NCiAgICBoYW5kbGVHYW1lUGhhc2VNdXNpYyhwaGFzZSkgew0KICAgICAgaWYgKCF0aGlzLmF1ZGlvRWxlbWVudCkgcmV0dXJuDQogICAgICANCiAgICAgIC8vIOWPquacieWcqOmfs+S5kOato+WcqOaSreaUvuaXtuaJjemcgOimgeagueaNrumYtuauteiwg+aVtA0KICAgICAgaWYgKCF0aGlzLmlzTXVzaWNQbGF5aW5nKSByZXR1cm4NCiAgICAgIA0KICAgICAgc3dpdGNoIChwaGFzZSkgew0KICAgICAgICBjYXNlICdwcmVwYXJhdGlvbic6DQogICAgICAgICAgLy8g5YeG5aSH6Zi25q6177ya5q2j5bi45pKt5pS+DQogICAgICAgICAgdGhpcy5zZXRWb2x1bWUoMC41KQ0KICAgICAgICAgIGJyZWFrDQogICAgICAgIGNhc2UgJ2NvdW50ZG93bic6DQogICAgICAgIGNhc2UgJ2ludGVybWlzc2lvbic6DQogICAgICAgICAgLy8g5YCS6K6h5pe25ZKM6Ze05q2H6Zi25q6177ya6ZmN5L2O6Z+z6YePDQogICAgICAgICAgdGhpcy5zZXRWb2x1bWUoMC4zKQ0KICAgICAgICAgIGJyZWFrDQogICAgICAgIGNhc2UgJ2F1Y3Rpb24nOg0KICAgICAgICAgIC8vIOaLjeWNlumYtuaute+8muato+W4uOmfs+mHjw0KICAgICAgICAgIHRoaXMuc2V0Vm9sdW1lKDAuNSkNCiAgICAgICAgICBicmVhaw0KICAgICAgICBjYXNlICdpdGVtJzoNCiAgICAgICAgICAvLyDpgZPlhbfpmLbmrrXvvJrnqI3lvq7pmY3kvY7pn7Pph48NCiAgICAgICAgICB0aGlzLnNldFZvbHVtZSgwLjQpDQogICAgICAgICAgYnJlYWsNCiAgICAgICAgY2FzZSAnc2V0dGxlbWVudCc6DQogICAgICAgICAgLy8g57uT566X6Zi25q6177ya6ZmN5L2O6Z+z6YePDQogICAgICAgICAgdGhpcy5zZXRWb2x1bWUoMC4zKQ0KICAgICAgICAgIGJyZWFrDQogICAgICAgIGRlZmF1bHQ6DQogICAgICAgICAgdGhpcy5zZXRWb2x1bWUoMC41KQ0KICAgICAgfQ0KICAgIH0sDQogICAgYXN5bmMgc3RhcnRHYW1lKCkgew0KICAgICAgdHJ5IHsNCiAgICAgICAgY29uc3QgcmlkID0gdGhpcy4kc3RvcmUuc3RhdGUucm9vbUlkDQogICAgICAgIGNvbnN0IHVpZCA9IHRoaXMuJHN0b3JlLnN0YXRlLnVzZXIgJiYgdGhpcy4kc3RvcmUuc3RhdGUudXNlci5pZA0KICAgICAgICBpZiAoIXJpZCB8fCAhdWlkIHx8ICF0aGlzLmlzT3duZXIgfHwgIXRoaXMuYWxsUmVhZHkpIHJldHVybg0KICAgICAgICAvLyDmlrDlsYDlvIDlp4vliY3ph43nva7ns7vnu5/ml6Xlv5fjgIHogYrlpKnmtojmga/lkozku7flgLzmlbDmja4NCiAgICAgICAgdHJ5IHsgdGhpcy4kc3RvcmUuY29tbWl0KCdDTEVBUl9HQU1FX0xPRycpIH0gY2F0Y2ggKF8pIHt9DQogICAgICAgIHRoaXMuY2hhdE1lc3NhZ2VzID0gW10NCiAgICAgICAgdGhpcy5hbGxQbGF5ZXJzQXJ0aWZhY3RzID0ge30NCiAgICAgICAgYXdhaXQgcm9vbVNlcnZpY2Uuc3RhcnRHYW1lKHJpZCwgdWlkKQ0KICAgICAgICBjb25zdCBzdXBhYmFzZSA9IGdldFN1cGFiYXNlKCkNCiAgICAgICAgdGhpcy5yb3VuZENvdW50ID0gMA0KICAgICAgICBhd2FpdCBzdGFydEdhbWVGbG93KHsNCiAgICAgICAgICByb29tSWQ6IHJpZCwNCiAgICAgICAgICB1c2VySWQ6IHVpZCwNCiAgICAgICAgICBpc093bmVyOiB0aGlzLmlzT3duZXIsDQogICAgICAgICAgYWxsUmVhZHk6IHRoaXMuYWxsUmVhZHksDQogICAgICAgICAgc3RvcmU6IHRoaXMuJHN0b3JlLA0KICAgICAgICAgIHN1cGFiYXNlLA0KICAgICAgICAgIHNldENvdW50ZG93bjogKG4pID0+IHRoaXMuJHNldCh0aGlzLCAnYXVjdGlvbkNvdW50ZG93bicsIG4pLA0KICAgICAgICAgIHNldEN1cnJlbnRQbGF5ZXJGcm9tUm9vbTogKCkgPT4gew0KICAgICAgICAgICAgY29uc3QgbWUgPSAodGhpcy5yb29tICYmIHRoaXMucm9vbS5yb29tX3BsYXllcnMgPyB0aGlzLnJvb20ucm9vbV9wbGF5ZXJzIDogW10pLmZpbmQocCA9PiBwLnVzZXJfaWQgPT09IHVpZCkNCiAgICAgICAgICAgIGlmIChtZSkgeyB0aGlzLiRzdG9yZS5jb21taXQoJ1NFVF9DVVJSRU5UX1BMQVlFUicsIHsgaWQ6IG1lLnVzZXJfaWQsIG5hbWU6IHRoaXMuZ2V0TmFtZUZvcihtZS51c2VyX2lkKSwgZW5lcmd5OiA1MCwgYXJ0aWZhY3RzOiBbXSwgaXRlbXM6IFtdIH0pIH0NCiAgICAgICAgICB9LA0KICAgICAgICAgIG9uQ291bnRkb3duRG9uZTogYXN5bmMgKCkgPT4gew0KICAgICAgICAgICAgaWYgKHRoaXMuaXNPd25lcikgeyBhd2FpdCB0aGlzLmF1dG9TdGFydEF1Y3Rpb24oKSB9DQogICAgICAgICAgfSwNCiAgICAgICAgfSkNCiAgICAgICAgLy8g5oi/5Li75pys5Zyw5Lmf5ZCv5Yqo6aKE5YCS6K6h5pe277yM6Ziy5q2i5bm/5pKt5LiN5Zue5Lyg5a+86Ie05LiN6Kem5Y+RIG9uR2FtZVN0YXJ0ZWQNCiAgICAgICAgaWYgKCF0aGlzLmNvdW50ZG93bkluUHJvZ3Jlc3MpIHsNCiAgICAgICAgICB0aGlzLmNvdW50ZG93bkluUHJvZ3Jlc3MgPSB0cnVlDQogICAgICAgICAgLy8g56Gu5L+d5pys5Zyw5Lmf6YeN572u5pWw5o2uDQogICAgICAgICAgdGhpcy5jaGF0TWVzc2FnZXMgPSBbXQ0KICAgICAgICAgIHRoaXMuYWxsUGxheWVyc0FydGlmYWN0cyA9IHt9DQogICAgICAgICAgdGhpcy4kc3RvcmUuY29tbWl0KCdTRVRfR0FNRV9QSEFTRScsICdjb3VudGRvd24nKQ0KICAgICAgICAgIHRoaXMuJHNldCh0aGlzLCAnYXVjdGlvbkNvdW50ZG93bicsIDUpDQogICAgICAgICAgY29uc3QgbWUgPSAodGhpcy5yb29tICYmIHRoaXMucm9vbS5yb29tX3BsYXllcnMgPyB0aGlzLnJvb20ucm9vbV9wbGF5ZXJzIDogW10pLmZpbmQocCA9PiBwLnVzZXJfaWQgPT09IHVpZCkNCiAgICAgICAgICBpZiAobWUpIHsNCiAgICAgICAgICAgIHRoaXMuJHN0b3JlLmNvbW1pdCgnU0VUX0NVUlJFTlRfUExBWUVSJywgeyBpZDogbWUudXNlcl9pZCwgbmFtZTogdGhpcy5nZXROYW1lRm9yKG1lLnVzZXJfaWQpLCBlbmVyZ3k6IDUwLCBhcnRpZmFjdHM6IFtdLCBpdGVtczogW10gfSkNCiAgICAgICAgICB9DQogICAgICAgICAgaWYgKHRoaXMuYXVjdGlvblRpbWVyKSB7IGNsZWFySW50ZXJ2YWwodGhpcy5hdWN0aW9uVGltZXIpOyB0aGlzLmF1Y3Rpb25UaW1lciA9IG51bGwgfQ0KICAgICAgICAgIHRoaXMuJG5leHRUaWNrKCgpID0+IHsNCiAgICAgICAgICAgIHN0YXJ0Q291bnRkb3duKHsNCiAgICAgICAgICAgICAgc2Vjb25kczogNSwNCiAgICAgICAgICAgICAgb25UaWNrOiAocykgPT4geyB0aGlzLiRzZXQodGhpcywgJ2F1Y3Rpb25Db3VudGRvd24nLCBzKSB9LA0KICAgICAgICAgICAgICBvbkRvbmU6IGFzeW5jICgpID0+IHsgdGhpcy5jb3VudGRvd25JblByb2dyZXNzID0gZmFsc2U7IGlmICh0aGlzLmlzT3duZXIpIHsgYXdhaXQgdGhpcy5hdXRvU3RhcnRBdWN0aW9uKCkgfSB9LA0KICAgICAgICAgICAgICBnZXRSZWY6ICgpID0+IHRoaXMuYXVjdGlvblRpbWVyLA0KICAgICAgICAgICAgICBzZXRSZWY6IChpZCkgPT4geyB0aGlzLmF1Y3Rpb25UaW1lciA9IGlkIH0sDQogICAgICAgICAgICB9KQ0KICAgICAgICAgIH0pDQogICAgICAgIH0NCiAgICAgIH0gY2F0Y2ggKGUpIHsgY29uc29sZS53YXJuKCdbZ2FtZV0gc3RhcnRHYW1lIGZhaWxlZCcsIGUpIH0NCiAgICB9LA0KICAgIA0KICAgIGFzeW5jIHN0YXJ0QXVjdGlvbigpIHsNCiAgICAgIC8vIOWQjOaXtuaKveWPluWkmuS7tui/m+ihjOaLjeWNlu+8iOekuuS+i+S4ujLku7bvvIkNCiAgICAgIGNvbnN0IGFydGlmYWN0cyA9IGF3YWl0IHRoaXMubG9hZEFydGlmYWN0cygpDQogICAgICBpZiAoYXJ0aWZhY3RzLmxlbmd0aCA+IDApIHsNCiAgICAgICAgY29uc3QgcGlja3MgPSBbXQ0KICAgICAgICB3aGlsZSAocGlja3MubGVuZ3RoIDwgTWF0aC5taW4oMiwgYXJ0aWZhY3RzLmxlbmd0aCkpIHsNCiAgICAgICAgICBjb25zdCBjYW5kaWRhdGUgPSBhcnRpZmFjdHNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogYXJ0aWZhY3RzLmxlbmd0aCldDQogICAgICAgICAgaWYgKCFwaWNrcy5maW5kKHAgPT4gcC5pZCA9PT0gY2FuZGlkYXRlLmlkKSkgcGlja3MucHVzaChjYW5kaWRhdGUpDQogICAgICAgIH0NCiAgICAgICAgZm9yIChjb25zdCBhcnQgb2YgcGlja3MpIHsNCiAgICAgICAgICBhd2FpdCB0aGlzLiRzdG9yZS5kaXNwYXRjaCgnc3RhcnRBdWN0aW9uJywgYXJ0KQ0KICAgICAgICB9DQogICAgICB9DQogICAgfSwNCiAgICANCiAgICBhc3luYyBsb2FkQXJ0aWZhY3RzKCkgew0KICAgICAgdHJ5IHsNCiAgICAgICAgY29uc3Qgc3VwYWJhc2UgPSBnZXRTdXBhYmFzZSgpDQogICAgICAgIHJldHVybiBhd2FpdCBsb2FkQXJ0aWZhY3RzU2VydmljZSh7IHN1cGFiYXNlIH0pDQogICAgICB9IGNhdGNoIChlcnJvcikgeyBjb25zb2xlLmVycm9yKCfliqDovb3ljaHniYzmlbDmja7lpLHotKU6JywgZXJyb3IpOyByZXR1cm4gW10gfQ0KICAgIH0sDQogICAgDQogICAgc2hvd0FydGlmYWN0RGV0YWlsKGFydGlmYWN0SWQpIHsNCiAgICAgIC8vIOiLpeW3suWKoOi9vWFydGlmYWN0TWFw77yM5YiZ5LyY5YWI5bGV56S655yf5a6e5pWw5o2uDQogICAgICBjb25zdCBhcnRpZmFjdCA9IHRoaXMuYXJ0aWZhY3RNYXBbYXJ0aWZhY3RJZF0NCiAgICAgIGlmIChhcnRpZmFjdCkgew0KICAgICAgICB0aGlzLnNlbGVjdGVkQ2FyZCA9IGFydGlmYWN0DQogICAgICB9IGVsc2Ugew0KICAgICAgICAvLyDlm57pgIDvvJrnu7TmjIHljp/npLrkvosNCiAgICAgICAgdGhpcy5zZWxlY3RlZENhcmQgPSB7DQogICAgICAgICAgaWQ6IGFydGlmYWN0SWQsDQogICAgICAgICAgbmFtZTogJ+ekuuS+i+Wlh+eJqScsDQogICAgICAgICAgZXJhOiAn5Y+k5LujJywNCiAgICAgICAgICBsb2NhdGlvbjogJ+acquefpScsDQogICAgICAgICAgc3Rvcnk6ICfov5nmmK/kuIDkuKrnpZ7np5jnmoTlpYfniakuLi4nLA0KICAgICAgICAgIGNvbGxlY3Rpb25UYWdzOiBbJ+iJuuacr+eRsOWunSddLA0KICAgICAgICAgIGJhc2VWYWx1ZTogOCwNCiAgICAgICAgICBpbWFnZTogJ2h0dHBzOi8vdmlhLnBsYWNlaG9sZGVyLmNvbS8zMDB4MjAwP3RleHQ956S65L6L5aWH54mpJw0KICAgICAgICB9DQogICAgICB9DQogICAgICB0aGlzLiRzdG9yZS5jb21taXQoJ1NFVF9TSE9XX0NBUkRfREVUQUlMJywgdHJ1ZSkNCiAgICB9LA0KICAgIA0KICAgIGhpZGVDYXJkRGV0YWlsKCkgew0KICAgICAgdGhpcy4kc3RvcmUuY29tbWl0KCdTRVRfU0hPV19DQVJEX0RFVEFJTCcsIGZhbHNlKQ0KICAgICAgdGhpcy5zZWxlY3RlZENhcmQgPSBudWxsDQogICAgfSwNCiAgICBzaG93QXJ0aWZhY3REZXRhaWxGcm9tQXVjdGlvbihhcnRpZmFjdCkgew0KICAgICAgdGhpcy5zZWxlY3RlZENhcmQgPSBhcnRpZmFjdA0KICAgICAgdGhpcy4kc3RvcmUuY29tbWl0KCdTRVRfU0hPV19DQVJEX0RFVEFJTCcsIGZhbHNlKQ0KICAgICAgdGhpcy5vcGVuTmFycmF0aW9uKCkNCiAgICB9LA0KICAgIC8vIOiuoeeul+eOqeWutuaAu+S7t+WAvO+8iOaUr+aMgeaJgOacieeOqeWutu+8iQ0KICAgIGdldFBsYXllclRvdGFsVmFsdWUodXNlcklkKSB7DQogICAgICBpZiAoIXVzZXJJZCkgcmV0dXJuIDANCiAgICAgIA0KICAgICAgLy8g5LyY5YWI5LuOIGFsbFBsYXllcnNBcnRpZmFjdHMg6I635Y+W5omA5pyJ546p5a6255qE5omL54mM5pWw5o2uDQogICAgICBsZXQgb3duZWQgPSBbXQ0KICAgICAgaWYgKHRoaXMuYWxsUGxheWVyc0FydGlmYWN0cyAmJiB0aGlzLmFsbFBsYXllcnNBcnRpZmFjdHNbdXNlcklkXSkgew0KICAgICAgICBvd25lZCA9IEFycmF5LmlzQXJyYXkodGhpcy5hbGxQbGF5ZXJzQXJ0aWZhY3RzW3VzZXJJZF0pID8gdGhpcy5hbGxQbGF5ZXJzQXJ0aWZhY3RzW3VzZXJJZF0gOiBbXQ0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgLy8g5Zue6YCA77ya5aaC5p6cIGFsbFBsYXllcnNBcnRpZmFjdHMg5Lit5rKh5pyJ77yM5bCd6K+V5LuO5b2T5YmN546p5a625pWw5o2u6I635Y+WDQogICAgICAgIGNvbnN0IGN1cnJlbnQgPSB0aGlzLiRzdG9yZS5zdGF0ZS5jdXJyZW50UGxheWVyDQogICAgICAgIGlmIChjdXJyZW50ICYmIGN1cnJlbnQuaWQgPT09IHVzZXJJZCkgew0KICAgICAgICAgIG93bmVkID0gQXJyYXkuaXNBcnJheSh0aGlzLiRzdG9yZS5zdGF0ZS5wbGF5ZXJBcnRpZmFjdHMpID8gdGhpcy4kc3RvcmUuc3RhdGUucGxheWVyQXJ0aWZhY3RzIDogW10NCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgDQogICAgICBpZiAoIW93bmVkIHx8IG93bmVkLmxlbmd0aCA9PT0gMCkgcmV0dXJuIDANCiAgICAgIA0KICAgICAgLy8g56Gu5L+dIGFydGlmYWN0TWFwIOW3suWKoOi9vQ0KICAgICAgaWYgKCF0aGlzLmFydGlmYWN0TWFwIHx8IE9iamVjdC5rZXlzKHRoaXMuYXJ0aWZhY3RNYXApLmxlbmd0aCA9PT0gMCkgcmV0dXJuIDANCiAgICAgIA0KICAgICAgbGV0IHRvdGFsID0gMA0KICAgICAgb3duZWQuZm9yRWFjaChhaWQgPT4gew0KICAgICAgICBjb25zdCBhID0gdGhpcy5hcnRpZmFjdE1hcFthaWRdDQogICAgICAgIGlmIChhICYmIHR5cGVvZiBhLmJhc2VWYWx1ZSA9PT0gJ251bWJlcicpIHsNCiAgICAgICAgICB0b3RhbCArPSBhLmJhc2VWYWx1ZQ0KICAgICAgICB9DQogICAgICB9KQ0KICAgICAgcmV0dXJuIHRvdGFsDQogICAgfSwNCg0KICAgIHNob3dQbGF5ZXJIYW5kKHBsYXllcikgew0KICAgICAgLy8g5p6E6YCg546p5a625a+56LGh77yM5YyF5ZCr5omL54mM5L+h5oGvDQogICAgICBjb25zdCBwbGF5ZXJEYXRhID0gew0KICAgICAgICBpZDogcGxheWVyLnVzZXJfaWQsDQogICAgICAgIG5hbWU6IHRoaXMuZ2V0TmFtZUZvcihwbGF5ZXIudXNlcl9pZCksDQogICAgICAgIGFydGlmYWN0czogdGhpcy5jdXJyZW50UGxheWVyICYmIHRoaXMuY3VycmVudFBsYXllci5pZCA9PT0gcGxheWVyLnVzZXJfaWQgPyANCiAgICAgICAgICAodGhpcy5jdXJyZW50UGxheWVyLmFydGlmYWN0cyB8fCBbXSkgOiBbXQ0KICAgICAgfQ0KICAgICAgdGhpcy5oYW5kUGxheWVyID0gcGxheWVyRGF0YQ0KICAgICAgdGhpcy5zaG93SGFuZFBvcHVwID0gdHJ1ZQ0KICAgIH0sDQoNCiAgICBoaWRlSGFuZCgpIHsNCiAgICAgIHRoaXMuaGFuZFBsYXllciA9IG51bGwNCiAgICAgIHRoaXMuc2hvd0hhbmRQb3B1cCA9IGZhbHNlDQogICAgfSwNCiAgICANCiAgICANCiAgICBnZXRBdmF0YXJGb3IodXNlcklkKSB7IHJldHVybiBnZXRBdmF0YXJGb3JIZWxwZXIoeyBwcm9maWxlTWFwOiB0aGlzLnByb2ZpbGVNYXAsIHVzZXJJZCB9KSB9LA0KICAgIGdldE5hbWVGb3IodXNlcklkKSB7IHJldHVybiBnZXROYW1lRm9ySGVscGVyKHsgcHJvZmlsZU1hcDogdGhpcy5wcm9maWxlTWFwLCByb29tOiB0aGlzLnJvb20sIHVzZXJJZCB9KSB9LA0KICAgIGdldEN1cnJlbnRMYW5ndWFnZSgpIHsgcmV0dXJuIGdldEN1cnJlbnRMYW5ndWFnZUltcG9ydGVkKCkgfSwNCiAgICANCiAgICAvLyDliqDovb3mlLbol4/pm4bmlbDmja7vvJrln7rkuo7mlbDmja7lupMgYXJ0aWZhY3RzIOeahCBjb2xsZWN0aW9uX3RhZ3Mg5Yqo5oCB55Sf5oiQDQogICAgYXN5bmMgbG9hZENvbGxlY3Rpb25zKCkgew0KICAgICAgdHJ5IHsgdGhpcy5jb2xsZWN0aW9ucyA9IGxvYWRDb2xsZWN0aW9uc0Zyb21BcnRpZmFjdHModGhpcy5hcnRpZmFjdE1hcCkgfQ0KICAgICAgY2F0Y2ggKGVycm9yKSB7IGNvbnNvbGUuZXJyb3IoJ+WKoOi9veaUtuiXj+mbhuaVsOaNruWksei0pTonLCBlcnJvcik7IHRoaXMuY29sbGVjdGlvbnMgPSBbXSB9DQogICAgfSwNCiAgICANCiAgIA0KICAgIA0KICAgIC8vIOiOt+WPluW9k+WJjeaUtuiXj+mbhuaVsOmHj++8iOWfuuS6juW9k+WJjeeUqOaIt+aJi+eJjO+8jOS4lOWPl+acgOWkp+imgeaxguaVsOS4iumZkOmZkOWItu+8iQ0KICAgIGdldEN1cnJlbnRDb2xsZWN0aW9uQ291bnQoY29sbGVjdGlvbikgew0KICAgICAgY29uc3Qgb3duZWQgPSAodGhpcy5jdXJyZW50UGxheWVyICYmIHRoaXMuY3VycmVudFBsYXllci5hcnRpZmFjdHMpID8gdGhpcy5jdXJyZW50UGxheWVyLmFydGlmYWN0cyA6IFtdDQogICAgICByZXR1cm4gZ2V0Q29sbGVjdGlvbkNvdW50VXRpbCh7IGFydGlmYWN0TWFwOiB0aGlzLmFydGlmYWN0TWFwLCBvd25lZEFydGlmYWN0SWRzOiBvd25lZCwgY29sbGVjdGlvbiB9KQ0KICAgIH0sDQoNCg0KICAgIC8vIOWxleW8gC/mlLbotbfmlLbol4/pm4YNCiAgICB0b2dnbGVDb2xsZWN0aW9uKGNvbGxlY3Rpb24pIHsNCiAgICAgIGNvbnN0IGlkID0gY29sbGVjdGlvbiAmJiBjb2xsZWN0aW9uLmlkDQogICAgICBpZiAoIWlkKSByZXR1cm4NCiAgICAgIHRoaXMuJHNldCh0aGlzLmV4cGFuZGVkQ29sbGVjdGlvbnMsIGlkLCAhdGhpcy5leHBhbmRlZENvbGxlY3Rpb25zW2lkXSkNCiAgICB9LA0KICAgIA0KICAgIC8vIOWFs+mXrea4uOaIj+e7k+adn+Wvueivneahhg0KICAgIGNsb3NlR2FtZUVuZERpYWxvZygpIHsNCiAgICAgIHRoaXMuc2hvd0dhbWVFbmREaWFsb2cgPSBmYWxzZQ0KICAgIH0sDQogICAgDQogICAgLy8g55WZ5Zyo5oi/6Ze0DQogICAgc3RheUluUm9vbSgpIHsNCiAgICAgIHRoaXMuc2hvd0dhbWVFbmREaWFsb2cgPSBmYWxzZQ0KICAgICAgdHJ5IHsgdGhpcy4kc3RvcmUuY29tbWl0KCdDTEVBUl9HQU1FX0xPRycpIH0gY2F0Y2ggKF8pIHt9DQogICAgICAvLyDov5Tlm57lvZPliY3miL/pl7Tlh4blpIfnlYzpnaINCiAgICAgIGNvbnN0IHJpZCA9IHRoaXMuJHN0b3JlLnN0YXRlLnJvb21JZA0KICAgICAgaWYgKHJpZCkgew0KICAgICAgICB0aGlzLiRzdG9yZS5jb21taXQoJ1NFVF9HQU1FX1BIQVNFJywgJ3ByZXBhcmF0aW9uJykNCiAgICAgICAgdGhpcy4kcm91dGVyLnB1c2goeyBwYXRoOiAnL2dhbWUnLCBxdWVyeTogeyByb29tSWQ6IHJpZCB9IH0pDQogICAgICB9DQogICAgfSwNCiAgICANCiAgICAvLyDov5Tlm57miL/pl7TliJfooagNCiAgICBnb1RvUm9vbXMoKSB7DQogICAgICB0aGlzLnNob3dHYW1lRW5kRGlhbG9nID0gZmFsc2UNCiAgICAgIHRoaXMudW5zdWJzY3JpYmVSb29tUmVhbHRpbWUoKQ0KICAgICAgdHJ5IHsgdGhpcy4kc3RvcmUuY29tbWl0KCdDTEVBUl9HQU1FX0xPRycpIH0gY2F0Y2ggKF8pIHt9DQogICAgICAvLyDov5Tlm57lvZPliY3miL/pl7Tlh4blpIfnlYzpnaLvvIjmm7TnrKblkIjmnJ/mnJvvvIkNCiAgICAgIGNvbnN0IHJpZCA9IHRoaXMuJHN0b3JlLnN0YXRlLnJvb21JZA0KICAgICAgaWYgKHJpZCkgew0KICAgICAgICB0aGlzLiRzdG9yZS5jb21taXQoJ1NFVF9HQU1FX1BIQVNFJywgJ3ByZXBhcmF0aW9uJykNCiAgICAgICAgdGhpcy4kcm91dGVyLnB1c2goeyBwYXRoOiAnL2dhbWUnLCBxdWVyeTogeyByb29tSWQ6IHJpZCB9IH0pDQogICAgICB9IGVsc2Ugew0KICAgICAgICB0aGlzLiRyb3V0ZXIucHVzaCgnL3Jvb21zJykNCiAgICAgIH0NCiAgICB9LA0KICAgIA0KICAgIC8vIOaXtumXtOWIsO+8mue7k+adn+W9k+WJjeaJgOacieaLjeWNluW5tue7k+eul+WIsOWvueW6lOeOqeWutuaJi+eJjO+8jOeEtuWQjui/m+WFpTEwc+mXtOath+aIlue7k+adn+a4uOaIjw0KICAgIGFzeW5jIG9uQXVjdGlvblRpbWVVcCgpIHsNCiAgICAgIHRyeSB7DQogICAgICAgIGNvbnN0IGF1Y3Rpb25zID0gdGhpcy4kc3RvcmUuc3RhdGUuY3VycmVudEF1Y3Rpb25zIHx8IFtdDQogICAgICAgIC8vIOe7n+S4gOWAkuiuoeaXtue7k+adn++8mue7k+adn+aJgOacieW9k+WJjeaLjeWNlg0KICAgICAgICBmb3IgKGNvbnN0IGEgb2YgYXVjdGlvbnMpIHsNCiAgICAgICAgICBhd2FpdCB0aGlzLiRzdG9yZS5kaXNwYXRjaCgnZW5kQXVjdGlvbicsIGEuaWQpDQogICAgICAgIH0NCiAgICAgICAgLy8g5Yik5pat5piv5ZCm6L6+5Yiw5oC75Zue5ZCI5pWwDQogICAgICAgIGNvbnN0IGN1ciA9IE51bWJlcih0aGlzLiRzdG9yZS5zdGF0ZS5yb3VuZEN1cnJlbnQgfHwgMCkNCiAgICAgICAgY29uc3QgdG90ID0gTnVtYmVyKHRoaXMuJHN0b3JlLnN0YXRlLnJvdW5kVG90YWwgfHwgNikNCiAgICAgICAgaWYgKGN1ciA+PSB0b3QpIHsNCiAgICAgICAgICAvLyDop6blj5Hnu5PmnZ8NCiAgICAgICAgICB0aGlzLiRzdG9yZS5jb21taXQoJ1NFVF9HQU1FX1BIQVNFJywgJ3NldHRsZW1lbnQnKQ0KICAgICAgICAgIGF3YWl0IHRoaXMuY29tcHV0ZUZpbmFsU2NvcmVzKCkNCiAgICAgICAgICB0aGlzLnNob3dHYW1lRW5kRGlhbG9nID0gdHJ1ZQ0KICAgICAgICAgIHJldHVybg0KICAgICAgICB9DQogICAgICAgIC8vIOWQpuWImei/m+WFpTEwc+mXtOath+mYtuautQ0KICAgICAgICB0aGlzLnN0YXJ0SW50ZXJtaXNzaW9uVGltZXIoMTApDQogICAgICB9IGNhdGNoIChlKSB7IGNvbnNvbGUud2FybignW2dhbWVdIG9uQXVjdGlvblRpbWVVcCBmYWlsZWQnLCBlKSB9DQogICAgfSwNCg0KICAgIC8vIOW8gOWni+aLjeWNluWAkuiuoeaXtu+8mue7n+S4gOavj+i9ruaLjeWNluWPquacieS4gOS4quWAkuiuoeaXtg0KICAgIHN0YXJ0QXVjdGlvblRpbWVyKGR1cmF0aW9uID0gMzApIHsNCiAgICAgIHRoaXMuJHN0b3JlLmNvbW1pdCgnU0VUX0dBTUVfUEhBU0UnLCAnYXVjdGlvbicpDQogICAgICBzdGFydENvdW50ZG93bih7DQogICAgICAgIHNlY29uZHM6IGR1cmF0aW9uLA0KICAgICAgICBvblRpY2s6IChzKSA9PiB7IHRoaXMuJHNldCh0aGlzLCAnYXVjdGlvbkNvdW50ZG93bicsIHMpOyB9LA0KICAgICAgICBvbkRvbmU6IGFzeW5jICgpID0+IHsgYXdhaXQgdGhpcy5vbkF1Y3Rpb25UaW1lVXAoKSB9LA0KICAgICAgICBnZXRSZWY6ICgpID0+IHRoaXMuYXVjdGlvblRpbWVyLA0KICAgICAgICBzZXRSZWY6IChpZCkgPT4geyB0aGlzLmF1Y3Rpb25UaW1lciA9IGlkIH0sDQogICAgICB9KQ0KICAgIH0sDQoNCg0KICAgIA0KICAgIC8vIOavj+i9ruS5i+mXtOeahOmXtOath+iuoeaXtuWZqO+8jOe7k+adn+WQjuiHquWKqOW8gOWni+S4i+S4gOi9ruaLjeWNlg0KICAgIHN0YXJ0SW50ZXJtaXNzaW9uVGltZXIoZHVyYXRpb24gPSAxMCkgew0KICAgICAgdGhpcy4kc3RvcmUuY29tbWl0KCdTRVRfR0FNRV9QSEFTRScsICdpbnRlcm1pc3Npb24nKQ0KICAgICAgc3RhcnRDb3VudGRvd24oew0KICAgICAgICBzZWNvbmRzOiBkdXJhdGlvbiwNCiAgICAgICAgb25UaWNrOiAocykgPT4geyB0aGlzLiRzZXQodGhpcywgJ2F1Y3Rpb25Db3VudGRvd24nLCBzKTsgfSwNCiAgICAgICAgb25Eb25lOiBhc3luYyAoKSA9PiB7DQogICAgICAgICAgaWYgKHRoaXMuaXNPd25lcikgew0KICAgICAgICAgICAgYXdhaXQgdGhpcy5hdXRvU3RhcnRBdWN0aW9uKCkNCiAgICAgICAgICB9DQogICAgICAgIH0sDQogICAgICAgIGdldFJlZjogKCkgPT4gdGhpcy5hdWN0aW9uVGltZXIsDQogICAgICAgIHNldFJlZjogKGlkKSA9PiB7IHRoaXMuYXVjdGlvblRpbWVyID0gaWQgfSwNCiAgICAgIH0pDQogICAgfSwNCiAgICANCiAgICAvLyDoh6rliqjlvIDlp4vmi43ljZYNCiAgICBhc3luYyBhdXRvU3RhcnRBdWN0aW9uKCkgew0KICAgICAgdHJ5IHsNCiAgICAgICAgY29uc3QgcmlkID0gdGhpcy4kc3RvcmUuc3RhdGUucm9vbUlkDQogICAgICAgIGNvbnN0IHN1cGFiYXNlID0gZ2V0U3VwYWJhc2UoKQ0KICAgICAgICBhd2FpdCBhdXRvU3RhcnRBdWN0aW9uRmxvdyh7DQogICAgICAgICAgcm9vbUlkOiByaWQsDQogICAgICAgICAgc3RvcmU6IHRoaXMuJHN0b3JlLA0KICAgICAgICAgIHN1cGFiYXNlLA0KICAgICAgICAgIGxvYWRBcnRpZmFjdHM6ICgpID0+IHRoaXMubG9hZEFydGlmYWN0cygpLA0KICAgICAgICAgIGRpc3BhdGNoU3RhcnRBdWN0aW9uOiAoYXJ0KSA9PiB0aGlzLiRzdG9yZS5kaXNwYXRjaCgnc3RhcnRBdWN0aW9uJywgYXJ0KSwNCiAgICAgICAgICBzdGFydEF1Y3Rpb25UaW1lcjogKHNlYykgPT4gdGhpcy5zdGFydEF1Y3Rpb25UaW1lcihzZWMpLA0KICAgICAgICAgIHJvdW5kQ291bnQ6IHRoaXMucm91bmRDb3VudCwNCiAgICAgICAgICB0b3RhbFJvdW5kczogdGhpcy50b3RhbFJvdW5kcywNCiAgICAgICAgICBzZXRSb3VuZENvdW50OiAobikgPT4geyB0aGlzLnJvdW5kQ291bnQgPSBuIH0sDQogICAgICAgIH0pDQogICAgICB9IGNhdGNoIChlKSB7IGNvbnNvbGUud2FybignW2dhbWVdIGF1dG9TdGFydEF1Y3Rpb24gZmFpbGVkJywgZSkgfQ0KICAgIH0sDQogICAgDQogICAgLy8g5Y+R6YCB6IGK5aSp5raI5oGvDQogICAgYXN5bmMgc2VuZE1lc3NhZ2UoKSB7DQogICAgICBpZiAoIXRoaXMubmV3TWVzc2FnZS50cmltKCkgfHwgIXRoaXMudXNlcikgcmV0dXJuDQogICAgICBjb25zdCBtZXNzYWdlID0geyANCiAgICAgICAgaWQ6IERhdGUubm93KCksIA0KICAgICAgICB1c2VySWQ6IHRoaXMudXNlci5pZCwgDQogICAgICAgIHVzZXJuYW1lOiB0aGlzLmdldE5hbWVGb3IodGhpcy51c2VyLmlkKSwgDQogICAgICAgIGNvbnRlbnQ6IHRoaXMubmV3TWVzc2FnZS50cmltKCksIA0KICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCkgDQogICAgICB9DQogICAgICAvLyDmnKzlnLDnq4vljbPmmL7npLrvvIzmj5DkvpvljbPml7blj43ppogNCiAgICAgIHRoaXMuY2hhdE1lc3NhZ2VzLnB1c2gobWVzc2FnZSkNCiAgICAgIHRoaXMubmV3TWVzc2FnZSA9ICcnDQogICAgICANCiAgICAgIC8vIOa7muWKqOWIsOW6lemDqA0KICAgICAgdGhpcy4kbmV4dFRpY2soKCkgPT4gew0KICAgICAgICBjb25zdCBjaGF0Q29udGFpbmVyID0gdGhpcy4kcmVmcy5jaGF0Q29udGFpbmVyDQogICAgICAgIGlmIChjaGF0Q29udGFpbmVyKSB7IGNoYXRDb250YWluZXIuc2Nyb2xsVG9wID0gY2hhdENvbnRhaW5lci5zY3JvbGxIZWlnaHQgfQ0KICAgICAgfSkNCiAgICAgIA0KICAgICAgLy8g5Y+R6YCB5Yiw5pyN5Yqh5Zmo77yM5bm/5pKt57uZ5omA5pyJ546p5a62DQogICAgICBjb25zdCByaWQgPSB0aGlzLiRzdG9yZS5zdGF0ZS5yb29tSWQNCiAgICAgIGlmIChyaWQpIHsgDQogICAgICAgIHRyeSB7IA0KICAgICAgICAgIGNvbnN0IHN1cGFiYXNlID0gZ2V0U3VwYWJhc2UoKQ0KICAgICAgICAgIGF3YWl0IHNlbmRDaGF0TWVzc2FnZSh7IHN1cGFiYXNlLCByb29tSWQ6IHJpZCwgbWVzc2FnZSB9KSANCiAgICAgICAgfSBjYXRjaCAoZSkgeyANCiAgICAgICAgICBjb25zb2xlLndhcm4oJ1tnYW1lXSBzZW5kTWVzc2FnZSBmYWlsZWQnLCBlKQ0KICAgICAgICAgIC8vIOWPkemAgeWksei0peaXtu+8jOWPr+S7pemAieaLqeenu+mZpOacrOWcsOa2iOaBr+aIluS/neeVme+8iOS/neeVmeaPkOS+m+abtOWlveeahOeUqOaIt+S9k+mqjO+8iQ0KICAgICAgICB9IA0KICAgICAgfQ0KICAgIH0sDQogICAgDQogICAgLy8g5qC85byP5YyW5raI5oGv5pe26Ze0DQogICAgZm9ybWF0TWVzc2FnZVRpbWUodGltZXN0YW1wKSB7IHJldHVybiBmb3JtYXRNZXNzYWdlVGltZUhlbHBlcih0aW1lc3RhbXApIH0NCiAgICAsDQoNCiAgICAvLyDorqHnrpfmnIDnu4jlvpfliIblubbnoa7lrprotaLlrrYNCiAgICBhc3luYyBjb21wdXRlRmluYWxTY29yZXMoKSB7DQogICAgICB0cnkgew0KICAgICAgICBjb25zdCByaWQgPSB0aGlzLiRzdG9yZS5zdGF0ZS5yb29tSWQNCiAgICAgICAgaWYgKCFyaWQpIHJldHVybg0KICAgICAgICBjb25zdCBzdXBhYmFzZSA9IGdldFN1cGFiYXNlKCkNCiAgICAgICAgY29uc3QgeyBkYXRhOiByb3dzIH0gPSBhd2FpdCBzdXBhYmFzZQ0KICAgICAgICAgIC5mcm9tKCdyb29tX2FydGlmYWN0cycpDQogICAgICAgICAgLnNlbGVjdCgnb3duZXJfdXNlcl9pZCwgYXJ0aWZhY3RfaWQnKQ0KICAgICAgICAgIC5lcSgncm9vbV9pZCcsIHJpZCkNCiAgICAgICAgY29uc3QgdXNlclRvQXJ0aWZhY3RzID0ge30NCiAgICAgICAgOyhyb3dzIHx8IFtdKS5mb3JFYWNoKHIgPT4gew0KICAgICAgICAgIGlmICghdXNlclRvQXJ0aWZhY3RzW3Iub3duZXJfdXNlcl9pZF0pIHVzZXJUb0FydGlmYWN0c1tyLm93bmVyX3VzZXJfaWRdID0gW10NCiAgICAgICAgICB1c2VyVG9BcnRpZmFjdHNbci5vd25lcl91c2VyX2lkXS5wdXNoKHIuYXJ0aWZhY3RfaWQpDQogICAgICAgIH0pDQoNCiAgICAgICAgY29uc3QgY29sbGVjdGlvbnMgPSBBcnJheS5pc0FycmF5KHRoaXMuY29sbGVjdGlvbnMpID8gdGhpcy5jb2xsZWN0aW9ucyA6IFtdDQogICAgICAgIGNvbnN0IHNjb3JlcyA9IE9iamVjdC5rZXlzKHVzZXJUb0FydGlmYWN0cykubWFwKHVpZCA9PiB7DQogICAgICAgICAgY29uc3Qgb3duZWQgPSB1c2VyVG9BcnRpZmFjdHNbdWlkXQ0KICAgICAgICAgIC8vIOaUtuiXj+mbhuWIhuaVsA0KICAgICAgICAgIGxldCBjb2xsZWN0aW9uU2NvcmUgPSAwDQogICAgICAgICAgY29sbGVjdGlvbnMuZm9yRWFjaChjb2wgPT4gew0KICAgICAgICAgICAgY29uc3QgY3VycmVudCA9IGdldENvbGxlY3Rpb25Db3VudFV0aWwoeyBhcnRpZmFjdE1hcDogdGhpcy5hcnRpZmFjdE1hcCwgb3duZWRBcnRpZmFjdElkczogb3duZWQsIGNvbGxlY3Rpb246IGNvbCB9KQ0KICAgICAgICAgICAgaWYgKGN1cnJlbnQgPj0gKGNvbC5yZXF1aXJlZENvdW50IHx8IDEpKSBjb2xsZWN0aW9uU2NvcmUgKz0gKGNvbC5yZXdhcmRQb2ludHMgfHwgMCkNCiAgICAgICAgICB9KQ0KICAgICAgICAgIC8vIOmbtuaVo+Wlh+eJqeWIhuaVsO+8iOWfuuehgOS7t+WAvOS4gOWNiu+8jOWQkeS4i+WPluaVtO+8iQ0KICAgICAgICAgIGxldCBhcnRpZmFjdFNjb3JlID0gMA0KICAgICAgICAgIG93bmVkLmZvckVhY2goYWlkID0+IHsNCiAgICAgICAgICAgIGNvbnN0IGEgPSB0aGlzLmFydGlmYWN0TWFwW2FpZF0NCiAgICAgICAgICAgIGlmIChhICYmIHR5cGVvZiBhLmJhc2VWYWx1ZSA9PT0gJ251bWJlcicpIGFydGlmYWN0U2NvcmUgKz0gTWF0aC5mbG9vcihhLmJhc2VWYWx1ZSAvIDIpDQogICAgICAgICAgfSkNCiAgICAgICAgDQogICAgICAgICAgY29uc3QgdG90YWwgPSBjb2xsZWN0aW9uU2NvcmUgKyBhcnRpZmFjdFNjb3JlDQogICAgICAgICAgcmV0dXJuIHsNCiAgICAgICAgICAgIHVzZXJJZDogdWlkLA0KICAgICAgICAgICAgbmFtZTogdGhpcy5nZXROYW1lRm9yKHVpZCksDQogICAgICAgICAgICBhdmF0YXI6IHRoaXMuZ2V0QXZhdGFyRm9yKHVpZCksDQogICAgICAgICAgICBjb2xsZWN0aW9uU2NvcmUsDQogICAgICAgICAgICBhcnRpZmFjdFNjb3JlLA0KICAgICAgICAgICAgdG90YWwNCiAgICAgICAgICB9DQogICAgICAgIH0pDQoNCiAgICAgICAgY29uc3Qgc29ydGVkID0gc2NvcmVzLnNvcnQoKGEsIGIpID0+IGIudG90YWwgLSBhLnRvdGFsKQ0KICAgICAgICB0aGlzLmZpbmFsU2NvcmVzID0gc29ydGVkDQogICAgICAgIHRoaXMud2lubmVySW5mbyA9IHNvcnRlZFswXSB8fCBudWxsDQoNCiAgICAgICAgaWYgKHRoaXMud2lubmVySW5mbykgew0KICAgICAgICAgIHRoaXMuJHN0b3JlLmNvbW1pdCgnQUREX0dBTUVfTE9HJywgeyB0aW1lc3RhbXA6IERhdGUubm93KCksIG1lc3NhZ2U6IGDmnKzlsYDnu5PmnZ/vvIzog5zogIXvvJoke3RoaXMud2lubmVySW5mby5uYW1lfe+8iOaAu+WIhiAke3RoaXMud2lubmVySW5mby50b3RhbH3vvIlgIH0pDQogICAgICAgIH0NCiAgICAgIH0gY2F0Y2ggKGUpIHsgY29uc29sZS53YXJuKCdbZ2FtZV0gY29tcHV0ZUZpbmFsU2NvcmVzIGZhaWxlZCcsIGUpIH0NCiAgICB9LA0KDQogICAgLy8g5byA5ZCvL+WFs+mXreaWh+eJqeiusui/sA0KICAgIG9wZW5OYXJyYXRpb24oKSB7DQogICAgICAvLyDmnoTpgKDorrLov7DmlofmnKzvvIzljIXlkKvln7rmnKzku4vnu40gKyDmlYXkuosNCiAgICAgIGNvbnN0IGJhc2UgPSBgJHt0aGlzLnNlbGVjdGVkQ2FyZC5uYW1lfe+8jOadpeiHqiAke3RoaXMuc2VsZWN0ZWRDYXJkLmVyYX0ke3RoaXMuc2VsZWN0ZWRDYXJkLmxvY2F0aW9uID8gJyDCtyAnICsgdGhpcy5zZWxlY3RlZENhcmQubG9jYXRpb24gOiAnJ33jgIJcbmANCiAgICAgIGNvbnN0IHN0b3J5ID0gKHRoaXMuc2VsZWN0ZWRDYXJkLnN0b3J5IHx8ICcnKS50cmltKCkNCiAgICAgIGNvbnN0IGZ1bGwgPSBgJHtiYXNlfSR7c3Rvcnl9YC50cmltKCkNCiAgICAgIC8vIOaJk+Wtl+acuuaViOaenA0KICAgICAgdGhpcy50eXBpbmdUZXh0ID0gJycNCiAgICAgIHRoaXMuc2hvd05hcnJhdGlvbiA9IHRydWUNCiAgICAgIGNvbnN0IHNwZWVkID0gKGZpcnN0TG9naW5EaWFsb2d1ZUNvbmZpZyAmJiBmaXJzdExvZ2luRGlhbG9ndWVDb25maWcuYW5pbWF0aW9ucyAmJiBmaXJzdExvZ2luRGlhbG9ndWVDb25maWcuYW5pbWF0aW9ucy50ZXh0VHlwaW5nU3BlZWQpIHx8IDMwDQogICAgICBpZiAodGhpcy50eXBpbmdUaW1lcikgeyBjbGVhckludGVydmFsKHRoaXMudHlwaW5nVGltZXIpOyB0aGlzLnR5cGluZ1RpbWVyID0gbnVsbCB9DQogICAgICBsZXQgaSA9IDANCiAgICAgIHRoaXMudHlwaW5nVGltZXIgPSBzZXRJbnRlcnZhbCgoKSA9PiB7DQogICAgICAgIGlmIChpID49IGZ1bGwubGVuZ3RoKSB7DQogICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLnR5cGluZ1RpbWVyKQ0KICAgICAgICAgIHRoaXMudHlwaW5nVGltZXIgPSBudWxsDQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgdGhpcy50eXBpbmdUZXh0ICs9IGZ1bGxbaV0NCiAgICAgICAgICBpICs9IDENCiAgICAgICAgfQ0KICAgICAgfSwgc3BlZWQpDQogICAgfSwNCiAgICBjbG9zZU5hcnJhdGlvbigpIHsNCiAgICAgIGlmICh0aGlzLnR5cGluZ1RpbWVyKSB7IGNsZWFySW50ZXJ2YWwodGhpcy50eXBpbmdUaW1lcik7IHRoaXMudHlwaW5nVGltZXIgPSBudWxsIH0NCiAgICAgIHRoaXMuc2hvd05hcnJhdGlvbiA9IGZhbHNlDQogICAgICB0aGlzLnR5cGluZ1RleHQgPSAnJw0KICAgIH0NCiAgfQ0KfQ0K"},{"version":3,"sources":["index.vue"],"names":[],"mappings":";AAsZA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;;AAGA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;;;AAIA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"index.vue","sourceRoot":"src/pages/index","sourcesContent":["<template>\r\n  <div class=\"game-container\" :class=\"{ 'post-start': gamePhase !== 'preparation' }\">\r\n    <!-- 顶部状态栏：品牌/用户信息/导航控制（登录、个人中心、准备/开始/商店/退出） -->\r\n    <div class=\"top-auth-bar\">\r\n      <div class=\"left\">\r\n        <span class=\"brand\">时空旅人拍卖会</span>\r\n      </div>\r\n      <div class=\"right\" v-if=\"user\">\r\n        <span class=\"user-email\">{{ user.email }}</span>\r\n        <!-- 音乐控制按钮 -->\r\n        <button class=\"nav-button music-control\" @click=\"toggleMusic\" :class=\"{ 'music-playing': isMusicPlaying }\">\r\n          <span class=\"music-icon\">{{ isMusicPlaying ? '🔊' : '🔇' }}</span>\r\n          <span class=\"music-text\">{{ isMusicPlaying ? '音乐' : '静音' }}</span>\r\n        </button>\r\n        <button class=\"nav-button\" @click=\"$router.push('/profile')\">个人中心</button>\r\n      </div>\r\n      <div class=\"right\" v-else>\r\n        <button class=\"nav-button primary\" @click=\"$router.push('/login')\">登录 / 注册</button>\r\n      </div>\r\n    </div>\r\n\r\n    <div class=\"game-status\">\r\n      <div class=\"room-info\">\r\n        <div class=\"room-name\">{{ room ? (room.name || '未命名房间') : '未加入房间' }}</div>\r\n        <div class=\"room-meta\" v-if=\"room\">玩家 {{ playerCount }}/{{ seatCount }} · 房主：{{ ownerName }}</div>\r\n        <div class=\"room-id-pill\">ID: {{ room ? (room.short_id || room.id) : '-' }}</div>\r\n      </div>\r\n      <span class=\"game-phase\">{{ gamePhaseText }}</span>\r\n      <div class=\"game-controls\">\r\n        <button class=\"control-button\" @click=\"toggleReady\" v-if=\"gamePhase === 'preparation'\">{{ currentUserReady ? '取消准备' : '准备' }}</button>\r\n        <button class=\"control-button\" @click=\"startGame\" v-if=\"gamePhase === 'preparation' && isOwner && allReady\">开始游戏</button>\r\n        <button class=\"control-button\" @click=\"startAuction\" v-if=\"false\">开始拍卖</button>\r\n        <button class=\"control-button danger\" @click=\"leaveRoom\">退出房间</button>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- 玩家头像区域：展示房间玩家，点击头像可查看该玩家手牌（当前仅展示自己的手牌明细） -->\r\n    <div class=\"players-avatars\" v-if=\"playerCount > 0 && gamePhase !== 'preparation'\">\r\n      <div class=\"avatar-item\" v-for=\"p in (room ? room.room_players : [])\" :key=\"p.user_id\" @click=\"showPlayerHand(p)\">\r\n        <div class=\"avatar-wrap\">\r\n          <img class=\"player-avatar\" :src=\"getAvatarFor(p.user_id)\" />\r\n          <span class=\"ready-indicator\" :class=\"{ on: !!p.is_ready }\"></span>\r\n        </div>\r\n        <div class=\"player-name\">{{ getNameFor(p.user_id) }}</div>\r\n        <div class=\"player-value\">价值 {{ getPlayerTotalValue(p.user_id) }}</div>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- 拍卖舞台：在不同的 gamePhase 下显示倒计时/间歇/拍卖面板或占位提示 -->\r\n    <div class=\"auction-stage\" :class=\"{ 'align-left': gamePhase === 'auction' }\">\r\n      <!-- 预倒计时阶段（游戏开始后5s预热） -->\r\n      <template v-if=\"gamePhase === 'countdown'\">\r\n        <div class=\"countdown-stage\">\r\n          <div class=\"countdown-content\">\r\n            <div class=\"countdown-icon\">⏳</div>\r\n            <div class=\"countdown-title\">游戏即将开始</div>\r\n            <div class=\"countdown-timer\">{{ auctionCountdown }}s</div>\r\n            <div class=\"countdown-subtitle\">请稍候，拍卖即将开始...</div>\r\n          </div>\r\n        </div>\r\n      </template>\r\n            <!-- 间歇阶段（每轮结束后的休息时间） -->\r\n      <template v-else-if=\"gamePhase === 'intermission'\">\r\n        <div class=\"countdown-stage\">\r\n          <div class=\"countdown-content\">\r\n            <div class=\"countdown-icon\">🧭</div>\r\n            <div class=\"countdown-title\">间歇中</div>\r\n            <div class=\"countdown-timer\">{{ auctionCountdown }}s</div>\r\n            <div class=\"countdown-subtitle\">请稍候，下一轮拍卖即将开始...</div>\r\n          </div>\r\n        </div>\r\n      </template>\r\n      \r\n      <!-- 拍卖阶段：展示拍卖面板（当前拍品列表、轮次信息、点击卡片触发讲述） -->\r\n      <auction-panel \r\n        v-else-if=\"gamePhase === 'auction' && $store.state.currentAuctions && $store.state.currentAuctions.length\" \r\n        :auctions=\"$store.state.currentAuctions\" \r\n        :countdown=\"auctionCountdown\"\r\n        :round-current=\"$store.state.roundCurrent\"\r\n        :round-total=\"$store.state.roundTotal\"\r\n        @artifact-click=\"showArtifactDetailFromAuction\" \r\n      />\r\n      <!-- 准备阶段：显示文物照片自动滑动展示 -->\r\n      <div v-else-if=\"gamePhase === 'preparation'\" class=\"preparation-stage\">\r\n        <div class=\"artifact-carousel-container\">\r\n          <div class=\"carousel-header\">\r\n            <h3 class=\"carousel-title\">时空珍宝预览</h3>\r\n            <p class=\"carousel-subtitle\">准备阶段 - 即将拍卖的珍贵文物</p>\r\n          </div>\r\n          \r\n          <div class=\"artifact-carousel\">\r\n            <div class=\"carousel-track\" :style=\"{ transform: `translateX(-${currentSlide * 100}%)` }\">\r\n              <div \r\n                v-for=\"(artifact, index) in artifactCarouselData\" \r\n                :key=\"index\" \r\n                class=\"carousel-slide\"\r\n              >\r\n                <div class=\"artifact-slide-content\">\r\n                  <div class=\"artifact-image-container\">\r\n                    <img \r\n                      class=\"artifact-image\" \r\n                      :src=\"artifact.image || 'https://via.placeholder.com/400x300?text=文物预览'\" \r\n                      :alt=\"artifact.name\"\r\n                      @error=\"handleImageError(artifact)\"\r\n                    />\r\n                    <div class=\"artifact-overlay\"></div>\r\n                  </div>\r\n                  <div class=\"artifact-info\">\r\n                    <h4 class=\"artifact-name\">{{ artifact.name || '未知文物' }}</h4>\r\n                    <div class=\"artifact-meta\">\r\n                      <span class=\"artifact-era\" v-if=\"artifact.era\">{{ artifact.era }}</span>\r\n                      <span class=\"artifact-location\" v-if=\"artifact.location\">{{ artifact.location }}</span>\r\n                    </div>\r\n                    <p class=\"artifact-value\" v-if=\"artifact.baseValue !== undefined\">\r\n                      基础价值: {{ artifact.baseValue }} ⚡\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n            \r\n            <!-- 轮播控制按钮 -->\r\n            <button class=\"carousel-nav carousel-prev\" @click=\"prevSlide\">\r\n              <span>‹</span>\r\n            </button>\r\n            <button class=\"carousel-nav carousel-next\" @click=\"nextSlide\">\r\n              <span>›</span>\r\n            </button>\r\n            \r\n            <!-- 轮播指示器 -->\r\n            <div class=\"carousel-indicators\">\r\n              <span \r\n                v-for=\"(artifact, index) in (artifactCarouselData || []).slice(0, 5)\" \r\n                :key=\"index\" \r\n                class=\"indicator-dot\"\r\n                :class=\"{ active: artifactCarouselData && artifactCarouselData.length > 0 && currentSlide % artifactCarouselData.length === index }\"\r\n                @click=\"goToSlide(index)\"\r\n              ></span>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n      <!-- 其他情况显示占位提示 -->\r\n      <div v-else class=\"stage-placeholder\">拍卖会台空闲，等待新一轮拍卖</div>\r\n    </div>\r\n\r\n    <!-- 房间座位区（准备阶段）：点击空位入座，已入座玩家显示头像与准备标记 -->\r\n    <div class=\"seats\" v-if=\"seatCount > 0 && gamePhase === 'preparation'\" :style=\"{ gridTemplateColumns: 'repeat(' + seatCount + ', 1fr)' }\">\r\n      <div class=\"seat\" v-for=\"(seat, idx) in seats\" :key=\"idx\" :class=\"{ occupied: !!seat.player }\" @click=\"moveToSeat(idx)\">\r\n        <div class=\"seat-index\">{{ idx + 1 }}/{{ seatCount }}</div>\r\n        <div class=\"seat-body\">\r\n          <div v-if=\"seat.player\" class=\"seat-player\">\r\n            <div class=\"avatar-wrap\">\r\n              <img class=\"seat-avatar\" :src=\"getAvatarFor(seat.player.user_id)\" />\r\n              <span v-if=\"seat.player.is_ready\" class=\"ready-badge\">✓</span>\r\n            </div>\r\n            <div class=\"seat-name\">{{ getNameFor(seat.player.user_id) }}</div>\r\n          </div>\r\n          <div v-else class=\"seat-empty\">空位</div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- 当前玩家手牌：展示自己已拥有的奇物，点击查看详情（或触发讲述） -->\r\n    <div class=\"my-hand\" v-if=\"gamePhase !== 'preparation'\">\r\n      <h3 class=\"hand-title\">我的手牌</h3>\r\n      <div class=\"hand-grid\">\r\n        <div\r\n          v-for=\"(aid, idx) in (currentPlayer ? currentPlayer.artifacts : [])\"\r\n          :key=\"aid + '-' + idx\"\r\n          class=\"hand-card fancy\"\r\n          @click=\"showArtifactDetail(aid)\"\r\n        >\r\n          <div class=\"hand-media\">\r\n            <img\r\n              class=\"hand-image\"\r\n              :src=\"artifactMap[aid] ? artifactMap[aid].image : 'https://via.placeholder.com/160x100?text=未知卡牌'\"\r\n            />\r\n            <div class=\"hand-overlay\"></div>\r\n          </div>\r\n          <div class=\"hand-info\">\r\n            <div class=\"hand-name\" :title=\"artifactMap[aid] ? artifactMap[aid].name : aid\">\r\n              {{ artifactMap[aid] ? artifactMap[aid].name : aid }}\r\n            </div>\r\n            <div class=\"hand-era\" v-if=\"artifactMap[aid] && (artifactMap[aid].era || artifactMap[aid].location)\">\r\n              {{ artifactMap[aid].era }}<span v-if=\"artifactMap[aid].location\"> · {{ artifactMap[aid].location }}</span>\r\n            </div>\r\n            <div class=\"hand-tags\" v-if=\"artifactMap[aid] && artifactMap[aid].collectionTags && artifactMap[aid].collectionTags.length\">\r\n              <span\r\n                class=\"hand-tag\"\r\n                v-for=\"tag in artifactMap[aid].collectionTags.slice(0,2)\"\r\n                :key=\"tag\"\r\n              >{{ tag }}</span>\r\n              <span class=\"hand-tag more\" v-if=\"artifactMap[aid].collectionTags.length > 2\">+{{ artifactMap[aid].collectionTags.length - 2 }}</span>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- 收藏集进度：仅展示与自己已拥有奇物相关的收藏集，支持展开查看成员清单 -->\r\n    <div class=\"collections-panel\" v-if=\"gamePhase !== 'preparation'\">\r\n      <div class=\"collections-section\">\r\n        <h4 class=\"collections-title\">收藏集进度</h4>\r\n        <div class=\"collections-list\">\r\n          <div \r\n            v-for=\"collection in collectionsComputed\" \r\n            :key=\"collection.id\"\r\n            class=\"collection-progress-item\"\r\n            :class=\"{ completed: collection._current >= collection.requiredCount }\"\r\n          >\r\n            <div class=\"collection-header\" @click=\"toggleCollection(collection)\">\r\n              <div class=\"collection-icon\">🏆</div>\r\n              <div class=\"collection-info\">\r\n                <div class=\"collection-name\">{{ collection.name }}</div>\r\n                <div class=\"collection-description\">{{ collection.description }}</div>\r\n              </div>\r\n              <div class=\"collection-reward\" v-if=\"collection._current >= collection.requiredCount\">\r\n                <span class=\"reward-badge\">✓</span>\r\n              </div>\r\n            </div>\r\n            <!-- 展开展示该收藏集所需所有商品 -->\r\n            <div class=\"collection-members\" v-if=\"expandedCollections[collection.id]\">\r\n              <div class=\"member-item\" v-for=\"aid in (collection.artifactIds || [])\" :key=\"aid\">\r\n                <img class=\"member-image\" :src=\"artifactMap[aid] ? artifactMap[aid].image : 'https://via.placeholder.com/60x40?text=No+Img'\" />\r\n                <div class=\"member-info\">\r\n                  <div class=\"member-name\">{{ artifactMap[aid] ? artifactMap[aid].name : aid }}</div>\r\n                  <div class=\"member-meta\">{{ artifactMap[aid] && artifactMap[aid].era }}<span v-if=\"artifactMap[aid] && artifactMap[aid].location\"> · {{ artifactMap[aid].location }}</span></div>\r\n                </div>\r\n                <div class=\"member-status\" :class=\"{ owned: currentPlayer && currentPlayer.artifacts && currentPlayer.artifacts.includes(aid) }\">\r\n                  {{ currentPlayer && currentPlayer.artifacts && currentPlayer.artifacts.includes(aid) ? '已拥有' : '未拥有' }}\r\n                </div>\r\n              </div>\r\n            </div>\r\n            <div class=\"progress-container\">\r\n              <div class=\"progress-bar\">\r\n                <div \r\n                  class=\"progress-fill\"\r\n                  :style=\"{ width: collection._progress + '%' }\"\r\n                ></div>\r\n              </div>\r\n              <div class=\"progress-text\">\r\n                {{ collection._current }}/{{ collection.requiredCount }}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- 聊天/日志面板：合并系统日志与聊天消息为统一时间序信息流 -->\r\n    <div class=\"chat-panel\" v-if=\"gamePhase !== 'preparation'\">\r\n      <div class=\"chat-header\">\r\n        <h4 class=\"chat-title\">聊天 / 日志</h4>\r\n        <div class=\"chat-status\">\r\n          <span class=\"status-dot\"></span>\r\n          <span class=\"status-text\">在线</span>\r\n        </div>\r\n      </div>\r\n      \r\n      <div class=\"chat-messages\" ref=\"chatContainer\">\r\n        <div \r\n          v-for=\"message in chatFeed\" \r\n          :key=\"message.id\"\r\n          class=\"chat-message\"\r\n          :class=\"{ 'own-message': message.type === 'chat' && message.userId === (user && user.id), 'system-log': message.type === 'log' }\"\r\n        >\r\n          <div class=\"message-header\">\r\n            <span class=\"message-username\">{{ message.type === 'log' ? '系统' : message.username }}</span>\r\n            <span class=\"message-time\">{{ formatMessageTime(message.timestamp) }}</span>\r\n          </div>\r\n          <div class=\"message-content\">{{ message.content }}</div>\r\n        </div>\r\n      </div>\r\n      \r\n      <div class=\"chat-input\">\r\n        <input \r\n          v-model=\"newMessage\"\r\n          @keyup.enter=\"sendMessage\"\r\n          placeholder=\"输入消息...\"\r\n          class=\"message-input\"\r\n        />\r\n        <button @click=\"sendMessage\" class=\"send-button\" :disabled=\"!newMessage.trim()\">\r\n          <span class=\"send-icon\">📤</span>\r\n        </button>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- 卡牌详情弹窗：展示所选奇物的核心信息与标签 -->\r\n    <div v-if=\"showCardDetail\" class=\"card-detail-popup\">\r\n      <div class=\"popup-overlay\" @click=\"hideCardDetail\"></div>\r\n      <div class=\"popup-content\" v-if=\"selectedCard\">\r\n        <img \r\n          class=\"detail-image\" \r\n          :src=\"selectedCard.image\" \r\n          alt=\"奇物图片\"\r\n        />\r\n        <div class=\"detail-content\">\r\n          <h3 class=\"detail-name\">{{ selectedCard.name }}</h3>\r\n          <p class=\"detail-era\">{{ selectedCard.era }} - {{ selectedCard.location }}</p>\r\n          <p class=\"detail-story\">{{ selectedCard.story }}</p>\r\n          <div class=\"detail-tags\">\r\n            <span \r\n              v-for=\"tag in selectedCard.collectionTags\" \r\n              :key=\"tag\"\r\n              class=\"detail-tag\"\r\n            >\r\n              {{ tag }}\r\n            </span>\r\n          </div>\r\n          <p class=\"detail-value\">基础价值: {{ selectedCard.baseValue }}</p>\r\n            \r\n        </div>\r\n        <button class=\"close-button\" @click=\"hideCardDetail\">关闭</button>\r\n      </div>\r\n    </div>\r\n\r\n      <!-- 文物讲述弹层：以角色对白形式讲述 selectedCard 的关键信息 -->\r\n      <div v-if=\"showNarration && selectedCard\" class=\"narration-popup\">\r\n        <div class=\"popup-overlay\" @click=\"closeNarration\"></div>\r\n        <div class=\"popup-content narration-content\">\r\n          <!-- 顶部：文物大图与快速元信息，图片下方显示名称 -->\r\n          <div class=\"artifact-media\" v-if=\"selectedCard\">\r\n            <img class=\"artifact-image-large\" :src=\"selectedCard.image || 'https://via.placeholder.com/800x240?text=Artifact'\" alt=\"artifact\" />\r\n            <div class=\"artifact-quick-meta\">\r\n              <span class=\"badge era\" v-if=\"selectedCard.era\">{{ selectedCard.era }}</span>\r\n              <span class=\"badge location\" v-if=\"selectedCard.location\">{{ selectedCard.location }}</span>\r\n              <span class=\"badge value\" v-if=\"selectedCard.baseValue !== undefined\">价值 {{ selectedCard.baseValue }}</span>\r\n              <span class=\"badge tags\" v-if=\"(selectedCard.collectionTags || []).length\">{{ (selectedCard.collectionTags || []).slice(0,3).join('、') }}</span>\r\n            </div>\r\n          </div>\r\n          <div class=\"artifact-caption\" v-if=\"selectedCard && selectedCard.name\">{{ selectedCard.name }}</div>\r\n\r\n          <!-- 下方：人物与对白一行排列 -->\r\n          <div class=\"narration-dialog\">\r\n            <!-- 左侧：角色大图与姓名 -->\r\n            <div class=\"character-side\" :style=\"{ borderColor: narrationCharacter && narrationCharacter.color ? narrationCharacter.color : '#3b82f6' }\">\r\n              <img class=\"character-image\" :src=\"(narrationCharacter && narrationCharacter.image) || '/images/guide.png'\" />\r\n              <div class=\"character-name\" :style=\"{ color: narrationCharacter && narrationCharacter.color ? narrationCharacter.color : '#3b82f6' }\">\r\n                {{ narrationCharacterName }}\r\n              </div>\r\n            </div>\r\n            <!-- 右侧：对白气泡 -->\r\n            <div class=\"speech-side\">\r\n              <div class=\"speech-bubble\">\r\n                <div class=\"speech-text\">{{ typingText }}</div>\r\n              </div>\r\n              <div class=\"narration-actions\">\r\n                <button class=\"control-button primary\" @click=\"closeNarration\">好的</button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n\r\n    <!-- 手牌弹窗：查看某位玩家的手牌缩略（当前仅展示当前玩家持有的真实列表） -->\r\n    <div v-if=\"showHandPopup\" class=\"hand-popup\">\r\n      <div class=\"popup-overlay\" @click=\"hideHand\"></div>\r\n      <div class=\"popup-content\">\r\n        <h3 class=\"hand-title\">{{ handPlayer ? handPlayer.name + ' 的手牌' : '手牌' }}</h3>\r\n        <div class=\"hand-grid\">\r\n          <div v-for=\"aid in (handPlayer ? handPlayer.artifacts : [])\" :key=\"aid\" class=\"hand-card\">\r\n            <img class=\"hand-image\" :src=\"artifactMap[aid] ? artifactMap[aid].image : 'https://via.placeholder.com/160x100?text=未知卡牌'\" />\r\n            <div class=\"hand-name\">{{ artifactMap[aid] ? artifactMap[aid].name : aid }}</div>\r\n          </div>\r\n        </div>\r\n        <button class=\"close-button\" @click=\"hideHand\">关闭</button>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- 游戏结束对话框：展示最终排名与赢家信息，提供回房或去列表的导航 -->\r\n    <div v-if=\"showGameEndDialog\" class=\"game-end-popup\">\r\n      <div class=\"popup-overlay\" @click=\"closeGameEndDialog\"></div>\r\n      <div class=\"popup-content game-end-content\">\r\n        <div class=\"game-end-header\">\r\n          <div class=\"game-end-icon\">🏆</div>\r\n          <h2 class=\"game-end-title\">游戏结束</h2>\r\n          <p class=\"game-end-subtitle\" v-if=\"winnerInfo\">胜者：{{ winnerInfo.name }} · 总分 {{ winnerInfo.total }}</p>\r\n          <p class=\"game-end-subtitle\" v-else>感谢参与时空旅人拍卖会！</p>\r\n        </div>\r\n        <div class=\"final-scoreboard\" v-if=\"finalScores && finalScores.length\">\r\n          <div class=\"score-row\" v-for=\"(p, idx) in finalScores\" :key=\"p.userId\">\r\n            <div class=\"rank\">{{ idx + 1 }}</div>\r\n            <img class=\"score-avatar\" :src=\"p.avatar\" />\r\n            <div class=\"name\">{{ p.name }}</div>\r\n            <div class=\"detail\">收藏集 {{ p.collectionScore }} + 奇物 {{ p.artifactScore }} = <b>{{ p.total }}</b></div>\r\n          </div>\r\n        </div>\r\n        \r\n        <div class=\"game-end-actions\">\r\n          <button class=\"action-button primary\" @click=\"stayInRoom\">\r\n            <span class=\"btn-icon\">🏠</span>\r\n            留在房间\r\n          </button>\r\n          <button class=\"action-button secondary\" @click=\"goToRooms\">\r\n            <span class=\"btn-icon\">📋</span>\r\n            返回房间列表\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport { mapState, mapGetters } from 'vuex'\r\nimport AuctionPanel from '../../components/auction-panel/auction-panel.vue'\r\nimport roomService from '../../services/room-service'\r\nimport { getSupabase } from '../../services/supabase-client'\r\nimport auctionService from '../../services/auction-service'\r\nimport { startCountdown, clearCountdown } from '../../features/game/countdown'\r\nimport { loadRoomState as loadRoomStateService } from '../../features/game/room-state.service'\r\nimport { subscribeRoomRealtime as subscribeRoomRealtimeService, unsubscribeRoomRealtime as unsubscribeRoomRealtimeService } from '../../features/game/room-realtime'\r\nimport { startGame as startGameFlow, autoStartAuction as autoStartAuctionFlow } from '../../features/game/auction-flow.service'\r\nimport { sendChatMessage } from '../../features/game/chat.service'\r\nimport { toggleReady as toggleReadyAction, moveToSeat as moveToSeatAction, leaveRoom as leaveRoomAction } from '../../features/game/room-actions.service'\r\nimport { loadArtifacts as loadArtifactsService } from '../../features/game/artifacts.service'\r\nimport { loadCollectionsFromArtifacts, getCurrentCollectionCount as getCollectionCountUtil, getCollectionProgress as getCollectionProgressUtil } from '../../features/game/collections.utils'\r\nimport { formatMessageTime as formatMessageTimeHelper, getAvatarFor as getAvatarForHelper, getNameFor as getNameForHelper } from '../../features/game/ui.helpers'\r\nimport { firstLoginDialogue as firstLoginDialogueConfig, getCurrentLanguage as getCurrentLanguageImported } from '../../config/dialogue-config'\r\nexport default {\r\n  name: 'GameIndex',\r\n  components: {\r\n    AuctionPanel\r\n  },\r\n  data() {\r\n    return {\r\n      selectedCard: null,\r\n      showHandPopup: false,\r\n      handPlayer: null,\r\n      artifactMap: {},\r\n      room: null,\r\n      profileMap: {},\r\n      refreshTimer: null,\r\n      collections: [],\r\n      showGameEndDialog: false,\r\n      finalScores: [],\r\n      winnerInfo: null,\r\n      auctionCountdown: 0,\r\n      auctionTimer: null,\r\n      currentAuction: null,\r\n      // 回合相关（前端实时显示，房主每轮开拍时广播以保持同步）\r\n      roundCount: 0,\r\n      totalRounds: 6,\r\n      chatMessages: [],\r\n      newMessage: '',\r\n      chatChannel: null,\r\n      countdownInProgress: false,\r\n      expandedCollections: {},\r\n      showNarration: false,\r\n      typingText: '',\r\n      typingTimer: null,\r\n      // 存储所有玩家的手牌数据，用于价值计算\r\n      allPlayersArtifacts: {},\r\n      // 文物轮播相关数据\r\n      artifactCarouselData: [],\r\n      currentSlide: 0,\r\n      carouselInterval: null,\r\n      // 音乐控制相关数据\r\n      isMusicPlaying: false,\r\n      audioElement: null,\r\n      musicVolume: 0.5\r\n    }\r\n  },\r\n  computed: {\r\n    ...mapState(['gamePhase', 'gameLog', 'showCardDetail', 'user', 'roomId', 'roundCurrent', 'roundTotal']),\r\n    // 将当前玩家注入到渲染上下文，避免模板引用报错\r\n    currentPlayer() { return this.$store.state.currentPlayer },\r\n    isOwner() { return this.room && this.user && this.room.owner_id === this.user.id },\r\n    allReady() {\r\n      const players = (this.room && this.room.room_players) ? this.room.room_players : []\r\n      return players.length > 0 && players.every(p => !!p.is_ready)\r\n    },\r\n    currentUserReady() {\r\n      const user = this.user\r\n      const players = (this.room && this.room.room_players) ? this.room.room_players : []\r\n      if (!user) return false\r\n      const me = players.find(p => p.user_id === user.id)\r\n      return !!(me && me.is_ready)\r\n    },\r\n    playerCount() {\r\n      return (this.room && this.room.room_players) ? this.room.room_players.length : 0\r\n    },\r\n    ownerName() {\r\n      if (!this.room) return '-'\r\n      return this.getNameFor(this.room.owner_id)\r\n    },\r\n    seatCount() { return (this.room && Number(this.room.max_players)) ? Number(this.room.max_players) : 0 },\r\n    seats() {\r\n      const players = (this.room && this.room.room_players) ? this.room.room_players : []\r\n      const max = this.seatCount\r\n      const seats = Array.from({ length: max }, () => ({ player: null }))\r\n      // 放置已设置座位的玩家\r\n      players.forEach(p => {\r\n        const idx = typeof p.seat_index === 'number' ? p.seat_index : -1\r\n        if (idx >= 0 && idx < max && !seats[idx].player) seats[idx].player = p\r\n      })\r\n      // 将未设置座位的玩家依次放到空位\r\n      players.filter(p => typeof p.seat_index !== 'number' || p.seat_index < 0).forEach(p => {\r\n        const emptyIdx = seats.findIndex(s => !s.player)\r\n        if (emptyIdx >= 0) seats[emptyIdx].player = p\r\n      })\r\n      return seats\r\n    },\r\n    gamePhaseText() {\r\n      const phaseMap = {\r\n        'preparation': '准备阶段',\r\n        'countdown': '预倒计时',\r\n        'intermission': '间歇阶段',\r\n        'auction': '拍卖阶段',\r\n        'settlement': '结算阶段'\r\n      }\r\n      return phaseMap[this.gamePhase] || '未知阶段'\r\n    },\r\n   \r\n\r\n    // 根据当前用户手牌计算收藏集显示数据，带缓存字段，便于模板直接引用\r\n    collectionsComputed() {\r\n      const list = Array.isArray(this.collections) ? this.collections : []\r\n      // 仅展示用户手牌中至少包含1件该收藏集的情况\r\n      return list\r\n        .map(col => {\r\n          const current = this.getCurrentCollectionCount(col)\r\n          const progress = Math.min((current / (col.requiredCount || 1)) * 100, 100)\r\n          return { ...col, _current: current, _progress: progress }\r\n        })\r\n        .filter(col => col._current > 0)\r\n    },\r\n\r\n    // 合并聊天与系统日志为同一信息流，按时间排序\r\n    chatFeed() {\r\n      const logs = (this.gameLog || []).map((l, idx) => ({\r\n        id: `log-${l.timestamp || idx}`,\r\n        type: 'log',\r\n        userId: null,\r\n        username: '系统',\r\n        content: l.message,\r\n        timestamp: l.timestamp || 0\r\n      }))\r\n      const chats = (this.chatMessages || []).map(m => ({ ...m, type: 'chat' }))\r\n      const merged = [...logs, ...chats]\r\n      return merged.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0))\r\n    },\r\n    // 暴露对话配置供模板使用\r\n    firstLoginConfig() { return firstLoginDialogueConfig },\r\n    // 当前讲述角色配置与名称\r\n    narrationCharacterName() { return (this.getCurrentLanguage() === 'zh-CN') ? '美里' : 'Misato' },\r\n    narrationCharacter() {\r\n      const key = this.narrationCharacterName\r\n      const chars = firstLoginDialogueConfig && firstLoginDialogueConfig.characters\r\n      return (chars && chars[key]) ? chars[key] : { image: '/images/guide.png', position: 'right', color: '#3b82f6' }\r\n    }\r\n  },\r\n  async mounted() {\r\n    const roomId = this.$route.query.roomId\r\n    if (roomId) this.$store.commit('SET_ROOM_ID', roomId)\r\n    await this.initializeGame()\r\n    await this.loadRoomState()\r\n    // 立即初始化文物轮播数据，确保准备阶段就有内容\r\n    await this.initializeArtifactCarousel()\r\n    // loadRoomState 中已经调用了 loadAllPlayersArtifacts，这里确保数据加载\r\n    await this.subscribeRoomRealtime()\r\n    // 初始化音乐播放器\r\n    this.initializeMusic()\r\n  },\r\n  beforeDestroy() {\r\n    this.unsubscribeRoomRealtime()\r\n    if (this.refreshTimer) { clearInterval(this.refreshTimer); this.refreshTimer = null }\r\n    if (this.auctionTimer) { clearInterval(this.auctionTimer); this.auctionTimer = null }\r\n    if (this.typingTimer) { clearInterval(this.typingTimer); this.typingTimer = null }\r\n    if (this.carouselInterval) { clearInterval(this.carouselInterval); this.carouselInterval = null }\r\n    // 清理音乐播放器\r\n    this.cleanupMusic()\r\n    this.$set(this, 'auctionCountdown', 0)\r\n  },\r\n  watch: {\r\n    gameLog() {\r\n      this.$nextTick(() => {\r\n        const chatContainer = this.$refs.chatContainer\r\n        if (chatContainer) { chatContainer.scrollTop = chatContainer.scrollHeight }\r\n      })\r\n    },\r\n    // 监听游戏阶段变化，在准备阶段确保轮播数据存在\r\n    gamePhase(newPhase) {\r\n      if (newPhase === 'preparation') {\r\n        this.$nextTick(() => {\r\n          // 如果轮播数据为空，重新初始化\r\n          if (!this.artifactCarouselData || this.artifactCarouselData.length === 0) {\r\n            this.initializeArtifactCarousel()\r\n          } else {\r\n            // 数据已存在，只需确保轮播正常运行\r\n            this.startAutoCarousel()\r\n          }\r\n        })\r\n      } else {\r\n        // 离开准备阶段时停止轮播\r\n        this.stopAutoCarousel()\r\n      }\r\n      \r\n      // 根据游戏阶段调整音乐播放\r\n      this.handleGamePhaseMusic(newPhase)\r\n    }\r\n  },\r\n  methods: {\r\n    // 初始化文物轮播数据（改进版：确保总有内容显示）\r\n    async initializeArtifactCarousel() {\r\n      try {\r\n        console.log('🧭 开始初始化文物轮播数据...')\r\n        \r\n        // 先检查是否有缓存的轮播数据\r\n        if (this.artifactCarouselData && this.artifactCarouselData.length > 0) {\r\n          console.log('📚 使用缓存轮播数据')\r\n          this.startAutoCarousel()\r\n          return\r\n        }\r\n        \r\n        // 直接使用artifacts表获取数据\r\n        const supabase = getSupabase()\r\n        console.log('🔗 获取Supabase实例:', supabase ? '✅ 成功' : '❌ 失败')\r\n        \r\n        console.log('📥 正在从artifacts表获取数据...')\r\n        const { data: artifactData, error: artifactError } = await supabase\r\n          .from('artifacts')\r\n          .select('id, name, era, location, image, base_value')\r\n          .limit(10) // 获取10个文物用于轮播\r\n          \r\n        console.log('📊 从artifacts表获取数据结果:', {\r\n          dataLength: artifactData ? artifactData.length : 0,\r\n          error: artifactError,\r\n          data: artifactData\r\n        })\r\n        \r\n        let finalData = []\r\n        \r\n        if (artifactError) {\r\n          console.error('❌ 从artifacts表获取文物数据失败:', artifactError)\r\n          console.log('🔄 使用模拟数据作为备用...')\r\n          finalData = this.getMockArtifactData()\r\n        } else if (artifactData && artifactData.length > 0) {\r\n          console.log('✅ 成功获取到文物数据:', artifactData.length, '条')\r\n          // 处理真实数据\r\n          finalData = artifactData.map((item, index) => {\r\n            console.log(`📸 处理文物 ${index + 1}:`, item.name, '原始图片URL:', item.image)\r\n            \r\n            // 确保图片URL是完整的URL\r\n            let imageUrl = item.image\r\n            if (imageUrl) {\r\n              if (imageUrl.startsWith('/')) {\r\n                // 相对路径，转换为绝对路径\r\n                console.log('🔄 转换相对路径为绝对路径...')\r\n                if (imageUrl.startsWith('/static/')) {\r\n                  // 静态资源路径，使用项目根路径\r\n                  imageUrl = window.location.origin + imageUrl\r\n                } else {\r\n                  // 其他相对路径，使用Supabase存储路径\r\n                  imageUrl = 'https://tgkzpywukorcwdsbfubw.supabase.co' + imageUrl\r\n                }\r\n              } else if (!imageUrl.startsWith('http')) {\r\n                // 可能是相对路径但缺少斜杠\r\n                console.log('🔄 处理可能缺少斜杠的路径...')\r\n                imageUrl = 'https://tgkzpywukorcwdsbfubw.supabase.co/storage/v1/object/public/' + imageUrl\r\n              }\r\n            }\r\n            \r\n            const processedItem = {\r\n              id: item.id,\r\n              name: item.name,\r\n              era: item.era,\r\n              location: item.location,\r\n              image: imageUrl || 'https://via.placeholder.com/400x300?text=文物预览',\r\n              baseValue: item.base_value\r\n            }\r\n            \r\n            console.log(`✅ 文物 ${index + 1} 处理完成 - 最终图片URL:`, processedItem.image)\r\n            return processedItem\r\n          })\r\n        } else {\r\n          console.log('📭 artifacts表为空，使用模拟数据')\r\n          finalData = this.getMockArtifactData()\r\n        }\r\n        \r\n        // 确保最终数据不为空\r\n        if (finalData.length === 0) {\r\n          console.log('⚠️ 最终数据为空，使用备用模拟数据')\r\n          finalData = this.getMockArtifactData()\r\n        }\r\n        \r\n        this.artifactCarouselData = finalData\r\n        console.log('🎯 最终轮播数据:', this.artifactCarouselData.length, '条')\r\n        console.log('🔄 开始自动轮播...')\r\n        \r\n        // 开始自动轮播\r\n        this.startAutoCarousel()\r\n      } catch (error) {\r\n        console.error('💥 初始化文物轮播失败:', error)\r\n        console.log('🔄 使用模拟数据作为最终备用...')\r\n        // 确保即使出错也有数据展示\r\n        this.artifactCarouselData = this.getMockArtifactData()\r\n        this.startAutoCarousel()\r\n      }\r\n    },\r\n    \r\n    // 获取模拟文物数据（备用方案）\r\n    getMockArtifactData() {\r\n      return [\r\n        {\r\n          id: 'artifact_001',\r\n          name: '唐代秘色瓷',\r\n          era: '唐代',\r\n          location: '中国',\r\n          image: 'https://via.placeholder.com/400x300/f0f0f0/666666?text=唐代秘色瓷',\r\n          baseValue: 8\r\n        },\r\n        {\r\n          id: 'artifact_002',\r\n          name: '达芬奇奇设图',\r\n          era: '文艺复兴',\r\n          location: '意大利',\r\n          image: 'https://via.placeholder.com/400x300/f0f0f0/666666?text=达芬奇奇设图',\r\n          baseValue: 9\r\n        },\r\n        {\r\n          id: 'artifact_003',\r\n          name: '琥珀化石',\r\n          era: '史前',\r\n          location: '波罗的海',\r\n          image: 'https://via.placeholder.com/400x300/f0f0f0/666666?text=琥珀化石',\r\n          baseValue: 6\r\n        },\r\n        {\r\n          id: 'artifact_004',\r\n          name: '维京龙头船',\r\n          era: '维京时代',\r\n          location: '北欧',\r\n          image: 'https://via.placeholder.com/400x300/f0f0f0/666666?text=维京龙头船',\r\n          baseValue: 7\r\n        },\r\n        {\r\n          id: 'artifact_005',\r\n          name: '星盘仪',\r\n          era: '中世纪',\r\n          location: '阿拉伯',\r\n          image: 'https://via.placeholder.com/400x300/f0f0f0/666666?text=星盘仪',\r\n          baseValue: 7\r\n        }\r\n      ]\r\n    },\r\n    \r\n    // 开始自动轮播\r\n    startAutoCarousel() {\r\n      if (this.carouselInterval) {\r\n        clearInterval(this.carouselInterval)\r\n      }\r\n      \r\n      // 确保有数据才开启轮播\r\n      if (!this.artifactCarouselData || this.artifactCarouselData.length === 0) {\r\n        console.log('⚠️ 轮播数据为空，不启动自动轮播')\r\n        return\r\n      }\r\n      \r\n      this.carouselInterval = setInterval(() => {\r\n        this.nextSlide()\r\n      }, 3000) // 每3秒自动切换\r\n    },\r\n    \r\n    // 停止自动轮播\r\n    stopAutoCarousel() {\r\n      if (this.carouselInterval) {\r\n        clearInterval(this.carouselInterval)\r\n        this.carouselInterval = null\r\n      }\r\n    },\r\n    \r\n    // 下一张幻灯片\r\n    nextSlide() {\r\n      if (this.artifactCarouselData && this.artifactCarouselData.length > 0) {\r\n        this.currentSlide = (this.currentSlide + 1) % this.artifactCarouselData.length\r\n      }\r\n    },\r\n    \r\n    // 上一张幻灯片\r\n    prevSlide() {\r\n      if (this.artifactCarouselData && this.artifactCarouselData.length > 0) {\r\n        this.currentSlide = (this.currentSlide - 1 + this.artifactCarouselData.length) % this.artifactCarouselData.length\r\n      }\r\n    },\r\n    \r\n    // 跳转到指定幻灯片\r\n    goToSlide(index) {\r\n      if (this.artifactCarouselData && index >= 0 && index < this.artifactCarouselData.length) {\r\n        this.currentSlide = index\r\n      }\r\n    },\r\n    \r\n    // 处理图片加载错误\r\n    handleImageError(artifact) {\r\n      console.warn(`文物图片加载失败: ${artifact.name}`)\r\n      // 可以设置默认图片或使用占位符\r\n      artifact.image = 'https://via.placeholder.com/400x300?text=文物预览'\r\n    },\r\n\r\n    // 去掉模拟初始化玩家，改为使用房间的实际玩家列表\r\n    async initializeGame() {\r\n      const artifacts = await this.loadArtifacts()\r\n      this.artifactMap = artifacts.reduce((acc, a) => { acc[a.id] = a; return acc }, {})\r\n      await this.loadCollections()\r\n    },\r\n    async subscribeRoomRealtime() {\r\n      const rid = this.$store.state.roomId\r\n      if (!rid) return\r\n      const supabase = getSupabase()\r\n      const { roomChannel, broadcastChannel } = subscribeRoomRealtimeService(\r\n        { roomId: rid, supabase, onLoadRoomState: this.loadRoomState },\r\n        {\r\n          onGameStarted: async (_payload) => {\r\n            // 防止重复启动多个倒计时\r\n            if (this.countdownInProgress) return\r\n            this.countdownInProgress = true\r\n            \r\n            // 新局开始：重置聊天消息和价值数据\r\n            this.chatMessages = []\r\n            this.allPlayersArtifacts = {}\r\n            // 重置回合数\r\n            this.$store.commit('RESET_ROUND')\r\n            this.$store.commit('SET_ROUND_TOTAL', 6)\r\n            \r\n            this.$store.commit('SET_GAME_PHASE', 'countdown')\r\n            this.$set(this, 'auctionCountdown', 5)\r\n            const me = (this.room && this.room.room_players ? this.room.room_players : []).find(p => p.user_id === this.$store.state.user.id)\r\n            if (me) {\r\n              this.$store.commit('SET_CURRENT_PLAYER', { id: me.user_id, name: this.getNameFor(me.user_id), energy: 50, artifacts: [], items: [] })\r\n            }\r\n            if (this.auctionTimer) { clearInterval(this.auctionTimer); this.auctionTimer = null }\r\n            this.$nextTick(() => {\r\n              startCountdown({\r\n                seconds: 5,\r\n                onTick: (s) => { this.$set(this, 'auctionCountdown', s) },\r\n                onDone: async () => { this.countdownInProgress = false; if (this.isOwner) { await this.autoStartAuction() } },\r\n                getRef: () => this.auctionTimer,\r\n                setRef: (id) => { this.auctionTimer = id },\r\n              })\r\n            })\r\n          },\r\n          onAuctionStarted: async (duration, payload) => { \r\n            // 确保所有玩家都能看到拍卖数据\r\n            await this.loadRoomState()\r\n            \r\n            // 同步回合数（如果广播中包含了回合信息）\r\n            if (payload && typeof payload.roundCurrent === 'number') {\r\n              this.$store.commit('SET_ROUND_CURRENT', payload.roundCurrent)\r\n            }\r\n            if (payload && typeof payload.roundTotal === 'number') {\r\n              this.$store.commit('SET_ROUND_TOTAL', payload.roundTotal)\r\n            }\r\n            \r\n            this.startAuctionTimer(duration) \r\n          },\r\n          onBidUpdate: ({ auctionId, highestBid, highestBidder }) => {\r\n            if (!auctionId) return\r\n            const list = this.$store.state.currentAuctions || []\r\n            const idx = list.findIndex(a => a.id === auctionId)\r\n            if (idx >= 0) {\r\n              const next = { ...list[idx], highestBid, highestBidder }\r\n              this.$store.commit('ADD_OR_UPDATE_AUCTION', next)\r\n            }\r\n          },\r\n          // 旧回合广播已移除，统一本地推进，不再接收该事件\r\n          onRoundUpdated: (_data) => {},\r\n          onGameEnded: () => {\r\n            this.$store.commit('SET_GAME_PHASE', 'settlement')\r\n        this.computeFinalScores().finally(() => { this.showGameEndDialog = true })\r\n            if (this.auctionTimer) { clearInterval(this.auctionTimer); this.auctionTimer = null }\r\n          },\r\n          onAuctionEnded: async () => { await this.loadRoomState() },\r\n          onChatMessage: (message) => {\r\n            // 避免重复添加消息\r\n            if (!message || !message.id) return\r\n            const existing = this.chatMessages.find(m => m.id === message.id || (m.userId === message.userId && m.timestamp === message.timestamp && m.content === message.content))\r\n            if (existing) return\r\n            \r\n            this.chatMessages.push(message)\r\n            this.$nextTick(() => {\r\n              const chatContainer = this.$refs.chatContainer\r\n              if (chatContainer) { chatContainer.scrollTop = chatContainer.scrollHeight }\r\n            })\r\n          },\r\n        },\r\n        () => { if (!this.refreshTimer) { this.refreshTimer = setInterval(this.loadRoomState, 1000) } }\r\n      )\r\n      this.roomChannel = roomChannel\r\n      this.broadcastChannel = broadcastChannel\r\n    },\r\n    unsubscribeRoomRealtime() {\r\n      unsubscribeRoomRealtimeService(this.roomChannel, this.broadcastChannel)\r\n      this.roomChannel = null\r\n      this.broadcastChannel = null\r\n    },\r\n    async loadRoomState() {\r\n      const rid = this.$store.state.roomId\r\n      const supabase = getSupabase()\r\n      await loadRoomStateService({\r\n        roomId: rid,\r\n        roomService,\r\n        supabase,\r\n        artifactMap: this.artifactMap,\r\n        store: this.$store,\r\n        setRoom: (room) => { this.room = room },\r\n        setProfileMap: (map) => { this.profileMap = map },\r\n        setGamePhase: (phase) => { this.$store.commit('SET_GAME_PHASE', phase) },\r\n        clearAuctionTimer: () => { if (this.auctionTimer) { clearInterval(this.auctionTimer); this.auctionTimer = null } },\r\n        setAuctionCountdown: (n) => { this.$set(this, 'auctionCountdown', n) },\r\n        onShowGameEnd: () => { this.showGameEndDialog = true; setTimeout(() => { this.handleGameEnd() }, 3000) },\r\n      })\r\n      // 加载所有玩家的手牌数据，用于价值计算\r\n      await this.loadAllPlayersArtifacts()\r\n      // 如果刷新后发现仍有活跃拍卖，但本地无倒计时，则用当前剩余时间启动统一倒计时\r\n      const auctions = this.$store.state.currentAuctions || []\r\n      if (this.$store.state.gamePhase === 'auction' && auctions.length > 0) {\r\n        const remaining = Number(this.auctionCountdown || 0)\r\n        if (!this.auctionTimer && remaining > 0) {\r\n          startCountdown({\r\n            seconds: remaining,\r\n            onTick: (s) => { this.$set(this, 'auctionCountdown', s); },\r\n            onDone: async () => { await this.onAuctionTimeUp() },\r\n            getRef: () => this.auctionTimer,\r\n            setRef: (id) => { this.auctionTimer = id },\r\n          })\r\n        }\r\n      }\r\n    },\r\n    \r\n    // 加载所有玩家的手牌数据\r\n    async loadAllPlayersArtifacts() {\r\n      try {\r\n        const rid = this.$store.state.roomId\r\n        if (!rid) {\r\n          this.allPlayersArtifacts = {}\r\n          return\r\n        }\r\n        \r\n        const supabase = getSupabase()\r\n        // 获取房间内所有玩家的手牌数据\r\n        const { data: allArtifacts } = await supabase\r\n          .from('room_artifacts')\r\n          .select('owner_user_id, artifact_id')\r\n          .eq('room_id', rid)\r\n        \r\n        // 按玩家ID分组\r\n        const playerArtifactsMap = {}\r\n        if (allArtifacts && allArtifacts.length > 0) {\r\n          allArtifacts.forEach(row => {\r\n            const userId = row.owner_user_id\r\n            if (!playerArtifactsMap[userId]) {\r\n              playerArtifactsMap[userId] = []\r\n            }\r\n            playerArtifactsMap[userId].push(row.artifact_id)\r\n          })\r\n        }\r\n        \r\n        // 使用 Vue.set 确保响应式更新\r\n        this.$set(this, 'allPlayersArtifacts', playerArtifactsMap)\r\n      } catch (e) {\r\n        console.warn('[game] loadAllPlayersArtifacts failed', e)\r\n        this.allPlayersArtifacts = {}\r\n      }\r\n    },\r\n    async toggleReady() {\r\n      try {\r\n        const rid = this.$store.state.roomId\r\n        const uid = this.$store.state.user && this.$store.state.user.id\r\n        if (!rid || !uid) return\r\n        await toggleReadyAction({ roomId: rid, userId: uid, room: this.room, roomService, reload: this.loadRoomState })\r\n      } catch (e) { console.warn('[game] toggleReady failed', e) }\r\n    },\r\n    async moveToSeat(idx) {\r\n      try {\r\n        const rid = this.$store.state.roomId\r\n        const uid = this.$store.state.user && this.$store.state.user.id\r\n        if (!rid || !uid) return\r\n        const targetSeat = { index: idx, player: this.seats[idx] && this.seats[idx].player }\r\n        await moveToSeatAction({ roomId: rid, userId: uid, room: this.room, seats: targetSeat, roomService, reload: this.loadRoomState })\r\n      } catch (e) { console.warn('[game] moveToSeat failed', e) }\r\n    },\r\n    async leaveRoom() {\r\n      try {\r\n        const rid = this.$store.state.roomId\r\n        const uid = this.$store.state.user && this.$store.state.user.id\r\n        if (!rid || !uid) return\r\n        await leaveRoomAction({\r\n          roomId: rid,\r\n          userId: uid,\r\n          clearAuctionTimer: () => { if (this.auctionTimer) { clearInterval(this.auctionTimer); this.auctionTimer = null } },\r\n          setCountdown: (n) => { this.$set(this, 'auctionCountdown', n) },\r\n          store: this.$store,\r\n          auctionService,\r\n          roomService,\r\n          unsubscribe: () => this.unsubscribeRoomRealtime(),\r\n          setRoomId: (v) => this.$store.commit('SET_ROOM_ID', v),\r\n          setLocalRoom: (v) => { this.room = v },\r\n          navigateToRooms: () => this.$router.push('/rooms'),\r\n        })\r\n      } catch (e) { console.warn('[game] leaveRoom failed', e) }\r\n    },\r\n    \r\n    // 游戏结束处理\r\n    async handleGameEnd() {\r\n      try {\r\n        const rid = this.$store.state.roomId\r\n        if (rid) {\r\n          // 将房间状态重置为 waiting，便于继续房间内准备/新一局\r\n          const supabase = getSupabase()\r\n          await supabase.from('rooms').update({ status: 'waiting' }).eq('id', rid)\r\n          // 跳转回房间页面（游戏页携带 roomId 即是房间界面）\r\n          this.$router.push({ path: '/game', query: { roomId: rid, gameEnded: 'true' } })\r\n        } else {\r\n          this.$router.push('/rooms')\r\n        }\r\n      } catch (e) {\r\n        console.warn('[game] handleGameEnd failed', e)\r\n        // 兜底跳回房间列表\r\n        this.$router.push('/rooms')\r\n      }\r\n    },\r\n\r\n    // 音乐控制相关方法\r\n    initializeMusic() {\r\n      try {\r\n        // 创建音频元素\r\n        this.audioElement = new Audio('/images/bgm.mp3')\r\n        this.audioElement.loop = true\r\n        this.audioElement.volume = this.musicVolume\r\n        \r\n        // 监听音频播放状态\r\n        this.audioElement.addEventListener('loadeddata', () => {\r\n          console.log('🎵 背景音乐加载完成')\r\n        })\r\n        \r\n        this.audioElement.addEventListener('error', (e) => {\r\n          console.error('🎵 背景音乐加载失败:', e)\r\n        })\r\n        \r\n        // 尝试自动播放（需要用户交互后才能生效）\r\n        this.audioElement.load()\r\n      } catch (error) {\r\n        console.error('🎵 初始化音乐播放器失败:', error)\r\n      }\r\n    },\r\n    \r\n    toggleMusic() {\r\n      if (!this.audioElement) return\r\n      \r\n      if (this.isMusicPlaying) {\r\n        this.pauseMusic()\r\n      } else {\r\n        this.playMusic()\r\n      }\r\n    },\r\n    \r\n    async playMusic() {\r\n      if (!this.audioElement) return\r\n      \r\n      try {\r\n        await this.audioElement.play()\r\n        this.isMusicPlaying = true\r\n        console.log('🎵 背景音乐开始播放')\r\n      } catch (error) {\r\n        console.warn('🎵 音乐播放失败，可能需要用户交互:', error)\r\n        // 如果是自动播放策略导致的失败，我们仍将状态标记为播放\r\n        this.isMusicPlaying = true\r\n      }\r\n    },\r\n    \r\n    pauseMusic() {\r\n      if (!this.audioElement) return\r\n      \r\n      this.audioElement.pause()\r\n      this.isMusicPlaying = false\r\n      console.log('🎵 背景音乐暂停')\r\n    },\r\n    \r\n    setVolume(volume) {\r\n      this.musicVolume = Math.max(0, Math.min(1, volume))\r\n      if (this.audioElement) {\r\n        this.audioElement.volume = this.musicVolume\r\n      }\r\n    },\r\n    \r\n    cleanupMusic() {\r\n      if (this.audioElement) {\r\n        this.pauseMusic()\r\n        this.audioElement = null\r\n      }\r\n    },\r\n    \r\n    // 根据游戏阶段处理音乐播放\r\n    handleGamePhaseMusic(phase) {\r\n      if (!this.audioElement) return\r\n      \r\n      // 只有在音乐正在播放时才需要根据阶段调整\r\n      if (!this.isMusicPlaying) return\r\n      \r\n      switch (phase) {\r\n        case 'preparation':\r\n          // 准备阶段：正常播放\r\n          this.setVolume(0.5)\r\n          break\r\n        case 'countdown':\r\n        case 'intermission':\r\n          // 倒计时和间歇阶段：降低音量\r\n          this.setVolume(0.3)\r\n          break\r\n        case 'auction':\r\n          // 拍卖阶段：正常音量\r\n          this.setVolume(0.5)\r\n          break\r\n        case 'item':\r\n          // 道具阶段：稍微降低音量\r\n          this.setVolume(0.4)\r\n          break\r\n        case 'settlement':\r\n          // 结算阶段：降低音量\r\n          this.setVolume(0.3)\r\n          break\r\n        default:\r\n          this.setVolume(0.5)\r\n      }\r\n    },\r\n\r\n    // 音乐控制相关方法\r\n    initializeMusic() {\r\n      try {\r\n        // 创建音频元素\r\n        this.audioElement = new Audio('/images/bgm.mp3')\r\n        this.audioElement.loop = true\r\n        this.audioElement.volume = this.musicVolume\r\n        \r\n        // 监听音频播放状态\r\n        this.audioElement.addEventListener('loadeddata', () => {\r\n          console.log('🎵 背景音乐加载完成')\r\n        })\r\n        \r\n        this.audioElement.addEventListener('error', (e) => {\r\n          console.error('🎵 背景音乐加载失败:', e)\r\n        })\r\n        \r\n        // 尝试自动播放（需要用户交互后才能生效）\r\n        this.audioElement.load()\r\n      } catch (error) {\r\n        console.error('🎵 初始化音乐播放器失败:', error)\r\n      }\r\n    },\r\n    \r\n    toggleMusic() {\r\n      if (!this.audioElement) return\r\n      \r\n      if (this.isMusicPlaying) {\r\n        this.pauseMusic()\r\n      } else {\r\n        this.playMusic()\r\n      }\r\n    },\r\n    \r\n    async playMusic() {\r\n      if (!this.audioElement) return\r\n      \r\n      try {\r\n        await this.audioElement.play()\r\n        this.isMusicPlaying = true\r\n        console.log('🎵 背景音乐开始播放')\r\n      } catch (error) {\r\n        console.warn('🎵 音乐播放失败，可能需要用户交互:', error)\r\n        // 如果是自动播放策略导致的失败，我们仍将状态标记为播放\r\n        this.isMusicPlaying = true\r\n      }\r\n    },\r\n    \r\n    pauseMusic() {\r\n      if (!this.audioElement) return\r\n      \r\n      this.audioElement.pause()\r\n      this.isMusicPlaying = false\r\n      console.log('🎵 背景音乐暂停')\r\n    },\r\n    \r\n    setVolume(volume) {\r\n      this.musicVolume = Math.max(0, Math.min(1, volume))\r\n      if (this.audioElement) {\r\n        this.audioElement.volume = this.musicVolume\r\n      }\r\n    },\r\n    \r\n    cleanupMusic() {\r\n      if (this.audioElement) {\r\n        this.pauseMusic()\r\n        this.audioElement = null\r\n      }\r\n    },\r\n    \r\n    // 根据游戏阶段处理音乐播放\r\n    handleGamePhaseMusic(phase) {\r\n      if (!this.audioElement) return\r\n      \r\n      // 只有在音乐正在播放时才需要根据阶段调整\r\n      if (!this.isMusicPlaying) return\r\n      \r\n      switch (phase) {\r\n        case 'preparation':\r\n          // 准备阶段：正常播放\r\n          this.setVolume(0.5)\r\n          break\r\n        case 'countdown':\r\n        case 'intermission':\r\n          // 倒计时和间歇阶段：降低音量\r\n          this.setVolume(0.3)\r\n          break\r\n        case 'auction':\r\n          // 拍卖阶段：正常音量\r\n          this.setVolume(0.5)\r\n          break\r\n        case 'item':\r\n          // 道具阶段：稍微降低音量\r\n          this.setVolume(0.4)\r\n          break\r\n        case 'settlement':\r\n          // 结算阶段：降低音量\r\n          this.setVolume(0.3)\r\n          break\r\n        default:\r\n          this.setVolume(0.5)\r\n      }\r\n    },\r\n    async startGame() {\r\n      try {\r\n        const rid = this.$store.state.roomId\r\n        const uid = this.$store.state.user && this.$store.state.user.id\r\n        if (!rid || !uid || !this.isOwner || !this.allReady) return\r\n        // 新局开始前重置系统日志、聊天消息和价值数据\r\n        try { this.$store.commit('CLEAR_GAME_LOG') } catch (_) {}\r\n        this.chatMessages = []\r\n        this.allPlayersArtifacts = {}\r\n        await roomService.startGame(rid, uid)\r\n        const supabase = getSupabase()\r\n        this.roundCount = 0\r\n        await startGameFlow({\r\n          roomId: rid,\r\n          userId: uid,\r\n          isOwner: this.isOwner,\r\n          allReady: this.allReady,\r\n          store: this.$store,\r\n          supabase,\r\n          setCountdown: (n) => this.$set(this, 'auctionCountdown', n),\r\n          setCurrentPlayerFromRoom: () => {\r\n            const me = (this.room && this.room.room_players ? this.room.room_players : []).find(p => p.user_id === uid)\r\n            if (me) { this.$store.commit('SET_CURRENT_PLAYER', { id: me.user_id, name: this.getNameFor(me.user_id), energy: 50, artifacts: [], items: [] }) }\r\n          },\r\n          onCountdownDone: async () => {\r\n            if (this.isOwner) { await this.autoStartAuction() }\r\n          },\r\n        })\r\n        // 房主本地也启动预倒计时，防止广播不回传导致不触发 onGameStarted\r\n        if (!this.countdownInProgress) {\r\n          this.countdownInProgress = true\r\n          // 确保本地也重置数据\r\n          this.chatMessages = []\r\n          this.allPlayersArtifacts = {}\r\n          this.$store.commit('SET_GAME_PHASE', 'countdown')\r\n          this.$set(this, 'auctionCountdown', 5)\r\n          const me = (this.room && this.room.room_players ? this.room.room_players : []).find(p => p.user_id === uid)\r\n          if (me) {\r\n            this.$store.commit('SET_CURRENT_PLAYER', { id: me.user_id, name: this.getNameFor(me.user_id), energy: 50, artifacts: [], items: [] })\r\n          }\r\n          if (this.auctionTimer) { clearInterval(this.auctionTimer); this.auctionTimer = null }\r\n          this.$nextTick(() => {\r\n            startCountdown({\r\n              seconds: 5,\r\n              onTick: (s) => { this.$set(this, 'auctionCountdown', s) },\r\n              onDone: async () => { this.countdownInProgress = false; if (this.isOwner) { await this.autoStartAuction() } },\r\n              getRef: () => this.auctionTimer,\r\n              setRef: (id) => { this.auctionTimer = id },\r\n            })\r\n          })\r\n        }\r\n      } catch (e) { console.warn('[game] startGame failed', e) }\r\n    },\r\n    \r\n    async startAuction() {\r\n      // 同时抽取多件进行拍卖（示例为2件）\r\n      const artifacts = await this.loadArtifacts()\r\n      if (artifacts.length > 0) {\r\n        const picks = []\r\n        while (picks.length < Math.min(2, artifacts.length)) {\r\n          const candidate = artifacts[Math.floor(Math.random() * artifacts.length)]\r\n          if (!picks.find(p => p.id === candidate.id)) picks.push(candidate)\r\n        }\r\n        for (const art of picks) {\r\n          await this.$store.dispatch('startAuction', art)\r\n        }\r\n      }\r\n    },\r\n    \r\n    async loadArtifacts() {\r\n      try {\r\n        const supabase = getSupabase()\r\n        return await loadArtifactsService({ supabase })\r\n      } catch (error) { console.error('加载卡牌数据失败:', error); return [] }\r\n    },\r\n    \r\n    showArtifactDetail(artifactId) {\r\n      // 若已加载artifactMap，则优先展示真实数据\r\n      const artifact = this.artifactMap[artifactId]\r\n      if (artifact) {\r\n        this.selectedCard = artifact\r\n      } else {\r\n        // 回退：维持原示例\r\n        this.selectedCard = {\r\n          id: artifactId,\r\n          name: '示例奇物',\r\n          era: '古代',\r\n          location: '未知',\r\n          story: '这是一个神秘的奇物...',\r\n          collectionTags: ['艺术瑰宝'],\r\n          baseValue: 8,\r\n          image: 'https://via.placeholder.com/300x200?text=示例奇物'\r\n        }\r\n      }\r\n      this.$store.commit('SET_SHOW_CARD_DETAIL', true)\r\n    },\r\n    \r\n    hideCardDetail() {\r\n      this.$store.commit('SET_SHOW_CARD_DETAIL', false)\r\n      this.selectedCard = null\r\n    },\r\n    showArtifactDetailFromAuction(artifact) {\r\n      this.selectedCard = artifact\r\n      this.$store.commit('SET_SHOW_CARD_DETAIL', false)\r\n      this.openNarration()\r\n    },\r\n    // 计算玩家总价值（支持所有玩家）\r\n    getPlayerTotalValue(userId) {\r\n      if (!userId) return 0\r\n      \r\n      // 优先从 allPlayersArtifacts 获取所有玩家的手牌数据\r\n      let owned = []\r\n      if (this.allPlayersArtifacts && this.allPlayersArtifacts[userId]) {\r\n        owned = Array.isArray(this.allPlayersArtifacts[userId]) ? this.allPlayersArtifacts[userId] : []\r\n      } else {\r\n        // 回退：如果 allPlayersArtifacts 中没有，尝试从当前玩家数据获取\r\n        const current = this.$store.state.currentPlayer\r\n        if (current && current.id === userId) {\r\n          owned = Array.isArray(this.$store.state.playerArtifacts) ? this.$store.state.playerArtifacts : []\r\n        }\r\n      }\r\n      \r\n      if (!owned || owned.length === 0) return 0\r\n      \r\n      // 确保 artifactMap 已加载\r\n      if (!this.artifactMap || Object.keys(this.artifactMap).length === 0) return 0\r\n      \r\n      let total = 0\r\n      owned.forEach(aid => {\r\n        const a = this.artifactMap[aid]\r\n        if (a && typeof a.baseValue === 'number') {\r\n          total += a.baseValue\r\n        }\r\n      })\r\n      return total\r\n    },\r\n\r\n    showPlayerHand(player) {\r\n      // 构造玩家对象，包含手牌信息\r\n      const playerData = {\r\n        id: player.user_id,\r\n        name: this.getNameFor(player.user_id),\r\n        artifacts: this.currentPlayer && this.currentPlayer.id === player.user_id ? \r\n          (this.currentPlayer.artifacts || []) : []\r\n      }\r\n      this.handPlayer = playerData\r\n      this.showHandPopup = true\r\n    },\r\n\r\n    hideHand() {\r\n      this.handPlayer = null\r\n      this.showHandPopup = false\r\n    },\r\n    \r\n    \r\n    getAvatarFor(userId) { return getAvatarForHelper({ profileMap: this.profileMap, userId }) },\r\n    getNameFor(userId) { return getNameForHelper({ profileMap: this.profileMap, room: this.room, userId }) },\r\n    getCurrentLanguage() { return getCurrentLanguageImported() },\r\n    \r\n    // 加载收藏集数据：基于数据库 artifacts 的 collection_tags 动态生成\r\n    async loadCollections() {\r\n      try { this.collections = loadCollectionsFromArtifacts(this.artifactMap) }\r\n      catch (error) { console.error('加载收藏集数据失败:', error); this.collections = [] }\r\n    },\r\n    \r\n   \r\n    \r\n    // 获取当前收藏集数量（基于当前用户手牌，且受最大要求数上限限制）\r\n    getCurrentCollectionCount(collection) {\r\n      const owned = (this.currentPlayer && this.currentPlayer.artifacts) ? this.currentPlayer.artifacts : []\r\n      return getCollectionCountUtil({ artifactMap: this.artifactMap, ownedArtifactIds: owned, collection })\r\n    },\r\n\r\n\r\n    // 展开/收起收藏集\r\n    toggleCollection(collection) {\r\n      const id = collection && collection.id\r\n      if (!id) return\r\n      this.$set(this.expandedCollections, id, !this.expandedCollections[id])\r\n    },\r\n    \r\n    // 关闭游戏结束对话框\r\n    closeGameEndDialog() {\r\n      this.showGameEndDialog = false\r\n    },\r\n    \r\n    // 留在房间\r\n    stayInRoom() {\r\n      this.showGameEndDialog = false\r\n      try { this.$store.commit('CLEAR_GAME_LOG') } catch (_) {}\r\n      // 返回当前房间准备界面\r\n      const rid = this.$store.state.roomId\r\n      if (rid) {\r\n        this.$store.commit('SET_GAME_PHASE', 'preparation')\r\n        this.$router.push({ path: '/game', query: { roomId: rid } })\r\n      }\r\n    },\r\n    \r\n    // 返回房间列表\r\n    goToRooms() {\r\n      this.showGameEndDialog = false\r\n      this.unsubscribeRoomRealtime()\r\n      try { this.$store.commit('CLEAR_GAME_LOG') } catch (_) {}\r\n      // 返回当前房间准备界面（更符合期望）\r\n      const rid = this.$store.state.roomId\r\n      if (rid) {\r\n        this.$store.commit('SET_GAME_PHASE', 'preparation')\r\n        this.$router.push({ path: '/game', query: { roomId: rid } })\r\n      } else {\r\n        this.$router.push('/rooms')\r\n      }\r\n    },\r\n    \r\n    // 时间到：结束当前所有拍卖并结算到对应玩家手牌，然后进入10s间歇或结束游戏\r\n    async onAuctionTimeUp() {\r\n      try {\r\n        const auctions = this.$store.state.currentAuctions || []\r\n        // 统一倒计时结束：结束所有当前拍卖\r\n        for (const a of auctions) {\r\n          await this.$store.dispatch('endAuction', a.id)\r\n        }\r\n        // 判断是否达到总回合数\r\n        const cur = Number(this.$store.state.roundCurrent || 0)\r\n        const tot = Number(this.$store.state.roundTotal || 6)\r\n        if (cur >= tot) {\r\n          // 触发结束\r\n          this.$store.commit('SET_GAME_PHASE', 'settlement')\r\n          await this.computeFinalScores()\r\n          this.showGameEndDialog = true\r\n          return\r\n        }\r\n        // 否则进入10s间歇阶段\r\n        this.startIntermissionTimer(10)\r\n      } catch (e) { console.warn('[game] onAuctionTimeUp failed', e) }\r\n    },\r\n\r\n    // 开始拍卖倒计时：统一每轮拍卖只有一个倒计时\r\n    startAuctionTimer(duration = 30) {\r\n      this.$store.commit('SET_GAME_PHASE', 'auction')\r\n      startCountdown({\r\n        seconds: duration,\r\n        onTick: (s) => { this.$set(this, 'auctionCountdown', s); },\r\n        onDone: async () => { await this.onAuctionTimeUp() },\r\n        getRef: () => this.auctionTimer,\r\n        setRef: (id) => { this.auctionTimer = id },\r\n      })\r\n    },\r\n\r\n\r\n    \r\n    // 每轮之间的间歇计时器，结束后自动开始下一轮拍卖\r\n    startIntermissionTimer(duration = 10) {\r\n      this.$store.commit('SET_GAME_PHASE', 'intermission')\r\n      startCountdown({\r\n        seconds: duration,\r\n        onTick: (s) => { this.$set(this, 'auctionCountdown', s); },\r\n        onDone: async () => {\r\n          if (this.isOwner) {\r\n            await this.autoStartAuction()\r\n          }\r\n        },\r\n        getRef: () => this.auctionTimer,\r\n        setRef: (id) => { this.auctionTimer = id },\r\n      })\r\n    },\r\n    \r\n    // 自动开始拍卖\r\n    async autoStartAuction() {\r\n      try {\r\n        const rid = this.$store.state.roomId\r\n        const supabase = getSupabase()\r\n        await autoStartAuctionFlow({\r\n          roomId: rid,\r\n          store: this.$store,\r\n          supabase,\r\n          loadArtifacts: () => this.loadArtifacts(),\r\n          dispatchStartAuction: (art) => this.$store.dispatch('startAuction', art),\r\n          startAuctionTimer: (sec) => this.startAuctionTimer(sec),\r\n          roundCount: this.roundCount,\r\n          totalRounds: this.totalRounds,\r\n          setRoundCount: (n) => { this.roundCount = n },\r\n        })\r\n      } catch (e) { console.warn('[game] autoStartAuction failed', e) }\r\n    },\r\n    \r\n    // 发送聊天消息\r\n    async sendMessage() {\r\n      if (!this.newMessage.trim() || !this.user) return\r\n      const message = { \r\n        id: Date.now(), \r\n        userId: this.user.id, \r\n        username: this.getNameFor(this.user.id), \r\n        content: this.newMessage.trim(), \r\n        timestamp: Date.now() \r\n      }\r\n      // 本地立即显示，提供即时反馈\r\n      this.chatMessages.push(message)\r\n      this.newMessage = ''\r\n      \r\n      // 滚动到底部\r\n      this.$nextTick(() => {\r\n        const chatContainer = this.$refs.chatContainer\r\n        if (chatContainer) { chatContainer.scrollTop = chatContainer.scrollHeight }\r\n      })\r\n      \r\n      // 发送到服务器，广播给所有玩家\r\n      const rid = this.$store.state.roomId\r\n      if (rid) { \r\n        try { \r\n          const supabase = getSupabase()\r\n          await sendChatMessage({ supabase, roomId: rid, message }) \r\n        } catch (e) { \r\n          console.warn('[game] sendMessage failed', e)\r\n          // 发送失败时，可以选择移除本地消息或保留（保留提供更好的用户体验）\r\n        } \r\n      }\r\n    },\r\n    \r\n    // 格式化消息时间\r\n    formatMessageTime(timestamp) { return formatMessageTimeHelper(timestamp) }\r\n    ,\r\n\r\n    // 计算最终得分并确定赢家\r\n    async computeFinalScores() {\r\n      try {\r\n        const rid = this.$store.state.roomId\r\n        if (!rid) return\r\n        const supabase = getSupabase()\r\n        const { data: rows } = await supabase\r\n          .from('room_artifacts')\r\n          .select('owner_user_id, artifact_id')\r\n          .eq('room_id', rid)\r\n        const userToArtifacts = {}\r\n        ;(rows || []).forEach(r => {\r\n          if (!userToArtifacts[r.owner_user_id]) userToArtifacts[r.owner_user_id] = []\r\n          userToArtifacts[r.owner_user_id].push(r.artifact_id)\r\n        })\r\n\r\n        const collections = Array.isArray(this.collections) ? this.collections : []\r\n        const scores = Object.keys(userToArtifacts).map(uid => {\r\n          const owned = userToArtifacts[uid]\r\n          // 收藏集分数\r\n          let collectionScore = 0\r\n          collections.forEach(col => {\r\n            const current = getCollectionCountUtil({ artifactMap: this.artifactMap, ownedArtifactIds: owned, collection: col })\r\n            if (current >= (col.requiredCount || 1)) collectionScore += (col.rewardPoints || 0)\r\n          })\r\n          // 零散奇物分数（基础价值一半，向下取整）\r\n          let artifactScore = 0\r\n          owned.forEach(aid => {\r\n            const a = this.artifactMap[aid]\r\n            if (a && typeof a.baseValue === 'number') artifactScore += Math.floor(a.baseValue / 2)\r\n          })\r\n        \r\n          const total = collectionScore + artifactScore\r\n          return {\r\n            userId: uid,\r\n            name: this.getNameFor(uid),\r\n            avatar: this.getAvatarFor(uid),\r\n            collectionScore,\r\n            artifactScore,\r\n            total\r\n          }\r\n        })\r\n\r\n        const sorted = scores.sort((a, b) => b.total - a.total)\r\n        this.finalScores = sorted\r\n        this.winnerInfo = sorted[0] || null\r\n\r\n        if (this.winnerInfo) {\r\n          this.$store.commit('ADD_GAME_LOG', { timestamp: Date.now(), message: `本局结束，胜者：${this.winnerInfo.name}（总分 ${this.winnerInfo.total}）` })\r\n        }\r\n      } catch (e) { console.warn('[game] computeFinalScores failed', e) }\r\n    },\r\n\r\n    // 开启/关闭文物讲述\r\n    openNarration() {\r\n      // 构造讲述文本，包含基本介绍 + 故事\r\n      const base = `${this.selectedCard.name}，来自 ${this.selectedCard.era}${this.selectedCard.location ? ' · ' + this.selectedCard.location : ''}。\\n`\r\n      const story = (this.selectedCard.story || '').trim()\r\n      const full = `${base}${story}`.trim()\r\n      // 打字机效果\r\n      this.typingText = ''\r\n      this.showNarration = true\r\n      const speed = (firstLoginDialogueConfig && firstLoginDialogueConfig.animations && firstLoginDialogueConfig.animations.textTypingSpeed) || 30\r\n      if (this.typingTimer) { clearInterval(this.typingTimer); this.typingTimer = null }\r\n      let i = 0\r\n      this.typingTimer = setInterval(() => {\r\n        if (i >= full.length) {\r\n          clearInterval(this.typingTimer)\r\n          this.typingTimer = null\r\n        } else {\r\n          this.typingText += full[i]\r\n          i += 1\r\n        }\r\n      }, speed)\r\n    },\r\n    closeNarration() {\r\n      if (this.typingTimer) { clearInterval(this.typingTimer); this.typingTimer = null }\r\n      this.showNarration = false\r\n      this.typingText = ''\r\n    }\r\n  }\r\n}\r\n</script>\r\n\r\n<style lang=\"scss\" scoped src=\"./index.scss\"></style>"]}]}